---
apiVersion: v1
kind: ConfigMap
metadata:
    name: zammad-scheduler-metrics
    namespace: default
data:
    metrics-exporter.sh: |
        #!/bin/bash
        PORT=9090

        check_scheduler() {
            if kubectl get pods -n default -l app.kubernetes.io/component=zammad-scheduler --no-headers 2>/dev/null | grep -q "Running"; then
                echo "1"
            else
                echo "0"
            fi
        }

        check_database() {
            if nc -z postgres16-rw.database.svc.cluster.local 5432 2>/dev/null; then
                echo "1"
            else
                echo "0"
            fi
        }

        generate_metrics() {
            local scheduler_status=$(check_scheduler)
            local db_status=$(check_database)

            echo "# HELP zammad_scheduler_up Whether the scheduler pod is running"
            echo "# TYPE zammad_scheduler_up gauge"
            echo "zammad_scheduler_up $scheduler_status"
            echo ""
            echo "# HELP zammad_scheduler_database_reachable Whether database is reachable"
            echo "# TYPE zammad_scheduler_database_reachable gauge"
            echo "zammad_scheduler_database_reachable $db_status"
            echo ""
            echo "# HELP zammad_scheduler_metrics_exporter_up Whether this metrics exporter is running"
            echo "# TYPE zammad_scheduler_metrics_exporter_up gauge"
            echo "zammad_scheduler_metrics_exporter_up 1"
        }

        echo "Starting simple metrics server on port $PORT"
        while true; do
            (
                echo "HTTP/1.1 200 OK"
                echo "Content-Type: text/plain; version=0.0.4; charset=utf-8"
                echo "Connection: close"
                echo ""
                generate_metrics
            ) | nc -l -p $PORT -q 1 2>/dev/null
            sleep 0.1
        done
