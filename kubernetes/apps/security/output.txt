File: ./wazuh/app/secrets.sops.yaml
apiVersion:
kind:
metadata:
name:
namespace:
stringData:
INDEXER_PASSWORD:
API_PASSWORD:
DASHBOARD_PASSWORD:
INDEXER_USERNAME:
DASHBOARD_USERNAME:
FILEBEAT_SSL_VERIFICATION_MODE:
SSL_CERTIFICATE_AUTHORITIES:
SSL_CERTIFICATE:
SSL_KEY:
WAZUH_API_URL:
OPENSEARCH_HOSTS:
OPENSEARCH_SSL_VERIFICATIONMODE:
SERVER_SSL_ENABLED:
SERVER_SSL_KEY:
SERVER_SSL_CERTIFICATE:
sops:
kms:
gcp_kms:
azure_kv:
hc_vault:
age:
enc:
enc:
lastmodified:
mac:
pgp:
encrypted_regex:
version:

File: ./wazuh/app/configmap.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-manager-config
data:
  ossec.conf: |
    <ossec_config>
      <global>
        <jsonout_output>yes</jsonout_output>
        <alerts_log>yes</alerts_log>
        <logall>no</logall>
        <logall_json>no</logall_json>
        <email_notification>no</email_notification>
        <smtp_server>smtp.gmail.com</smtp_server>
        <email_from>wazuh@${SECRET_DOMAIN}</email_from>
        <email_to>admin@${SECRET_DOMAIN}</email_to>
        <email_maxperhour>12</email_maxperhour>
        <email_log_source>alerts.log</email_log_source>
        <agents_disconnection_time>10m</agents_disconnection_time>
        <agents_disconnection_alert_time>0</agents_disconnection_alert_time>
      </global>

      <alerts>
        <log_alert_level>3</log_alert_level>
        <email_alert_level>12</email_alert_level>
      </alerts>

      <remote>
        <connection>secure</connection>
        <port>1514</port>
        <protocol>tcp</protocol>
        <queue_size>131072</queue_size>
      </remote>

      <rootcheck>
        <disabled>no</disabled>
        <check_files>yes</check_files>
        <check_trojans>yes</check_trojans>
        <check_dev>yes</check_dev>
        <check_sys>yes</check_sys>
        <check_pids>yes</check_pids>
        <check_ports>yes</check_ports>
        <check_if>yes</check_if>
        <frequency>43200</frequency>
        <rootkit_files>/var/ossec/etc/rootcheck/rootkit_files.txt</rootkit_files>
        <rootkit_trojans>/var/ossec/etc/rootcheck/rootkit_trojans.txt</rootkit_trojans>
        <skip_nfs>yes</skip_nfs>
      </rootcheck>

      <syscheck>
        <disabled>no</disabled>
        <frequency>43200</frequency>
        <scan_on_start>yes</scan_on_start>
        <auto_ignore>no</auto_ignore>
        <alert_new_files>yes</alert_new_files>
        <scan_day>sunday</scan_day>
        <scan_time>6:00</scan_time>
        <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
        <directories check_all="yes">/bin,/sbin,/boot</directories>
        <ignore>/etc/mtab</ignore>
        <ignore>/etc/hosts.deny</ignore>
        <ignore>/etc/mail/statistics</ignore>
        <ignore>/etc/random-seed</ignore>
        <ignore>/etc/random.seed</ignore>
        <ignore>/etc/adjtime</ignore>
        <ignore>/etc/httpd/logs</ignore>
        <ignore>/etc/utmpx</ignore>
        <ignore>/etc/wtmpx</ignore>
        <ignore>/etc/cups/certs</ignore>
        <ignore>/etc/dumpdates</ignore>
        <ignore>/etc/svc/volatile</ignore>
        <skip_nfs>yes</skip_nfs>
      </syscheck>
    </ossec_config>
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-indexer-config
data:
  opensearch.yml: |
    cluster.name: wazuh-cluster
    node.name: ${HOSTNAME}
    network.host: 0.0.0.0
    bootstrap.memory_lock: true
    http.port: 9200
    discovery.type: single-node

File: ./wazuh/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wazuh-manager-etc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: ceph-rbd
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wazuh-manager-logs
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: ceph-rbd
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wazuh-manager-queue
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: ceph-rbd
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wazuh-indexer-data
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 30Gi
  storageClassName: cephfs
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wazuh-dashboard-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: ceph-rbd

File: ./wazuh/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: wazuh
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      manager:
        type: statefulset
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: wazuh/wazuh-manager
              tag: 4.10.0-rc3
            env:
              INDEXER_URL: http://localhost:9200
              INDEXER_USERNAME: admin
              INDEXER_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: wazuh-secrets
                    key: INDEXER_PASSWORD
              FILEBEAT_SSL_VERIFICATION_MODE: full
              API_USERNAME: wazuh-wui
              API_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: wazuh-secrets
                    key: API_PASSWORD
            resources:
              requests:
                memory: 512Mi
                cpu: 100m
              limits:
                memory: 2Gi
            securityContext:
              runAsNonRoot: true
              runAsUser: 101
              runAsGroup: 101

      indexer:
        type: statefulset
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: wazuh/wazuh-indexer
              tag: 4.10.0-rc3
            env:
              OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
              bootstrap.memory_lock: "true"
              DISABLE_INSTALL_DEMO_CONFIG: "true"
              DISABLE_SECURITY_PLUGIN: "true"
            resources:
              requests:
                memory: 512Mi
                cpu: 100m
              limits:
                memory: 2Gi
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              runAsGroup: 1000

      dashboard:
        type: deployment
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: wazuh/wazuh-dashboard
              tag: 4.10.0-rc3
            env:
              OPENSEARCH_HOSTS: http://wazuh-indexer.svc.cluster.lcoal:9200
              WAZUH_API_URL: http://wazuh-manager.svc.cluster.local:55000
              API_USERNAME: wazuh-wui
              API_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: wazuh-secrets
                    key: API_PASSWORD
              DASHBOARD_USERNAME: admin
              DASHBOARD_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: wazuh-secrets
                    key: DASHBOARD_PASSWORD
            resources:
              requests:
                memory: 512Mi
                cpu: 100m
              limits:
                memory: 2Gi
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              runAsGroup: 1000

    service:
      manager:
        controller: manager
        ports:
          agent-tcp:
            port: 1514
          agent-udp:
            port: 1514
            protocol: UDP
          registration:
            port: 1515
          api:
            port: 55000

      indexer:
        controller: indexer
        ports:
          http:
            port: 9200

      dashboard:
        controller: dashboard
        ports:
          http:
            port: 5601

    ingress:
      dashboard:
        enabled: true
        className: internal
        annotations:
          hajimari.io/icon: simple-icons:kibana
        hosts:
          - host: &host "wazuh.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: dashboard
                  port: http
        tls:
          - hosts:
              - *host

    persistence:
      manager-etc:
        enabled: true
        existingClaim: wazuh-manager-etc
        globalMounts:
          - path: /var/ossec/etc
      manager-logs:
        enabled: true
        existingClaim: wazuh-manager-logs
        globalMounts:
          - path: /var/ossec/logs
      manager-queue:
        enabled: true
        existingClaim: wazuh-manager-queue
        globalMounts:
          - path: /var/ossec/queue

      indexer-data:
        enabled: true
        existingClaim: wazuh-indexer-data
        globalMounts:
          - path: /usr/share/wazuh-indexer/data

      dashboard-data:
        enabled: true
        existingClaim: wazuh-dashboard-data
        globalMounts:
          - path: /usr/share/wazuh-dashboard/data

File: ./wazuh/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./pvc.yaml
  - ./secrets.sops.yaml
  - ./configmap.yaml
  - ./helmrelease.yaml

File: ./wazuh/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app wazuh
  namespace: flux-system
spec:
  targetNamespace: &ns security
  interval: 10m
  path: "./kubernetes/apps/security/wazuh/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  postBuild:
    substitute:
      APP: *app

File: ./kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./ns.yaml
#  - ./wazuh/ks.yaml

File: ./ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: security

