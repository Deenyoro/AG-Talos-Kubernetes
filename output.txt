File: ./config.yaml
---
#
# 1. (Required) Cluster details - Cluster represents the Kubernetes cluster layer and any additional customizations
#

# (Optional) Cluster name; affects Cilium and Talos
#   Default is "home-kubernetes"
bootstrap_cluster_name: "thepatriots"

# (Required) Generated schematic id from https://factory.talos.dev/
bootstrap_schematic_id: "ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515"

# (Required) The CIDR your nodes are on (e.g. 192.168.1.0/24)
bootstrap_node_network: "10.10.10.0/20"

# (Required) Use only 1, 3 or more ODD number of controller nodes, recommended is 3
#   Worker nodes are optional
bootstrap_node_inventory:
  - name: "kjd111"
    address: "10.10.12.111"
    controller: true
    disk: "/dev/sda"
    mac_addr: "0269cb6f84a4"
    mtu: "1500"
  - name: "kjd112"
    address: "10.10.12.112"
    controller: true
    disk: "/dev/sda"
    mac_addr: "0249f55f0575"
    mtu: "1500"
  - name: "kjd113"
    address: "10.10.12.113"
    controller: true
    disk: "/dev/sda"
    mac_addr: "027ce94bfbb6"
    mtu: "1500"
  - name: "kawg121"
    address: "10.10.12.121"
    controller: false
    disk: "/dev/sda"
    mac_addr: "025ffcaf8d15"
    mtu: "1500"
  - name: "kawg122"
    address: "10.10.12.122"
    controller: false
    disk: "/dev/sda"
    mac_addr: "02448ef5d041"
    mtu: "1500"
  - name: "kawg123"
    address: "10.10.12.123"
    controller: false
    disk: "/dev/sda"
    mac_addr: "0263b2e00a63"
    mtu: "1500"
  - name: "kawg124"
    address: "10.10.12.124"
    controller: false
    disk: "/dev/sda"
    mac_addr: "021579a6b815"
    mtu: "1500"

# (Optional) The DNS servers to use for the cluster nodes.
#   Default is pulled from your DHCP server.
bootstrap_dns_servers:
  - "10.10.10.1"

# (Optional) The NTP servers to use for the cluster nodes.
#   Default is pulled from your DHCP server.
bootstrap_ntp_servers: [time.google.com]

# (Required) The pod CIDR for the cluster, this must NOT overlap with any
#   existing networks and is usually a /16 (64K IPs).
# If you want to use IPv6 check the advanced flags below and be aware of
# https://github.com/onedr0p/cluster-template/issues/1148
bootstrap_pod_network: "10.244.0.0/16"

# (Required) The service CIDR for the cluster, this must NOT overlap with any
#   existing networks and is usually a /16 (64K IPs).
# If you want to use IPv6 check the advanced flags below and be aware of
# https://github.com/onedr0p/cluster-template/issues/1148
bootstrap_service_network: "10.96.0.0/16"

# (Required) The IP address of the Kube API, choose an available IP in
#   your nodes host network that is NOT being used. This is announced over L2.
bootstrap_controller_vip: "10.10.12.105"

# (Optional) Add additional SANs to the Kube API cert, this is useful
#   if you want to call the Kube API by hostname rather than IP
bootstrap_tls_sans:
  - "ThePatriots.local"

# (Optional) The default gateway for the nodes
#   Default is .1 which is derived from bootstrap_node_network (e.g. 192.168.1.1)
bootstrap_node_default_gateway: "10.10.10.1"

# (Optional) Add vlan tag to network master device, this is not needed if you tag ports on your switch with the VLAN
#   See: https://www.talos.dev/latest/advanced/advanced-networking/#vlans
bootstrap_vlan: ""

# (Required) Age Public Key (e.g. age1...)
# 1. Generate a new key with the following command:
#    > task sops:age-keygen
# 2. Copy the PUBLIC key and paste it below
bootstrap_sops_age_pubkey: "age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy"

# (Optional) Use cilium BGP control plane when L2 announcements won't traverse VLAN network segments.
#   Needs a BGP capable router setup with the node IPs as peers.
#   See: https://docs.cilium.io/en/latest/network/bgp-control-plane/
bootstrap_bgp:
  enabled: false
  # (Optional) If using multiple BGP peers add them here.
  #   Default is .1 derived from host_network: ['x.x.x.1']
  peers: []
  # (Required) Set the BGP Autonomous System Number for the router(s) and nodes.
  #   If these match, iBGP will be used. If not, eBGP will be used.
  peer_asn: "" # Router(s) AS
  local_asn: "" # Node(s) AS
  peer_port: 179 # BGP Port - default is TCP port 179
  # (Required) The advertised CIDR for the cluster, this must NOT overlap with any
  #   existing networks and is usually a /16 (64K IPs).
  # If you want to use IPv6 check the advanced flags below
  advertised_network: ""

# (Optional) Secureboot and TPM-based disk encryption
bootstrap_secureboot:
  # (Optional) Enable secureboot on UEFI systems. Not supported on x86 platforms in BIOS mode.
  #   See: https://www.talos.dev/latest/talos-guides/install/bare-metal-platforms/secureboot
  enabled: false
  # (Optional) Enable TPM-based disk encryption. Requires TPM 2.0
  #   See: https://www.talos.dev/v1.6/talos-guides/install/bare-metal-platforms/secureboot/#disk-encryption-with-tpm
  encrypt_disk_with_tpm: false

#
# 2. (Required) Flux details - Flux is used to manage the cluster configuration.
#

# (Required) GitHub repository URL
#   For a public repo use the 'https://' URL (e.g. "https://github.com/onedr0p/cluster-template.git")
#   For a private repo use the 'ssh://' URL (e.g. "ssh://git@github.com/onedr0p/cluster-template.git")
#     If using a private repo make sure to follow the instructions with the 'bootstrap_github_private_key' option below.
bootstrap_github_address: "https://github.com/Deenyoro/AG-Talos-Kubernetes"

# (Required) GitHub repository branch
bootstrap_github_branch: "main"

# (Required) Token for GitHub push-based sync
# 1. Generate a new token with the following command:
#    > openssl rand -hex 16
# 2. Copy the token and paste it below
bootstrap_github_webhook_token: "b7c85b2947bda260d8fff020ee521572"

# (Optional) Private key for Flux to access the GitHub repository
#   1. Generate a new key with the following command:
#      > ssh-keygen -t ecdsa -b 521 -C "github-deploy-key" -f github-deploy.key -q -P ""
#   2. Make sure to paste the public key from "github-deploy.key.pub" into
#      the deploy keys section of your GitHub repository settings.
#   3. Uncomment and paste the private key below
# bootstrap_github_private_key: |
#   -----BEGIN OPENSSH PRIVATE KEY-----
#   ...
#   -----END OPENSSH PRIVATE KEY-----

#
# 3. (Optional) Cloudflare details - Cloudflare is used for DNS, TLS certificates and tunneling.
#

bootstrap_cloudflare:
  # (Required) Disable to manually set up and use a different DNS provider - setting this
  #   to false will not deploy a network namespace or the workloads contained within.
  enabled: true
  # (Required) Cloudflare Domain
  domain: "kawalink.com"
  # (Required) Cloudflare API Token (NOT API Key)
  #   1. Head over to Cloudflare and create an API Token by going to
  #      https://dash.cloudflare.com/profile/api-tokens
  #   2. Under the `API Tokens` section click the blue `Create Token` button.
  #   3. Click the blue `Use template` button for the `Edit zone DNS` template.
  #   4. Name your token something like `home-kubernetes`
  #   5. Under `Permissions`, click `+ Add More` and add each permission below:
  #      `Zone - DNS - Edit`
  #      `Account - Cloudflare Tunnel - Read`
  #   6. Limit the permissions to a specific account and zone resources.
  #   7. Click the blue `Continue to Summary` button and then the blue `Create Token` button.
  #   8. Copy the token and paste it below.
  token: "RWTmAdF45ROveuDsB0R_HiiWRxINwIAhodVnaUsR"
  # (Required) Optionals for Cloudflare Acme
  acme:
    # (Required) Any email you want to be associated with the ACME account (used for TLS certs via letsencrypt.org)
    email: "dean@kawalink.com"
    # (Required) Use the ACME production server when requesting the wildcard certificate.
    #   By default, the ACME staging server is used. This is to prevent being rate-limited.
    #   Update this option to `true` when you have verified the staging certificate
    #   works and then re-run `task configure` and push your changes to GitHub.
    production: true
  # (Required) Provide LAN access to the cluster ingresses for internal ingress classes
  # The Load balancer IP for internal ingress, choose an available IP
  #   in your nodes host network that is NOT being used. This is announced over L2.
  ingress_vip: "10.10.12.110"
  # (Required) Gateway is used for providing DNS to your cluster on LAN
  # The Load balancer IP for k8s_gateway, choose an available IP
  #   in your nodes host network that is NOT being used. This is announced over L2.
  gateway_vip: "10.10.12.109"
  # (Required) Options for Cloudflare Tunnel
  # There's two methods to create a tunnel, via the CLI or the Cloudflare dashboard.
  #   1. Authenticate cloudflared to your domain with the following command:
  #     > cloudflared tunnel login
  #   2. Create the tunnel with the following command:
  #     > cloudflared tunnel create k8s
  tunnel:
    # (Required) Get the Cloudflared Tunnel ID with the following command:
    #   > jq -r .TunnelID ~/.cloudflared/*.json
    id: "3802e685-7734-4293-b9f1-dbb836581ac5"
    # (Required) Get the Cloudflare Account ID with the following command:
    #   > jq -r .AccountTag ~/.cloudflared/*.json
    account_id: "11130f68de674f870b3391763d200b31"
    # (Required) Get the Cloudflared Tunnel Secret with the following command:
    #   > jq -r .TunnelSecret ~/.cloudflared/*.json
    secret: "wQjzbtbR5+Pc2wV57XpuepgTjRXdvw7EAVa1QTxIGfc="
    # (Required) Provide WAN access to the cluster ingresses for external ingress classes
    # The Load balancer IP for external ingress, choose an available IP
    #   in your nodes host network that is NOT being used. This is announced over L2.
    ingress_vip: "10.10.12.108"
# (Optional) Feature gates are used to enable experimental features
# bootstrap_feature_gates:
#   # Enable Dual Stack IPv4 first
#   # IMPORTANT: I am looking for people to help maintain IPv6 support since I cannot test it.
#   #   Ref: https://github.com/onedr0p/cluster-template/issues/1148
#   # Keep in mind that Cilium does not currently support IPv6 L2 announcements.
#   dual_stack_ipv4_first: false

File: ./ceph-rbd-sc.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-rbd
parameters:
  clusterID: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/fstype: ext4
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  imageFeatures: layering
  imageFormat: "2"
  pool: SSD4x1_pool
provisioner: rook-ceph.rbd.csi.ceph.com
reclaimPolicy: Delete
volumeBindingMode: Immediate
allowVolumeExpansion: true

File: ./.venv/lib/python3.12/site-packages/markdown_it/port.yaml
- package: markdown-it/markdown-it
  version: 13.0.1
  commit: e843acc9edad115cbf8cf85e676443f01658be08
  date: May 3, 2022
  notes:
    - Rename variables that use python built-in names, e.g.
      - `max` -> `maximum`
      - `len` -> `length`
      - `str` -> `string`
    - |
      Convert JS `for` loops to `while` loops
      this is generally the main difference between the codes,
      because in python you can't do e.g. `for {i=1;i<x;i++} {}`
    - |
      `env` is a common Python dictionary, and so does not have attribute access to keys,
      as with JavaScript dictionaries.
      `options` have attribute access only to core markdownit configuration options
    - |
      `Token.attrs` is a dictionary, instead of a list of lists.
      Upstream the list format is only used to guarantee order: https://github.com/markdown-it/markdown-it/issues/142,
      but in Python 3.7+ order of dictionaries is guaranteed.
      One should anyhow use the `attrGet`, `attrSet`, `attrPush` and `attrJoin` methods
      to manipulate `Token.attrs`, which have an identical signature to those upstream.
    - Use python version of `charCodeAt`
    - |
      Use `str` units instead of `int`s to represent Unicode codepoints.
      This provides a significant performance boost
    - |
      In markdown_it/rules_block/reference.py,
      record line range in state.env["references"] and add state.env["duplicate_refs"]
      This is to allow renderers to report on issues regarding references
    - |
      The `MarkdownIt.__init__` signature is slightly different for updating options,
      since you must always specify the config first, e.g.
      use `MarkdownIt("commonmark", {"html": False})` instead of `MarkdownIt({"html": False})`
    - The default configuration preset for `MarkdownIt` is "commonmark" not "default"
    - Allow custom renderer to be passed to `MarkdownIt`
    - |
      change render method signatures
      `func(tokens, idx, options, env, slf)` to
      `func(self, tokens, idx, options, env)`
    - |
      Extensions add render methods by format
      `MarkdownIt.add_render_rule(name, function, fmt="html")`,
      rather than `MarkdownIt.renderer.rules[name] = function`
      and renderers should declare a class property `__output__ = "html"`.
      This allows for extensibility to more than just HTML renderers
    - inline tokens in tables are assigned a map (this is helpful for propagation to children)

File: ./Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # Directories
  BOOTSTRAP_DIR: "{{.ROOT_DIR}}/bootstrap"
  KUBERNETES_DIR: "{{.ROOT_DIR}}/kubernetes"
  PRIVATE_DIR: "{{.ROOT_DIR}}/.private"
  SCRIPTS_DIR: "{{.ROOT_DIR}}/scripts"
  # Files
  AGE_FILE: "$HOME/.config/sops/age/keys.txt"
  BOOTSTRAP_CONFIG_FILE: "{{.ROOT_DIR}}/config.yaml"
  KUBECONFIG_FILE: "{{.ROOT_DIR}}/kubeconfig"
  MAKEJINJA_CONFIG_FILE: "{{.ROOT_DIR}}/makejinja.toml"
  PIP_REQUIREMENTS_FILE: "{{.ROOT_DIR}}/requirements.txt"
  SOPS_CONFIG_FILE: "{{.ROOT_DIR}}/.sops.yaml"
  # Binaries
  PYTHON_BIN: python3

env:
  KUBECONFIG: "{{.KUBECONFIG_FILE}}"
  PYTHONDONTWRITEBYTECODE: "1"
  SOPS_AGE_KEY_FILE: "{{.AGE_FILE}}"
  VIRTUAL_ENV: "{{.ROOT_DIR}}/.venv"

includes:
  kubernetes: .taskfiles/Kubernetes
  flux: .taskfiles/Flux
  repository: .taskfiles/Repository
  talos: .taskfiles/Talos
  sops: .taskfiles/Sops
  workstation: .taskfiles/Workstation
  user:
    taskfile: .taskfiles/User
    optional: true

tasks:

  default: task --list

  init:
    desc: Initialize configuration files
    cmds:
      - cp -n {{.BOOTSTRAP_CONFIG_FILE | replace ".yaml" ".sample.yaml"}} {{.BOOTSTRAP_CONFIG_FILE}}
      - echo "=== Configuration file copied ==="
      - echo "Proceed with updating the configuration files..."
      - echo "{{.BOOTSTRAP_CONFIG_FILE}}"
    status:
      - test -f {{.BOOTSTRAP_CONFIG_FILE}}
    silent: true

  configure:
    desc: Configure repository from bootstrap vars
    prompt: Any conflicting config in the kubernetes directory will be overwritten... continue?
    deps: ["workstation:direnv", "workstation:venv", "sops:age-keygen", "init"]
    cmds:
      - task: .template
      - task: sops:encrypt
      - task: .validate
      - |
          chmod +x ./merge_config.sh
          ./merge_config.sh

  .template:
    internal: true
    cmds:
      - "{{.VIRTUAL_ENV}}/bin/makejinja"
    preconditions:
      - msg: Missing virtual environment
        sh: test -d {{.VIRTUAL_ENV}}
      - msg: Missing Makejinja config file
        sh: test -f {{.MAKEJINJA_CONFIG_FILE}}
      - msg: Missing Makejinja plugin file
        sh: test -f {{.BOOTSTRAP_DIR}}/scripts/plugin.py
      - msg: Missing bootstrap config file
        sh: test -f {{.BOOTSTRAP_CONFIG_FILE}}

  .validate:
    internal: true
    cmds:
      - task: kubernetes:kubeconform
      - echo "=== Done rendering and validating YAML ==="
      - |
          if [[ $KUBECONFIG != "{{.KUBECONFIG_FILE}}" ]]; then
            echo "WARNING: KUBECONFIG is not set to the expected value, this may cause conflicts."
          fi
      - |
          if [[ $SOPS_AGE_KEY_FILE != "{{.AGE_FILE}}" ]]; then
            echo "WARNING: SOPS_AGE_KEY_FILE is not set to the expected value, this may cause conflicts."
          fi
      - |
          if test -f ~/.config/sops/age/keys.txt; then
            echo "WARNING: SOPS Age key found in home directory, this may cause conflicts."
          fi
    silent: true

File: ./.github/workflows/e2e.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "e2e"

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  configure:
    if: ${{ github.repository == 'onedr0p/cluster-template' }}
    name: configure
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config-files:
          - talos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Homebrew
        id: setup-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Setup Python
        uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.11" # minimum supported version

      - name: Cache homebrew packages
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/cache@v4
        id: cache-homebrew-packages
        with:
          key: homebrew-${{ runner.os }}-${{ steps.setup-homebrew.outputs.gems-hash }}-${{ hashFiles('.taskfiles/Workstation/Brewfile') }}
          path: /home/linuxbrew/.linuxbrew

      - name: Cache venv
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/cache@v4
        with:
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('requirements.txt', 'requirements.yaml') }}
          path: .venv

      - name: Setup Workflow Tools
        if: ${{ github.event_name == 'pull_request' && steps.cache-homebrew-packages.outputs.cache-hit != 'true' }}
        shell: bash
        run: brew install go-task

      - name: Run Workstation Brew tasks
        if: ${{ github.event_name == 'pull_request' && steps.cache-homebrew-packages.outputs.cache-hit != 'true' }}
        shell: bash
        run: task workstation:brew

      - name: Run Workstation venv tasks
        shell: bash
        run: task workstation:venv

      - name: Run Workstation direnv tasks
        shell: bash
        run: task workstation:direnv

      - name: Run Sops Age key task
        shell: bash
        run: task sops:age-keygen

      - name: Run init tasks
        shell: bash
        run: |
          task init
          cp ./.github/tests/config-${{ matrix.config-files }}.yaml ./config.yaml
          export BOOTSTRAP_AGE_PUBLIC_KEY=$(sed -n 's/# public key: //gp' age.key)
          envsubst < ./config.yaml | sponge ./config.yaml

      - name: Run configure task
        shell: bash
        run: task configure --yes

      - name: Run repo clean and reset tasks
        shell: bash
        run: |
          task repository:clean
          task repository:reset --yes

File: ./.github/workflows/devcontainer.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "devcontainer"

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: [".devcontainer/ci/**"]
  pull_request:
    branches: ["main"]
    paths: [".devcontainer/ci/**"]
  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  devcontainer:
    if: ${{ github.repository == 'onedr0p/cluster-template' }}
    name: publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64 #,linux/arm64

      - if: ${{ github.event_name != 'pull_request' }}
        name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: devcontainers/ci@v0.3
        env:
          BUILDX_NO_DEFAULT_ATTESTATIONS: true
        with:
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          # cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          imageTag: base,latest
          platform: linux/amd64 #,linux/arm64
          configFile: .devcontainer/ci/devcontainer.json
          push: ${{ github.event_name == 'pull_request' && 'never' || 'always' }}

File: ./.github/workflows/release.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Release"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  release:
    if: ${{ github.repository == 'onedr0p/cluster-template' }}
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        shell: bash
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          # Retrieve previous release tag
          previous_tag="$(gh release list --limit 1 | awk '{ print $1 }')"
          previous_major="${previous_tag%%\.*}"
          previous_minor="${previous_tag#*.}"
          previous_minor="${previous_minor%.*}"
          previous_patch="${previous_tag##*.}"
          # Determine next release tag
          next_major_minor="$(date +'%Y').$(date +'%-m')"
          if [[ "${previous_major}.${previous_minor}" == "${next_major_minor}" ]]; then
              echo "Month release already exists for year, incrementing patch number by 1"
              next_patch="$((previous_patch + 1))"
          else
              echo "Month release does not exist for year, setting patch number to 0"
              next_patch="0"
          fi
          # Create release
          release_tag="${next_major_minor}.${next_patch}"
          gh release create "${release_tag}" \
              --repo="${GITHUB_REPOSITORY}" \
              --title="${release_tag}" \
              --generate-notes

File: ./.github/workflows/flux-diff.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Flux Diff"

on:
  pull_request:
    branches: ["main"]
    paths: ["kubernetes/**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  flux-diff:
    name: Flux Diff
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      matrix:
        paths: ["kubernetes"]
        resources: ["helmrelease", "kustomization"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: pull

      - name: Checkout Default Branch
        uses: actions/checkout@v4
        with:
          ref: "${{ github.event.repository.default_branch }}"
          path: default

      - name: Diff Resources
        uses: docker://ghcr.io/allenporter/flux-local:v6.1.1
        with:
          args: >-
            diff ${{ matrix.resources }}
            --unified 6
            --path /github/workspace/pull/${{ matrix.paths }}/flux
            --path-orig /github/workspace/default/${{ matrix.paths }}/flux
            --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart"
            --limit-bytes 10000
            --all-namespaces
            --sources "thepatriots"
            --output-file diff.patch

      - name: Generate Diff
        id: diff
        run: |
          cat diff.patch
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat diff.patch >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - if: ${{ steps.diff.outputs.diff != '' }}
        name: Add comment
        uses: mshick/add-pr-comment@v2
        with:
          message-id: "${{ github.event.pull_request.number }}/${{ matrix.paths }}/${{ matrix.resources }}"
          message-failure: Diff was not successful
          message: |
            ```diff
            ${{ steps.diff.outputs.diff }}
            ```

File: ./.github/workflows/label-sync.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Label Sync"

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: [".github/labels.yaml"]

jobs:
  label-sync:
    name: Label Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Labels
        uses: EndBug/label-sync@v2
        with:
          config-file: .github/labels.yaml
          delete-other-labels: true

File: ./.github/workflows/labeler.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Labeler"

on:
  workflow_dispatch:
  pull_request_target:
    branches: ["main"]

jobs:
  labeler:
    name: Labeler
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Labeler
        uses: actions/labeler@v5
        with:
          configuration-path: .github/labeler.yaml

File: ./.github/release.yaml
changelog:
  exclude:
    authors:
      - renovate

File: ./.github/labels.yaml
---
# Area
- { name: "area/bootstrap",          color: "0e8a16" }
- { name: "area/github",             color: "0e8a16" }
- { name: "area/kubernetes",         color: "0e8a16" }
- { name: "area/taskfile",           color: "0e8a16" }
# Distro
- { name: "distro/talos",            color: "ffc300" }
# Renovate
- { name: "renovate/container",      color: "027fa0" }
- { name: "renovate/github-action",  color: "027fa0" }
- { name: "renovate/github-release", color: "027fa0" }
- { name: "renovate/helm",           color: "027fa0" }
# Semantic Type
- { name: "type/patch",              color: "ffec19" }
- { name: "type/minor",              color: "ff9800" }
- { name: "type/major",              color: "f6412d" }
- { name: "type/break",              color: "f6412d" }
# Uncategorized
- { name: "hold/upstream",           color: "ee0701" }

File: ./.github/labeler.yaml
---
area/bootstrap:
  - changed-files:
      - any-glob-to-any-file: bootstrap/**/*
area/github:
  - changed-files:
      - any-glob-to-any-file: .github/**/*
area/kubernetes:
  - changed-files:
      - any-glob-to-any-file: kubernetes/**/*
area/taskfile:
  - changed-files:
      - any-glob-to-any-file: .taskfiles/**/*
      - any-glob-to-any-file: Taskfile*

File: ./.github/tests/config-talos.yaml
---
skip_tests: true

boostrap_talos:
  schematic_id: "376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba"
bootstrap_node_network: 10.10.10.0/24
bootstrap_node_default_gateway: 10.10.10.1
bootstrap_node_inventory:
  - name: k8s-controller-0
    address: 10.10.10.100
    controller: true
    disk: fake
    mac_addr: fake
  - name: k8s-worker-0
    address: 10.10.10.101
    controller: false
    disk: fake
    mac_addr: fake
bootstrap_dns_servers: ["1.1.1.1", "1.0.0.1"]
bootstrap_ntp_servers: ["time.cloudflare.com"]
bootstrap_pod_network: 10.69.0.0/16
bootstrap_service_network: 10.96.0.0/16
bootstrap_controller_vip: 10.10.10.254
bootstrap_tls_sans: ["fake"]
bootstrap_sops_age_pubkey: $BOOTSTRAP_AGE_PUBLIC_KEY
bootstrap_bgp:
  enabled: false
bootstrap_github_address: https://github.com/onedr0p/cluster-template
bootstrap_github_branch: main
bootstrap_github_webhook_token: fake
bootstrap_cloudflare:
  enabled: true
  domain: fake
  token: take
  acme:
    email: fake@example.com
    production: false
  tunnel:
    account_id: fake
    id: fake
    secret: fake
    ingress_vip: 10.10.10.252
  ingress_vip: 10.10.10.251
  gateway_vip: 10.10.10.253

File: ./config.sample.yaml
---

#
# 1. (Required) Cluster details - Cluster represents the Kubernetes cluster layer and any additional customizations
#

# (Optional) Cluster name; affects Cilium and Talos
#   Default is "home-kubernetes"
bootstrap_cluster_name: ""

# (Required) Generated schematic id from https://factory.talos.dev/
bootstrap_schematic_id: ""

# (Required) The CIDR your nodes are on (e.g. 192.168.1.0/24)
bootstrap_node_network: ""

# (Required) Use only 1, 3 or more ODD number of controller nodes, recommended is 3
#   Worker nodes are optional
bootstrap_node_inventory: []
    # - name: ""            # (Required) Name of the node (must match [a-z0-9-\]+)
    #   address: ""         # (Optional) IP address of the node (Remove if node has a static DHCP reservation)
    #   controller: true    # (Required) Set to true if this is a controller node
    #   disk: ""            # (Required) Device path or serial number of the disk for this node (talosctl disks -n <ip> --insecure)
    #   mac_addr: ""        # (Required) MAC address of the NIC for this node (talosctl get links -n <ip> --insecure)
    #   schematic_id: ""    # (Optional) Override the 'bootstrap_schematic_id' with a node specific schematic ID from https://factory.talos.dev/
    #   mtu: ""             # (Optional) MTU for the NIC, default is 1500
    #   manifests:          # (Optional) Additional manifests to include after MachineConfig
    #     - extra.yaml      #            See: https://www.talos.dev/v1.7/reference/configuration/extensions/extensionserviceconfig/
    #   extension_services: # (Optional) Additional talhelper ExtensionServices (supports talenv.sops.yaml envsubst)
    #     - name: name
    #       configFiles:
    #         - content: |-
    #             ...
    #       mountPath: ...
    #       environment:
    #         - key=value
    # ...

# (Optional) The DNS servers to use for the cluster nodes.
#   Default is pulled from your DHCP server.
# If using a local DNS server make sure it meets the following requirements:
#   1. your nodes can reach it
#   2. it is configured to forward requests to a public DNS server
#   3. you are not force redirecting DNS requests to it - this will break cert generation over DNS01
# If using multiple DNS servers make sure they are setup the same way, there is no
#   guarantee that the first DNS server will always be used for every lookup.
bootstrap_dns_servers: []

# (Optional) The NTP servers to use for the cluster nodes.
#   Default is pulled from your DHCP server.
bootstrap_ntp_servers: []

# (Required) The pod CIDR for the cluster, this must NOT overlap with any
#   existing networks and is usually a /16 (64K IPs).
# If you want to use IPv6 check the advanced flags below and be aware of
# https://github.com/onedr0p/cluster-template/issues/1148
bootstrap_pod_network: "10.69.0.0/16"

# (Required) The service CIDR for the cluster, this must NOT overlap with any
#   existing networks and is usually a /16 (64K IPs).
# If you want to use IPv6 check the advanced flags below and be aware of
# https://github.com/onedr0p/cluster-template/issues/1148
bootstrap_service_network: "10.96.0.0/16"

# (Required) The IP address of the Kube API, choose an available IP in
#   your nodes host network that is NOT being used. This is announced over L2.
bootstrap_controller_vip: ""

# (Optional) Add additional SANs to the Kube API cert, this is useful
#   if you want to call the Kube API by hostname rather than IP
bootstrap_tls_sans: []

# (Optional) The default gateway for the nodes
#   Default is .1 which is derrived from bootstrap_node_network (e.g. 192.168.1.1)
bootstrap_node_default_gateway: ""

# (Optional) Add vlan tag to network master device, this is not needed if you tag ports on your switch with the VLAN
#   See: https://www.talos.dev/latest/advanced/advanced-networking/#vlans
bootstrap_vlan: ""

# (Required) Age Public Key (e.g. age1...)
# 1. Generate a new key with the following command:
#    > task sops:age-keygen
# 2. Copy the PUBLIC key and paste it below
bootstrap_sops_age_pubkey: ""

# (Optional) Use cilium BGP control plane when L2 announcements won't traverse VLAN network segments.
#   Needs a BGP capable router setup with the node IPs as peers.
#   See: https://docs.cilium.io/en/latest/network/bgp-control-plane/
bootstrap_bgp:
  enabled: false
  # (Optional) If using multiple BGP peers add them here.
  #   Default is .1 derrived from host_network: ['x.x.x.1']
  peers: []
  # (Required) Set the BGP Autonomous System Number for the router(s) and nodes.
  #   If these match, iBGP will be used. If not, eBGP will be used.
  peer_asn: ""   # Router(s) AS
  local_asn: ""  # Node(s) AS
  peer_port: 179 # BGP Port - default is TCP port 179
  # (Required) The advertised CIDR for the cluster, this must NOT overlap with any
  #   existing networks and is usually a /16 (64K IPs).
  # If you want to use IPv6 check the advanced flags below
  advertised_network: ""

# (Optional) Secureboot and TPM-based disk encryption
bootstrap_secureboot:
  # (Optional) Enable secureboot on UEFI systems. Not supported on x86 platforms in BIOS mode.
  #   See: https://www.talos.dev/latest/talos-guides/install/bare-metal-platforms/secureboot
  enabled: false
  # (Optional) Enable TPM-based disk encryption. Requires TPM 2.0
  #   See: https://www.talos.dev/v1.6/talos-guides/install/bare-metal-platforms/secureboot/#disk-encryption-with-tpm
  encrypt_disk_with_tpm: false

#
# 2. (Required) Flux details - Flux is used to manage the cluster configuration.
#

# (Required) GitHub repository URL
#   For a public repo use the 'https://' URL (e.g. "https://github.com/onedr0p/cluster-template.git")
#   For a private repo use the 'ssh://' URL (e.g. "ssh://git@github.com/onedr0p/cluster-template.git")
#     If using a private repo make sure to following the instructions with the 'bootstrap_github_private_key' option below.
bootstrap_github_address: ""

# (Required) GitHub repository branch
bootstrap_github_branch: "main"

# (Required) Token for GitHub push-based sync
# 1. Generate a new token with the following command:
#    > openssl rand -hex 16
# 2. Copy the token and paste it below
bootstrap_github_webhook_token: ""

# (Optional) Private key for Flux to access the GitHub repository
#   1. Generate a new key with the following command:
#      > ssh-keygen -t ecdsa -b 521 -C "github-deploy-key" -f github-deploy.key -q -P ""
#   2. Make sure to paste public key from "github-deploy.key.pub" into
#      the deploy keys section of your GitHub repository settings.
#   3. Uncomment and paste the private key below
#   4. Optionally set your repository on GitHub to private
# bootstrap_github_private_key: |
#   -----BEGIN OPENSSH PRIVATE KEY-----
#   ...
#   -----END OPENSSH PRIVATE KEY-----

#
# 3. (Optional) Cloudflare details - Cloudflare is used for DNS, TLS certificates and tunneling.
#

bootstrap_cloudflare:
  # (Required) Disable to manually setup and use a different DNS provider - setting this
  #   to false will not deploy a network namespace or the workloads contained within.
  enabled: true
  # (Required) Cloudflare Domain
  domain: ""
  # (Required) Cloudflare API Token (NOT API Key)
  #   1. Head over to Cloudflare and create a API Token by going to
  #      https://dash.cloudflare.com/profile/api-tokens
  #   2. Under the `API Tokens` section click the blue `Create Token` button.
  #   3. Click the blue `Use template` button for the `Edit zone DNS` template.
  #   4. Name your token something like `home-kubernetes`
  #   5. Under `Permissions`, click `+ Add More` and add each permission below:
  #      `Zone - DNS - Edit`
  #      `Account - Cloudflare Tunnel - Read`
  #   6. Limit the permissions to a specific account and zone resources.
  #   7. Click the blue `Continue to Summary` button and then the blue `Create Token` button.
  #   8. Copy the token and paste it below.
  token: ""
  # (Required) Optionals for Cloudflare Acme
  acme:
    # (Required) Any email you want to be associated with the ACME account (used for TLS certs via letsencrypt.org)
    email: ""
    # (Required) Use the ACME production server when requesting the wildcard certificate.
    #   By default the ACME staging server is used. This is to prevent being rate-limited.
    #   Update this option to `true` when you have verified the staging certificate
    #   works and then re-run `task configure` and push your changes to Github.
    production: false
  # (Required) Provide LAN access to the cluster ingresses for internal ingress classes
  # The Load balancer IP for internal ingress, choose an available IP
  #   in your nodes host network that is NOT being used. This is announced over L2.
  ingress_vip: ""
  # (Required) Gateway is used for providing DNS to your cluster on LAN
  # The Load balancer IP for k8s_gateway, choose an available IP
  #   in your nodes host network that is NOT being used. This is announced over L2.
  gateway_vip: ""
  # (Required) Options for Cloudflare Tunnel
  # There's two methods to create a tunnel, via the CLI or the Cloudflare dashboard.
  #   1. Authenticate cloudflared to your domain with the following command:
  #     > cloudflared tunnel login
  #   2. Create the tunnel with the following command:
  #     > cloudflared tunnel create k8s
  tunnel:
    # (Required) Get the Cloudflared Tunnel ID with the following command:
    #   > jq -r .TunnelID ~/.cloudflared/*.json
    id: ""
    # (Required) Get the Cloudflare Account ID with the following command:
    #   > jq -r .AccountTag ~/.cloudflared/*.json
    account_id: ""
    # (Required) Get the Cloudflared Tunnel Secret with the following command:
    #   > jq -r .TunnelSecret ~/.cloudflared/*.json
    secret: ""
    # (Required) Provide WAN access to the cluster ingresses for external ingress classes
    # The Load balancer IP for external ingress, choose an available IP
    #   in your nodes host network that is NOT being used. This is announced over L2.
    ingress_vip: ""

# (Optional) Feature gates are used to enable experimental features
# bootstrap_feature_gates:
#   # Enable Dual Stack IPv4 first
#   # IMPORTANT: I am looking for people to help maintain IPv6 support since I cannot test it.
#   #   Ref: https://github.com/onedr0p/cluster-template/issues/1148
#   # Keep in mind that Cilium does not currently support IPv6 L2 announcements.
#   dual_stack_ipv4_first: false

File: ./test-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: invoiceninja-db-backup
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: ceph-rbd

File: ./kubernetes/bootstrap/talos/talsecret.sops.yaml
cluster:
    id: ENC[AES256_GCM,data:L3lu0hLGk7yhUAHNsX+6XEUd6eH7h1ZJQ88YGFCCCj0d0hLGhznkwjtZEDw=,iv:x4YiCaxw9MXXIRP6tmAl5sBWOH4ZNC4MEe52SXp4ots=,tag:vAR5q85XWYr56k6WRAv/Ig==,type:str]
    secret: ENC[AES256_GCM,data:IYAyv6+5JNx8DTg1p8jgxIJg5LJcay75gEGyMPHKGqx2MpekkcbSry9Kixg=,iv:VhuIDf+WU08Vxtke8cktRF4LWR9BJhoim8pSzVEfgL0=,tag:/IsgvLeRmafE1Z89zJkHSw==,type:str]
secrets:
    bootstraptoken: ENC[AES256_GCM,data:ArDtUCBrL6c6TNvHT9FFMpURgA1OoGI=,iv:vHhyRU7pN7di8eNbcisSgjK4/0KahWU2eso1ckiQOHE=,tag:ZzDavAIS9zGOmYiSC2ICOw==,type:str]
    secretboxencryptionsecret: ENC[AES256_GCM,data:8/C31jkGwOjHPcC0257Gmu2cTQO/oEENnDmrSLv6HUiTyWE67YWvABVD3ME=,iv:F+w1TTfc0EOXvpuFATXA6b5z1ZHyApxhcnYGq/r0YUs=,tag:blh3trKEn8j8c07Rzl5+NA==,type:str]
trustdinfo:
    token: ENC[AES256_GCM,data:5KB7dj9Rf+BLq0vytnmzouprq+k0v3c=,iv:K4NgtSOv2OeCphhqCzO+iCPP2ZcrhMN6qoeVBBfaDLs=,tag:cJN2BhL4tGY69muwu5nVCA==,type:str]
certs:
    etcd:
        crt: ENC[AES256_GCM,data:N17fLr5iE9p/jXK0egoVeGHLE+Ujwr6Oo+Q/SXw6PXcq+eu1pHFJaj1/qtHBTZvUWr2qp8gs4yghddjdAmMYOVf3RGA0/+oRasTXzbnw5vRYjEyPCbIHRO7Wx6vRVttcVOUCWEvlLxod66A011cPU1ChzLRQrRy8EOEJdaC2XaD/24rCdMhlazWPLeeKtNQ48VUy/Nbz8jfaDr55bmCYyIVw44kTR30RUVE8WQvDy0oQLNmDeQsT2vRh5oyQ9kbKWeFkYDzfiFGGHllgHch2B4Hx9FNO1MinMZaHkho/FAPwxfbYelxFf1KCDFHj4wP/zTsrpcCBV1OM9Duu8Zz7DFxEFj5MZeyVlq6KjuqTi04r/XE7c0EyCaFv18qKkpQkx2mEEcz+vbMEozp9+Y9gMFJ4P46GN1NqqBP+KaPVviZ3FrnR4Ns9wgRcSDTQiYtQEnWdxEb6G8loAzFtjCHcPdKWG6t4zVRGww+BAglp7RZOTjgVh6Bg8W3EaygRvZjtlwTCc5UBmT2WDXeU4BOpTb3rht8XhYsBfb6NAzW6RxVN1pHR4GQvpEPDfrkefTZdGLq3CykjBocV2OIB05JBv7RbAklSY1vPRkVynqGLzwah65RY78zRYoTkZ34zlbS6rIeZdUY9pbhhzSlhTY4rwJQskKAunkn1rLwmkv6bqBPrSb5VbnkDQRRd2/y6tu1Eh0qDon23ySc/aOZp8lUM3oqRnzgZjwFNKABWUawYE44XBoQjzyS+o0+4maq68O/LwZ1ouHU/j6piJ/xXrZhTNZpNxz8gn0mdXOwMwuDtC6i5RgDzVN5qHLcbIoVi8FKrsoLLFgm1N+sxuXUu6E+noVXHGpuIflmQvYHw+H48OGRn4ADeBK4mN2lxUfZ22ZQl3rKC6JQhENyuaz4WnQIvCxDbCPEVKNUzls9g2TsUv/9L0XwtUoQM6cA/avMWqTTdDvGD6JkcAFZFEiq4Ni7RIogdOFGXlWxGmgLdR5d27NKemNQA4LlSugLKyaf8EDxLCOiSLg==,iv:2pGS3sIo995KEEshqPUWP1JUnlBrCeX2uleRuW8SRr0=,tag:L/h9+I3+SiJa84pSTZRmdA==,type:str]
        key: ENC[AES256_GCM,data:hDUmJcOfsI9YPt3J6Xn1icIgQUxGULiu3fpGIk6k+fT3pl4HdNzPdB4yCCkMkjf3yK7cltZyTQT9RK1lymYInbesLqlr6MmwN2Z7AwN67BuLjInqKSeZ8gQWfd/QfY80irZmIhPW9zOLb5m3rGQeyFN5zNzZVbSS2+76mr2La2LFmcNDtnRzPiPMhdTeK7r7EORNu09eCF3Fy74RVg47WIbDBfc+WFUf/SOdBk/6v2d5AvONt0svRLQtBCSDhKgUw6bvo6+ZZHN+owSCFDs/1MIvEstxEL0EBQbJbCy8U+P/OXiSDRRgqQJLOXBNyp3P38TJhZ8/FQYsawfqQvSuBe60g/Oh1ZN6fDhcsT5Amg83auZN0TLnyCsZwa6KEMuYmA1ZThIGdBkxUQ9hZTYX8w==,iv:ymUYVMdAvMR39GmziQm0PWIK0lIoVrV76xmWJYxnA5g=,tag:S/4Z1TJNakAJPLyp6GX5gw==,type:str]
    k8s:
        crt: ENC[AES256_GCM,data:SHCvXHRB3WuTI2bNnJJnjHAK8SVh8Wc9NHucd0XNWbJbIkoBB31AKaBSAkxD0cpRN8gaUdpYOtHCNZxV5gDLE/8XDiDtPguwLoDMTsIMyxyfO9rvNhwrHHRC/V1Cf/dVDYylNbW0I8OCasUOEZ4sxF8DlaCUxGnhSaMnFyVWgp+XYBz/DiqHYFDVtYNMcZvOc87BLsNvpVYrf2H8CYSNflOHNNcmKcEsOYngqN8qxxsXuvmScqi4CLpSo3YRESVa2Jh6joCbudF30tVMOraD37CbB5EpeKp0BQvRg/ecGqz70rPGiOqcv5oNERCZM0LBbVMQHWMKYohvO7yMd9H/86HFtQsBZSGuwEFrbvJGUeDs3HaWxCuDJRa8DXssnLhpK8KQyhbjbhA8ZrUVRGEpDH9fgfuGJ66eOhR6Ck6tKHWm/iEhbu4YpV7SDzNzMtGen0hYtOO6OCo0QOd59StKAZTILncG4BAn8aEtR2/R6qBy/hXdcyyv6T6b0HQdtNNJDf2HuLTSqEIDb7AdhMOaOAEiy1HlB17JLgP6fQjpRn6T5Gt1HS0mhFrnA/jFXsvAbwPQ2bK0ZlKwTucku1VvbJNgruESEWFogpX57GrnCAGyteweXc3j3LN6q5Lq1ypLiOZZYhqjl28yycExcHO8s2rsb4Szba5d92ChpHINgpfuASBG0iFtVWX7z5SMVEizsk2yhkGZwCvVB5ATq1+T2gvKxXDKKq+cs1LgcrElCoWu/FiVEeNNIXfOxCMc3awH9C+eyFctRJI8EdpTph05fELVDVeCVzdQDjfv0A6QCUAOXKB8bPHWLKqieQa5wWxYnQbLX6ARivabT/qYdYFo+bH/OL0sp793hZtK3NXp8rGzq1hSxao1710hb1mL7Dth7iCT/ZEXNTk8AlKmuZ2ZLpa4G6sVMB9BomjeCdw0gr0xz1AuMyBBwIuwnytTf/EumJyxt5HjkyBQf4GElujgTl1JcPl3XsDhhL1fJn6mmUE1MjNlLykrz0fB1Z6bIS4RzpbV0s8Z3U8YpkNQWuzzoZmKjvFbO3xsVVL+UQ==,iv:d3VxIw4HjOhR9lA7ghjw653vQNqg8kYqt/BWSjyH5yE=,tag:4stKpNuHMB1Ay6NoYyeFvw==,type:str]
        key: ENC[AES256_GCM,data:jZM1USX03/Mzt0teQQO+qhuu50z0H1iZ2njR811gce7gWcfg4VFOj69JadyWhLeZjxpP8Z8aAI9lTzIHyKFgvQh37FZEDOXR0CAlEa9Vk6AOMS/3blV8ZLNAj9lEUfRHCvE9o0wVCXA05ELyIT/j8fHt4sb7qbo47dh+fjT5V+y8tR3zkCPKL9lc43/wF4x4izVBAeLY1xKRrFLOa1vN9+Uzm38tqAsgoBXI02fFdq8M64lgQZB1LbzkhIv0ekXIjPlE5tsEWFlJMtlDr0jxJZ8smwjWxuy7pd5CVNlvigqJWVdMbmuGuYCN2m32t6Xrz8X/SeFzPB6Sbq1WjQ4sGTzfMJDXNJsBJagVQ0WLIF7b7yveFEqhXh87s/cN3iLLyTxZ6o5aAT1l3HNh4c5pNw==,iv:J3bPHA5XgSXbu4m73IaHK4NZ/oOAF8Y/lqSw4bEFk0U=,tag:yyUGWfApIAop8nryZWD0Uw==,type:str]
    k8saggregator:
        crt: ENC[AES256_GCM,data:amfcAOFZjMz9/8wsZ92sDzx5vURQSMk+wZI/ToElC0Z/gdU1e0cKE6O9teVa/9uz4Vb62vYJ7IjfDtmcv9PES1qowMvSSt3kFrZo8ask4ipGy2z/1Q6Zazjo/E/gT0EQhIh791vetpFEl8PK85uJJhRLX80e58s1MS/RVpL9WU+cMh6sRvBthMSeOFeiJGlVi58f7fpNjYalw0VtTfh+GnQ1qL3LysWEP0jdNcgGCjcwAYlvZiSgdf+ehEepHZhaS6iM/nR1AHma7/H9pOgTG/wIyyCyNbgveKolYSo3eCU/ErDyWhP0QUZ+01a4IoyD2ADsx8XeeKzSPIn+7XJm2IrqCoeZDTZT5BjUfn4HV6MEBNgX5WKjWgTmiYey+0hS2Ni+CCQru8pKOAjbiFtlFa5+LO9IPzGnI/iTW75gR1wLSQyEHpufOA/0nxU396E1g+LWhucswYLe+YugDWE914xP4JRTf0W867W8/2A7sGpiNKo3cz9RTR4eZr3vmzs8VhcIwC5dV6/zEi4AMeEWkyWSqL4nZM9yA/y61ZS0UcON1n0IBoMkh8TAg/bzEwqu90IpUnGrFiQvuOI38U32Mt/1qupr153cauwOWmPD2aC273EKb9MHRcOfJvonBpDJ4Ph2GMkpN5To1sjf8KIja+BEoXFBg+Kxw8xDLvQpSNTGhTBYFMAnv6KACHUzK5F+F3GJTgSNA7a0DBRWq+c81qAXVJMdm69ss9o9zd88pmPk/5aTDxmGimwSJzm9KgtWwnGd+vFslHVEH2PjZQuZJqk8FdAuiNlbbeBnnwcff9EWhAKpUqJjR+vJwVmZ80i4wejCQYYFXexwWH/smmUPa4gYoIWFd3kZ6xfXJA8PtXScFpqqIHFEd7RKHROsI4hj4DwY5F8JKsToGaw3NpwGvoa7Lsdy8GI+OxD1SVuyiB8lnrj77oHBHq8h33BeH+8a,iv:vl/xwqVyPA/9NDCivBCB+wueGN+DhapdGyjKLzIQ7go=,tag:MjwKSBd6ZrgEMVHeEFrsJg==,type:str]
        key: ENC[AES256_GCM,data:Q578GKMV+zI3X97yw3lQSiA9Dv/2G52fBR1VtQ6ZnyXh46oDHE1gcshU4j8TImgbRrE3UHDHmrtJ8CUK1Xv8MbClJr7PR8bUE7t1DS/unsgVzIpBtx6ad8aet52Ra/RiCrqklCBJD7somyYGgrgNdYd0x3IisAvK0TqnPUK5F42YgEhjObjBc5XkRU0lmrAgSPgRHJ8ybUmdDm+QK1+M1jmxY6swzpa/qtphEfmGKN1XKnPdbZ9gYZSDfIwDLwT1CWk9Y9873wOXBOyns/2n4pEyMY55MiTxO5CmTBmNLHwLlhEFDlzrZ9Gp3GooDbp//FYGr4/GoYobbX8uatzqoWDn6zaVSoN49oQ3NM4hb1SLDxJaf3W9W7zmNVuLMu9FCCvZhVRG+81ZyFbBYNpXnA==,iv:K5b4YvmLm1/tDN6IuwM4j9zHXM0Gxn4ImUZzwE2D7dI=,tag:42vNHBYQq0VtKnudfkLUrQ==,type:str]
    k8sserviceaccount:
        key: ENC[AES256_GCM,data:Gy8CJLqV9taHwmTZDVZZu6V2qNYBwkBxL94aGq8HS71Vn28VsHy2TxwOkxi+lhNlASzmsbG7eTNfbqiH4K6+z7rcyrhOkRzsyoJd7zS/+OHmo/M5m7wVfDq5jv9K95PmKug0Uu9Kbpe0/oDwkuPADNC2nqQ/sFgFHBCpbtb9FkvmYJLdhGlhH/iCynBV7QDibeD8fuSDYHSeoXf7Buss+KEq37xTbQMkEUvrL4bLON5WaTetqFAyBIvFbyOA/8oTQPYvMgPVjRbUtzN7QCukBktw740tFIOaiI2hRtBnQHPN5hpjC8y3X1TmVhlqhf8jBoSMeLvKTtNy5ePaoG83aOV1xExhlBezZCvYD/kBJdqpudHtUMvTq7ILNwV+BIht7NATz9aGWC0ThvDhaKUXiePwZK7Pjozxhb447xbSXeqie45cRwMaPUrrVjXlus8QYR3AQSEuDWML402JqPGHJCZIBp3gKdAxcbOB3GSKQVFW/nH7n/rOJrum888In92eHSCWGEGxzA++UdRhTk8EKQo0lkiOJ/Jk3hrDUHyS9bqq3Dzp9Nebzi+1oEq/8IOFvCJ3PanC6Rq/7NFpmJDWO0mQGARDZscqB5162Z21dnf2A7dYMv9wMnVmFoKsONPizCqAOKCnnwt6I7Rrbh8Q+HizINh7BnafH2cVG4LryZ+zRPbS0xDIz6mu04jGU7nRy/ooTLKNciI7mgKFPlQIStrGt4x5ef3Y/0tyRYPxvSfYuw+ZryxvBQIu3RKjQhJD7GvRCDfxNPEu3qkBrEf1IZWQD9rdz7uq2CdHG5kgr9f0iZrGgZzouSQKOK6xjt+Mzw5GOhF16zoCZ5xpWbGFym514tUrqMzt+vzjbmmWqSNVzT/H+m0fvjv95prbIf08nCIU3ybM9SSaZ+TT4Blg3aU4CDAGuq/JUPCiQXneZvWJf6fdjsQO0GT9rnIY6FDRsUyaOgIfNFiqCZgPXhvq7EFDYPmUJ/M6s+lOGfuFBVjhwe3OBBeJl9RR6yAFKAww2Bucb539zYaJgYdzkmcwT1J9ZFZFYWfKWzT+NDbyVpQR0wpoMQkOVA7prg4JTIxvMvzzoJKo2oYnYawawb2sTEbGE9FPdX71bYQtoZQs0E+8O7ey9u3g8G4oyqfQ6c1FAgsA5YQ8qz7/kuGLQDN5vJJhy122DR6hnIzZUFscyzv0s1XixL/xUDjf+rdg9krFfHgM40+RXSGvsoiUxhLNoq/3R8cflEriJ74ChTCsGdsIU/LUSAFpc0TPQbRGJM+dmJl+zuOvtapcyDG7RlQd9Pf2K4OECp8CvHnZ3LJv1pvRPZ46bE+12bbWy2EcgR1APg6BW6Y2UcnqyvucZUPmnau/BfEv2jL3o4eWpSOuG042cKFrE0GtkerK57geB6VG7pmdjjjy2qqK0oNn30/Deqmt2JMb3mtdI5D05wSFXJNoq/eUHExGzYXKlqcMKhelK7zZ/mftftveqGTv8Z9mG6FpUHVp2SKRRDblpqepfdJsKN8mWgrE8vPMr4wknXJ86kWcsgUpVhg1JFkA69uhjaVhMZyeLup9C2ZmEEqnOCfg8WkoO+KsEOiQCHScDsjV/Xgl2ympOpXwDx4qYkeYRdN3i52r6zdLI8j0Zkpu5pAovRb5F9+lY+YCHor2ufdnStD4lAMXI9E7wJr/2YAhHz3gysdvIB68xtNaQ0ILL4LGQV4g3QFu633JY5vZmJ8iCveiVAx1qnBpUv/h7rMmO9D0Yiq7s9AFlHvywa2JMWmU14xXLnIdyjFNUDFCqhNqa0JKY3gVoulkUpPh1v8REMNYfUibySu6wRnmpNn4swsNQuaRbwy5s2eVeBWajKWew83zX9aK+M5NLbQrIHdKDZXtHn6rxFCj7JmPeI+haC7ws2WOfhbc43m5mVuxL2CuJf5OCkixw5d1CUqSTA2wNqGccsg2wLmSLYbNngmQVWW1iIvkMk0vFkoLBtVZRqRyR8qH29SaSXhMw/Eh4p2UcfwUiUtyHCLUxomoo2WvFpHtFKPy1tlEeNbmkq9w/8dvrgViODjol0u7wzZPjtvOnH2S8rjWFAi/jPViYbp6SxLFr6bJ17gom1ANUAQ+97/OroCuYvZk9nEIHPUeaRpcWLuPFugmiabz4l6tmB52RE+w5hRLMg+oHFfj9R+beHMNKNIoTAyfWeMJv1C162r5bLTaKkGfCU9oiK6elSpNmHvzHjzV7EWuZrQaRrh6bM9WytvdOoDeJ6LVyXrdSlbZzMt6Cl0XET76DKh4W8Ioh4374/R5NvW/K7saWx2P3mDxS0PlLcBOgAZ+dYG/03rugghShSvEuYTsQeCKAloNR7oFhnpkm7pBcUXiiKRnPilRdRVC+uAq3RwWDerXiHSWSs5d3xpkUv+uLonU8ar90dWcJW8Rppb1k3jttdDx0+3fvqcEBWhmJnto+S++Ijx0OCSQCYSEBkCPRZKayjm/o/uAtV7q4+zcTvt6xIqIluUWXI7yR5VhkuR7Gg3+6T9Jp0q7hspsjuqQj+w0VuhF8YccKlKBmzkt1yCw/WaH1WKHffWRDJ82pxEU2tTV1j5HbBa+4F6JXZVFJU/lgA3ddxJF1/mvgsI0k10TUx1EFiH1d9Lkn7TG7M5hZeJewnxJuALXQ5aALcnNXeZ58iwZr++STsCyki6T5Wfa7MnTlN2mnMuGwnsR9jzgd1FZ458rRoWtpz4e67GqelLnwynDqAco8KL9GdWR1/FbuaKrrAZjQyqi2uRXpsCSdQCfhffuApPLx5+CJvsvMeK+qR40ffPD9yry1Q2wmU9kpdALgfDYXQoIIIzwwZc0CPYagBt+W+UE1cWyER7/ChPxp8zNemTApXHwz/sHbfp+ujgtoUZGrnVvRy1nAf4yuf0IUsJm/CeevEf3zM4bstIp4DFOU2xzHWbWMoKf1DeEneESKOEsrJaEFnPGtjecmjo+BhroHq29MJducigk177+WxCJF4OgzvnazIbmRvU2cKHy+h8ISj3PD2Mk3iwvB3FiRzWxc75EbLV6PHY+1rvyNBbpWTjJ47XkqPg8pZeuXVHYWaqapQn3OOX/yDuqTpDI3N+x83DuggOvBDYLvMaRi1NaQqA32kgG4T6fcFFmihXI26ftfxipDO7Ak8QCAEPxH1SADPnM8hfKGIGDFc0xs9FDiMrQibM6rTgW/qzmLw2g1uZg9aVhXXe/3+yNZkpze1K5Qe2wFkAOsiaTkVF82AmFJvAT0TElrpRnnF4RHV0cZu6Z/JTDrMQ7kkeLpzlqe3Bhpg4l8qI4u30m0+R5ei/NHSxkegxMuLwqS9m77UHWRqlou4c6a+Y9t0O4ic6peOBJIEYqHr5fJNS3/hSFoGHEGDkPDMk+YiW8rMBwRCkcBktx6zAWq90SMpbDnCCzBWNVou9NcY3Hk/2YKHeDGRUoLVtfHsW11x3AX1SFtStT13/PoQ2rLl7MbGXTFZ7+YsQK0jsaWGfTdu0S+rBuGtph4XP7x3BLw2ZF0XeYg0oPBaj8rziWnKGcRxcXEgrJa6/WkrGXBn4J4tKnxPaYVHUaPvpYSNsoBpSylYG8muhKHhvJnYHV7nNYXlo36H6i3qDESjORL/fLLny7dOM77mYR6N3H9OiVeJtvgeQIu3prf6+gW2B5O7c2Y+SKxdqj8odwT5plcUVgsD1gfp49C0GWMB7rM3aX72ZLprdXH/zrJEaLyoGdnw42i9UJknnqywxCj7UZXi+qzJcAdpeLm2+YsTFwd/+k+NoPzeEkNIQhDejEBgOdFh9eSM7ww8Dq6ccBdQqsxraevWGby98dqIPL4GSrFOnjOM0ZPHlE/LpG1qHklHceSeKvNKreWRVd9ntJD7/WQHlN9U7nNd2Va7XPQ2kbrlaWbagZkLOe7DZZbZ5sZpcBQZCK5foT+7fXDZ8VE7nGaZ8bQNPzu0tusd+art8ppjaLorRJiYEe8lHpJMfj8D6fq/zFtbCaqs++LRoDIL5yBA6+mwGLO4bk/PuZFE1yDlAHrDxfvwZIpXGnWlhzkDJNzbhxe3SSUFgajuCfLrkQgxVwT3am5DzkOfyQO0S3StygWagTm/SDLGCHjZ6CDh83liudMOW3jDNI7JS8BlSax3QxKgyTD8ekbN6EslISnNtq3NSWCFchIxbuj48gYxOxAQ1WRPyGLg7RXXNJFrcve5dx5kV6aIjrYAhDm2FATvXMM91yTEvLS/OWkBa4EQhCZOrbwhZy9Qy5m/9OXzU6Yds5EV/7BbsnvohvASrmtNFk1EnpM+egMdqfiu1JKOAv4uXCL/lKHGYyHq/mAf2Jo8GVQM/zEaXhxpHann/GCBwFNNngQTI73J44i/F9umGFEZDtvOPI2Ne5w46lCLAQeu/kqj2qvTrY5GrMeeSofpcgqrVJEFO6WXFe0dLm3Y3GCdk39S+3fdJ3aj6A0F/f5sQRqxJ/F718/eweiTeUBLpSrOX9iK9Ng4zexQyIKwerukHMlfRTfcOzsHE1sRnxe3w09AOrJNC/S6jBYGXzziOWl347HfP8MC1sYSgKbM/57Gou+J59sTRTC2law0VAb9tyNVBfaKqKNUMrXrJeD8Vau3H/VCwype+yA21sbDo03Wz1jGOukQde+6FACqUyR1UndLpGNrjfNwYX09GskM0MlehKNbZTMF0HuBEFxrcVJbNDQ3r29ppzYZxw/Fbdf9gEBz7iwZlbN4QXhSyMzFJgT2D3+yyoQNFiCgWOBQFa0RH5AH/SS4DaEVWTapj6bPdVBeUMYiiXztu3lTYPmZ8dY6xLJlRpQbNTArfpVYuT0lmULg2tmsz1s5ZiaHEHEo1syCEzJf98WoHEqo94BgjlLjXo4XFS25hl2j/lqlu+GRFxJ8fU+ubd7yxQ+QYAO5/HoLQpdE3L2KXmdwslDEBiwpT6fg8wbL8lw1E4p7WdNIxbeztLNxBORljVS03hF9ajUrdfWmiZzhzKN5Czd11QznrlPte7E6S9tO4i9HZPI0kinqnGJhDFj4gr1NGgNOF1ksLZhs4gTjGX4WAyUtecoP7mcD7jsRr9VteACDhrC0/gBMYzYpkCb1HJkLVPFcqc5fp+MlSy8I2HmcU1zl4IHYKzqh3TS+UGX6RdBtMnmkPLHFyZ9DjmgDrHfIoKJDfWB9VgUyNhekJL3a6yQzwMJK7YEnSn1SCbEzKN+tVRf20ZnuTB+QsNbEIz+1Mv5VlvnqCmllhe0ZQu4QjdiaT0i4ZOAWu5MNZeDT4zsEieZ94+Jw8D8IbA3rqS2f1L2iZza0ELfmn/uOiTJID3wGTjy67mKcUIKAyD9QG++6CAs7/zXg7/rf5PvZ97wt4UyQZol/AUeflB7yb8ejkUj7PAa3bD5v422/Ba4OmA9UVuNKJJMs//390bgM7oJ6qfjYCawCyqxtoYObcySMdCD4g6/zjv9bwJtOcEI/ffwE9nfQmQjbbocJU0jyPY+sPln4dladc6Rbm5Jp227Pl6rMYJL/ThvZneQntp1uo4VdtMOecAz/BkptA+c0VTpeJmI4f20+uE8jIBpc1fipG7N7w9k77WsIKFnxzYfBaWnbE1/1q95ocPPo/5fVN+b6BbRtlM5I4tNInw7mAJYDTE+M3gQDe6+wpNqghrJTkS6imkhfgdHWEBOWvWjA0BzrCgUSDEL+pLcOXLWmKH3VWWvdckq9TfVgdb4XtE4vMtxYH/8cF2Sh6W3DigYCiC4AzbZKYGWOgafFC4wY/l9pNxtaSDPZ8ccM+wK8iR8Tx9ijaAQA==,iv:Hy/Pc+IZ60tTgqdx5Wb4t9pO0+OiON0Bgg1MdnFUJ+o=,tag:fLD/RDwTN5Eut42IPsg4Ng==,type:str]
    os:
        crt: ENC[AES256_GCM,data:D6l/Wmq9zfheFTyFRKgi7njhLwvFwkQRWw8B3BQ6in5juRNtgBvY9Mu+URDa9OicyqzZGa57iR11FPw6IHXKqiMS/PcA2vMNr06umluYFsFKm+4SXNUcp6NOhny9ykVhQO2u80nXt/vLb4wFN7LKzzPMTNXRXvIRrGDWNZCF/CsZWpwtzMgnUHcHj9kZKGm+fys9OsSceZ8E3SdS3EMqkdLb2zQzkNoIgoAgKQmeqwYgzcK0IuerG6rktRNdBucYK/F6p/v60Gv60N4NiDuv8j2wwKM1uIRUur+1mRLngOF09qzYABxbEz4U1jlqjt4T5sJdG4/DlguUPsA5gR4zX0n7HykX/F+sShmnpWzm5/HiTUtEPEQc7Ltbf6Pb1nG8s/kBZJEQeN9Zooyc9qR5Iu+gS++FQcD/bPT+Ekjo6D1BlQ5VcamB9X0awXIsdAO308Dvd379jQtfwH8sGXIlzGDh25NsRhWvVFQDGzixbRDCbDRUMJdZZMzC649fEavCIEev8+BTPGyESEXL7A6hmgo6ygIZcAU/ymXP0gA5LonItKSqQ7CO1vQAKn5rni6+y+dzZ59flde50L7CwiV6zahKkYl/bIO/v8MP8D/5rVEGmsbtOZMeA/8KibNh2tZRArUqxnYkfuRhg0JJklnpRNMnlr8Wj0tBXbAbt3BG0NPtS6c5tu1Kvzz43VZPj9rc9vAk6dD+IxkpnjLIc2JFlROYu0eTlZaNM+K/Tb4+O3Bh8VYeaCTASRPm9J5XAxTlWt1ObzbgxQEMLA37JLfFQ29FeydRvJvlzdVqmM1vEgAZhk8mi+3SS7vt2NE0NF0eDefmOw3fpcqeZtWkkiAl1yxkFyeDCzitkF81k2iYXf042HDg,iv:auWTqdxts27l8pogC49ZwGF1qaxYE7KvyDYKps2yciM=,tag:KFaJSQxG4PlrXS4BkxHXnQ==,type:str]
        key: ENC[AES256_GCM,data:NkwuekklJjRHgbNXE5S/O950pJQgoAK7dJQ+P1nOOhngFR5Pfpc/OX7/YBYnUW0wdeFG+Ps0auJ01Rshh2FAgtqCM5d3gVvoEeoDL+DZhyptJW0k4ioV4HCluwMqM249qE/Al+tjhZ8Er3hxwVSvDQEoT+zo9kx9pX62yd9i9LeONcGKQDvy793NjJsNWC3KlML9ncc9qsVNjaY4wtFUeaU3Mie+LuZgAMEpMzGsw+k4C+dW,iv:zGUMcVowFWf2pLBC8JRQCenaZq2GuDKglxrgN+oB1IU=,tag:yIn+rEe4dHhHOBGiLTI6Ww==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBubk5xVVpSOVJJTHJUMERP
            SU9pREtOcnIrVWRqcFliUXpVSEhuMVVoRnp3CnVVSFp4SG5XbFVraHVxWDVkVXFD
            U0lMU2pBYnJxZlZ3c1N6d1NraFZZeG8KLS0tIEpmZ0t2bWQzSENSaEcwRlhJZ2xt
            TWVYNnNaTzhtYjRscXY5REJxNXpkdU0KV51yi9TcEpPPTNQnoF38kVl5Za8QiUCb
            jQ+L1AGq+xOn+xVhMYrqDzJ5FtmtKMdoSkobF9iLw2SONVru8gYc5A==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-07-31T21:14:19Z"
    mac: ENC[AES256_GCM,data:HuhW8jYAH+oq89L8SWpdsKiDhdEWlYt/6NMRAAvJGu7I/NlPwezPTCKa1P6QNUcxNlecIRVY6t04nPBasziVlYIY1/1FpvPsE149k7yr0jcFouRe0XswLtFX3poDlEVpveEXzi+dyTv3eyNrKK2vJ/Ttl19EjridNdj1bAEk32I=,iv:9r20mJj5fcARPcn0V2WpNN++B04pwXtds8cEt38qfzw=,tag:54fkoWhYlyTZnIGTnNc68Q==,type:str]
    pgp: []
    unencrypted_suffix: _unencrypted
    version: 3.9.0

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kcp113tr.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: controlplane
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0KTUM0Q0FRQXdCUVlESzJWd0JDSUVJTFZ4L2p5N0lpZGFlMHpoTlhMQkZFYmRoNUNGZ3VUS3dNK0IwSVV6Z3MwbwotLS0tLUVORCBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0K
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.12.0/20
    disableManifestsDirectory: true
  network:
    hostname: kcp113tr
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.113/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx027ce94bfbb6
          mode: active-backup
        mtu: 1500
        vip:
          ip: 10.10.12.105
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.5
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - system-upgrade
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  clusterName: thepatriots
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  secretboxEncryptionSecret: qHwgxRuYyLn7d9cK4GePMjlrds7VrCzavxjTVEthc3I=
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU1ZekhKVFhoRHlVaWVPaWFOdXB4VEwybFd0LzJza2Z4TWpiK3d2a0pQcmtvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFOGxScDRBNDdhcG9tN2lPaGhFTzdyanlJeWptMDVtZm5LSWpReTFwSkxlZWlKbTB2cEQxQgpXbVlnMUZqUGVwK1VZWG9jWlNmYjluaVJxYWNMd3UrR1NBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  aggregatorCA:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJZRENDQVFhZ0F3SUJBZ0lSQVB0V2FRWWp3Qk9BL01qM1hNTnNKQ2N3Q2dZSUtvWkl6ajBFQXdJd0FEQWUKRncweU5EQTNNekV5TVRFME1UaGFGdzB6TkRBM01qa3lNVEUwTVRoYU1BQXdXVEFUQmdjcWhrak9QUUlCQmdncQpoa2pPUFFNQkJ3TkNBQVNEZmQzc2FUeDlLNGxxZXhodFRuZGpNejBicnFtUXArKzFRVVUwNkFQZDk0Z09QRDNEClNUTzZhVkxWZGJTS0gxRjk5MXpzb0hoWGFhVHFaR0N4cmNWd28yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXcKSFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4dwpIUVlEVlIwT0JCWUVGRU11S2kxRm9MNVN3N3RpdkcxQjd0YUVlN2dGTUFvR0NDcUdTTTQ5QkFNQ0EwZ0FNRVVDCklHSm1tMGRqMFE1RFJtamZ3dlhyajhCaGhPYkNxaTMrdFBMOTNuNVkrUE5WQWlFQXN0bnpERXh0blhkb0l6VjEKRlpaY0pNdnpYQTFjSk1UK3FBaWlmbGlLWEowPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUxMdnhQeXdwd0JYT0FtY2VlOEZJaDdWSzd0TEZZOHNLOHdKckt0TXBUZE1vQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFZzMzZDdHazhmU3VKYW5zWWJVNTNZek05RzY2cGtLZnZ0VUZGTk9nRDNmZUlEanc5dzBregp1bWxTMVhXMGloOVJmZmRjN0tCNFYybWs2bVJnc2EzRmNBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  serviceAccount:
    key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBeE5CS0ZpSEhvVDN5bHZyODErZXFPVmdIU3BLYitFRnJ2MmlNcUt2OHFBQlhscUd3CnFaR2g5TnhPRzVVMTRoYTJlc2JySk1HV016MFdSUFg0RUtvaVRJWkZsYk16Qlk4UEpwQnhpUEJueGlWRWpMUHEKZ2hTSUIwaC9FYVg3bGNFOURRcWV0Y3VvNVRYdG45M1E0bE1VdFI1OHVZYXV5M2RXa3FFa0JwUHAwa3huM1VsdAptS3pqb0lmZzlxNkRWWmtVQlZoLzAvNCs0bFdweW9JSHpLOUdDbU5NOFk4blBENTVtL09ZQVNlMGJUdkFyUnRKClZzWjZCRWdpUFdYV042NlJwSVFtVVdId2xFTDIyNkxGSG12RzhzZDlYQ25lZjdFQkZibk1CL3U5eXYwQjhLQWkKRmJjWHk5eXFQaUdnWk5aT0pxK1k1dEZSQjgyeUNWZjQzTnpSRzNWMnRUSUFnL2NUZjBBdW1jcGxzYzZKZXE3SApicUsyKzg0ek1YWEFkTGJqVFFHaXNnUGt6aTV3M0pGU24wRk1WeUZGYU9KYlFUbWNicmp3cEdPci8yb1RZUkFZCmRjK3JNcVhhVWNqb0ZudzEwbWkwb01LY2czcWhueko1bk1Sa1IxSTJlU0poVXZDZVlYRW05Uk9Teit1OWwra2wKekQyQmN6RUNRODNWRkRoZ3ZRYjIxUUVUR3N4Z3NEVVhHcEc1bUxabDlwbmdkOE55RnBWQzd2ODM1RnI1b2s5TwpiT1pJUlVTb1VVMlZDMjFCeGVDeDUxN1FNRXpKdDEzKzdMRDVYUW9kZVRaSGVOWGtCejI1ZTRIL2ZCTW9sQ0ZJCnFrRlRxamNleUNiTzNkUDIvcmY5WWRTN0RLbHQzakZMLzRBQWdVUVMrYWFEYVc3akJKNDBRWTNEbW0wQ0F3RUEKQVFLQ0FnQXZlMXpVV0JQMFo2Q1dJamxMMFYwMDluTFQzK2ozRExsMDlVRXlGRVFoTit2cHNGcVJua3ZuYWhzQgo5bzZJWEJoc0tIOWtYN3ZmNHJYenJ5L0l2WE1HNlVIeWFzZzlhQlVzcFo1dWZpbGJHWFNmU1d5ak0xYmFBdmg5CkJvRmEwTUxzMllvT3EvSzBVYjFoV3o5Z3l0QnRIY3pUYVpYVUNwZDlTcGtKYVRmNC8ydnpiQnFmd2Q0c3hYdFYKcUNhUlNSd1dhaEowejVyV09mcDdtOEZMOVdFOWNsV0cxWldPcURmb2t1MHlJaVVhVVZjYnJFQ1dTYzM0S0hyeQpPeFppV3FCU2czdEhHUXpVaUE5TVQ4bWtuRFhrTHBLazRJa0lYMmkybUJ1TU5ZVEZheUxEcmE1cmRMK3Q5Qyt5ClM2U0pqMVpOYVFISGRlcEpxcXR3SzZRampMWjVyKzYwK2RJTWxCcUtaejQ1aThnYnI2c3c0NEtRQmwya1A2TnIKRS9hN1J1b0ozeVNEZzZ5ZTRCS1BvMDFLQjZBTmpGdkRXUFd1SlJyU2JwVkcrK1Jtc1lQeUpsSFVUWDlPMWdzQwo3cDZMVDZBK2RjYkZveUw4Nk10UGwwdDdkakZFSWI2MHpvbEhMVFRtNVlrenRkb0tWWG1zUHFHSWRrb0RRL3lFCmU5Z09HdVVESHhiMno2UUZNcXhONE1VaVZicitMbEN5blN2b1BHT3FVS3FQbWU1Yis5dldVZDRtQzJyM0VxSTAKWHIvTy94cHJ4SDdjdVJvcDJQaUdnK2hKYXAzbUtsRXh2K0I0ZVBsUDJKeFYrZHQ1TVlxbnFlaDZCYTIvTmpkUAp4MC90WFcrZlNNKythTkJoRWdTekJhR0Ira0l6Z3VUTFZQNkpKTHNzZVk4dmNHZHdnUUtDQVFFQTdpek9ZbXlhCkc5c1lrRnEwQnRmRjJ1Z3Z3dVNHRUJWMlFiOHRoZzhxSkRSZENPY2pCK3VpVlozK3NEV3ZXTXlJTmxPR0hLVHAKMlZpRGNxUGdZdURBMDRqYTN3MWNIMEVzTkZlS1F4VER4YnlSdjlKRk5BbnFrbThUTjcyalNJaWEyaDhubWV4YwpCeDB1VEJtSnBQSUxZQTAyVDJCNXJLRFYwMjBjNlpNVEtWOXMzWGdiWWlOK016SkY2VmhjR3luQ3VKT3QrZ0xYCjRrd3NUN2VWQnpMSEN5d09XRUdHTVU3ZklUYkx5NGlEVUkyNXdhbzR3L3ZGM0Z2YkFkU0Mvc2E0WGhpaFZDb2wKQ1h3b1NaR0Vnb1Z5a09TZ1NrekxNNzZFeHAwKzdLK3hBSlJWU1l3N3dFSHFlUkp1ZlZqMDJEMm1YMzdhUi9KdwpIUXc5Z0hta0g1elR6UUtDQVFFQTA0c0tYOSsyNm9rS3BKejY3UDVRVjFKVnhrQWxNYXE1ZkZVRGdsY0JROE1WCk1VQUdWOXRGOSt1SDIzN3YvWlEwMmV3OVpqYzgvTjRoMFArMzYvTVU2Y0Q3RnBJc2g4dnRwaDVrMi9TTWR0bGwKRnZiK3EwMVFiQnFrYXgzYXlsdVVVK2YvcW9XZEg2M3JHa3pCZ1FaNmJnOFNnRjdNUjB2d0JaNTRjTzlaUEszRQpGd0RTemYyU09ZZ0toZndmbEp1SEJaQVVLcnJPaFk1RngzOVZURHM2SU82blloVk9UajJTaXBmdFYrSlBHcWdOClBXRGdTOTNubUc2RVNldmNYVGlTb2FKdWhveW5ISW91NEFMZ21qRnZTVy9EUWNOUS9RbnpwdVp3cDZER2NVaGoKVVBVT0xESmhMc0lLS1lXUUN1NENLOTBnRWEwWWpGMkFmb0oydFJxQklRS0NBUUVBNFJTNjNjemdQcDdwTWRKbAorMm1DYzRPbFR6c0Ric081aEJ5VmV2RnQwOVVnYnI5d0haWVRUWElJTktJbldYWEE3QVkyNFc4QUNBUmNCTVRWCjB0dXZucmpnanBaampxM2Fob1NNQnlUaWRrWGtQekVKY1VwRndhanlzbVNtb0c5b1YrWEZXUE5EYlAyb3VRWVIKVEMzcGpoWXVVd2xMTTFhemZDRExoL2tUeks5L2hEUnpQR1ZxYUJ1RWNpYXN0SWJjbSs0RUpoYjF5Y2hPdis4dwpDU04xY3h0cFd3SmhQTXZhbGRyZzhUSExWeDc0Z3dySXBuMlMyTko5djljRERKN2pzUmo1clQ0K3poM2xQTkVtCk51ckNBQ2Z2U3dnVHFJek5rWjBjMERTZ3czbHF1QnlzZ3Q1SUphN0RkL1hQUFdQVmpMMm1yd052N0NPYkk0VFIKRTRienFRS0NBUUFjRkRtVlRrR2VVZ0JxcHplYlc0cFlmT0pMeFZucWhNbklHaFMwS1U1T3EwZFYyVFMrVnFtcgo1Y1NMdXdhcDl4RW8xL1d5YXFTYXYvVm5JM3BMUkdIRFFVMVN5cVpFaENvUVFicUxnNk5kWnkvRzQ1UWNNcy80CitYUlhqNGZxRWt2VzgxVjVVZkR3TW9xaFhBelhUbi9UdWdadnFhV2QxUk9QKzEvclJhbm5wdnovUEttK2sramoKNEEzZGlRQzhIZ1RIRlQvSUNERy9nb242bUFrL2JDRWtHK2wxMkhRamFJTGFDSjZGYXRHckxTRk13MTRpVTlzWQozWnFMb1ZZSHZhbWc4TW1RN0h5R0NrVjhrSVUxa2xnK1BDcUR3U1F2NGpGSU54QSsvOVUzVmk5d29JWjRFVnZhCjlBQ2JVRkkxVVRCU21EQllpRXhZM1ZSZjludEJRTHBoQW9JQkFCbUs2eUhPa2NLOVF5TWh1UENUL3hyTHo4VHAKdWlFTGRDRU9LdXB5aDdKR0pzeWtQcHVTdjVIVWpZYVJHQXg0MllJaUN0WXlZZ243Z29tRVpwV1N6WVhESFhFWgpXTTFvQjVldG1DS1h4ZUpPaitKUmZIRU9EbDlMR091d2xvMGRLdmVFemRBZUNTamtYWXVoMytjbkxNVHpQZ0gxCk9CT3NYbmpYNEVnenN5Mjh2ajlaU1VMVDFOWWU3b2ZYcGpKTWpuMmdNTElYY1hoZWkxZHluOHIyUXE3L1NPdGEKQ1NvOXdCN1dKeVlpT2IxbWpUUExQZldqM1VxMFlyeSt3TEwzeGtoOFNQT1RGYVYrRmRiUk1OSXhrOUcrL1N6Rgo1MzFPNmZIT01oNjUzeTd4RGRZSlNMYi9pMXhQdURRQXZTUzY0V1dpNGthNUVleE84M3pKNW5EMDhGcz0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
  apiServer:
    image: registry.k8s.io/kube-apiserver:v1.30.3
    certSANs:
      - 10.10.12.105
      - 10.10.12.105
      - 127.0.0.1
      - ThePatriots.local
    disablePodSecurityPolicy: true
    auditPolicy:
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        - level: Metadata
  controllerManager:
    image: registry.k8s.io/kube-controller-manager:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:v1.30.3
  scheduler:
    image: registry.k8s.io/kube-scheduler:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false
  etcd:
    ca:
      crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmekNDQVNTZ0F3SUJBZ0lSQVBXNUFLOG9LaC94eTV0WGVpZGZJUWN3Q2dZSUtvWkl6ajBFQXdJd0R6RU4KTUFzR0ExVUVDaE1FWlhSalpEQWVGdzB5TkRBM016RXlNVEUwTVRoYUZ3MHpOREEzTWpreU1URTBNVGhhTUE4eApEVEFMQmdOVkJBb1RCR1YwWTJRd1dUQVRCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFTYU15SUV4b2NWCkFXK21sK3dwQi83THpaS1V1ODY4L29xOW92ZXQxTTE2eFhDbHA3ZWdjbCs2b0xtQUpFWnk5alVEOHY0dnJuZUQKZHBrdWh3NW9INmJhbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSApBd0VHQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRkxOS2RmbEVIaHJDCjRGSE5mQW9PaUQ2TU83WFZNQW9HQ0NxR1NNNDlCQU1DQTBrQU1FWUNJUUNvWkZRWkVLazdzY3hUS3pNNmczY0cKbzFnM3F5aDVIQk5PWW02MG9YWm5QQUloQU5Wc1QxdUNKQWU5RnFQV2RxWG0rcHZUblhaNzVLa2xUYUxDS1NPdQpWajQyCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUdXeEhwaWJJdnhZYUN5eDJZQnNlSW02Q2hoQSthZnZxVXMyRWFndVBSbUxvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFbWpNaUJNYUhGUUZ2cHBmc0tRZit5ODJTbEx2T3ZQNkt2YUwzcmRUTmVzVndwYWUzb0hKZgp1cUM1Z0NSR2N2WTFBL0wrTDY1M2czYVpMb2NPYUIrbTJnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
    advertisedSubnets:
      - 10.10.12.0/20
  coreDNS:
    disabled: true
  allowSchedulingOnControlPlanes: true

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kcp111gw.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: controlplane
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0KTUM0Q0FRQXdCUVlESzJWd0JDSUVJTFZ4L2p5N0lpZGFlMHpoTlhMQkZFYmRoNUNGZ3VUS3dNK0IwSVV6Z3MwbwotLS0tLUVORCBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0K
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.12.0/20
    disableManifestsDirectory: true
  network:
    hostname: kcp111gw
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.111/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx0269cb6f84a4
          mode: active-backup
        mtu: 1500
        vip:
          ip: 10.10.12.105
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.5
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - system-upgrade
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  clusterName: thepatriots
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  secretboxEncryptionSecret: qHwgxRuYyLn7d9cK4GePMjlrds7VrCzavxjTVEthc3I=
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU1ZekhKVFhoRHlVaWVPaWFOdXB4VEwybFd0LzJza2Z4TWpiK3d2a0pQcmtvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFOGxScDRBNDdhcG9tN2lPaGhFTzdyanlJeWptMDVtZm5LSWpReTFwSkxlZWlKbTB2cEQxQgpXbVlnMUZqUGVwK1VZWG9jWlNmYjluaVJxYWNMd3UrR1NBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  aggregatorCA:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJZRENDQVFhZ0F3SUJBZ0lSQVB0V2FRWWp3Qk9BL01qM1hNTnNKQ2N3Q2dZSUtvWkl6ajBFQXdJd0FEQWUKRncweU5EQTNNekV5TVRFME1UaGFGdzB6TkRBM01qa3lNVEUwTVRoYU1BQXdXVEFUQmdjcWhrak9QUUlCQmdncQpoa2pPUFFNQkJ3TkNBQVNEZmQzc2FUeDlLNGxxZXhodFRuZGpNejBicnFtUXArKzFRVVUwNkFQZDk0Z09QRDNEClNUTzZhVkxWZGJTS0gxRjk5MXpzb0hoWGFhVHFaR0N4cmNWd28yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXcKSFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4dwpIUVlEVlIwT0JCWUVGRU11S2kxRm9MNVN3N3RpdkcxQjd0YUVlN2dGTUFvR0NDcUdTTTQ5QkFNQ0EwZ0FNRVVDCklHSm1tMGRqMFE1RFJtamZ3dlhyajhCaGhPYkNxaTMrdFBMOTNuNVkrUE5WQWlFQXN0bnpERXh0blhkb0l6VjEKRlpaY0pNdnpYQTFjSk1UK3FBaWlmbGlLWEowPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUxMdnhQeXdwd0JYT0FtY2VlOEZJaDdWSzd0TEZZOHNLOHdKckt0TXBUZE1vQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFZzMzZDdHazhmU3VKYW5zWWJVNTNZek05RzY2cGtLZnZ0VUZGTk9nRDNmZUlEanc5dzBregp1bWxTMVhXMGloOVJmZmRjN0tCNFYybWs2bVJnc2EzRmNBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  serviceAccount:
    key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBeE5CS0ZpSEhvVDN5bHZyODErZXFPVmdIU3BLYitFRnJ2MmlNcUt2OHFBQlhscUd3CnFaR2g5TnhPRzVVMTRoYTJlc2JySk1HV016MFdSUFg0RUtvaVRJWkZsYk16Qlk4UEpwQnhpUEJueGlWRWpMUHEKZ2hTSUIwaC9FYVg3bGNFOURRcWV0Y3VvNVRYdG45M1E0bE1VdFI1OHVZYXV5M2RXa3FFa0JwUHAwa3huM1VsdAptS3pqb0lmZzlxNkRWWmtVQlZoLzAvNCs0bFdweW9JSHpLOUdDbU5NOFk4blBENTVtL09ZQVNlMGJUdkFyUnRKClZzWjZCRWdpUFdYV042NlJwSVFtVVdId2xFTDIyNkxGSG12RzhzZDlYQ25lZjdFQkZibk1CL3U5eXYwQjhLQWkKRmJjWHk5eXFQaUdnWk5aT0pxK1k1dEZSQjgyeUNWZjQzTnpSRzNWMnRUSUFnL2NUZjBBdW1jcGxzYzZKZXE3SApicUsyKzg0ek1YWEFkTGJqVFFHaXNnUGt6aTV3M0pGU24wRk1WeUZGYU9KYlFUbWNicmp3cEdPci8yb1RZUkFZCmRjK3JNcVhhVWNqb0ZudzEwbWkwb01LY2czcWhueko1bk1Sa1IxSTJlU0poVXZDZVlYRW05Uk9Teit1OWwra2wKekQyQmN6RUNRODNWRkRoZ3ZRYjIxUUVUR3N4Z3NEVVhHcEc1bUxabDlwbmdkOE55RnBWQzd2ODM1RnI1b2s5TwpiT1pJUlVTb1VVMlZDMjFCeGVDeDUxN1FNRXpKdDEzKzdMRDVYUW9kZVRaSGVOWGtCejI1ZTRIL2ZCTW9sQ0ZJCnFrRlRxamNleUNiTzNkUDIvcmY5WWRTN0RLbHQzakZMLzRBQWdVUVMrYWFEYVc3akJKNDBRWTNEbW0wQ0F3RUEKQVFLQ0FnQXZlMXpVV0JQMFo2Q1dJamxMMFYwMDluTFQzK2ozRExsMDlVRXlGRVFoTit2cHNGcVJua3ZuYWhzQgo5bzZJWEJoc0tIOWtYN3ZmNHJYenJ5L0l2WE1HNlVIeWFzZzlhQlVzcFo1dWZpbGJHWFNmU1d5ak0xYmFBdmg5CkJvRmEwTUxzMllvT3EvSzBVYjFoV3o5Z3l0QnRIY3pUYVpYVUNwZDlTcGtKYVRmNC8ydnpiQnFmd2Q0c3hYdFYKcUNhUlNSd1dhaEowejVyV09mcDdtOEZMOVdFOWNsV0cxWldPcURmb2t1MHlJaVVhVVZjYnJFQ1dTYzM0S0hyeQpPeFppV3FCU2czdEhHUXpVaUE5TVQ4bWtuRFhrTHBLazRJa0lYMmkybUJ1TU5ZVEZheUxEcmE1cmRMK3Q5Qyt5ClM2U0pqMVpOYVFISGRlcEpxcXR3SzZRampMWjVyKzYwK2RJTWxCcUtaejQ1aThnYnI2c3c0NEtRQmwya1A2TnIKRS9hN1J1b0ozeVNEZzZ5ZTRCS1BvMDFLQjZBTmpGdkRXUFd1SlJyU2JwVkcrK1Jtc1lQeUpsSFVUWDlPMWdzQwo3cDZMVDZBK2RjYkZveUw4Nk10UGwwdDdkakZFSWI2MHpvbEhMVFRtNVlrenRkb0tWWG1zUHFHSWRrb0RRL3lFCmU5Z09HdVVESHhiMno2UUZNcXhONE1VaVZicitMbEN5blN2b1BHT3FVS3FQbWU1Yis5dldVZDRtQzJyM0VxSTAKWHIvTy94cHJ4SDdjdVJvcDJQaUdnK2hKYXAzbUtsRXh2K0I0ZVBsUDJKeFYrZHQ1TVlxbnFlaDZCYTIvTmpkUAp4MC90WFcrZlNNKythTkJoRWdTekJhR0Ira0l6Z3VUTFZQNkpKTHNzZVk4dmNHZHdnUUtDQVFFQTdpek9ZbXlhCkc5c1lrRnEwQnRmRjJ1Z3Z3dVNHRUJWMlFiOHRoZzhxSkRSZENPY2pCK3VpVlozK3NEV3ZXTXlJTmxPR0hLVHAKMlZpRGNxUGdZdURBMDRqYTN3MWNIMEVzTkZlS1F4VER4YnlSdjlKRk5BbnFrbThUTjcyalNJaWEyaDhubWV4YwpCeDB1VEJtSnBQSUxZQTAyVDJCNXJLRFYwMjBjNlpNVEtWOXMzWGdiWWlOK016SkY2VmhjR3luQ3VKT3QrZ0xYCjRrd3NUN2VWQnpMSEN5d09XRUdHTVU3ZklUYkx5NGlEVUkyNXdhbzR3L3ZGM0Z2YkFkU0Mvc2E0WGhpaFZDb2wKQ1h3b1NaR0Vnb1Z5a09TZ1NrekxNNzZFeHAwKzdLK3hBSlJWU1l3N3dFSHFlUkp1ZlZqMDJEMm1YMzdhUi9KdwpIUXc5Z0hta0g1elR6UUtDQVFFQTA0c0tYOSsyNm9rS3BKejY3UDVRVjFKVnhrQWxNYXE1ZkZVRGdsY0JROE1WCk1VQUdWOXRGOSt1SDIzN3YvWlEwMmV3OVpqYzgvTjRoMFArMzYvTVU2Y0Q3RnBJc2g4dnRwaDVrMi9TTWR0bGwKRnZiK3EwMVFiQnFrYXgzYXlsdVVVK2YvcW9XZEg2M3JHa3pCZ1FaNmJnOFNnRjdNUjB2d0JaNTRjTzlaUEszRQpGd0RTemYyU09ZZ0toZndmbEp1SEJaQVVLcnJPaFk1RngzOVZURHM2SU82blloVk9UajJTaXBmdFYrSlBHcWdOClBXRGdTOTNubUc2RVNldmNYVGlTb2FKdWhveW5ISW91NEFMZ21qRnZTVy9EUWNOUS9RbnpwdVp3cDZER2NVaGoKVVBVT0xESmhMc0lLS1lXUUN1NENLOTBnRWEwWWpGMkFmb0oydFJxQklRS0NBUUVBNFJTNjNjemdQcDdwTWRKbAorMm1DYzRPbFR6c0Ric081aEJ5VmV2RnQwOVVnYnI5d0haWVRUWElJTktJbldYWEE3QVkyNFc4QUNBUmNCTVRWCjB0dXZucmpnanBaampxM2Fob1NNQnlUaWRrWGtQekVKY1VwRndhanlzbVNtb0c5b1YrWEZXUE5EYlAyb3VRWVIKVEMzcGpoWXVVd2xMTTFhemZDRExoL2tUeks5L2hEUnpQR1ZxYUJ1RWNpYXN0SWJjbSs0RUpoYjF5Y2hPdis4dwpDU04xY3h0cFd3SmhQTXZhbGRyZzhUSExWeDc0Z3dySXBuMlMyTko5djljRERKN2pzUmo1clQ0K3poM2xQTkVtCk51ckNBQ2Z2U3dnVHFJek5rWjBjMERTZ3czbHF1QnlzZ3Q1SUphN0RkL1hQUFdQVmpMMm1yd052N0NPYkk0VFIKRTRienFRS0NBUUFjRkRtVlRrR2VVZ0JxcHplYlc0cFlmT0pMeFZucWhNbklHaFMwS1U1T3EwZFYyVFMrVnFtcgo1Y1NMdXdhcDl4RW8xL1d5YXFTYXYvVm5JM3BMUkdIRFFVMVN5cVpFaENvUVFicUxnNk5kWnkvRzQ1UWNNcy80CitYUlhqNGZxRWt2VzgxVjVVZkR3TW9xaFhBelhUbi9UdWdadnFhV2QxUk9QKzEvclJhbm5wdnovUEttK2sramoKNEEzZGlRQzhIZ1RIRlQvSUNERy9nb242bUFrL2JDRWtHK2wxMkhRamFJTGFDSjZGYXRHckxTRk13MTRpVTlzWQozWnFMb1ZZSHZhbWc4TW1RN0h5R0NrVjhrSVUxa2xnK1BDcUR3U1F2NGpGSU54QSsvOVUzVmk5d29JWjRFVnZhCjlBQ2JVRkkxVVRCU21EQllpRXhZM1ZSZjludEJRTHBoQW9JQkFCbUs2eUhPa2NLOVF5TWh1UENUL3hyTHo4VHAKdWlFTGRDRU9LdXB5aDdKR0pzeWtQcHVTdjVIVWpZYVJHQXg0MllJaUN0WXlZZ243Z29tRVpwV1N6WVhESFhFWgpXTTFvQjVldG1DS1h4ZUpPaitKUmZIRU9EbDlMR091d2xvMGRLdmVFemRBZUNTamtYWXVoMytjbkxNVHpQZ0gxCk9CT3NYbmpYNEVnenN5Mjh2ajlaU1VMVDFOWWU3b2ZYcGpKTWpuMmdNTElYY1hoZWkxZHluOHIyUXE3L1NPdGEKQ1NvOXdCN1dKeVlpT2IxbWpUUExQZldqM1VxMFlyeSt3TEwzeGtoOFNQT1RGYVYrRmRiUk1OSXhrOUcrL1N6Rgo1MzFPNmZIT01oNjUzeTd4RGRZSlNMYi9pMXhQdURRQXZTUzY0V1dpNGthNUVleE84M3pKNW5EMDhGcz0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
  apiServer:
    image: registry.k8s.io/kube-apiserver:v1.30.3
    certSANs:
      - 10.10.12.105
      - 10.10.12.105
      - 127.0.0.1
      - ThePatriots.local
    disablePodSecurityPolicy: true
    auditPolicy:
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        - level: Metadata
  controllerManager:
    image: registry.k8s.io/kube-controller-manager:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:v1.30.3
  scheduler:
    image: registry.k8s.io/kube-scheduler:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false
  etcd:
    ca:
      crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmekNDQVNTZ0F3SUJBZ0lSQVBXNUFLOG9LaC94eTV0WGVpZGZJUWN3Q2dZSUtvWkl6ajBFQXdJd0R6RU4KTUFzR0ExVUVDaE1FWlhSalpEQWVGdzB5TkRBM016RXlNVEUwTVRoYUZ3MHpOREEzTWpreU1URTBNVGhhTUE4eApEVEFMQmdOVkJBb1RCR1YwWTJRd1dUQVRCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFTYU15SUV4b2NWCkFXK21sK3dwQi83THpaS1V1ODY4L29xOW92ZXQxTTE2eFhDbHA3ZWdjbCs2b0xtQUpFWnk5alVEOHY0dnJuZUQKZHBrdWh3NW9INmJhbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSApBd0VHQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRkxOS2RmbEVIaHJDCjRGSE5mQW9PaUQ2TU83WFZNQW9HQ0NxR1NNNDlCQU1DQTBrQU1FWUNJUUNvWkZRWkVLazdzY3hUS3pNNmczY0cKbzFnM3F5aDVIQk5PWW02MG9YWm5QQUloQU5Wc1QxdUNKQWU5RnFQV2RxWG0rcHZUblhaNzVLa2xUYUxDS1NPdQpWajQyCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUdXeEhwaWJJdnhZYUN5eDJZQnNlSW02Q2hoQSthZnZxVXMyRWFndVBSbUxvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFbWpNaUJNYUhGUUZ2cHBmc0tRZit5ODJTbEx2T3ZQNkt2YUwzcmRUTmVzVndwYWUzb0hKZgp1cUM1Z0NSR2N2WTFBL0wrTDY1M2czYVpMb2NPYUIrbTJnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
    advertisedSubnets:
      - 10.10.12.0/20
  coreDNS:
    disabled: true
  allowSchedulingOnControlPlanes: true

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kawg124.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.10.0/20
    disableManifestsDirectory: true
  network:
    hostname: kawg124
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.124/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx021579a6b815
          mode: active-backup
        mtu: 1500
      - interface: bond1
        addresses:
          - 192.168.90.124/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.90.1
        bond:
          interfaces:
            - enxbc241128e2c4
          mode: active-backup
        mtu: 9000
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.6
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kawg122.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.10.0/20
    disableManifestsDirectory: true
  network:
    hostname: kawg122
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.122/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx02448ef5d041
          mode: active-backup
        mtu: 1500
      - interface: bond1
        addresses:
          - 192.168.90.122/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.90.1
        bond:
          interfaces:
            - enxbc241180885f
          mode: active-backup
        mtu: 9000
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.6
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kawg121.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.10.0/20
    disableManifestsDirectory: true
  network:
    hostname: kawg121
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.121/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx025ffcaf8d15
          mode: active-backup
        mtu: 1500
      - interface: bond1
        addresses:
          - 192.168.90.121/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.90.1
        bond:
          interfaces:
            - enxbc2411506ff7
          mode: active-backup
        mtu: 9000
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.6
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kawg123.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: worker
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.10.0/20
    disableManifestsDirectory: true
  network:
    hostname: kawg123
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.123/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx0263b2e00a63
          mode: active-backup
        mtu: 1500
      - interface: bond1
        addresses:
          - 192.168.90.123/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.90.1
        bond:
          interfaces:
            - enxbc2411b16bd5
          mode: active-backup
        mtu: 9000
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.6
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: ""
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

File: ./kubernetes/bootstrap/talos/clusterconfig/thepatriots-kcp112tj.yaml
version: v1alpha1
debug: false
persist: true
machine:
  type: controlplane
  token: 09jiom.ngx540hi270uj4s2
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJQekNCOHFBREFnRUNBaEVBaThMVzBsbnFHQmVCNmJwOHkraEx2REFGQmdNclpYQXdFREVPTUF3R0ExVUUKQ2hNRmRHRnNiM013SGhjTk1qUXdOek14TWpFeE5ERTVXaGNOTXpRd056STVNakV4TkRFNVdqQVFNUTR3REFZRApWUVFLRXdWMFlXeHZjekFxTUFVR0F5dGxjQU1oQVBrdm0xRGxoZTBpZVRjY1VOQ2Q4eStCTCtldDVtRFJFRU4zCmpLekphWEpYbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUcKQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRlAzbFl4eHdndi9RTXdtYQovME9LVXBrQlFUZklNQVVHQXl0bGNBTkJBSTZHZXlrRFVTbWJxUG1zV3FqUGtVTTQ1V3BlTlRmMXRMZ3VIMGpJCnE4NmhJRVNYU1lFeVlsZlkzMFQycTZjQmtsbmJMN3B0NVA5ZmhSU21lcTBNZHdvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0KTUM0Q0FRQXdCUVlESzJWd0JDSUVJTFZ4L2p5N0lpZGFlMHpoTlhMQkZFYmRoNUNGZ3VUS3dNK0IwSVV6Z3MwbwotLS0tLUVORCBFRDI1NTE5IFBSSVZBVEUgS0VZLS0tLS0K
  certSANs:
    - 10.10.12.105
    - 127.0.0.1
    - ThePatriots.local
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.3
    extraArgs:
      rotate-server-certificates: "true"
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 10.10.12.0/20
    disableManifestsDirectory: true
  network:
    hostname: kcp112tj
    interfaces:
      - interface: bond0
        addresses:
          - 10.10.12.112/20
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.10.1
        bond:
          interfaces:
            - enx0249f55f0575
          mode: active-backup
        mtu: 1500
        vip:
          ip: 10.10.12.105
    nameservers:
      - 10.10.10.1
      - 10.10.10.1
    disableSearchDomain: true
  install:
    diskSelector:
      size: <=89GB
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.7.5
    wipe: false
  files:
    - content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  time:
    disabled: false
    servers:
      - time.google.com
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"
  features:
    rbac: true
    stableHostname: true
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - system-upgrade
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
      resolveMemberNames: true
cluster:
  id: opACGiNcYEtH87Og16A_PMiPC990hfMdAP46G0jxE3I=
  secret: +6uIL4OFR+KMnku6+IO4MbImrrETgd1ikUp7ENfxDhA=
  controlPlane:
    endpoint: https://10.10.12.105:6443
  clusterName: thepatriots
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  token: kbn95j.d3v7cjbauqwb6b6a
  secretboxEncryptionSecret: qHwgxRuYyLn7d9cK4GePMjlrds7VrCzavxjTVEthc3I=
  ca:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJpekNDQVRDZ0F3SUJBZ0lSQUtOWXNhZ0VzTk51WlZwK214Qnd0b013Q2dZSUtvWkl6ajBFQXdJd0ZURVQKTUJFR0ExVUVDaE1LYTNWaVpYSnVaWFJsY3pBZUZ3MHlOREEzTXpFeU1URTBNVGhhRncwek5EQTNNamt5TVRFMApNVGhhTUJVeEV6QVJCZ05WQkFvVENtdDFZbVZ5Ym1WMFpYTXdXVEFUQmdjcWhrak9QUUlCQmdncWhrak9QUU1CCkJ3TkNBQVR5VkduZ0RqdHFtaWJ1STZHRVE3dXVQSWpLT2JUbVorY29pTkRMV2trdDU2SW1iUytrUFVGYVppRFUKV005Nm41UmhlaHhsSjl2MmVKR3Bwd3ZDNzRaSW8yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXdIUVlEVlIwbApCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0hRWURWUjBPCkJCWUVGSEdpR2c2VklBL0ZkaGp0MUVrVHp2M0tBOEdiTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDQnRKVDIKTUJ3Y1RBQk4vZTN0emNSbm0zUHhZQlFuREdjYVM0RnErSXJyZmdJaEFQTUl6enJwOEQ1T1MySXBqQ3BWTnlScgpleitSdldxUEJBVlNCN3hPWHhDYQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU1ZekhKVFhoRHlVaWVPaWFOdXB4VEwybFd0LzJza2Z4TWpiK3d2a0pQcmtvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFOGxScDRBNDdhcG9tN2lPaGhFTzdyanlJeWptMDVtZm5LSWpReTFwSkxlZWlKbTB2cEQxQgpXbVlnMUZqUGVwK1VZWG9jWlNmYjluaVJxYWNMd3UrR1NBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  aggregatorCA:
    crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJZRENDQVFhZ0F3SUJBZ0lSQVB0V2FRWWp3Qk9BL01qM1hNTnNKQ2N3Q2dZSUtvWkl6ajBFQXdJd0FEQWUKRncweU5EQTNNekV5TVRFME1UaGFGdzB6TkRBM01qa3lNVEUwTVRoYU1BQXdXVEFUQmdjcWhrak9QUUlCQmdncQpoa2pPUFFNQkJ3TkNBQVNEZmQzc2FUeDlLNGxxZXhodFRuZGpNejBicnFtUXArKzFRVVUwNkFQZDk0Z09QRDNEClNUTzZhVkxWZGJTS0gxRjk5MXpzb0hoWGFhVHFaR0N4cmNWd28yRXdYekFPQmdOVkhROEJBZjhFQkFNQ0FvUXcKSFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01BOEdBMVVkRXdFQi93UUZNQU1CQWY4dwpIUVlEVlIwT0JCWUVGRU11S2kxRm9MNVN3N3RpdkcxQjd0YUVlN2dGTUFvR0NDcUdTTTQ5QkFNQ0EwZ0FNRVVDCklHSm1tMGRqMFE1RFJtamZ3dlhyajhCaGhPYkNxaTMrdFBMOTNuNVkrUE5WQWlFQXN0bnpERXh0blhkb0l6VjEKRlpaY0pNdnpYQTFjSk1UK3FBaWlmbGlLWEowPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUxMdnhQeXdwd0JYT0FtY2VlOEZJaDdWSzd0TEZZOHNLOHdKckt0TXBUZE1vQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFZzMzZDdHazhmU3VKYW5zWWJVNTNZek05RzY2cGtLZnZ0VUZGTk9nRDNmZUlEanc5dzBregp1bWxTMVhXMGloOVJmZmRjN0tCNFYybWs2bVJnc2EzRmNBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  serviceAccount:
    key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBeE5CS0ZpSEhvVDN5bHZyODErZXFPVmdIU3BLYitFRnJ2MmlNcUt2OHFBQlhscUd3CnFaR2g5TnhPRzVVMTRoYTJlc2JySk1HV016MFdSUFg0RUtvaVRJWkZsYk16Qlk4UEpwQnhpUEJueGlWRWpMUHEKZ2hTSUIwaC9FYVg3bGNFOURRcWV0Y3VvNVRYdG45M1E0bE1VdFI1OHVZYXV5M2RXa3FFa0JwUHAwa3huM1VsdAptS3pqb0lmZzlxNkRWWmtVQlZoLzAvNCs0bFdweW9JSHpLOUdDbU5NOFk4blBENTVtL09ZQVNlMGJUdkFyUnRKClZzWjZCRWdpUFdYV042NlJwSVFtVVdId2xFTDIyNkxGSG12RzhzZDlYQ25lZjdFQkZibk1CL3U5eXYwQjhLQWkKRmJjWHk5eXFQaUdnWk5aT0pxK1k1dEZSQjgyeUNWZjQzTnpSRzNWMnRUSUFnL2NUZjBBdW1jcGxzYzZKZXE3SApicUsyKzg0ek1YWEFkTGJqVFFHaXNnUGt6aTV3M0pGU24wRk1WeUZGYU9KYlFUbWNicmp3cEdPci8yb1RZUkFZCmRjK3JNcVhhVWNqb0ZudzEwbWkwb01LY2czcWhueko1bk1Sa1IxSTJlU0poVXZDZVlYRW05Uk9Teit1OWwra2wKekQyQmN6RUNRODNWRkRoZ3ZRYjIxUUVUR3N4Z3NEVVhHcEc1bUxabDlwbmdkOE55RnBWQzd2ODM1RnI1b2s5TwpiT1pJUlVTb1VVMlZDMjFCeGVDeDUxN1FNRXpKdDEzKzdMRDVYUW9kZVRaSGVOWGtCejI1ZTRIL2ZCTW9sQ0ZJCnFrRlRxamNleUNiTzNkUDIvcmY5WWRTN0RLbHQzakZMLzRBQWdVUVMrYWFEYVc3akJKNDBRWTNEbW0wQ0F3RUEKQVFLQ0FnQXZlMXpVV0JQMFo2Q1dJamxMMFYwMDluTFQzK2ozRExsMDlVRXlGRVFoTit2cHNGcVJua3ZuYWhzQgo5bzZJWEJoc0tIOWtYN3ZmNHJYenJ5L0l2WE1HNlVIeWFzZzlhQlVzcFo1dWZpbGJHWFNmU1d5ak0xYmFBdmg5CkJvRmEwTUxzMllvT3EvSzBVYjFoV3o5Z3l0QnRIY3pUYVpYVUNwZDlTcGtKYVRmNC8ydnpiQnFmd2Q0c3hYdFYKcUNhUlNSd1dhaEowejVyV09mcDdtOEZMOVdFOWNsV0cxWldPcURmb2t1MHlJaVVhVVZjYnJFQ1dTYzM0S0hyeQpPeFppV3FCU2czdEhHUXpVaUE5TVQ4bWtuRFhrTHBLazRJa0lYMmkybUJ1TU5ZVEZheUxEcmE1cmRMK3Q5Qyt5ClM2U0pqMVpOYVFISGRlcEpxcXR3SzZRampMWjVyKzYwK2RJTWxCcUtaejQ1aThnYnI2c3c0NEtRQmwya1A2TnIKRS9hN1J1b0ozeVNEZzZ5ZTRCS1BvMDFLQjZBTmpGdkRXUFd1SlJyU2JwVkcrK1Jtc1lQeUpsSFVUWDlPMWdzQwo3cDZMVDZBK2RjYkZveUw4Nk10UGwwdDdkakZFSWI2MHpvbEhMVFRtNVlrenRkb0tWWG1zUHFHSWRrb0RRL3lFCmU5Z09HdVVESHhiMno2UUZNcXhONE1VaVZicitMbEN5blN2b1BHT3FVS3FQbWU1Yis5dldVZDRtQzJyM0VxSTAKWHIvTy94cHJ4SDdjdVJvcDJQaUdnK2hKYXAzbUtsRXh2K0I0ZVBsUDJKeFYrZHQ1TVlxbnFlaDZCYTIvTmpkUAp4MC90WFcrZlNNKythTkJoRWdTekJhR0Ira0l6Z3VUTFZQNkpKTHNzZVk4dmNHZHdnUUtDQVFFQTdpek9ZbXlhCkc5c1lrRnEwQnRmRjJ1Z3Z3dVNHRUJWMlFiOHRoZzhxSkRSZENPY2pCK3VpVlozK3NEV3ZXTXlJTmxPR0hLVHAKMlZpRGNxUGdZdURBMDRqYTN3MWNIMEVzTkZlS1F4VER4YnlSdjlKRk5BbnFrbThUTjcyalNJaWEyaDhubWV4YwpCeDB1VEJtSnBQSUxZQTAyVDJCNXJLRFYwMjBjNlpNVEtWOXMzWGdiWWlOK016SkY2VmhjR3luQ3VKT3QrZ0xYCjRrd3NUN2VWQnpMSEN5d09XRUdHTVU3ZklUYkx5NGlEVUkyNXdhbzR3L3ZGM0Z2YkFkU0Mvc2E0WGhpaFZDb2wKQ1h3b1NaR0Vnb1Z5a09TZ1NrekxNNzZFeHAwKzdLK3hBSlJWU1l3N3dFSHFlUkp1ZlZqMDJEMm1YMzdhUi9KdwpIUXc5Z0hta0g1elR6UUtDQVFFQTA0c0tYOSsyNm9rS3BKejY3UDVRVjFKVnhrQWxNYXE1ZkZVRGdsY0JROE1WCk1VQUdWOXRGOSt1SDIzN3YvWlEwMmV3OVpqYzgvTjRoMFArMzYvTVU2Y0Q3RnBJc2g4dnRwaDVrMi9TTWR0bGwKRnZiK3EwMVFiQnFrYXgzYXlsdVVVK2YvcW9XZEg2M3JHa3pCZ1FaNmJnOFNnRjdNUjB2d0JaNTRjTzlaUEszRQpGd0RTemYyU09ZZ0toZndmbEp1SEJaQVVLcnJPaFk1RngzOVZURHM2SU82blloVk9UajJTaXBmdFYrSlBHcWdOClBXRGdTOTNubUc2RVNldmNYVGlTb2FKdWhveW5ISW91NEFMZ21qRnZTVy9EUWNOUS9RbnpwdVp3cDZER2NVaGoKVVBVT0xESmhMc0lLS1lXUUN1NENLOTBnRWEwWWpGMkFmb0oydFJxQklRS0NBUUVBNFJTNjNjemdQcDdwTWRKbAorMm1DYzRPbFR6c0Ric081aEJ5VmV2RnQwOVVnYnI5d0haWVRUWElJTktJbldYWEE3QVkyNFc4QUNBUmNCTVRWCjB0dXZucmpnanBaampxM2Fob1NNQnlUaWRrWGtQekVKY1VwRndhanlzbVNtb0c5b1YrWEZXUE5EYlAyb3VRWVIKVEMzcGpoWXVVd2xMTTFhemZDRExoL2tUeks5L2hEUnpQR1ZxYUJ1RWNpYXN0SWJjbSs0RUpoYjF5Y2hPdis4dwpDU04xY3h0cFd3SmhQTXZhbGRyZzhUSExWeDc0Z3dySXBuMlMyTko5djljRERKN2pzUmo1clQ0K3poM2xQTkVtCk51ckNBQ2Z2U3dnVHFJek5rWjBjMERTZ3czbHF1QnlzZ3Q1SUphN0RkL1hQUFdQVmpMMm1yd052N0NPYkk0VFIKRTRienFRS0NBUUFjRkRtVlRrR2VVZ0JxcHplYlc0cFlmT0pMeFZucWhNbklHaFMwS1U1T3EwZFYyVFMrVnFtcgo1Y1NMdXdhcDl4RW8xL1d5YXFTYXYvVm5JM3BMUkdIRFFVMVN5cVpFaENvUVFicUxnNk5kWnkvRzQ1UWNNcy80CitYUlhqNGZxRWt2VzgxVjVVZkR3TW9xaFhBelhUbi9UdWdadnFhV2QxUk9QKzEvclJhbm5wdnovUEttK2sramoKNEEzZGlRQzhIZ1RIRlQvSUNERy9nb242bUFrL2JDRWtHK2wxMkhRamFJTGFDSjZGYXRHckxTRk13MTRpVTlzWQozWnFMb1ZZSHZhbWc4TW1RN0h5R0NrVjhrSVUxa2xnK1BDcUR3U1F2NGpGSU54QSsvOVUzVmk5d29JWjRFVnZhCjlBQ2JVRkkxVVRCU21EQllpRXhZM1ZSZjludEJRTHBoQW9JQkFCbUs2eUhPa2NLOVF5TWh1UENUL3hyTHo4VHAKdWlFTGRDRU9LdXB5aDdKR0pzeWtQcHVTdjVIVWpZYVJHQXg0MllJaUN0WXlZZ243Z29tRVpwV1N6WVhESFhFWgpXTTFvQjVldG1DS1h4ZUpPaitKUmZIRU9EbDlMR091d2xvMGRLdmVFemRBZUNTamtYWXVoMytjbkxNVHpQZ0gxCk9CT3NYbmpYNEVnenN5Mjh2ajlaU1VMVDFOWWU3b2ZYcGpKTWpuMmdNTElYY1hoZWkxZHluOHIyUXE3L1NPdGEKQ1NvOXdCN1dKeVlpT2IxbWpUUExQZldqM1VxMFlyeSt3TEwzeGtoOFNQT1RGYVYrRmRiUk1OSXhrOUcrL1N6Rgo1MzFPNmZIT01oNjUzeTd4RGRZSlNMYi9pMXhQdURRQXZTUzY0V1dpNGthNUVleE84M3pKNW5EMDhGcz0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
  apiServer:
    image: registry.k8s.io/kube-apiserver:v1.30.3
    certSANs:
      - 10.10.12.105
      - 10.10.12.105
      - 127.0.0.1
      - ThePatriots.local
    disablePodSecurityPolicy: true
    auditPolicy:
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        - level: Metadata
  controllerManager:
    image: registry.k8s.io/kube-controller-manager:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:v1.30.3
  scheduler:
    image: registry.k8s.io/kube-scheduler:v1.30.3
    extraArgs:
      bind-address: 0.0.0.0
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false
  etcd:
    ca:
      crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmekNDQVNTZ0F3SUJBZ0lSQVBXNUFLOG9LaC94eTV0WGVpZGZJUWN3Q2dZSUtvWkl6ajBFQXdJd0R6RU4KTUFzR0ExVUVDaE1FWlhSalpEQWVGdzB5TkRBM016RXlNVEUwTVRoYUZ3MHpOREEzTWpreU1URTBNVGhhTUE4eApEVEFMQmdOVkJBb1RCR1YwWTJRd1dUQVRCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFTYU15SUV4b2NWCkFXK21sK3dwQi83THpaS1V1ODY4L29xOW92ZXQxTTE2eFhDbHA3ZWdjbCs2b0xtQUpFWnk5alVEOHY0dnJuZUQKZHBrdWh3NW9INmJhbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQW9Rd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSApBd0VHQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRkxOS2RmbEVIaHJDCjRGSE5mQW9PaUQ2TU83WFZNQW9HQ0NxR1NNNDlCQU1DQTBrQU1FWUNJUUNvWkZRWkVLazdzY3hUS3pNNmczY0cKbzFnM3F5aDVIQk5PWW02MG9YWm5QQUloQU5Wc1QxdUNKQWU5RnFQV2RxWG0rcHZUblhaNzVLa2xUYUxDS1NPdQpWajQyCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUdXeEhwaWJJdnhZYUN5eDJZQnNlSW02Q2hoQSthZnZxVXMyRWFndVBSbUxvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFbWpNaUJNYUhGUUZ2cHBmc0tRZit5ODJTbEx2T3ZQNkt2YUwzcmRUTmVzVndwYWUzb0hKZgp1cUM1Z0NSR2N2WTFBL0wrTDY1M2czYVpMb2NPYUIrbTJnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
    advertisedSubnets:
      - 10.10.12.0/20
  coreDNS:
    disabled: true
  allowSchedulingOnControlPlanes: true

File: ./kubernetes/bootstrap/talos/talconfig_backup.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.9.0
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.31.2

clusterName: "thepatriots"
endpoint: https://10.10.12.105:6443
clusterPodNets:
  - "10.244.0.0/16"
clusterSvcNets:
  - "10.96.0.0/16"
additionalApiServerCertSans: &sans
  - "10.10.12.105"
  - 127.0.0.1 # KubePrism
  - "ThePatriots.local"
additionalMachineCertSans: *sans

# Disable built-in Flannel to use Cilium
cniConfig:
  name: none

nodes:
  - hostname: "kcp111"
    ipAddress: "10.10.12.111"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: true
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "0269cb6f84a4"
        dhcp: false
        addresses:
          - "10.10.12.111/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
        vip:
          ip: "10.10.12.105"
  - hostname: "kcp112"
    ipAddress: "10.10.12.112"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: true
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "0249f55f0575"
        dhcp: false
        addresses:
          - "10.10.12.112/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
        vip:
          ip: "10.10.12.105"
  - hostname: "kcp113"
    ipAddress: "10.10.12.113"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: true
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "027ce94bfbb6"
        dhcp: false
        addresses:
          - "10.10.12.113/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
        vip:
          ip: "10.10.12.105"
  - hostname: "kawg121"
    ipAddress: "10.10.12.121"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: false
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "025ffcaf8d15"
        dhcp: false
        addresses:
          - "10.10.12.121/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
  - hostname: "kawg122"
    ipAddress: "10.10.12.122"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: false
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "02448ef5d041"
        dhcp: false
        addresses:
          - "10.10.12.122/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
  - hostname: "kawg123"
    ipAddress: "10.10.12.123"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: false
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "0263b2e00a63"
        dhcp: false
        addresses:
          - "10.10.12.123/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500
  - hostname: "kawg124"
    ipAddress: "10.10.12.124"
    installDisk: "/dev/sda"
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515
    controlPlane: false
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "021579a6b815"
        dhcp: false
        addresses:
          - "10.10.12.124/20"
        routes:
          - network: 0.0.0.0/0
            gateway: "10.10.10.1"
        mtu: 1500

# Global patches
patches:
  - # Force nameserver
    |-
    machine:
      network:
        nameservers:
          - 10.10.10.1
  - # Configure NTP
    |-
    machine:
      time:
        disabled: false
        servers:
          - time.google.com
  - "@./patches/global/cluster-discovery.yaml"
  - "@./patches/global/containerd.yaml"
  - "@./patches/global/disable-search-domain.yaml"
  - "@./patches/global/hostdns.yaml"
  - "@./patches/global/kubelet.yaml"
  - "@./patches/global/openebs-local.yaml"
  - "@./patches/global/sysctl.yaml"

# Controller patches
controlPlane:
  patches:
    - "@./patches/controller/api-access.yaml"
    - "@./patches/controller/cluster.yaml"
    - "@./patches/controller/disable-admission-controller.yaml"
    - "@./patches/controller/etcd.yaml"


File: ./kubernetes/bootstrap/talos/talconfig.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.9.0
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.31.2
clusterName: "thepatriots"
endpoint: https://10.10.12.105:6443
clusterPodNets:
  - "10.244.0.0/16"
clusterSvcNets:
  - "10.96.0.0/16"
additionalApiServerCertSans: &sans
  - "10.10.12.105"
  - 127.0.0.1 # KubePrism
  - "ThePatriots.local"
additionalMachineCertSans: *sans
# Disable built-in Flannel to use Cilium
cniConfig:
  name: none
nodes:
  - hostname: "kcp111"
    ipAddress: 10.10.12.111
    controlPlane: true
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.111/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
        vip:
          ip: "10.10.12.105"
    nameservers:
      - 10.10.12.1
  - hostname: "kcp112"
    ipAddress: 10.10.12.112
    controlPlane: true
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.112/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
        vip:
          ip: "10.10.12.105"
    nameservers:
      - 10.10.12.1
  - hostname: "kcp113"
    ipAddress: 10.10.12.113
    controlPlane: true
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.113/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
        vip:
          ip: "10.10.12.105"
    nameservers:
      - 10.10.12.1
  - hostname: "kawg121"
    ipAddress: 10.10.12.121
    controlPlane: false
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.121/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
      - interface: bond1
        bond:
          interfaces:
            - eth1
          mode: active-backup
        mtu: 9000
        addresses:
          - 192.168.90.121/24
    nameservers:
      - 10.10.12.1
  - hostname: "kawg122"
    ipAddress: 10.10.12.122
    controlPlane: false
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.122/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
      - interface: bond1
        bond:
          interfaces:
            - eth1
          mode: active-backup
        mtu: 9000
        addresses:
          - 192.168.90.122/24
    nameservers:
      - 10.10.12.1
  - hostname: "kawg123"
    ipAddress: 10.10.12.123
    controlPlane: false
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.123/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
      - interface: bond1
        bond:
          interfaces:
            - eth1
          mode: active-backup
        mtu: 9000
        addresses:
          - 192.168.90.123/24
    nameservers:
      - 10.10.12.1
  - hostname: "kawg124"
    ipAddress: 10.10.12.124
    controlPlane: false
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.124/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
      - interface: bond1
        bond:
          interfaces:
            - eth1
          mode: active-backup
        mtu: 9000
        addresses:
          - 192.168.90.124/24
    nameservers:
      - 10.10.12.1
  - hostname: "kawg125"
    ipAddress: 10.10.12.125
    controlPlane: false
    installDiskSelector:
      size: "<=89GB"
    networkInterfaces:
      - interface: bond0
        bond:
          interfaces:
            - eth0
          mode: active-backup
        mtu: 9000
        addresses:
          - 10.10.12.125/24
        routes:
          - network: 0.0.0.0/0
            gateway: 10.10.12.1
      - interface: bond1
        bond:
          interfaces:
            - eth1
          mode: active-backup
        mtu: 9000
        addresses:
          - 192.168.90.125/24
    nameservers:
      - 10.10.12.1

# Global patches
patches:
  # Force nameserver
  - |-
    machine:
      network:
        nameservers:
          - 10.10.12.1
  # Configure NTP
  - |-
    machine:
      time:
        disabled: false
        servers:
          - time.google.com
  - "@./patches/global/cluster-discovery.yaml"
  - "@./patches/global/containerd.yaml"
  - "@./patches/global/disable-search-domain.yaml"
  - "@./patches/global/hostdns.yaml"
  - "@./patches/global/kubelet.yaml"
  - "@./patches/global/openebs-local.yaml"
  - "@./patches/global/sysctl.yaml"
# Controller patches
controlPlane:
  patches:
    - "@./patches/controller/api-access.yaml"
    - "@./patches/controller/cluster.yaml"
    - "@./patches/controller/disable-admission-controller.yaml"
    - "@./patches/controller/etcd.yaml"

File: ./kubernetes/bootstrap/talos/.sops.yaml
creation_rules:
    - age: ENC[AES256_GCM,data:9Yn/u88uWPr/gvdZJ2MfmjY9oue50Y2vkNLfEC+bBoDomcXOHehAxxehb4WoFosx+e8dvybQVim7x68XTlI=,iv:l0rVowCmD7zOwm/q+fOXw6loR/rnCUj9hkXNqz2O+i0=,tag:xJvmPkIjZtijwDYDGE3KFQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBVSEJHMDkwK1pDYk4xaVRK
            ZnhxVkxra0pmT0NCQStpbmU5bUJFMW1LVkNBCnpKNnZPcFFCMEY2SHo4N1hIVXMr
            bjJGT1U0eTMxMlR5Ky9MY3ZYTXJBYTAKLS0tIGYzNis0N3RySE80aDFGelJpQWc0
            blFKaDAyTDVtMGtmNFVtQzBPZkZBdkEKFaZCFhIN3g2ufKlv+rGC1dRPXKJmZqFJ
            dzBIJXtZM0/6iVnDcr43y+WwHfF6zx8LR10SbGu6Yf7OXTf2ayO8+w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-07-31T22:58:51Z"
    mac: ENC[AES256_GCM,data:zJuFiNtGm34OxwTps90uSKtjqZ3PliXSnzMOCuJHVF3sKC7HMphl98vc41uewZd8wJswcKQ3w3K8rDlb8VpL1JTAlEjRuLCcll7OjbLtegbFjijxlZBum/6fLVRUebo8xiW77k5f1nLd4maWdIsuTsxpBLFPMD9kDAVlvq5RgOI=,iv:fKlGgSDovecadnitfe6yBuPj/hXBfSSNlfN0l1CzPVo=,tag:N1SNIiRh2CbDP5BBqxlPvA==,type:str]
    pgp: []
    unencrypted_suffix: _unencrypted
    version: 3.9.0

File: ./kubernetes/bootstrap/talos/patches/controller/etcd.yaml
cluster:
  etcd:
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
    advertisedSubnets:
      - 10.10.12.0/24

File: ./kubernetes/bootstrap/talos/patches/controller/api-access.yaml
machine:
  features:
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - system-upgrade

File: ./kubernetes/bootstrap/talos/patches/controller/cluster.yaml
cluster:
  allowSchedulingOnControlPlanes: true
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0
  coreDNS:
    disabled: true
  proxy:
    disabled: true
  scheduler:
    extraArgs:
      bind-address: 0.0.0.0

File: ./kubernetes/bootstrap/talos/patches/controller/disable-admission-controller.yaml
- op: remove
  path: /cluster/apiServer/admissionControl

File: ./kubernetes/bootstrap/talos/patches/global/kubelet.yaml
machine:
  kubelet:
    extraArgs:
      rotate-server-certificates: true
    nodeIP:
      validSubnets:
        - 10.10.10.0/20

File: ./kubernetes/bootstrap/talos/patches/global/cluster-discovery.yaml
cluster:
  discovery:
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

File: ./kubernetes/bootstrap/talos/patches/global/hostdns.yaml
machine:
  features:
    hostDNS:
      enabled: true
      resolveMemberNames: true
      forwardKubeDNSToHost: true # Requires Cilium `bpf.masquerade: false`

File: ./kubernetes/bootstrap/talos/patches/global/containerd.yaml
machine:
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false

File: ./kubernetes/bootstrap/talos/patches/global/openebs-local.yaml
machine:
  kubelet:
    extraMounts:
      - destination: /var/openebs/local
        type: bind
        source: /var/openebs/local
        options:
          - bind
          - rshared
          - rw

File: ./kubernetes/bootstrap/talos/patches/global/disable-search-domain.yaml
machine:
  network:
    disableSearchDomain: true

File: ./kubernetes/bootstrap/talos/patches/global/sysctl.yaml
machine:
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_watches: "524288"
    fs.inotify.max_user_instances: "8192"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"

File: ./kubernetes/bootstrap/flux/kustomization.yaml
# IMPORTANT: This file is not tracked by flux and should never be. Its
# purpose is to only install the Flux components and CRDs into your cluster.
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - github.com/fluxcd/flux2/manifests/install?ref=v2.4.0
patches:
  # Remove the default network policies
  - patch: |-
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: not-used
    target:
      group: networking.k8s.io
      kind: NetworkPolicy
  # Resources renamed to match those installed by oci://ghcr.io/fluxcd/flux-manifests
  - target:
      kind: ResourceQuota
      name: critical-pods
    patch: |
      - op: replace
        path: /metadata/name
        value: critical-pods-flux-system
  - target:
      kind: ClusterRoleBinding
      name: cluster-reconciler
    patch: |
      - op: replace
        path: /metadata/name
        value: cluster-reconciler-flux-system
  - target:
      kind: ClusterRoleBinding
      name: crd-controller
    patch: |
      - op: replace
        path: /metadata/name
        value: crd-controller-flux-system
  - target:
      kind: ClusterRole
      name: crd-controller
    patch: |
      - op: replace
        path: /metadata/name
        value: crd-controller-flux-system
  - target:
      kind: ClusterRole
      name: flux-edit
    patch: |
      - op: replace
        path: /metadata/name
        value: flux-edit-flux-system
  - target:
      kind: ClusterRole
      name: flux-view
    patch: |
      - op: replace
        path: /metadata/name
        value: flux-view-flux-system

File: ./kubernetes/bootstrap/helmfile.yaml
---
helmDefaults:
  wait: true
  waitForJobs: true
  timeout: 600
  recreatePods: true
  force: true

repositories:
  - name: cilium
    url: https://helm.cilium.io
  - name: coredns
    url: https://coredns.github.io/helm
  - name: postfinance
    url: https://postfinance.github.io/kubelet-csr-approver

releases:
  - name: prometheus-operator-crds
    namespace: observability
    chart: oci://ghcr.io/prometheus-community/charts/prometheus-operator-crds
    version: 17.0.2
  - name: cilium
    namespace: kube-system
    chart: cilium/cilium
    version: 1.16.5
    values:
      - ../apps/kube-system/cilium/app/helm-values.yaml
    needs:
      - observability/prometheus-operator-crds
  - name: coredns
    namespace: kube-system
    chart: coredns/coredns
    version: 1.36.1
    values:
      - ../apps/kube-system/coredns/app/helm-values.yaml
    needs:
      - observability/prometheus-operator-crds
      - kube-system/cilium
  - name: kubelet-csr-approver
    namespace: kube-system
    chart: postfinance/kubelet-csr-approver
    version: 1.2.4
    values:
      - ../apps/kube-system/kubelet-csr-approver/app/helm-values.yaml
    needs:
      - observability/prometheus-operator-crds
      - kube-system/cilium
      - kube-system/coredns
  - name: spegel
    namespace: kube-system
    chart: oci://ghcr.io/spegel-org/helm-charts/spegel
    version: v0.0.28
    values:
      - ../apps/kube-system/spegel/app/helm-values.yaml
    needs:
      - observability/prometheus-operator-crds
      - kube-system/cilium
      - kube-system/coredns
      - kube-system/kubelet-csr-approver

File: ./kubernetes/apps/meshcentral/app/configmap.sops.yaml
apiVersion: v1
kind: ConfigMap
metadata:
    name: meshcentral-config
data:
    config.json: ENC[AES256_GCM,data:JKHqHZ+3ZQNeAdIDiaW4MwJgoVEBHKThoj73UDqszfYGILbZySz8jRUOKY8BfSBEqoKRW6hIDkGnLYlPuTmefwqb1aXWXrRZc3ZGgvb8SSDPhgik6LVwOsakPvggpxf6DiKasnwhrCgv2SXM0R4F7ARAVwOxauSfcKQNfHCsNVCiMsAvBlu1V4R3R85T5gVDwYydLufjbXf5X5Av6p1bJ6U0cLwf4M512+N/bQWGdT1rGGpdybOriGmM7O6nv3wRUdtBUPIVmphI+nL8MG2h/VeiMEjGjsndqW6D5GWnpCazw2zjGKKnmluuBT+kZyQVyD7sUCMmD/RBao2jQxqI/g7/McnFPe/qaykHvi9d1jUd5wQ7H+DG/1Pdl/t/WnJcPymnNBk2/0JfoWL7pEszDb3XvVl1pUlj/DsEQktEsLAghCz6U8SjfI9RGiafrdakXfRW8m+tD8bbpxcUo5uZGobOXV7p6IjcSpLNMDxbWntmdNYYLXfECCO8NBGrWXsh4TqqcFngkJqNmNQ21lTqPBPvVD3nxU0/SivuNKR0qnUVXjR/J0wDvYsmW09gjaLu/ETqync06FxNVVqxTnZXL94pqZcFO5+DdisTJDQw487VYry8/EAyZe2tPgvSqTtYVN82OUdLIoei0O0G8KYru6G/yBx05PF9Axjw7ZL/7isdFfTfl7gkKeXBZJaV1auC0CyraLDwptEdbXyuJ+TgYWnwnXoCHK0+e+/VVcjf2hRuQHuz94bLZNpzWDYIDNG7mO/7AFncfQ7YJ8hKPW9szgDSmx7s008d44eZ1VAoKwZ8H/nAsWVhM/jL2zAtUDKOPIyJSRvbrZ67rJJaK/bHsfFwkcRUrk6zDU0InprVNBVisqYcwaKy9/tOuD/8oXpUMqxrFXJyXwYp4d1y7vOa36RgHr6+E3layR40+PipJLjVxlK0fLIhZDoxLsuRXYUnomHiCQiKKR2Uv91JV4F4fW6e+AOqAC+4nMNxu2CzpjxwS6TaTDe/TpD7OCCdeak8oAQtZPIQAX35oQfRehqycFeyDzmkM7SIgzGF3+Jn6GEKaLZllyzFuS0kveMBEmewNwQ0El+MOL8L9Cv+t5ZpcYdO5kO5ZMWG3Uzgq6XsNJi6UAr8IZND6BhnNNybl8+9jdkvIyiFXGkk8hdzfnHILiouFHQDMeteI604tD1faWxfrM5MAU7I2qhcNIl8b0LtgI4mpwXG96gOgUNJ5AjD14iTn/0slJEMl4Jz3fPdyU+xkDzAleIwKyH6C3AUQ1qX7Nchwdl3a+tthLAzpbcNJjzyH/yAZtSQpFkliyZjyocnklAUWIrdUvz/BC/FfjJTwlWhn3MEGa4c17/4kZYvao+98TbVqenl92Vta2R8H2pb0W+sjL9j/wCkzTDvkEsb0GkmreqHrxlrH688Pw5DhUrs8fk0WoAcRWlB4kmL+j7yE5Nz8iL74ujnSoQc83UzvyfzJDzwWILVuMMwJmGMcgjr1DW69isrkB2hQMUagfGYQtz5N2QGWzQo/UI14OjF9QkCAyC/hr/HMkOW99D5zx4bJdeb/6ixXYZuGulBV1FegsC2NaFSx0w5dTCRXNNTbAD45DM=,iv:C5SEjjtg31+Zbcjnug+opJPwzDaPivpRlHVf22RM6ds=,tag:m9oUygdHYjBhlGHr6Is2Hw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBWajZwY2xBNDBxRUNaTEVa
            WFhiV1pCdTVBV0EzQkVhblVvaVVRYm51MW04Cm5RQUI3U2JQTDQwbUFGYVBYT1pn
            UjYxREtwL3hoTURnM3E2V3ZWa0VtSFEKLS0tIDd3aU1WNHFrYjZWN1doTEtvWUFP
            TnlSSERhTURRL0xoTjdlUnk3a3I0S3MKdRAoBwsCZHS/+/McQuJeM6cnwyUpZD+r
            znZzLg1xwU2S8JQ6SbEhFcBWqpWeMByiWA4AYhvogTpjgGXFGU4QCg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBNSXBOQjlKSXFhOUFHVVk0
            ellNTmE2ZzlSYWVUQjIwYmRJaGFSYUVTWUJrClJXM2xLUlMyN0hRdWgwUTk4SGlr
            OUVCSzZqOXFIcU9FTkhjd0tLR21PSEUKLS0tIHlrRGo3eEMvMDBvOFAyaHVnWlNJ
            WUQ1Nzl6ZWd2TWFMdzhnRmlFN0s5dGcKVq2djWFxR0kGjIz0/+A+6B0QpQWZ49/9
            0n3ocqAqWPLPCU7A2xta5uBX6mdp4jkRqGqr69/GcDs+9b/YR7Y6Eg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-21T14:26:46Z"
    mac: ENC[AES256_GCM,data:cYeONXGQqH7sLZ9OavrGhq/FgE7QdPtPTZef1zlf12ZDMNqd3KZjB0XRD4rCLy7tXeK7U6XiAAb4AZRXuPsMSHXA4+CZZAjDsR9BSM5gI1Z03UO0Ahs07aZSb9Ux9/Nd/3XbPb59E1emozs6U0wqOTjIzaTorGtqrRDRXSGJKms=,iv:Qe1xNAFJGMc5w8do1rXuJWXScnPdTq8+zYJvYULLxWQ=,tag:Hz/f3XLmoE3o9LJ8+ZTHJw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.2

File: ./kubernetes/apps/meshcentral/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: meshcentral-v2
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: ceph-rbd

File: ./kubernetes/apps/meshcentral/app/oidc-creds.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: meshcentral-oidc-secret
stringData:
    OIDC_CLIENT_ID: ENC[AES256_GCM,data:BU1faaqRm1hJvm+Rj/ruI1vS0z7DT/lm7keanLvzrDBGgBuZ7GJCvg==,iv:42Y4OeY3XpkPpVoBFdNa3vcmfQrJzcZXEc0cJ5YA8ms=,tag:R6ZVJetZfYi5gArDrfTqPw==,type:str]
    OIDC_CLIENT_SECRET: ENC[AES256_GCM,data:LEvdIR9wBcb+plr6oIFxKvKrpn4r4zEy2xWIDA18Z2voJqbc8GWcEWppW8+ZwSz0cOqrFa84zvbIzz7F+gYfLQb5/TuxI1ZlU1c2YXt8YqlQOmaY7w9EfJ3vKnbMhKwKo/XLGlobyf5I1BUdkqBPLs7ryk+RRPw5ul3mmbkk5v8=,iv:jTCvRgc2+pbbN1sqMtt98p3B16JOXq/QTRUR2q3JJaQ=,tag:bsY8R2T6+B5FBg9VQd1vFw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOQ2g0VFpmTStwamJ1dFFY
            WndMSHFYUVU2T0FFMEpxNEl6eXk0ZXZRblhBCmwvcytjRkMvODdVdE5TeXUxeDdy
            aXRVZmpYSVVVRi9WV1pFQ3BING5JSTAKLS0tIE9XbXlmMkZGUlRleE16RmJ5WWR1
            MzlCQnJtUGRVZ0Z4Q1ZQalg5a2dhd28KjlovyDqGhwLCDd40fIfNyLX2K2jWvt74
            eJVFuVBvuAUCbDlKVwgfH6Tl/IF0Y8svArtlsUJ2I3u8871DNgjUpA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLWk5jU2N3dk1hNVhVZnNS
            clZYdHNLd0MyVW05WVQ4bXVKdFpkZmpiV1RvCk9maGREcTZxR1BFK3pMbWJrQzg2
            Rms3djg1VG0wamJnKzA2ME9jcTlqbmcKLS0tIDgzYklheG4wVmh4b21yZDIwMUlL
            d1pyN1VkUzQ0em9iTkwrVWtjRXF6emsKim3VpyWraP0/xxADEKaMkHMbW/113zcr
            Us3TmFByG6FN8ix0nkIh1rZbBu1iFOo8RvaJcMhMEhDehAcdSjW1Jw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-21T12:54:10Z"
    mac: ENC[AES256_GCM,data:XBtLRbH0QiCFDaWOm9xkAD/40KrtnZ69o/7KQZpV0RIHOtbNb4IUdug91TijMdlxjIWK+upI3n5CpQ4I0Yo4/h5QBsup1QPxhd/ZQXW3Ujpn5hc94+c4CHn4yv59A7dEX4XZi/riDiIN3xQr6Vhr65kfwbuQCaDYHR7rDbX/yig=,iv:p6ZutM5/qhLnT+74cWKm7wBCGrqkGJsTGA+hcGEnHGM=,tag:lY5+5OUG0F9JZrloDJ6L3w==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.2

File: ./kubernetes/apps/meshcentral/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: meshcentral
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      meshcentral:
        annotations:
          reloader.stakater.com/auto: "true"
        # pod:
        #   annotations:
        #     k8s.v1.cni.cncf.io/networks: |
        #       [{
        #         "name":"macvlan-lan",
        #         "interface": "eth1",
        #         "namespace": "kube-system",
        #         "ips": ["10.10.12.224/24"]
        #       }]
        containers:
          app:
            image:
              repository: ghcr.io/ylianst/meshcentral
              tag: 1.1.37
            env:
              TZ: ${TIMEZONE}
              NODE_ENV: production
              HOSTNAME: ${HOSTNAME}
            # command:
            #  - /bin/sleep
            #  - infinity
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 2Gi
    service:
      app:
        controller: meshcentral
        ports:
          http:
            port: ${PORT}
    ingress:
      external:
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          - host: ${HOSTNAME}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - ${HOSTNAME}
            secretName: "${HOSTNAME/./-}-tls"

      internal:
        className: internal
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          - host: ${HOSTNAME}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - ${HOSTNAME}
            secretName: "${HOSTNAME/./-}-tls"
    persistence:
      config:
        type: configMap
        name: meshcentral-config
        advancedMounts:
          meshcentral:
            app:
              - path: /opt/meshcentral/meshcentral-data/config.json
                subPath: config.json
#      cert:
#        type: secret
#        name: ${HOSTNAME/./-}-tls
#        advancedMounts:
#          meshcentral:
#            app:
#              - path: /opt/meshcentral/meshcentral-data/webserver-cert-public.crt
#                subPath: webserver-cert-public.crt
      data:
        existingClaim: meshcentral-v2
        globalMounts:
          - path: /root
            subPath: rootdir
          - path: /opt/meshcentral/meshcentral-data
            subPath: data
          - path: /opt/meshcentral/meshcentral-files
            subPath: userfiles
          - path: /opt/meshcentral/meshcentral-backups
            subPath: backups

File: ./kubernetes/apps/meshcentral/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - configmap.sops.yaml
  - helmrelease.yaml
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/meshcentral/volsync-backup/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: meshcentral-volsync-r2-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:gNAPzRPf2VwJaQ7bfI8Qqpyvn8aOC78j9d4cCY+iTM+FFzKPPBrt2ZvXsHk5YprC6itixlMe+ozxK3QVhLQonwV0t3AoQa+rBzX6BQ2JFC5h5dSj5T/xIugqy5o=,iv:VC12BY/lto0sk3BgshSVqd2RSNTbfL1JJzRFx3Q9Aio=,tag:DeWCJ3doJT95bhSdXFA37g==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:HKISCJJy9jNGJaHooEFpHWp/Zi/AK4h1UUpGBu6n0iA=,iv:gIUBv0QfvtXKP2Rxztpc2Pt63D1B/HofqI2Fq8wi6R0=,tag:pDIe/OExm69EMQnf9ILWwg==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:d++KlSYIvoj4r3Et3sASRA82KQWQKe7Bgiy5MK23X/8=,iv:Sv4vAIxuYrocN+a4qVPqeSvnqSRDR2PB7QFy+yw+be4=,tag:qwCBPKvd5G3Uho7/uWPUOw==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:TDuqWXedpDa732yQiQwA/fL/n9g9Cmpmr6HIE7sm8J1SXMUnmvsQ/fTONKW4W/+y0F3Z1GcaR58R/5U9VIyUMA==,iv:vOA2hS1+AG6z5IaDfYZcMG5qj/LSp9+sQ1Htvy9vGnA=,tag:Op7rw3uCCcfSBMQsQ2DCVQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA4ak9uYzk1Tk5uVStpNUIw
            MTd2dFpwMjZwZXRiTDRTcHlNaWE4M25hT0NvClRDeWFJQTJvQ1dTOUtlZjgyS0ly
            V1N2cllUSkFUWkwzMlEwRzhOZE9uMTAKLS0tIHYrODk4MmtzQzlDdkhWMVRLbWFZ
            UU5hY0xYeDlpOUZLTVJEL1M3ZmQybzQKxOhbLqKOMQaSxf/No63xFdB2IkYyvveQ
            YhTZgTnOOnAtdQKcsDeSmCmM2VfMZkCtJPU+EkEP9RcViUz+/B2aOw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBxZ0ExOC9xekp1Q3ZoTEJh
            MHR5akVQZVNJNEZodDUxRU9WaXVNQ1E3VFM0CndkdmhWekVmQ1I4QWh4cXFZODZt
            RlkyaUQ2UDVXTUVZMStQajlxaE1iQjAKLS0tIDZ5MzZuT1hsNTdoTmI3V3l4d2lD
            K3owU3RaK2hSY1VvKzUwY0c5Z3F0UW8KlCcnAp7DsuasDNABJl1+AvGz9mUaLPZu
            GS08x8NorWpwSPkJIfS8W7h4TXzm1jUifopGOiwKk9HdInJ0rYT9uA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-17T15:55:11Z"
    mac: ENC[AES256_GCM,data:s0nVvvknvc3HbYyGTA5/Vy42KPlYEUs25gg4U1VpHXcak+/ktkwgaguRMgsvTo13+ciC3AhFbsr+zdQYFSqH3HNZif8NimTGMrk5vY0GPZ6zfSDkCG7l3LTTBaBSkGa+cU2UGCg2k2bFhOi86dRvPWZislOtOQIY2FMrvlwBXT8=,iv:fkUe9bAdBkew5nJM9Esdq41s+gSfWtm4gcKmiEMKUm4=,tag:wREL7fUu2+UTQG1IGYUz9g==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/meshcentral/volsync-backup/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: meshcentral
spec:
  restic:
    cacheCapacity: 2Gi
    cacheStorageClassName: local-hostpath
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 0
      runAsGroup: 0
      runAsUser: 0
    pruneIntervalDays: 7
    repository: meshcentral-volsync-r2-secret
    retain:
      daily: 7
      weekly: 4
    storageClassName: ceph-rbd
    volumeSnapshotClassName: csi-ceph-blockpool
  sourcePVC: meshcentral-v2
  trigger:
    schedule: "0 4 * * *"

File: ./kubernetes/apps/meshcentral/volsync-backup/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./replicationsource.yaml

File: ./kubernetes/apps/meshcentral/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd/kustomize-controller/main/config/crd/bases/kustomize.toolkit.fluxcd.io_kustomizations.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: meshcentral
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/meshcentral/app"
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  postBuild:
    substitute:
      TIMEZONE: "America/New_York"
      HOSTNAME: "meshcentral.${SECRET_DOMAIN}"
      PORT: "4430"
      ALIAS_PORT: "443"
      RedirPORT: "800"
      MpsPORT: "44330"
      MpsALIAS_PORT: "4433"

File: ./kubernetes/apps/meshcentral/ks-backup.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: meshcentral-backup
  namespace: flux-system
spec:
  targetNamespace: default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/meshcentral/volsync-backup"
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots

File: ./kubernetes/apps/bookstack/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: bookstack-secret
    namespace: default
stringData:
    APP_URL: ENC[AES256_GCM,data:ZXeJSH5HSZwGvOQEZMIMMJfJvxHkE6Ic+/WcaAJzCl6emA==,iv:W9BIjc/Ji7BdHK5rZWkHFclbInVFbbV6lRfNhIJV4kk=,tag:PRHF1d/iDhqn5aEUGKaFzw==,type:str]
    DB_HOST: ENC[AES256_GCM,data:HaFlHaitC2zLrpb3DefU+dqTuDv5gCyzvsLCTIkfJFN7BVG3AhIQAjfZ5BFIH5zmmNQ=,iv:ghCU44uy4+aYvus2qg6ZCo7I7kSqp6ar01N4s4J3xZI=,tag:KIO4zh1l4ZZTZ3vGVmhYkw==,type:str]
    DB_PORT: ENC[AES256_GCM,data:I6+dFg==,iv:MvNggNzR/ccyZFGaFvs3dj/YsXBn8bwLn+A0Vfwtxok=,tag:zMr4DapC2lLenipnEUdpoQ==,type:str]
    DB_DATABASE: ENC[AES256_GCM,data:z6f4ux/XjwLt1ysh,iv:gYPmJwu+Cdtza1LgI4WKNSe4ZIIdZYkX3wpCn6nFk0c=,tag:2qxijTukZemhwYIJLNx+4w==,type:str]
    DB_USERNAME: ENC[AES256_GCM,data:1XQbQdlAmC25,iv:HQ5V7BYi+eFbkKyuzYWSb+cVBBJzdKNkynVXuHYDlas=,tag:tR7vGJHjIVdgjLFR0xkzWA==,type:str]
    DB_PASSWORD: ENC[AES256_GCM,data:sP8/N3XgH/mV1ICjhk6boDCcKv6DdhtDkfDVIW4GQa8Wil9YK1jK0IqSF40=,iv:r9udH7drHDbFvW486LmBbqdnIzVz9tKiSrspJ+amjzo=,tag:T8jrmLETsGeBLkTcL1IhjA==,type:str]
    MAIL_DRIVER: ENC[AES256_GCM,data:XmolSQ==,iv:BsV3gUrT2wd+34AaR6CzEz/tmfXDbI7xY+tQd2LC53k=,tag:qtQRbHYESLNuZ3ixQs/iKg==,type:str]
    MAIL_HOST: ENC[AES256_GCM,data:7grgbJQ8g2D35+gvKyS59H8GRLzoHsYYBhcWaJA4Ehi28TLG,iv:AO6ihlORMGTEmjBkfPcCbEbF2f8EL+nQFV7X+TFmt7k=,tag:A27BzrPlonrpWghE8/PSXQ==,type:str]
    MAIL_PORT: ENC[AES256_GCM,data:JrWw,iv:TnGW2orwIFfAJQhvaN2UQHOXG474r1Ms7+7pc3CjBkk=,tag:QdMGFOWuYp7noFlyQbTx1w==,type:str]
    MAIL_ENCRYPTION: ENC[AES256_GCM,data:OqWE7w==,iv:LuHySDTrMz8gj+bfoajSG2FXnQUQyl/F1eC6V6LwAQg=,tag:I+951iG3SE1iJiFeUf8Hgg==,type:str]
    MAIL_VERIFY_SSL: ENC[AES256_GCM,data:hrTj/BI=,iv:iTsE0Kj1mTiNCQDY2cWX5JDeBGDYCIvk7mugiDECLLs=,tag:beThDIeDl2g3fZQsEuJ2bw==,type:str]
    MAIL_FROM: ENC[AES256_GCM,data:5vd37Bhof6wFvtfgOZA06oJhiVh5Y7s=,iv:Sq5/MPuQ2MgWh5jIR25nHsIee9Og1MQ1PB6GGWP3wiQ=,tag:wUCZhADibRyi83OmtYer3w==,type:str]
    MAIL_FROM_NAME: ENC[AES256_GCM,data:VwRFHkGm34RVf6tF7A==,iv:Y2Oe0yqbjsr5W4QJjqBFaLCAqnj5EQYm8oqQAlVoR+k=,tag:kaaxpyfx+1YKQwSW7Yu6+g==,type:str]
    AUTH_METHOD: ENC[AES256_GCM,data:YyCk4w==,iv:NXrw2cbKXcXwL5MgIjHYoYGXYJ5Oq3USnu8dWLOM/ps=,tag:GK+iFGAhlVxiYHBYh6gm8w==,type:str]
    OIDC_NAME: ENC[AES256_GCM,data:CXZObnngjeaPgdjnyA==,iv:KI/ozB+qW7KofVMIh4GcKapcb/DOlRdDKSlfBpDlIVI=,tag:wb6oZEf3bM/oF+c1ahMrAw==,type:str]
    OIDC_DISPLAY_NAME_CLAIMS: ENC[AES256_GCM,data:tL3S8g==,iv:zy+m6FULNLvwr309G0Q0vZ4keIM04I2vtKxD9dk+LrU=,tag:Fa91sziwlmQ2NNZSz6rHlQ==,type:str]
    OIDC_CLIENT_ID: ENC[AES256_GCM,data:+dDtNuFhDsq48W6nWwXTf2JPS2rzrluQdyLi+BE7z8UggpKlAVtg7Q==,iv:jUIvBwmrZbU8ETZpTQaq5w0KZuwvcDr96Trj97V/QQE=,tag:ANYt0GAFgV6HSjG1sU0jEQ==,type:str]
    OIDC_CLIENT_SECRET: ENC[AES256_GCM,data:X//Ut4oxhb4IyzELI8d/+LRR6vUkJvBydnp85im2EjpR/tav0KJBT7eBrJrHxMVJ18I8SWQbKMt2owO6DAqTNT5cqAnANf0vA4vlY9VtIR78wSp3uuf+KRxL94u5FH/C9Q4T1mbNCeJ4RmMsHHp+KUdGOyHewj82raYjopegtbo=,iv:ZKJ/E/KmoGeFoOhxfSE8X06G3/ic2uUJyH5Xee4uCSs=,tag:BD5qC9VXoj4UchPrmq3D8A==,type:str]
    OIDC_ISSUER: ENC[AES256_GCM,data:kH62kSf5OfZWrfGp9S46BRNYK1m49UQWiMv4fuJv8GCXDF9OucFYagFh+7zpknwMrhgXkBkpgA==,iv:umbqM6s+fRS/QO1J9YZV74MHnXyrH2ADKR7aBycmZCU=,tag:PGwUdcrENW9oqCbvFfI2Ng==,type:str]
    OIDC_END_SESSION_ENDPOINT: ENC[AES256_GCM,data:kog/IA==,iv:n1tipa0fmcwm7xCVQ1Thwx68Nd/Q2gZf8u6TeIQIlR0=,tag:zw96vXrf+6EP7sHp0XV0Mw==,type:str]
    OIDC_ISSUER_DISCOVER: ENC[AES256_GCM,data:HMltCg==,iv:WI87Yms2RsXP0/1Lo9PImLC/q0PT66ngYZKMwKuoUFE=,tag:7dtf4Y+Ek+AMYl7IC6yOyQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXdXNaYU41NnRhcTJySnF6
            MXhmeURnL1kxMDNRS2l1S1pHZzhzbHArZGtzCkRUalNRc2loRDVMU0VGUzNCRzND
            YjNvd0ZUaTBITnBwUXJ4dVdQcU9zdWcKLS0tIGRxcklLVHIybVFlaXJXb1RNM2VV
            SEpDczhqaE5QaW9va3dyNGh3cXZWSnMKgWWYpDP0UHBgnzAGMLk/UzINZYj9MGIv
            r8+ioYsGOlJZ+D0rhlRDH2et9YhgRkOPZclZOAQqS5ZAi5qEx74paQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJMHBJMGVhVVdrQithZXpB
            MStqY3Avd0VIdmxQN3VSb2dIUEJqZ2FwWTM0CnZRNVp6UjhGTUpnL29FK2ZnMGtj
            VWoxa0lJRU0yY1pZMnIvM0x2R3lIYk0KLS0tIDdScmVLdURVakVFWDUvMkIySWhh
            Y2NyWUIyR28zcVhhOThyRzMwRW5Nd0kK6jzlbICX1+ajVCBr4F2HWlzCdminLCsg
            cCi1ZTXAUM1rBonQp5K4BvPxfZgPoQqpcPJxY+jwQbA5OUZ351ivzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-21T15:22:26Z"
    mac: ENC[AES256_GCM,data:8KQsWPnYQ76TexYUCDVR1syUyTjR4ImNhv0UHCMwxFEQmhgr58dmxuOj20AiKJPDr9eO8sJjlmG2UKuksa3gPr97PoA+1joIJmAdGIi1lOqpiDDWxQiT6WHA5gv90m11Dxij0/ty3jKST1v5Bv+0MUnldzFVcTuufYxiaY3x73Y=,iv:nVFAUg5PoF6kfvIKwYK1ucgiC7XYwXEPFKYcO5nSO/8=,tag:lM3t1Jr029b3Ws+oNxv28Q==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.2

File: ./kubernetes/apps/bookstack/app/.decrypted~secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: bookstack-secret
    namespace: default
stringData:
    APP_URL: https://documentation.kawalink.com
    DB_HOST: mariadb-galera-maxscale.database.svc.cluster.local
    DB_PORT: "3306"
    DB_DATABASE: bookstackapp
    DB_USERNAME: bookstack
    DB_PASSWORD: LnpzXR5fc9KFMUxyeQaQ8CfvHj4hvlCjuTKx4LQOR9s=
    MAIL_DRIVER: smtp
    MAIL_HOST: smtp-relay.default.svc.cluster.local
    MAIL_PORT: "587"
    MAIL_ENCRYPTION: "null"
    MAIL_VERIFY_SSL: "false"
    MAIL_FROM: noreply@kawaconnect.com
    MAIL_FROM_NAME: Documentation
    AUTH_METHOD: oidc
    OIDC_NAME: Authentik SSO
    OIDC_DISPLAY_NAME_CLAIMS: name
    OIDC_CLIENT_ID: TMs0hrbz6pmSY3VLKIdS8XhBX8iooCKsIWnziioi
    OIDC_CLIENT_SECRET: 3dzQCc0SxKmfCvoFwPkUhKSxfEH31e1j1LhqkFv4DG26H0NkDwdYRlKqoLvBWtLqycrz48MXNnyHyN2BWg6lIppPLZUwwaliQULIF44wE5cof3NS9Fs3gAhkCrFpaZDt
    OIDC_ISSUER: https://auth.kawalink.com/application/o/bookstack-docs/
    OIDC_END_SESSION_ENDPOINT: "true"
    OIDC_ISSUER_DISCOVER: "true"

File: ./kubernetes/apps/bookstack/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bookstack
  namespace: default
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: cephfs

File: ./kubernetes/apps/bookstack/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./hr.yaml
  - ./secret.sops.yaml
  - ./pvc.yaml

File: ./kubernetes/apps/bookstack/app/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: bookstack
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      bookstack:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/linuxserver/bookstack
              tag: v24.05.4-ls166
            env:
              OIDC_DUMP_USER_DETAILS: "false"
              OIDC_ADDITIONAL_SCOPES: "groups"
              OIDC_GROUPS_CLAIM: "groups"
              OIDC_USER_TO_GROUPS: "true"
            envFrom:
              - secretRef:
                  name: bookstack-secret
            resources:
              requests:
                cpu: 10m
                memory: 50Mi
              limits:
                memory: 256Mi

    service:
      app:
        controller: bookstack
        ports:
          http:
            port: 80

    ingress:
      app:
        enabled: true
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
        hosts:
          - host: "documentation.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - "documentation.${SECRET_DOMAIN}"
            secretName: "documentation.${SECRET_DOMAIN}-tls"

      internal:
        enabled: true
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
        hosts:
          - host: "documentation.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - "documentation.${SECRET_DOMAIN}"
            secretName: "documentation.${SECRET_DOMAIN}-tls"

    persistence:
      config:
        existingClaim: bookstack
        globalMounts:
          - path: /config

File: ./kubernetes/apps/bookstack/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app bookstack
  namespace: flux-system
spec:
  targetNamespace: default
  dependsOn:
    - name: mariadb
  path: "./kubernetes/apps/bookstack/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m
  postBuild:
    substitute:
      APP: *app
      VOLSYNC_CAPACITY: 512Mi

File: ./kubernetes/apps/authentik/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: authentik-secrets
    namespace: default
stringData:
    SECRET_AUTHENTIK_SECRET_KEY: null
    SECRET_AUTHENTIK_POSTGRES_PASSWORD: null
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXdXNaYU41NnRhcTJySnF6
            MXhmeURnL1kxMDNRS2l1S1pHZzhzbHArZGtzCkRUalNRc2loRDVMU0VGUzNCRzND
            YjNvd0ZUaTBITnBwUXJ4dVdQcU9zdWcKLS0tIGRxcklLVHIybVFlaXJXb1RNM2VV
            SEpDczhqaE5QaW9va3dyNGh3cXZWSnMKgWWYpDP0UHBgnzAGMLk/UzINZYj9MGIv
            r8+ioYsGOlJZ+D0rhlRDH2et9YhgRkOPZclZOAQqS5ZAi5qEx74paQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJMHBJMGVhVVdrQithZXpB
            MStqY3Avd0VIdmxQN3VSb2dIUEJqZ2FwWTM0CnZRNVp6UjhGTUpnL29FK2ZnMGtj
            VWoxa0lJRU0yY1pZMnIvM0x2R3lIYk0KLS0tIDdScmVLdURVakVFWDUvMkIySWhh
            Y2NyWUIyR28zcVhhOThyRzMwRW5Nd0kK6jzlbICX1+ajVCBr4F2HWlzCdminLCsg
            cCi1ZTXAUM1rBonQp5K4BvPxfZgPoQqpcPJxY+jwQbA5OUZ351ivzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-14T16:22:32Z"
    mac: ENC[AES256_GCM,data:DoI9u9zZSg3j/7nzmxvpgaDsOzCeyGVn+Wo5Rh5YZV7H2xVF8at9t2f52VPQJBMoQGPbECP4DQkZDBBUvTJJwBa+Ox/2vjRv4EvUSb+G1k7AHvQd5Mu0bXadgO2ZWyPfh02IPs74G4pgHtJpyE40TpzrCEN8AXf/qT8JgOU/Xjg=,iv:1DibRFxANNw8+xcUhqrCKnZqaZtZpqHyRhGXVKB77F0=,tag:hpTrXluymShsWRYmbgP+/Q==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/authentik/app/redirect-and-webfinger.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    meta.helm.sh/release-name: authentik
    nginx.ingress.kubernetes.io/permanent-redirect: https://auth.kawalink.com/.well-known/webfinger
    #nginx.ingress.kubernetes.io/configuration-snippet: |
    # return 200 '{\"subject\": null, \"links\": [{\"rel\": \"http://openid.net/specs/connect/1.0/issuer\", \"href\": \"https://auth.kawalink.com/application/o/tailscale/\"}]}';
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/instance: authentik
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authentik
    app.kubernetes.io/part-of: authentik
  name: authentik-webfinger
spec:
  ingressClassName: external
  rules:
    - host: kawalink.com
      http:
        paths:
          - backend:
              service:
                name: authentik-server
                port:
                  number: 80
            path: /.well-known/webfinger
            pathType: Exact
  tls:
    - hosts:
        - kawalink.com
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    meta.helm.sh/release-name: authentik
    nginx.ingress.kubernetes.io/permanent-redirect: https://auth.kawalink.com
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/instance: authentik
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authentik
    app.kubernetes.io/part-of: authentik
  name: authentik-root-domain-redirect
spec:
  ingressClassName: external
  rules:
    - host: kawalink.com
      http:
        paths:
          - backend:
              service:
                name: authentik-server
                port:
                  number: 80
            path: /
            pathType: Prefix
  tls:
    - hosts:
        - kawalink.com

File: ./kubernetes/apps/authentik/app/int-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: authentik-internal
  namespace: default
spec:
  ingressClassName: internal
  rules:
    - host: &host "auth.${SECRET_DOMAIN}"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: authentik-server
                port:
                  number: 80
  tls:
    - hosts:
        - *host
      secretName: "auth-${SECRET_DOMAIN/./-}-tls"

File: ./kubernetes/apps/authentik/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: authentik
  namespace: default
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 500Mi
  storageClassName: cephfs

File: ./kubernetes/apps/authentik/app/secret-init.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: authentik-init-secret
stringData:
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:ccGoeddz/82J,iv:9PB8ec9sefkVm3d9WWVoN4ynA6Kmq0j8FfcKhl4Wnjc=,tag:liEnV5nQq3VcmwNz5x3ZHw==,type:str]
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:twIqW2R3YJdM+aM9IjsCuew1CqlbOCvcPJ/c5psSlfJYL1xb9RWf9A==,iv:Yvs118KNC1MBMRLT39pDTWtlXs+OD55eHgXs+DCMnX0=,tag:PS0jD8thAwuGAJ3bdyb88A==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:ybeQpWfq1Ftf,iv:sd82vuR9/abevCl2Wf0BJqqpFmd1vWo8BZBHi2ufF6s=,tag:ddVt2DOVL7fzZlXJZzxmuQ==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:m4YhgJ3OEaNwBlkmcP5RMZcm8uhQPZa1xgtEF1VD,iv:5v5vU+7GcGkwm1wg5XSwbzuvDkTUtktJRDK+amADnnc=,tag:BR6qSpY4AtZDBGDuaAnsuw==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:ICS4MjIWWM8zT0bKjrexnVsWVkofYzh9v+HD9fLI,iv:pGfTEvW5Gz98LwR6wxT0K8ykOs4mizRZnojARwUBnwE=,tag:H17HzMk+Fqi6XpvGPtVhBQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBxWkhwamE0TDNqdXE4YWFn
            MTNSWS9Ga1dEcFlTczFPN3dYVE1Fd25UbUZRCno1eVJCcVorZUZEa0ZBcms4WXd5
            SktHUFQxZXVXeUMwWFIvU0N6UDh0RDgKLS0tIFNpMXNwQWs4MExJbEJuTW5LWFdx
            b3RhTGpBdmtxcDJxa0FCaFpjazZTdHMKn1iPhTOU8WURb6l19dFv4/GwyAOSysmR
            vntgRp43Y+c6tBzjwFelvv7hjgDBnbflm7RiwxKDfdQhDwVWqpxYSg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBNbndvVnNIL2M3OWYvK0gx
            TVA0aFc5Qm92ditOdWZ1eEVyajJRNnltbWd3Ck1WL0xTdW5GalQxTGtpbnVnY1hD
            WmhvalJ1dWw3OE9hbEs5Q0JqZ001bGMKLS0tIDN0Z3NuOHJrVVh0azdIZ1NSN2Nr
            Y0xFMGRObHlXSFFDeXVnZzNZbFJvV3MKN1SYQKGxjc/0lTiK9efAxDKqmsKFra4U
            VmxoocW4aLkUcheDmbrrcwBlT65uRMAB1bh5sQ8+6GzYVY8X1I56xA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-14T17:01:33Z"
    mac: ENC[AES256_GCM,data:z67e3qoNeIB/h2trZEYJJ3DzGQHvxtCRYIAYM+baS4PUQNqVnLvc3qcL931gOnZfnN+vOgt2hEDIR2oLVpUNOJj0zGluhL+r5qqqgoqog6hdIS9uKKc7Qu+eEZQcr6fNGeDqSsHIolgpQZoogSSU2SmcPlmK6BjKwYIdpWo85tE=,iv:dz4TFTk3uKT8NYOLDc17QrsYin6q8nPeGQGpPvrlUFc=,tag:r0t1EJHg/Ru7Nr66NpgFVA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/authentik/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./hr.yaml
  - ./int-ingress.yaml
#  - ./secret.sops.yaml
  - ./secret-init.sops.yaml
  - ./redirect-and-webfinger.yaml
  - ./pvc.yaml

File: ./kubernetes/apps/authentik/app/hr.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      version: 2024.12.0
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
      remediateLastFailure: true
    cleanupOnFail: true
  rollback:
    timeout: 10m
    recreate: true
    cleanupOnFail: true
  values:
    global:
      image:
        repository: ghcr.io/goauthentik/server
        tag: 2024.12.1
      fullnameOverride: authentik
    authentik:
      log_level: info
      avatars: "initials"
      email:
        host: "smtp-relay.default.svc.cluster.local"
        port: 587
        use_tls: false
        from: "noreply@${SECRET_DOMAIN_COMP}"
      secret_key: "${SECRET_AUTHENTIK_SECRET_KEY}"
      error_reporting:
        enable: false
        send_pii: false
      postgresql:
        host: "postgres16-rw.database.svc.cluster.local"
        name: "authentik"
        user: "authentik"
        password: "${SECRET_AUTHENTIK_POSTGRES_PASSWORD}"
      redis:
        host: "dragonfly.database.svc.cluster.local"

    server:
      replicas: 2
      initContainers:
       - name: 01-init-db
         image: ghcr.io/onedr0p/postgres-init:16
         envFrom:
              - secretRef:
                  name: authentik-init-secret
      volumes:
        - name: custom
          existingClaim: authentik
      volumeMounts:
        - name: custom
          mountPath: /media
      ingress:
        enabled: true
        ingressClassName: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hosts:
          - &host "auth.${SECRET_DOMAIN}"
        paths:
          - /
        tls:
          - hosts:
              - *host
            secretName: "auth-${SECRET_DOMAIN/./-}-tls"
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          memory: 2Gi
    worker:
      replicas: 2
      resources:
        requests:
          cpu: 50m
          memory: 512Mi
        limits:
          memory: 1Gi

File: ./kubernetes/apps/authentik/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: authentik
  namespace: flux-system
spec:
  dependsOn:
    - name: cnpg-cluster16
    - name: dragonfly-cluster
  targetNamespace: default
  path: ./kubernetes/apps/authentik/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  interval: 30m
  timeout: 5m
  wait: true

File: ./kubernetes/apps/volsync/app/operator/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - hr.yaml

File: ./kubernetes/apps/volsync/app/operator/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: volsync
  namespace: volsync-system
spec:
  interval: 30m
  chart:
    spec:
      chart: volsync
      version: 0.11.0
      sourceRef:
        kind: HelmRepository
        name: backube
        namespace: flux-system
  values:
    manageCRDs: true

File: ./kubernetes/apps/volsync/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - operator/
  - cloudflare/

File: ./kubernetes/apps/volsync/app/cloudflare/cloudflare-secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: cloudflare-secrets
    namespace: volsync-system
type: Opaque
data:
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:5AjIjy45TUIiPMT4f3pvB1g00XSw5baZtqyd8vCrs4YQSIZ+8U0EOBfy4WM=,iv:jjkLBb6RF8//swaq66DXiR0Ah6bhs3fPz2tZiFTHSCg=,tag:91L//d2LtqGB59wZGbGPtw==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:mgUpbCGqqw8N5ftqd5JSd8VSwnOUPHQETy6/MPnrHqC3jQjD/AtRoTxvLtpmORQTBmipMp8HJEhvHuTHjkpQfAlMq8Ei7c1CGsedP7CJT0tWFzET,iv:Zje179GjRL039bADcDkgWlmK0PhCZS2+GhGlC9+5Wlo=,tag:6Ukc6ymTJSxmDS4i50vTyQ==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:dbtmQMA0LIh4YbfNfV5COpkbUyJxiVgEUo46NVkEwAsvFMJjbU9C+zjfD7w=,iv:8kgZjW70pzcTsLnfVZGiTLAwQaXA+xFC0B2P3HO03RI=,tag:DQIqj7wbHE1jzNPfu9meZQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBQY05qaC9BZVdOVndSN0lQ
            WXBzK0IyQjZSaDc2Mll4SXA3THZEdWtaQ1FjCm13N2QzVno5dSsvY0preWNBNjFP
            REhrR1Y3NXowRm1tQnpLR0pjK25WVWcKLS0tIFc3SVlnc2NiaVdka2V3cnFaV1hu
            VEFyV0YvNFJ3OHB5bDcrOE51VjNKamMKWIwTjc8xV1t12V5+fpRyeJDllRD7Teqf
            MCGfC/xCEZ8lWYCjJFzSI/0YyEOegXMF285ZCDNIzZIPsuR5/bSKzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-15T16:37:49Z"
    mac: ENC[AES256_GCM,data:fUsjeHCadoKcp1DgZ8sOHtvR1ICijbJTFxidHiT+aFs1oD8nicMvkyAksnTS8KJoqAyawb+FXzb3+irbEEgEtIDCiwidRT1pfoaJAHkKr4vXy6kdw+NlYGRPbaY2pcURa0Rc0kENhEKnlIzvczCnTmOixLrnviHXvZFNCUYbyrQ=,iv:AmLbK6Y18TPZtgVKQUaZhvaOv0b9A8g/TEsKU5k3DXU=,tag:z567ZRuSx1Es6VOYl7j9qA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/volsync/app/cloudflare/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - cloudflare-secrets.sops.yaml

File: ./kubernetes/apps/volsync/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &appname volsync
  namespace: flux-system
spec:
  targetNamespace: volsync-system
  path: ./kubernetes/apps/volsync/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/rook-ceph/rook/operator/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./hr.yaml

File: ./kubernetes/apps/rook-ceph/rook/operator/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: rook-ceph-operator
  namespace: rook-ceph
spec:
  interval: 30m
  chart:
    spec:
      chart: rook-ceph
      version: v1.15.6
      sourceRef:
        kind: HelmRepository
        name: rook-release
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    logLevel: DEBUG # INFO
    csi:
      cephFSKernelMountOptions: ms_mode=secure # Set when encryption/compression is enabled
      logLevel: 4
      enableMetadata: true
    crds:
      enabled: true
    pspEnable: false
    resources:
      requests:
        cpu: 300m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

File: ./kubernetes/apps/rook-ceph/rook/ks-cluster.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: rook-ceph-cluster
  namespace: flux-system
spec:
  path: ./kubernetes/apps/rook-ceph/rook/cluster
  prune: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
    namespace: flux-system
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      name: rook-ceph-cluster
      namespace: rook-ceph
  interval: 30m
  retryInterval: 1m
  timeout: 3m

File: ./kubernetes/apps/rook-ceph/rook/ks-operator.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: rook-ceph-operator
  namespace: flux-system
spec:
  path: ./kubernetes/apps/rook-ceph/rook/operator
  prune: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
    namespace: flux-system
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      name: rook-ceph-operator
      namespace: rook-ceph
  interval: 30m
  retryInterval: 1m
  timeout: 3m

File: ./kubernetes/apps/rook-ceph/rook/cluster/media-storageclass-replicated.yaml
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
provisioner: rook-ceph.cephfs.csi.ceph.com
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
metadata:
  name: cephfs-media
parameters:
  clusterID: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-cephfs-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  fsName: QuadSquad_cephfs
  pool: QuadSquad_cephfs_Replicated

File: ./kubernetes/apps/rook-ceph/rook/cluster/media-storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
provisioner: rook-ceph.cephfs.csi.ceph.com
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
metadata:
  name: cephfs-media-ec
parameters:
  clusterID: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-cephfs-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  fsName: QuadSquad_cephfs
  pool: QuadSquad_cephfs_EC



File: ./kubernetes/apps/rook-ceph/rook/cluster/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./hr.yaml
#  - ./media-storageclass.yaml
#  - ./media-storageclass-replicated.yaml

File: ./kubernetes/apps/rook-ceph/rook/cluster/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: rook-ceph-cluster
  namespace: rook-ceph
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: rook-ceph-cluster
      version: v1.15.6
      sourceRef:
        kind: HelmRepository
        name: rook-release
        namespace: flux-system
  dependsOn:
    - name: rook-ceph-operator
  values:
    toolbox:
      enabled: true
      image: quay.io/ceph/ceph:v18.2.4
    cephClusterSpec:
      cephVersion:
        image: quay.io/ceph/ceph:v18.2.4
      external:
        enable: true
      crashCollector:
        disable: true
      healthCheck:
        daemonHealth:
          mon:
            disabled: false
            interval: 45s
      network:
        provider: host
        connections:
          encryption:
            enabled: true

    cephBlockPools: {}
    cephFileSystems: {}
    cephObjectStores: {}

File: ./kubernetes/apps/rook-ceph/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./ns.yaml
  - ./rook/ks-operator.yaml
  - ./rook/ks-cluster.yaml

File: ./kubernetes/apps/rook-ceph/ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: rook-ceph

File: ./kubernetes/apps/gpu-system/intel-device-plugin/operator/helmrelease.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: intel-device-plugin-operator
spec:
  interval: 30m
  chart:
    spec:
      chart: intel-device-plugins-operator
      version: 0.31.1
      sourceRef:
        kind: HelmRepository
        name: intel
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: node-feature-discovery
      namespace: kube-system

File: ./kubernetes/apps/gpu-system/intel-device-plugin/operator/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/gpu-system/intel-device-plugin/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app intel-device-plugin
  namespace: flux-system
spec:
  targetNamespace: gpu-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/gpu-system/intel-device-plugin/operator
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app intel-device-plugin-gpu
  namespace: flux-system
spec:
  targetNamespace: gpu-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/gpu-system/intel-device-plugin/gpu
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/gpu-system/intel-device-plugin/gpu/helmrelease.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: intel-device-plugin-gpu
spec:
  interval: 30m
  chart:
    spec:
      chart: intel-device-plugins-gpu
      version: 0.31.1
      sourceRef:
        kind: HelmRepository
        name: intel
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: intel-device-plugin-operator
      namespace: gpu-system
  values:
    name: intel-gpu-plugin
    sharedDevNum: 3
    nodeFeatureRule: false

File: ./kubernetes/apps/gpu-system/intel-device-plugin/gpu/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/gpu-system/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: gpu-system

File: ./kubernetes/apps/gpu-system/kustomization.yaml
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Pre Flux-Kustomizations
  - ./namespace.yaml
  # Flux-Kustomizations
  - ./intel-device-plugin/ks.yaml

File: ./kubernetes/apps/network/external-dns/external/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: external-dns-secret
stringData:
    api-token: ENC[AES256_GCM,data:i6KoG0CifYeCAvFxncbG8fA3otjXWlFwp5MJhvkbV8ryfJEwNynDqw==,iv:M3GCdVdpBqNHn4XPrZQKD8ZdrrasuBRfmMGSHzaxdWw=,tag:WbBwPPIE+tdO7uyHksd9jw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBjczJQcmoxTHpLMkRNNk00
            Z3h0dWt5dXpqNjhWTGR1WFdWUkdhOC9ObTJVCm1wTUNwV21QL3VwY245TkRMQlJQ
            b2FCK1lSOFpNbGVUaGpYdDZ5OHpNTlkKLS0tIEo3NExiZXA1MTdwZjlQS2s1dG1h
            OUlnU2NNUUprWkdkVDgvaEg3L3l2SUkKrCncexTgEnr1VMx5EmpKSnE6W9SVmn0/
            sq+dHZl3LAhlOp3bzk7jMr2LcCZQhA9VfoaVpMT3882SwUYUzsY1rg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-06T18:11:03Z"
    mac: ENC[AES256_GCM,data:1DBwc3wdlHfYg0pjkw95/Y7D6aQBIsxLfLlWEfccV3l+fAhoVSd0ZCWPjZbiphkcrKrht1/xzrIduJawxzAGzf3j3toaV1biguypc9p3+1OQeUD72ZxWqa8FxngWXBEFy2HdMwkpD/iDmIo7oPPf/LTnoqrqdC6gId0SY/grGFI=,iv:FRiY9AqFsPaowt+j2xPPpQtSuyG10yoLF9vmG7zWExg=,tag:kuxtpkkjbmddS+2Lehi5Lg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/network/external-dns/external/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app external-dns-cf
spec:
  interval: 30m
  chart:
    spec:
      chart: external-dns
      version: 1.15.0
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: *app
    provider: cloudflare
    env:
      - name: CF_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: external-dns-secret
            key: api-token
    extraArgs:
      - --ingress-class=external
      - --cloudflare-proxied
      - --crd-source-apiversion=externaldns.k8s.io/v1alpha1
      - --crd-source-kind=DNSEndpoint
    policy: sync
    sources: ["crd", "ingress"]
    txtPrefix: k8s.
    txtOwnerId: default
    domainFilters: ["${SECRET_DOMAIN}", "${SECRET_DOMAIN_CHAT}"]
    serviceMonitor:
      enabled: true
    podAnnotations:
      secret.reloader.stakater.com/reload: external-dns-secret

File: ./kubernetes/apps/network/external-dns/external/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/external-dns/ks-external.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app external-dns-cf
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/network/external-dns/external
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/network/external-dns/internal/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: externaldns-internal-secrets
stringData:
    bind_rndc_algorithm: ENC[AES256_GCM,data:a0wohIyHEGgPqEQ=,iv:vhAaOND5CHSYzUwrmK/DvrNRDt/mh7fxY+a8YI1B504=,tag:2RYNpbxYOF6vbhuoyu1Tcg==,type:str]
    bind_rndc_secret: ENC[AES256_GCM,data:YIEUFp0+Eb8SOJBHaCMOCbyLkSXA21ddr4V96eYnAEKn4s0YYwDDuAwZ6Ug=,iv:cWig8lELmI9aYSDuEiZxfGl+77z6C01eeMgtNSrD/Jg=,tag:zN4GLiPQRoNh5wEHFo1XEA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB2UHlVSk5hYUx2VG9pT2Fa
            Z2NXaUdQUVozRllWM29MUGduWk9EZnF1QlJnCmtja1R3cWFtMUN1aFVvamprU2Qw
            UzQ3WDBNNHl5aXB4Zk05NnpBeTJCd0EKLS0tIHd5Rm02ZGhXcHlNemdJOG9EOERB
            dERGRWsvUHB2TjBtakZRZk1DUG90b00KwneviJFA0KBRtGFQtOAIjOSlVnnmbJHH
            GfwxuRDiZdhLgeM3fZGoOfux5OFOSd9qldAfz3JMTseJ3mE1yqYgAg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBQRmVWMldmNkllMWQvRGpU
            OWNWMVM3QkxSSlRPM0VqOGcrajBrWnNYNVRjCkVVc1NxOVRkQ0tFYkxXSis0MFhM
            UmJaN2M3cFd0VFBzSzhmdEdGZEFSQXcKLS0tIGtFWlIxNnZ2R1RtZmtaTEYyaWZq
            cmh2ZmNqWDRqTWplLzNvVmNWbkRNODQKz6I2Ba3ZE9KvW7ULAL6dZec4nlVP5MkE
            XWw5ajhqdlgC+NNKg+btXQ9Kw5eIcCg9KLCxX6i+ulBDbgJCswdLrA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-27T20:46:31Z"
    mac: ENC[AES256_GCM,data:1L+KCxudUi0uieeetcG/Ny6QwF76+BRb2t3avfQBX1RTm32ykgoYaEv+NeKGfJaU6Ag7AmOKs/zuaIdapo/y/9LbY6rIB6GJwLgfbUqbciyV8W7wnYmm8+2TInUosC819s/7fWSesxhkMGp62+00R51wOTpsiYmNc2zmk5lzxkM=,iv:4Ff01TZj71M56mMkHxF2y+YruDaMa2jjmYZng9K4WQ8=,tag:yyCfEDZqfp46GvJ+hFSX9w==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/network/external-dns/internal/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app external-dns-internal
spec:
  interval: 30m
  chart:
    spec:
      chart: external-dns
      version: 1.15.0
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: *app

    domainFilters:
      - ${SECRET_DOMAIN}

    env:
    - name: EXTERNAL_DNS_RFC2136_HOST
      value: "172.16.10.3"
    - name: EXTERNAL_DNS_RFC2136_PORT
      value: "53"
    - name: EXTERNAL_DNS_RFC2136_ZONE
      value: "${SECRET_DOMAIN}"
    - name: EXTERNAL_DNS_RFC2136_TSIG_AXFR
      value: "true"
    - name: EXTERNAL_DNS_RFC2136_TSIG_KEYNAME
      value: externaldns
    - name: EXTERNAL_DNS_RFC2136_TSIG_SECRET_ALG
      valueFrom:
        secretKeyRef:
          name: externaldns-internal-secrets
          key: bind_rndc_algorithm
    - name: EXTERNAL_DNS_RFC2136_TSIG_SECRET
      valueFrom:
        secretKeyRef:
          name: externaldns-internal-secrets
          key: bind_rndc_secret

    podAnnotations:
      secret.reloader.stakater.com/reload: externaldns-internal-secrets

    policy: sync
    provider: rfc2136

    resources:
      requests:
        cpu: 16m
        memory: 90M
      limits:
        memory: 90M

    sources:
      - ingress
      - crd

    extraArgs:
      - --ingress-class=internal
      - --crd-source-apiversion=externaldns.k8s.io/v1alpha1
      - --crd-source-kind=DNSEndpoint

    txtPrefix: "k8s."
    serviceMonitor:
      enabled: true





File: ./kubernetes/apps/network/external-dns/internal/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/external-dns/ks-internal.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app external-dns-internal
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/network/external-dns/internal
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/network/cloudflared/app/configs/config.yaml
---
originRequest:
  originServerName: "external.${SECRET_DOMAIN}"

ingress:
  - hostname: "${SECRET_DOMAIN}"
    service: https://ingress-nginx-external-controller.network.svc.cluster.local:443
  - hostname: "*.${SECRET_DOMAIN}"
    service: https://ingress-nginx-external-controller.network.svc.cluster.local:443
  - hostname: "${SECRET_DOMAIN_CHAT}"
    service: https://ingress-nginx-external-controller.network.svc.cluster.local:443
  - hostname: "*.${SECRET_DOMAIN_CHAT}"
    service: https://ingress-nginx-external-controller.network.svc.cluster.local:443
  - service: http_status:404

File: ./kubernetes/apps/network/cloudflared/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: cloudflared-secret
stringData:
    TUNNEL_ID: ENC[AES256_GCM,data:odtqmw2uMIrogBtjejAoYtT1VSAK56I4S2GHGcDrlf+Ox5b8,iv:ETfTrxtk8xvlbpbtEesvnD3I3L2UFLHWGVJnLh4B7Wo=,tag:flO+1c+0qQ4Wad7My4YGPQ==,type:str]
    credentials.json: ENC[AES256_GCM,data:8mXPGLS5sEnoVCgb8/0TUUZJqtfActHElWHNmYbEsHtoiKhHY2ZJx1ZPdR/XWpAOoa9speMsIPQjLLXcseGOy/3EeFOPA6QmwIn/L9LF6yBSBPnSLwiaeVN7EgLTod0xSgsLRnU00wAx8djKtIlaPoAGIliAuiLX9NlG36rY7NF8TC89zs9sI6CjylE//m88tFhzFKEAJ/R0QtTNYvlh2Vvv0mx2fZ+m15UMvThqBQ==,iv:PloJ6RdnVlz5rZPY9yXlsd41ul7Ad6vB61EOGtPQBsw=,tag:KfU/vqMREYC8y4KecfgTcg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB4dS9TYlhkS1NkcW81MWIw
            cGM0bEY5Uy9jbDdxOURrcENIbHUzeWJsVWdRCmFUMUJvTEh4Y3FlaVdOWjRMb0hQ
            UXVORFdObEF2N2Q5aEIvVDNZWjZrMU0KLS0tIHhWUFhkRllCaWo0V0JhL1FjcTY0
            THVJb3BtRUwzS1B0cVNZM0tyTmptdXMKhMHHiiCPWhMnZlY8b0Wtde3df1Xgdeba
            Or21ffT1Hj2RzLgFFt+eE6kUHl4i74bhWoxhqHH+Zh6MkFAL3FAT1A==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-06T18:11:03Z"
    mac: ENC[AES256_GCM,data:hRrwbZQhA0YPUsMWM4/I1bvJtl3fhCxrgPHcN+2RM2HRnF9F0o82Bhc8CSyjoHWcVKlnEOi0Zl17yumhVdaE0OIJATk5eb6k2PQVQcj2lq8RTTnpXKAhEEmGoUGtkx2H5FYaU1EBTgicjJuEw+QM9UnwO2svpMuAUhXBl/1RJGo=,iv:+aOLwVwwedntLFzWgyGYg83xgod82GB18Chfrxy3Qq0=,tag:nl3hRynluEJIQYGrKHy0ww==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/network/cloudflared/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudflared
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      cloudflared:
        strategy: RollingUpdate
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: docker.io/cloudflare/cloudflared
              tag: 2025.1.0
            env:
              NO_AUTOUPDATE: true
              TUNNEL_CRED_FILE: /etc/cloudflared/creds/credentials.json
              TUNNEL_METRICS: 0.0.0.0:8080
              TUNNEL_ORIGIN_ENABLE_HTTP2: true
              TUNNEL_TRANSPORT_PROTOCOL: quic
              TUNNEL_POST_QUANTUM: true
              TUNNEL_ID:
                valueFrom:
                  secretKeyRef:
                    name: cloudflared-secret
                    key: TUNNEL_ID
            args:
              - tunnel
              - --config
              - /etc/cloudflared/config/config.yaml
              - run
              - "$(TUNNEL_ID)"
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ready
                    port: &port 8080
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 256Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: cloudflared
        ports:
          http:
            port: *port
    serviceMonitor:
      app:
        serviceName: cloudflared
        endpoints:
          - port: http
            scheme: http
            path: /metrics
            interval: 1m
            scrapeTimeout: 10s
    persistence:
      config:
        type: configMap
        name: cloudflared-configmap
        globalMounts:
          - path: /etc/cloudflared/config/config.yaml
            subPath: config.yaml
            readOnly: true
      creds:
        type: secret
        name: cloudflared-secret
        globalMounts:
          - path: /etc/cloudflared/creds/credentials.json
            subPath: credentials.json
            readOnly: true

File: ./kubernetes/apps/network/cloudflared/app/dnsendpoint.yaml
---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: cloudflared
spec:
  endpoints:
    - dnsName: "external.${SECRET_DOMAIN}"
      recordType: CNAME
      targets: ["${SECRET_CLOUDFLARE_TUNNEL_ID}.cfargotunnel.com"]

File: ./kubernetes/apps/network/cloudflared/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./dnsendpoint.yaml
  - ./secret.sops.yaml
  - ./helmrelease.yaml
configMapGenerator:
  - name: cloudflared-configmap
    files:
      - ./configs/config.yaml
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/network/cloudflared/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app cloudflared
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: external-dns-cf
  path: ./kubernetes/apps/network/cloudflared/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/network/ingress-nginx/external/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ingress-nginx-external
spec:
  interval: 30m
  chart:
    spec:
      chart: ingress-nginx
      version: 4.12.0
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  dependsOn:
    - name: cloudflared
      namespace: network
  values:
    fullnameOverride: ingress-nginx-external
    controller:
      service:
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "external.${SECRET_DOMAIN}"
          io.cilium/lb-ipam-ips: "10.10.12.247"
        externalTrafficPolicy: Cluster
      ingressClassResource:
        name: external
        default: false
        controllerValue: k8s.io/external
      admissionWebhooks:
        objectSelector:
          matchExpressions:
            - key: ingress-class
              operator: In
              values: ["external"]
      config:
        client-body-buffer-size: 100M
        client-body-timeout: 120
        client-header-timeout: 120
        enable-brotli: "true"
        enable-real-ip: "true"
        hsts-max-age: 31449600
        keep-alive-requests: 10000
        keep-alive: 120
        log-format-escape-json: "true"
        log-format-upstream: >
          {"time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for",
          "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time,
          "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args",
          "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer",
          "http_user_agent": "$http_user_agent"}
        proxy-body-size: 0
        proxy-buffer-size: 16k
        ssl-protocols: TLSv1.3 TLSv1.2
        hide-headers: Server,X-Powered-By
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          namespaceSelector:
            any: true
      extraArgs:
        default-ssl-certificate: "network/${SECRET_DOMAIN/./-}-production-tls"
      resources:
        requests:
          cpu: 100m
          memory: 2Gi
        limits:
          memory: 4Gi

File: ./kubernetes/apps/network/ingress-nginx/external/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/ingress-nginx/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app ingress-nginx-certificates
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: cert-manager-issuers
  path: ./kubernetes/apps/network/ingress-nginx/certificates
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app ingress-nginx-internal
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: ingress-nginx-certificates
  path: ./kubernetes/apps/network/ingress-nginx/internal
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app ingress-nginx-external
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: ingress-nginx-certificates
  path: ./kubernetes/apps/network/ingress-nginx/external
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/network/ingress-nginx/certificates/legacy.yaml
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "${SECRET_DOMAIN_LEGACY/./-}-production"
spec:
  secretName: "${SECRET_DOMAIN_LEGACY/./-}-production-tls"
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  commonName: "${SECRET_DOMAIN_LEGACY}"
  dnsNames:
    - "${SECRET_DOMAIN_LEGACY}"
    - "*.${SECRET_DOMAIN_LEGACY}"
  secretTemplate:
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "media"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"

File: ./kubernetes/apps/network/ingress-nginx/certificates/production.yaml
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "${SECRET_DOMAIN/./-}-production"
spec:
  secretName: "${SECRET_DOMAIN/./-}-production-tls"
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  commonName: "${SECRET_DOMAIN}"
  dnsNames:
    - "${SECRET_DOMAIN}"
    - "*.${SECRET_DOMAIN}"

File: ./kubernetes/apps/network/ingress-nginx/certificates/staging.yaml
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "${SECRET_DOMAIN/./-}-staging"
spec:
  secretName: "${SECRET_DOMAIN/./-}-staging-tls"
  issuerRef:
    name: letsencrypt-staging
    kind: ClusterIssuer
  commonName: "${SECRET_DOMAIN}"
  dnsNames:
    - "${SECRET_DOMAIN}"
    - "*.${SECRET_DOMAIN}"

File: ./kubernetes/apps/network/ingress-nginx/certificates/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./staging.yaml
  - ./production.yaml
  - ./legacy.yaml

File: ./kubernetes/apps/network/ingress-nginx/internal/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ingress-nginx-internal
  namespace: network
spec:
  interval: 30m
  chart:
    spec:
      chart: ingress-nginx
      version: 4.12.0
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    fullnameOverride: ingress-nginx-internal
    controller:
      service:
        annotations:
          io.cilium/lb-ipam-ips: "10.10.12.246"
        externalTrafficPolicy: Cluster
      ingressClassResource:
        name: internal
        default: true
        controllerValue: k8s.io/internal
      admissionWebhooks:
        objectSelector:
          matchExpressions:
            - key: ingress-class
              operator: In
              values: ["internal"]
      config:
        client-body-buffer-size: 100M
        client-body-timeout: 120
        client-header-timeout: 120
        enable-brotli: "true"
        enable-real-ip: "true"
        hsts-max-age: 31449600
        keep-alive-requests: 10000
        keep-alive: 120
        log-format-escape-json: "true"
        log-format-upstream: >
          {"time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for",
          "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time,
          "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args",
          "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer",
          "http_user_agent": "$http_user_agent"}
        proxy-body-size: 0
        proxy-buffer-size: 16k
        ssl-protocols: TLSv1.3 TLSv1.2
        hide-headers: Server,X-Powered-By
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          namespaceSelector:
            any: true
      extraArgs:
        default-ssl-certificate: "network/${SECRET_DOMAIN/./-}-production-tls"
      resources:
        requests:
          cpu: 100m
        limits:
          memory: 2Gi

File: ./kubernetes/apps/network/ingress-nginx/internal/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: network
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/network/unimus/unimus/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unimus
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    controllers:
      unimus:
        type: deployment
        replicas: 1
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          app:
            image:
              repository: croc/unimus
              tag: 2.6.1
            env:
              TZ: "America/New_York"
              JAVA_OPTS: "-Xms256M -Xmx1024M -Dunimus.core.connect-timeout=20000 -Dunimus.core.inter-connection-delay=1000 -Dunimus.core.cli-expect-timeout=30000"
            resources:
              requests:
                memory: 256Mi
              limits:
                memory: 1Gi
    service:
      main:
        controller: unimus
        ports:
          http:
            port: 8085
    ingress:
      main:
        enabled: true
        className: internal
        hosts:
          - host: "${HOSTNAME}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: 8085
        tls:
          - hosts:
              - "${HOSTNAME}"


    persistence:
      data:
        enabled: true
        existingClaim: "${VOLSYNC_CLAIM}"
        globalMounts:
          - path: /etc/unimus/





File: ./kubernetes/apps/network/unimus/unimus/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/unimus/unimus/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app unimus
  namespace: flux-system
spec:
  targetNamespace: &ns network
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/network/unimus/unimus/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: unimus-pvc
    - name: rook-ceph-cluster
    - name: volsync
  wait: false
  postBuild:
    substitute:
      HOSTNAME: "unimus.${SECRET_DOMAIN}"
      APP: unimus
      VOLSYNC_CLAIM: unimus-storage


File: ./kubernetes/apps/network/unimus/pvc/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: unimus-volsync-r2-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:oKEilDrA77tQYd0YSmV5mMR/D0/qCWFOeCq7lJFyLE6+AdE5XiQfLxbqa8RX8VNM4B3N3uWxDIIy9OgyeDIoAbzlEHwLUX7Jq8NT8FKWZ3EoKTELmIBOpw==,iv:PafO7IMAygahOjOFiF/MGwzJYryQ/TliInSz8qMQHSM=,tag:96GxR8SzAqzGbpLhY61V0Q==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:Q+ndNbsIXdkZZRAODTlQjIqQhWYIB7eUd9zsENi2Z7c=,iv:e9ErKQR3hyDhF8toXyw97H+imsopHgCh95CHF2hxtug=,tag:zoy5uLHMIhUdtnEgEsrSRg==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:zhF3j10dQoS4ncBKESUzbgZlzMPMFdoknq/6VbWSGpk=,iv:ar/wCOLRZnWwxaLwzs5KpimXNRi5dJRadCz/8p99o6A=,tag:INvB58Ylc1aoETSrNfn5/g==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:v+mYxTKldQYIWTUeepo8dtPJTGS1ruRTJDaAINxUnIuuQW88D4MDaaJGmDt+08FTXckVtjtjknrtg8Iuk82Lgw==,iv:WieXkge0pCGhg/FM6kafHEB+QYZ79K1li3Uil0sM9hk=,tag:8PsvcucoCBKkxwzQjkCq9A==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBoTjVQYTVGbTdzS1ZlTkNM
            dnVTT1JHQ2plZ2RZRkZSKzI4V2JUZTREMmlFCk03QXRmMUJmb1lnK2hXKzNoSFEy
            dHUvYzlnVmxuQkUzT25LUUI2K3Y2NUUKLS0tIG1PbnA1c1QyMTFXbWxXTnE5OFpy
            NkRUOEV0NzlGcjRMcDB0dTRvaGNiblEKAuba0i4gkCvkuxSpKSRbACJvYJLzT3Gr
            O+aj8ikCWJQCD1C3HZDSwsX+ukKzFmbpZBYYvZ/FzNqJ8pNTTIoc2w==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBFN1NCWS8vZ1pleGpwSGU0
            WDRrZG5GRlhWa3JKTzZSRDNsak9QbGRnaFdZCkpBUTJEMitHSHZKeEpIUmlKaHMv
            WEtYU251NGdRdnMvZ2JQSE1wQkRpVkEKLS0tIE9XVW10TnJNVXkrRmpXbWR6ZkpS
            RzhTUlNXS0NSc2JuVHVjSG5tWnJlbFEKjQINLG3W5dqWgGMXE+wYYHsD0wwCv5w8
            w4tgKdYu3/BURc86DNh9433oXV1b7BxXsqzP3vIZYFse81+vvaY4lw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-17T00:16:15Z"
    mac: ENC[AES256_GCM,data:bNbGVpbuED7KbHeswvKcIOmR2qCjZZBuNICddgjSKNSukw6kOCCF+aXRRvlStJ2yCCHwaLm4EJRun8GXw8bLhH01wS8KsmjUI+Ka2gRwXvG6a+CXaK9ofLf0E7NpUcAoyR+kFeYEw9UlnCu69zrfTaas024AvwlL0VKwgVglOGg=,iv:JjEXY6W1zKGLW3pC0eJLrd9LsbR8nd96dwAGF1hvWhI=,tag:nCcE0HIIK44de1vn2+tZsg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/network/unimus/pvc/app/replicationdestination.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: unimus-storage-bootstrap
  namespace: invoiceninja
spec:
  restic:
    accessModes:
    - ReadWriteOnce
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    capacity: "${VOLSYNC_CAPACITY:-1Gi}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 568
      runAsGroup: 568
      runAsUser: 568
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    manual: restore-once

File: ./kubernetes/apps/network/unimus/pvc/app/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: unimus
spec:
  sourcePVC: "${VOLSYNC_CLAIM:-${APP}}"
  restic:
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 568
      runAsGroup: 568
      runAsUser: 568
    pruneIntervalDays: 7
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    retain:
      daily: 7
      weekly: 4
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    schedule: "0 4 * * *"

File: ./kubernetes/apps/network/unimus/pvc/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${APP}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"


File: ./kubernetes/apps/network/unimus/pvc/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - replicationdestination.yaml
  - replicationsource.yaml
  - secret.sops.yaml

File: ./kubernetes/apps/network/unimus/pvc/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app unimus-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns network
  interval: 10m
  path: "./kubernetes/apps/network/unimus/pvc/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  dependsOn:
    - name: volsync
  postBuild:
    substitute:
      APP: unimus-storage
      APP_NS: *ns
      VOLSYNC_CLAIM: unimus-storage
      VOLSYNC_CAPACITY: 2Gi
      VOLSYNC_ACCESSMODES: ReadWriteOnce
      VOLSYNC_STORAGECLASS: cephfs
      VOLSYNC_SNAPSHOTCLASS: csi-ceph-filesystem
      VOLSYNC_REPOSITORY_SECRET: unimus-volsync-r2-secret

File: ./kubernetes/apps/network/unimus/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc/ks.yaml
  - unimus/ks.yaml

File: ./kubernetes/apps/network/multus/app/networkattachment.yaml
---
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: macvlan-lan
spec:
  config: |-
    {
      "cniVersion": "0.3.1",
      "name": "macvlan-lan",
      "plugins": [
        {
          "type": "macvlan",
          "master": "bond0",
          "mode": "bridge",
          "capabilities": {
            "ips": true
          },
          "ipam": {
            "type": "static"
          }
        }
      ]
    }

File: ./kubernetes/apps/network/multus/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: multus
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      chart: multus
      version: 5.0.7
      sourceRef:
        kind: HelmRepository
        name: angelnu-charts
        namespace: flux-system
      interval: 30m
  values:
    image:
      repository: ghcr.io/k8snetworkplumbingwg/multus-cni
      tag: v4.1.4-thick
    cni:
      image:
        repository: ghcr.io/angelnu/cni-plugins
        tag: 1.5.1
      paths:
        bin: /opt/cni/bin
        config: /etc/cni/net.d
    resources:
      requests:
        cpu: 10m
      limits:
        memory: 128Mi
    hostPaths:
      netns: /var/run/netns

File: ./kubernetes/apps/network/multus/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helmrelease.yaml
  - networkattachment.yaml

File: ./kubernetes/apps/network/multus/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app multus
  namespace: flux-system
spec:
  targetNamespace: kube-system
  interval: 10m
  path: ./kubernetes/apps/network/multus/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true

File: ./kubernetes/apps/network/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./cloudflared/ks.yaml
  - ./echo-server/ks.yaml
  - ./external-dns/ks-external.yaml
  - ./external-dns/ks-internal.yaml
  - ./ingress-nginx/ks.yaml
  - ./k8s-gateway/ks.yaml
  #  - ./multus/ks.yaml
  - ./unimus

File: ./kubernetes/apps/network/echo-server/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: echo-server
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      echo-server:
        strategy: RollingUpdate
        containers:
          app:
            image:
              repository: ghcr.io/mendhak/http-https-echo
              tag: 35
            env:
              HTTP_PORT: &port 8080
              LOG_WITHOUT_NEWLINE: true
              LOG_IGNORE_PATH: /healthz
              PROMETHEUS_ENABLED: true
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 64Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: echo-server
        ports:
          http:
            port: *port
    serviceMonitor:
      app:
        serviceName: echo-server
        endpoints:
          - port: http
            scheme: http
            path: /metrics
            interval: 1m
            scrapeTimeout: 10s
    ingress:
      app:
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hosts:
          - host: "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
      int:
        className: internal
        hosts:
          - host: "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http

File: ./kubernetes/apps/network/echo-server/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/echo-server/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app echo-server
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/network/echo-server/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/network/k8s-gateway/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: k8s-gateway
spec:
  interval: 30m
  chart:
    spec:
      chart: k8s-gateway
      version: 2.4.0
      sourceRef:
        kind: HelmRepository
        name: k8s-gateway
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    fullnameOverride: k8s-gateway
    domain: "${SECRET_DOMAIN},${SECRET_DOMAIN_LEGACY} "
    ttl: 1
    service:
      type: LoadBalancer
      port: 53
      annotations:
        io.cilium/lb-ipam-ips: "10.10.12.249"
      externalTrafficPolicy: Cluster
    watchedResources: ["Ingress", "Service"]

File: ./kubernetes/apps/network/k8s-gateway/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/network/k8s-gateway/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app k8s-gateway
  namespace: flux-system
spec:
  targetNamespace: network
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/network/k8s-gateway/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/zammad/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zammad-postgres-secrets
stringData:
    postgresql-pass: ENC[AES256_GCM,data:k6Hnup5mj3OSVwFJWyI0oxKGzcW2x+Grd4ukl2OpJhQ=,iv:lPj+7wqlCKOGue+wHnPME3D0BOAqpTjuD8KEWcq/1ik=,tag:IsjZzlgmQIJOUg+enApqLA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBMa1drVitTczIyWHNPeDJ3
            TTJnR3FVczlQZU1mRGhpQ3FZMVpaL21CZFJRCmg5eDhBeFJjWWFXbUYvTGJkT2J5
            VUh5VEM2dVFERXFabm5LK3pDcVJLYmsKLS0tIDdXRWdlR0hhZmhqSDRoM29wRHVS
            L1lBcW8xdkNLZTlIdkZmaFllNWNhK2sK8a5jvox2nMmFRQPEfL4hyDeYjjHGynqV
            Nb2eZC72YuueuG/cno00Vc/NxZYd0XzV8zeDInAzYM2477fhIv/zjQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBMdkZpeVFRYnJ0REk3TDYx
            SGZqbU1XUFlKd251ODB3WkR4RmNTclJ3VzNFCndPVUtlY25uZW9jUDRVWjVyZWdm
            QmtqMFVoclBwOTJzNGwzVTlPK0hSZGMKLS0tIEcycmlZbU02OXNYakVwaWxuMUlu
            T1RwR0tSLzdxSlR5NUtUeGdhSWFyc0UKXo6wl3qtfm26IG1y60aVyR7i0BwoiJKd
            5MLWhjt4rQ8ABO6EIYnYA2+8svPK5ctnXMAQvq7Tn9ez4SSpuk1IMQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-05T10:26:15Z"
    mac: ENC[AES256_GCM,data:OJgKA0xosinNusRjjyD7j46vfksyWuZUe4QEC6/C/2cvZrL+1wr9TO2LZbmfy3VIBOTs2vHEL6ibR384hDKgsLw+jWaxdCL+aXbvEb6Psf2jzffSlUjdGrBzC+Hd/hKq2bap/9wYvyXr16p3E7Dix9uKcLkXOOStSi9IH45h/K0=,iv:Yfec9aQXSnw1i6JT4AeTF1YPmlY95fzulnLj7FCxlIc=,tag:9gi2fE73QtkaFcugK8SE2Q==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/zammad/app/helm-release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app zammad
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: zammad
      version: 13.0.6
      sourceRef:
        kind: HelmRepository
        name: zammad
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    image:
      repository: ghcr.io/zammad/zammad
      tag: "6.4@sha256:a4bf8050636d55fab510fdafd8db0311627caeceaeca119fa5e1887e718da6e7"

    service:
      type: ClusterIP
      port: 8080

    ingress:
      enabled: true
      className: "external"
      annotations:
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        nginx.ingress.kubernetes.io/proxy-body-size: 100M
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
      hosts:
        - host: &host helpdesk.${SECRET_DOMAIN}
          paths:
            - path: /
              pathType: ImplementationSpecific
      tls:
        - hosts:
            - *host

    zammadConfig:
      elasticsearch:
        enabled: true
        clusterName: zammad
        image:
          repository: docker.elastic.co/elasticsearch/elasticsearch
          tag: "7.8.0"
        coordinating:
          replicaCount: 0
        data:
          replicaCount: 0
        ingest:
          replicaCount: 0
        master:
          heapSize: 512m
          masterOnly: false
          replicaCount: 2
          resources:
            requests:
              cpu: 2
              memory: 6Gi
            limits:
              cpu: 4
              memory: 8Gi

      postgresql:
        enabled: false
        db: zammad
        host: postgres16-rw.database.svc.cluster.local
        user: zammad

    # Note: Passwords should not contain special characters requiring URL encoding
    secrets:
      autowizard:
        useExisting: false
        secretKey: autowizard
        secretName: autowizard
      elasticsearch:
        useExisting: false
        secretKey: password
        secretName: elastic-credentials
      postgresql:
        useExisting: true
        secretKey: postgresql-pass
        secretName: zammad-postgres-secrets
      redis:
        useExisting: false
        secretKey: redis-password
        secretName: redis-pass

File: ./kubernetes/apps/zammad/app/ingress-int.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zammad-int
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 100M
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
  labels:
    app.kubernetes.io/instance: zammad
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: zammad
    helm.sh/chart: zammad-12.4.1
    helm.toolkit.fluxcd.io/name: zammad
    helm.toolkit.fluxcd.io/namespace: default
spec:
  ingressClassName: internal
  rules:
    - host: helpdesk.${SECRET_DOMAIN}
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: zammad-nginx
                port:
                  number: 8080
  tls:
    - hosts:
        - helpdesk.${SECRET_DOMAIN}
      secretName: helpdesk.${SECRET_DOMAIN}-tls

File: ./kubernetes/apps/zammad/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml
  - secret.sops.yaml
  - ingress-int.yaml

File: ./kubernetes/apps/zammad/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app zammad
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/zammad/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false


File: ./kubernetes/apps/nfs-subdir-provisioner/app/helm-release.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nfs-subdir-provisioner
spec:
  interval: 5m
  chart:
    spec:
      chart: nfs-subdir-external-provisioner
      version: 4.0.18
      sourceRef:
        kind: HelmRepository
        name: nfs-subdir-external-provisioner
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner
      tag: v4.0.2
    nfs:
      server: "192.168.90.101"
      # path: "TBD"
    mountOptions:
    - nfsvers=3
    - tcp
    - intr
    - hard
    - noatime
    - nodiratime
    storageClass:
      defaultClass: false
      archiveOnDelete: true

File: ./kubernetes/apps/nfs-subdir-provisioner/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- helm-release.yaml

File: ./kubernetes/apps/nfs-subdir-provisioner/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: nfs-subdir-provisioner
  namespace: flux-system
spec:
  targetNamespace: kube-system
  path: ./kubernetes/apps/nfs-subdir-provisioner/app/
  prune: true
  wait: true # Something might depend on this to be ready
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/misc-pvcs/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./emulation-pvc.yaml
  - ./other-pvc.yaml

File: ./kubernetes/apps/misc-pvcs/app/other-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: other-pvc-v1
spec:
  resources:
    requests:
      storage: 2Ti
  accessModes:
    - ReadWriteMany
  storageClassName: cephfs-media

File: ./kubernetes/apps/misc-pvcs/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app misc-pvcs
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/misc-pvcs/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false


File: ./kubernetes/apps/observability/prometheus-operator-crds/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prometheus-operator-crds
spec:
  interval: 30m
  chart:
    spec:
      chart: prometheus-operator-crds
      version: 17.0.2
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

File: ./kubernetes/apps/observability/prometheus-operator-crds/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/observability/prometheus-operator-crds/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app prometheus-operator-crds
  namespace: flux-system
spec:
  targetNamespace: observability
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/observability/prometheus-operator-crds/app
  prune: false # never should be deleted
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/observability/kube-prometheus-stack/app/scrapeconfig.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/scrapeconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: &name node-exporter
spec:
  staticConfigs:
    - targets:
        - 192.168.90.101:9100
  metricsPath: /metrics
  relabelings:
    - action: replace
      targetLabel: job
      replacement: *name

File: ./kubernetes/apps/observability/kube-prometheus-stack/app/helm-release.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  interval: 30m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 67.1.0
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  install:
    crds: Skip
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: Skip
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: prometheus-operator-crds
      namespace: observability
    - name: rook-ceph-cluster
      namespace: rook-ceph
  values:
    crds:
      enabled: false
    cleanPrometheusOperatorObjectNames: true
    alertmanager:
      enabled: true
      ingress:
        enabled: true
        ingressClassName: internal
        hosts: ["prom-alerts.${SECRET_DOMAIN}"]
        pathType: Prefix
        tls:
          - hosts:
            - prom-alers.${SECRET_DOMAIN}
      alertmanagerSpec:
        alertmanagerConfiguration:
          name: alertmanager
          global:
            resolveTimeout: 5m
        externalUrl: https://prom-alerts.${SECRET_DOMAIN}
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: ceph-rbd
              resources:
                requests:
                  storage: 1Gi
    kubeApiServer:
      serviceMonitor:
        selector:
          k8s-app: kube-apiserver
    kubeScheduler:
      service:
        selector:
          k8s-app: kube-scheduler
    kubeControllerManager: &kubeControllerManager
      service:
        selector:
          k8s-app: kube-controller-manager
    kubeEtcd:
      <<: *kubeControllerManager # etcd runs on control plane nodes
    kubeProxy:
      enabled: false
    nodeExporter:
      enabled: true
    prometheus:
      ingress:
        enabled: true
        ingressClassName: internal
        hosts: ["prometheus.${SECRET_DOMAIN}"]
        pathType: Prefix
        tls:
          - hosts:
            - prometheus.${SECRET_DOMAIN}
      prometheusSpec:
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false
        scrapeConfigSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        enableAdminAPI: true
        walCompression: true
        enableFeatures:
          - memory-snapshot-on-shutdown
        retention: 14d
        retentionSize: 50GB
        resources:
          requests:
            cpu: 200m
          limits:
            memory: 2000Mi
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: ceph-rbd
              resources:
                requests:
                  storage: 50Gi
    prometheus-node-exporter:
      fullnameOverride: node-exporter
      prometheus:
        monitor:
          enabled: true
          relabelings:
            - action: replace
              regex: (.*)
              replacement: $1
              sourceLabels: ["__meta_kubernetes_pod_node_name"]
              targetLabel: kubernetes_node
    kubeStateMetrics:
      enabled: true
    kube-state-metrics:
      fullnameOverride: kube-state-metrics
      metricLabelsAllowlist:
        - pods=[*]
        - deployments=[*]
        - persistentvolumeclaims=[*]
      prometheus:
        monitor:
          enabled: true
          relabelings:
            - action: replace
              regex: (.*)
              replacement: $1
              sourceLabels: ["__meta_kubernetes_pod_node_name"]
              targetLabel: kubernetes_node
    grafana:
      enabled: false
      forceDeployDashboards: true
    additionalPrometheusRulesMap:
      dockerhub-rules:
        groups:
          - name: dockerhub
            rules:
              - alert: DockerhubRateLimitRisk
                annotations:
                  summary: Kubernetes cluster Dockerhub rate limit risk
                expr: count(time() - container_last_seen{image=~"(docker.io).*",container!=""} < 30) > 100
                labels:
                  severity: critical
      oom-rules:
        groups:
          - name: oom
            rules:
              - alert: OomKilled
                annotations:
                  summary: Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.
                expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m >= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
                labels:
                  severity: critical

File: ./kubernetes/apps/observability/kube-prometheus-stack/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml
  - ./scrapeconfig.yaml

File: ./kubernetes/apps/observability/kube-prometheus-stack/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app kube-prometheus-stack
  namespace: flux-system
spec:
  targetNamespace: observability
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/observability/kube-prometheus-stack/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  timeout: 5m
  postBuild:
    substitute:
      APP: *app

File: ./kubernetes/apps/observability/zabbix/ks-pvc.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app zabbix-server-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns observability
  interval: 10m
  path: "./kubernetes/apps/observability/zabbix/volsync-pvc"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  dependsOn:
    - name: volsync
    - name: zabbix-secrets
  postBuild:
    substitute:
      APP_NS: *ns
      VOLSYNC_CLAIM: zabbix-storage
      VOLSYNC_CAPACITY: 1Gi
      VOLSYNC_ACCESSMODES: ReadWriteMany
      VOLSYNC_STORAGECLASS: cephfs
      VOLSYNC_SNAPSHOTCLASS: csi-ceph-filesystem
      VOLSYNC_REPOSITORY_SECRET: zabbix-volsync-r2-storage-pvc-secret

File: ./kubernetes/apps/observability/zabbix/web/helm-release.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app zabbix-web
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1997
        runAsGroup: 1995
        fsGroup: 1995
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [20, 1995, 1000, 0]
        seccompProfile: { type: RuntimeDefault }
    controllers:
      zabbix-web:
        type: deployment
        replicas: 1

        containers:
          web:
           image:
            repository: zabbix/zabbix-web-nginx-pgsql
            tag: alpine-7.2.1
           env:
            ZBX_SERVER_HOST: zabbix-server.observability.svc.cluster.local
            ZBX_SSO_SP_CERT: /var/lib/zabbix/certs/sp.crt
            ZBX_SSO_IDP_CERT: /var/lib/zabbix/certs/sp.crt
            ZBX_SSO_SP_KEY: /var/lib/zabbix/certs/sp.key
           envFrom:
            - secretRef:
                name: zabbix-secrets
    service:
      zabbix-web:
        controller: *app
        type: ClusterIP
        ports:
          http:
            port: 8080
            protocol: TCP
          http-alt:
            port: 8443
            protocol: TCP
    ingress:
      app:
        className: internal
        hosts:
          - host: "zabbix.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: zabbix-web
                  port: http
    persistence:
      tmp:
        type: emptyDir
      certs:
        globalMounts:
          - path: /usr/share/zabbix/conf/certs/
            subPath: certs
        existingClaim: zabbix-storage

File: ./kubernetes/apps/observability/zabbix/web/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./kubernetes/apps/observability/zabbix/volsync-pvc/replicationdestination.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: ${VOLSYNC_CLAIM}-bootstrap
spec:
  restic:
    accessModes:
    - ReadWriteOnce
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    capacity: "${VOLSYNC_CAPACITY:-1Gi}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    manual: restore-once

File: ./kubernetes/apps/observability/zabbix/volsync-pvc/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: ${VOLSYNC_CLAIM:-${APP}}
spec:
  sourcePVC: "${VOLSYNC_CLAIM:-${APP}}"
  restic:
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    pruneIntervalDays: 7
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    retain:
      daily: 7
      weekly: 4
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    schedule: "0 4 * * *"

File: ./kubernetes/apps/observability/zabbix/volsync-pvc/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${VOLSYNC_CLAIM}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"


File: ./kubernetes/apps/observability/zabbix/volsync-pvc/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - replicationdestination.yaml
#  - replicationsource.yaml

File: ./kubernetes/apps/observability/zabbix/ks-secrets.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: zabbix-secrets
  namespace: flux-system
spec:
  targetNamespace: observability
  path: ./kubernetes/apps/observability/zabbix/secrets
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  prune: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/observability/zabbix/server/helm-release.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app zabbix-server
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1997
        runAsGroup: 1995
        fsGroup: 1995
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [20, 1995, 1000, 0]
        seccompProfile: { type: RuntimeDefault }
    controllers:
      zabbix-server:
        type: statefulset

        initContainers:
          01-init-db:
            image:
              repository:  ghcr.io/onedr0p/postgres-init
              tag: 16.4
            envFrom:
              - secretRef:
                  name: zabbix-init-secrets


        containers:
          server:
            image:
              repository: zabbix/zabbix-server-pgsql
              tag: alpine-7.2.1
            envFrom:
              - secretRef:
                  name: zabbix-secrets
    service:
      zabbix:
        controller: *app
        type: LoadBalancer
        ports:
          http:
            enabled: false
            port: 80
          agent-udp:
            port: 10051
            protocol: UDP
          agent-tcp:
            port: 10051
            protocol: TCP

    persistence:
      config:
        globalMounts:
          - path: /var/lib/zabbix
          - path: /usr/share/zabbix/conf/certs/
            subPath: certs
        existingClaim: zabbix-storage

File: ./kubernetes/apps/observability/zabbix/server/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./kubernetes/apps/observability/zabbix/ks-server.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: zabbix-server
  namespace: flux-system
spec:
  targetNamespace: observability
  path: ./kubernetes/apps/observability/zabbix/server
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: zabbix-secrets
    - name: zabbix-server-pvc
    - name: rook-ceph-cluster
  wait: true
  prune: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/observability/zabbix/secrets/volsync-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zabbix-volsync-r2-storage-pvc-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:P4BgyrN7Id+bmSJih3TbU3QxYzYtLkUFL8SOE/DBAodDG4csv619oc2w2ydz/lY4W4j/dMFk47qJL5PhMprQWvtva1fE62McUXVHrTnWJzBE1eYdcBfOhULpeBFw+w==,iv:7sYGA2evp6Pmr6wwhO0z6vd1WhgnYXdTPD1Ipji5e7k=,tag:ZsZrCQbeGy57s6bbhnaBlw==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:e4snhRu01lUNd9dQb2iZvaApQuY8WoqcQ5GM9AWlIwY=,iv:ZskdS8Gv9SL5fpliB3DZRmK8znArgzJCr5by9p5JAR0=,tag:fOVeKFz7h8/7WGmIf2Ey9g==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:Bvwy31lsbWibmYLRQPwOBw9gNLDbz/T89p7T6Ra+hWg=,iv:/Pcj/HkMAddswT9CFJi6XfJlNnnRQYRfWlomjlDV2rs=,tag:Ix/yTea+R8/WkKiHNzE2bA==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:v4BtHyCyhNzy8GVosiwuTH3mwoYgg4uecwz57ChH9eVRHNt2I27XCCAvYBpxXQpgRKUkRMUPqZxJ8dHMj1xdZA==,iv:zZ4/sz9vvNXqkRYber4unOEWp8AlVzjttMocerdZBGk=,tag:Rn666UUHGcGKpLn3RWhNnA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB5M014aUdVdk5GaTRoNUpm
            UHh0Uy9sYjdmMUxmV1FSVXluaENETFRicWpjCldnQ2htbmkzM0t5SzI3TWMrM2hF
            Sks2MFp6SnBlOHNxMkg2d2tsMEl3Z0EKLS0tIHFHY2lVd1FLaGU2Z3UxOGdmcDdl
            V0FRWjhWZkkrZjBvazNYZzlMejJ0aDAKye35MZfq7IOgSZ+wZGalgepaXF3xajtu
            /HaWr+AoT2/xSdL5H/y/Rp/gt8Cf1U4ot88c5Zl7myJX0SeKBoPErA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBuZGxCa0NBd3VMYU9KUHA0
            QmY4eXNiR3ZXL1ZrKzJLN2Z2Tk5PTW1xU0ZRCkF1UmhjSEdlelU2NDdZTlN6L2t3
            dmhoSXJZZHNkTWtEdUU2UHB2T1U3SFEKLS0tIHlOK0orTHJEbC9tcmNuVHBHSU11
            NXMydkJidTA5Ynh4MXIxTkxKbjhiKzAK/xIrehde7dPVJ9ZbxZiKEHBqRX5o6i2+
            bUm3F9mor96Il0RcD1QrRu+P1LPigUMfZKG6KdXEnXLdxr/wVWiP9w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-29T00:11:17Z"
    mac: ENC[AES256_GCM,data:7HAm4Oqlxi0vBuNiEVnm1rsBzPL3dzrtu3U0p8Xuwu8Jfcf7D6U7gCYZ2neQ0vEJ26yH1cs0kOlhb9rtFAeOmJuVgfEJxOBOWRquQI4wmv5HGm71rR8buOpiF5lBX1V7HjRLCVnoUdxgRQyGVV0K2gEi7VNPVtPg4cvlHMpTv3w=,iv:4Yyy7VEnGnq+DsiwFmTS3kKrWBb48s9CgaExbRb+uZo=,tag:jX2gTIiTd5O3B3wIUFZHCQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/observability/zabbix/secrets/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zabbix-secrets
stringData:
    DB_SERVER_HOST: ENC[AES256_GCM,data:aFN6GsQl8J5Olz8PyAMkffSMHQW+ktSY9A5eem59THhBFW47zSk1tw==,iv:XLTIK4EBlcSitFoWa+u8SfEY5RrKgUX5G4Dcoo+2D88=,tag:6IE9M3hfMelgx3QPk6EKuA==,type:str]
    DB_SERVER_PORT: ENC[AES256_GCM,data:c8xeqA==,iv:Gk8HPk5P381b47g5eEmnkNREGoNjrycSyIAlMUCDKN4=,tag:JlL763G9Z0WoEd+U+yGKEA==,type:str]
    ZBX_SERVER_NAME: ENC[AES256_GCM,data:8zdL8bbfIujWsIfAMac=,iv:OOSlkG6Jh8WKb6dO6inazXihXwbMt9j8jwWmh8PyusU=,tag:cvcrlyMIix2os1+dKpgbEw==,type:str]
    POSTGRES_USER: ENC[AES256_GCM,data:YIeOMBVE,iv:LpaX9SGPnPlhzLYkzwDYLG3X8BbGGXOFvuuVtDNhNaQ=,tag:iyRRpEoe898bfmRoYo4wXQ==,type:str]
    POSTGRES_PASSWORD: ENC[AES256_GCM,data:1L+p4CmMPMtLUqiNVs/ST8+vjiAgXNbTQbejWLCd,iv:AZolqMlDRzQCNnGmtMZL5TPhTHLzTevV/9i2+J5cpf0=,tag:o9alBPts0ij0w0yewQYFfw==,type:str]
    POSTGRES_DB: ENC[AES256_GCM,data:nL9ZgMXR,iv:M2sabfsAHR2QRl6vDawNHr6JaB1fy69D2NOQD36Z3AA=,tag:xzKBrseDC1YVJStHt8uBaQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBFS2kxVUVhN1VIVTI5aGJl
            Vi9XdGNrY3JvNExUbFdFZ3NsVTVSQkJVUTE0CkZEeFgrQ0NzQTA5S2JGdEF1anhE
            dEovYS90Qkx3WFFyUXA1elYzYjZjencKLS0tIE9kK0JnVnR4MncyemVva3pQdmo2
            TG9jdTFMUDJaS3ltU25ENXU4ck44OEUKtMrUOFAAeu5Yw6+rIJTasJIW2VPG2CnU
            OdZ4D7g+T5ROE4/fxsoeBbr7S0+Z6KL2v85U5CGPSAr+IEQgiItndw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLVEg4Mkl2c01KRi8zYlJH
            YUdOYlBtR3RnWVZaUnZYc0EvL3VHTDlXUXgwCjhOQlYwRHVscnM5Y2NSYzdDZEVD
            L0Z6dDk1b2FHTDNTTlVxSUxZazNLZ1UKLS0tIEFIWTUwT2VyRXF3dnUrRkxMY2xE
            VmJDU01JdzlzQVZoclRBVVpHZGQzM2MKmTlBEqpd3/4j0SMdqWUmnlfZmle/I8OP
            Pw2y+T5mvt27CH+ffRsLumo9np1kUqA5jyb9qLMBRjoEaZaL38neZw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-29T20:45:14Z"
    mac: ENC[AES256_GCM,data:RH2ytA+GCj7Kg4rG4Q2SH/iqtazjhAwboSh3Xwtgrd+wzwl9tvT8dgA1TSw2G3dDXLyA/9Rm8ItU9wwlE+Y8ZsthT11tYCwkNWjP0FWL5bAkyQpQ7oVxalGJkaguUU69x6k3BGRrYuMYEKi4i3g3pVKayggr3UKGSVjmBfUcsp0=,iv:SLGaOmQLYRFtP1IXWzmgPAqx7DgPMaNHUbFk0pDgJ18=,tag:W69tEHXqg43utgNNpjMMHg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/observability/zabbix/secrets/.decrypted~secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zabbix-secrets
stringData:
    DB_SERVER_HOST: postgres16-rw.database.svc.cluster.local
    DB_SERVER_PORT: "5432"
    ZBX_SERVER_NAME: Zabbix on Kube
    POSTGRES_USER: zabbix
    POSTGRES_PASSWORD: aX6eing8yu3iel@eem7ouKohc8ohs4
    POSTGRES_DB: zabbix

File: ./kubernetes/apps/observability/zabbix/secrets/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./db-init-secret.sops.yaml
  - ./secret.sops.yaml
  - ./volsync-secret.sops.yaml

File: ./kubernetes/apps/observability/zabbix/secrets/db-init-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zabbix-init-secrets
stringData:
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:z1XBHyUd,iv:UWs0nhVB7ILDaFPH+ZN1dueLCxuJkz5SZiKHXsnrl3U=,tag:S92Kcvj7E+sB9td4E7lzvQ==,type:str]
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:s2XhVz8WV4IflJZx942b51MlUaYSZj7iJY5IGEPMlRM8OzBL9UjaAg==,iv:uEgGd9tJtzPHi4/QB1TFOkEScodROz2hyxB+kG50BP8=,tag:a8y6kuDwCmQWtab8eStn2Q==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:px9joIUk,iv:2e0Xcawp7Wjtw52LhqB92REzm7/4xznWbNcCXA38YQ4=,tag:FkEcNAUESC6D2dbT6ETULw==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:lMGjwScaPf+mmyd0KY3SXpZJld5T8xJopyBK96fR,iv:zFsyDblQREuhyiWVZL4Izj3TaCXA46UzyYpMZklAr5o=,tag:sqS6I6Gph0DOjaDnXVueeQ==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:ShNzVL26pJzoAUYMFjTU5HIYPaUXwSqpHDziE5AR,iv:0SQBaLe1f7cUoow6PyyrQ5B1HKn/PHGuwsk45Px4Fj0=,tag:H4Dmb0ZsLj+rWCm+WM1tbg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBwQTE3Yi9NYzIzNzYzTFBy
            V0FxQncyeE8wSmt4TXZzK0RJeVk3YWxSN1cwCmhTZUZ4UXdLTXo0cUZCSlRhUno2
            S0w0a1BsVGJlamlKT3JwS3FIcVhYSGcKLS0tIFNHdG9hMXh3eUlrSjJWdUVzV3NI
            OUxFc0EyeWZpeFo0eDlrZ1Y4cGcyZGMK0oQU/QnyCTrTaNubBiPpuEBrVqfZ4xd9
            iFVFFK9VeLlNwQONH+tOZ8SvPq8LJZ2nMNCXF+52Un7j/xnOeKlQKg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqdDVFZkJGV0hFOHBUTGVr
            Zlc2Y0NFSmpCUk5TWUcva3oyQS8rUFZzQ0RjClErMzBKM2RtSWE0aElrU2UyL3kv
            NkNCWk42WVhyd2hnZTYrMkVvVnIzVlkKLS0tIDlnRDNSektDRG1GTzFZQkNpQUt4
            YlRuWkdYeXdQWTFlWFpNQXZhYTg5RmcK+E4z0ljHI7udd7uiAFcw48nzm3qDredk
            m5GulqNKDhvaWCMpWGCXk7pXKsRXhPI8OjI1lt5GogGepfbRhj1CNQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-29T00:03:21Z"
    mac: ENC[AES256_GCM,data:PO86qFOGwIY1Tif9K8iu8SkJ/G/XSivNyC84QhWr5X5mzddVVkqk0xMrIwhbL/rcT/h7qx3Omw2Lwa9/BQOrz46I5tjjq+KS5+lOm1dY6hGCcXc0g+35Jlyp+8GBacW/VCmJP04eMZ0lprj/HmTJTdjQ3RIv21kQorup4/rjM5Q=,iv:Qmg38aUUr4YJZk+re8MqKSjoGrd4gaOnaNigHGPHpng=,tag:/I9j98TkyDfVCdW62mFNHg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/observability/zabbix/ks-web.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: zabbix-web
  namespace: flux-system
spec:
  targetNamespace: observability
  path: ./kubernetes/apps/observability/zabbix/web
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: zabbix-server
  wait: false # no Flux KS deps
  prune: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/observability/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: observability
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/observability/uptimekuma/app/helm-release.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/common-3.5.1/charts/library/common
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: uptimekuma
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: docker.io/louislam/uptime-kuma
              tag: 1.23.16-alpine
              pullPolicy: IfNotPresent
            env:
              TZ: ${TZ}
              UPTIME_KUMA_DISABLE_FRAME_SAMEORIGIN: 0
            resources:
              requests:
                cpu: 200m
                memory: 128Mi
              limits:
                memory: 256Mi
    service:
      main:
        controller: main
        ports:
          http:
            enabled: true
            port: 3001
    ingress:
      main:
        enabled: true
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
          nginx.ingress.kubernetes.io/server-snippets: |
            location / {
              proxy_set_header Upgrade $http_upgrade;
              proxy_http_version 1.1;
              proxy_set_header X-Forwarded-Host $http_host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-For $remote_addr;
              proxy_set_header Host $host;
              proxy_set_header Connection "upgrade";
              proxy_cache_bypass $http_upgrade;
            }
        hosts:
          - host: &host uptime.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: http
        tls:
          - hosts:
              - *host
    persistence:
      data:
        enabled: true
        type: persistentVolumeClaim
        storageClass: cephfs
        accessMode: ReadWriteMany
        size: 3Gi
        globalMounts:
          - path: /app/data

File: ./kubernetes/apps/observability/uptimekuma/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./kubernetes/apps/observability/uptimekuma/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app uptimekuma
  namespace: flux-system
spec:
  targetNamespace: observability
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: rook-ceph-cluster
  path: ./kubernetes/apps/observability/uptimekuma/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      name: uptimekuma
      namespace: observability
  interval: 30m
  retryInterval: 1m
  timeout: 3m
  postBuild:
    substitute:
      APP: *app

File: ./kubernetes/apps/observability/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./prometheus-operator-crds/ks.yaml
  - ./kube-prometheus-stack/ks.yaml
  - ./uptimekuma/ks.yaml
  - ./zabbix/ks-secrets.yaml
  - ./zabbix/ks-pvc.yaml
  - ./zabbix/ks-server.yaml
  - ./zabbix/ks-web.yaml

File: ./kubernetes/apps/matrix-synapse/element/app/helm-release.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: element
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      element:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: vectorim/element-web
              tag: v1.11.89@sha256:d58031e793e00eed951c340e0a11da165774863e0510ec184bb4843debd084f2

    service:
      app:
        controller: element
        ports:
          http:
            port: 80

    ingress:
      app:
        className: external
        annotations:
          nginx.ingress.kubernetes.io/configuration-snippet: |
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
            add_header Content-Security-Policy "frame-ancestors 'none'";
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hosts:
          - host: "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
        - secretName: "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}-tls"
          hosts:
            - "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}"
      internal:
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/configuration-snippet: |
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
            add_header Content-Security-Policy "frame-ancestors 'none'";
        hosts:
          - host: "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
        - secretName: "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}-tls"
          hosts:
            - "{{ .Release.Name }}.${SECRET_DOMAIN_CHAT}"

    persistence:
      config:
        enabled: true
        type: configMap
        name: element-config
        globalMounts:
          - path: /app/config.json
            subPath: config.json

File: ./kubernetes/apps/matrix-synapse/element/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: flux-system
resources:
  - ./helm-release.yaml
configMapGenerator:
  - name: element-config
    files:
      - config.json=./config/config.json
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/matrix-synapse/element/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: matrix-synapse-element
  namespace: flux-system
spec:
  targetNamespace: default
  interval: 30m
  timeout: 5m
  path: "./kubernetes/apps/matrix-synapse/element/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false

File: ./kubernetes/apps/matrix-synapse/app/internal-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-synapse-int
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: 100M
    # nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
spec:
  ingressClassName: internal
  rules:
    - host: ${SECRET_DOMAIN_CHAT}
      http:
        paths:
          - path: /_matrix/media/.*
            pathType: ImplementationSpecific
            backend:
              service:
                name: matrix-synapse-media-repository
                port:
                  number: 8083
          - path: /_matrix
            pathType: Prefix
            backend:
              service:
                name: matrix-synapse
                port:
                  number: 8008
          - path: /.well-known/matrix
            pathType: Prefix
            backend:
              service:
                name: matrix-synapse-wellknown-lighttpd
                port:
                  number: 80
    - host: matrix.${SECRET_DOMAIN_CHAT}
      http:
        paths:
          - path: /_matrix/media/.*
            pathType: ImplementationSpecific
            backend:
              service:
                name: matrix-synapse-media-repository
                port:
                  number: 8083
          - path: /_matrix
            pathType: Prefix
            backend:
              service:
                name: matrix-synapse
                port:
                  number: 8008
  tls:
    - secretName: matrix.${SECRET_DOMAIN_CHAT}-tls
      hosts:
        - ${SECRET_DOMAIN_CHAT}
        - matrix.${SECRET_DOMAIN_CHAT}

File: ./kubernetes/apps/matrix-synapse/app/matrix-signing-key.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: matrix-synapse-signingkey
    namespace: default
data:
    signing.key: ENC[AES256_GCM,data:aYCNRvObsnSJryeg7m6U1PH/p7B7MHdF/fCKP0o4ec0UcA9P62RvxPCjVq6+0eO2H4fHiutzgIo3kqdnNBpDFx5hOzq9+QnZVucV0/Deu0A=,iv:dintB88ixOmfUbVowGreCellIj1C523CJrQDXBXMiwU=,tag:aXuETX1AuvpLW2hCshtvAA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBCaGlvdWpEVmR1L1owUmJx
            Q0ZWVTlrMXFjczRUV3RETE9mRkJRMmdNKzM0ClF6a2kzSTIvREhQN2s5Z0JLM244
            NE8vbk41KyswcSt2WVVzRGFxSWhVR1kKLS0tIE1NcHdVRFRHVTBLTndHMU9TdkFv
            Z09hYzVNK25LUGJ4dHZCd0dvdSsvbjQKsOodPPlLRH5WfUXCCtV4n85F2wdBbjmH
            +tzpSk9BwgbfY60/3EQmZfKgRoSnLGfY2ae0KrwF+Pfo5qNLE4TiCg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAwUDhkcFBJT0s2L1dDVnJT
            cXRla3p2M2N2Wm9zcUxHSkN3ck85TVJnUzAwCnRDcUh1K0d5bHUvZ0NsTmJwckpo
            bTFjU3BRM2FpWDVraTFoVHBYNWU0c3MKLS0tIFZQd0VBUnk2RnJHT2NpQ0UwN1pT
            S1pWME0yWlVjMjdrTHBVaFdCZDhSOGMK0CNxU/ZFSY3mnFVgJK7xSSRI0Ap0HArf
            F+BVf8dwkYV0br/M3twWcoE04yWC/PmQ95x6FZUQ/R8SZG3up/r6kw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-13T01:33:01Z"
    mac: ENC[AES256_GCM,data:2u5QK0UjFBq1tEwnb7pdtZdeFLj5bAymCrMbh47QITTukYFEnCvBzdq4BXtr2TQ2gfSWwMqHbuf34Aj0L7y+aIcf78sppKi6IMva2AerxeyC9Cmevo+9OmHKPsqQwz5lhm0mNL2BqBPEyh//UOtQsqpFOYBciENKmfFxZXYN6Yc=,iv:PZQDnhBIJyUh8KCnZ2MGsx+60SKe7oi3bhiazTYLZ/Y=,tag:RGIV8Wj8RtZMb9mdeVAcfg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/matrix-synapse/app/helm-release.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: matrix-synapse
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: matrix-synapse
      version: 3.10.3
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: flux-system
      interval: 5m
  valuesFrom:
    - kind: Secret
      name: matrix-synapse-shared-secret
      valuesKey: registration_pass
      targetPath: config.registrationSharedSecret
  values:
    image:
      repository: ghcr.io/element-hq/synapse
      tag: v1.120.2
    serverName: ${SECRET_DOMAIN_CHAT}
    publicServerName: matrix.${SECRET_DOMAIN_CHAT}
    wellknown:
      enabled: true
      image:
        repository: ghcr.io/rtsp/docker-lighttpd
        tag: 1.4.76

    config:
       enableRegistration: true
#      registrationSharedSecret: # Value is passed via Flux's valuesFrom secret feature.
    extraConfig:
      registration_requires_token: true

    workers:
      default:
        resources:
          limits:
            memory: 1Gi
          requests:
            memory: 512Mi
      media_repository:
        enabled: true
        strategy:
          type: Recreate
      federation_sender:
        enabled: false
        replicaCount: 2
      generic_worker:
        enabled: false
        generic: true
        replicaCount: 2
        listeners: [ client ]
        csPaths:
          ## Client API requests
          - "/_matrix/client/(api/v1|r0|v3|unstable)/createRoom$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/publicRooms$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/joined_members$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/context/"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/members$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/state$"
          - "/_matrix/client/v1/rooms/.*/hierarchy$"
          - "/_matrix/client/unstable/org.matrix.msc2716/rooms/.*/batch_send$"
          - "/_matrix/client/unstable/im.nheko.summary/rooms/.*/summary$"
          - "/_matrix/client/(r0|v3|unstable)/account/3pid$"
          - "/_matrix/client/(r0|v3|unstable)/account/whoami$"
          - "/_matrix/client/(r0|v3|unstable)/devices$"
          - "/_matrix/client/versions$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/voip/turnServer$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/event/"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/joined_rooms$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/search$"

          ## Encryption requests
          - "/_matrix/client/(r0|v3|unstable)/keys/query$"
          - "/_matrix/client/(r0|v3|unstable)/keys/changes$"
          - "/_matrix/client/(r0|v3|unstable)/keys/claim$"
          - "/_matrix/client/(r0|v3|unstable)/room_keys/"

          ## Registration/login requests
          - "/_matrix/client/(api/v1|r0|v3|unstable)/login$"
          - "/_matrix/client/(r0|v3|unstable)/register$"
          - "/_matrix/client/v1/register/m.login.registration_token/validity$"

          ## Event sending requests
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/redact"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/send"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/state/"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/(join|invite|leave|ban|unban|kick)$"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/join/"
          - "/_matrix/client/(api/v1|r0|v3|unstable)/profile/"

          ## User directory search requests
          - "/_matrix/client/(r0|v3|unstable)/user_directory/search"
      synchrotron:
        enabled: true
        generic: true
        listeners: [ client ]
        csPaths:
          - "/_matrix/client/(v2_alpha|r0|v3)/sync$"
          - "/_matrix/client/(api/v1|v2_alpha|r0|v3)/events$"
          - "/_matrix/client/(api/v1|r0|v3)/initialSync$"
          - "/_matrix/client/(api/v1|r0|v3)/rooms/[^/]+/initialSync$"

    ingress:
      enabled: true
      className: "external"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        nginx.ingress.kubernetes.io/use-regex: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: 100M
        # nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
      tls:
        - secretName: matrix.${SECRET_DOMAIN_CHAT}-tls
          hosts:
            - ${SECRET_DOMAIN_CHAT}
            - matrix.${SECRET_DOMAIN_CHAT}

    postgresql:
      enabled: false

    externalPostgresql:
      host: postgres16-rw.database.svc.cluster.local
      port: 5432
      username: matrix_synapse
      existingSecret: synapse-postgres-secrets
      existingSecretPasswordKey: postgresql-pass
      database: "synapse"

    redis:
      enabled: true
      auth:
        enabled: true
        password: ${SECRET_MATRIX_REDIS_PASSWORD}

    synapse:
      strategy:
        type: Recreate
      resources:
        requests:
          cpu: 1000m
          memory: 2500Mi
        limits:
          cpu: 1000m
          memory: 2500Mi

    signingkey:
      job:
        enabled: true
      # existingSecret: matrix-synapse-signingkey # DO NOT REMOVE, job and existingSecret cannot be enabled at the same time

    persistence:
      enabled: true
      existingClaim: synapse-data

File: ./kubernetes/apps/matrix-synapse/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: synapse-data
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  # storageClassName: standard

File: ./kubernetes/apps/matrix-synapse/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - synapse-postgres-secrets.sops.yaml
  - matrix-synapse-shared-secret.sops.yaml
  - helm-release.yaml
  - internal-ingress.yaml

File: ./kubernetes/apps/matrix-synapse/app/synapse-postgres-secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: synapse-postgres-secrets
    namespace: default
stringData:
    postgresql-pass: ENC[AES256_GCM,data:7NQRYh61EVVG8MFGBNkszynN/g==,iv:Bpjc4Ynvvv4ADTViYvmi5QfQepKorWscX5PG8l7OKPk=,tag:jIiBFE8g1xok65V2Za2yFg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpelI3QUNDMkRRanFYVXhC
            cFpSM3NxT0ZQbmtFT1RQQlBBWDI4UGpPOFJNCi8zTjBUZld1enhLTHN0OE9nNkkz
            ZnFJMCtIWEYxcTM1K0QyY2x3ZFNCNFkKLS0tIGh0UnZXOThuV3ZzNWVxUkFlaTJm
            V3p0U3oreUNhS3lZMkZlRlRxaUx6MGcKxSch+gBCz2GjYTY87pia98OFwqmriO7T
            bVxDiuudB7gpiBvHGg2+X8yobd1iOyKv7egNOkC5yAzBprDiwbTCEQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBnbjh1bk90M0orZ3dmOE1E
            cUEvM1ZZRmdUVU0vS3RNbEx6SkdSQU5ZYTNJCldBSndQRXo0MVJxUVFaY1c3cngw
            SG5tbWJkRWFxcTZzNFp4SjFZSENnYTQKLS0tIHJ2TDBzS01YN2tFWmRuUC92b2xB
            VURpMjA1aiszeHRhVFlCUEh0d1RhdWcKmKWCNsTQxJLStwsUk2Sevzem7jn9oT/1
            pWNkPPHkMfAyTvdUJzlQBrapRJplK7pwclu+kXFn/0JFf1W0H5FW1Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-13T01:29:58Z"
    mac: ENC[AES256_GCM,data:runCWcFGvmoVNQtkn3S3HfNc0HbhliHFzl8qMZiYPIxrWsK8mvBRbza6eloLLgMzLWCgzQkFtyO8zMTf0oj7SzTBLlM6BqdXLQF0IOnk6m4toY9lJVz7NicHP+xFVR4dhmy2YA+GgHu9owBAn0O8W7Uxq8km6LqN4xd0Ofv3TcQ=,iv:TxjxpA+YGQ2WX9UPEghjFcbcNcPZnFlC2Mx9GwesnDE=,tag:Dkyr7A/WUJ3fcpfuyLVvUQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/matrix-synapse/app/matrix-synapse-shared-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: matrix-synapse-shared-secret
    namespace: default
stringData:
    registration_pass: ENC[AES256_GCM,data:6YmOOZH8/7z4ClvWgyll3mMb7R9DZ0LzqGZQtctXTxcmRStGOHCNEZVkMbs=,iv:T3pitUBhxhW95mh2jwjBh/DQDSZNG2Ayjer+5s+j9Kw=,tag:g+MxBC4MiL+ngngzx19xbg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBCaGlvdWpEVmR1L1owUmJx
            Q0ZWVTlrMXFjczRUV3RETE9mRkJRMmdNKzM0ClF6a2kzSTIvREhQN2s5Z0JLM244
            NE8vbk41KyswcSt2WVVzRGFxSWhVR1kKLS0tIE1NcHdVRFRHVTBLTndHMU9TdkFv
            Z09hYzVNK25LUGJ4dHZCd0dvdSsvbjQKsOodPPlLRH5WfUXCCtV4n85F2wdBbjmH
            +tzpSk9BwgbfY60/3EQmZfKgRoSnLGfY2ae0KrwF+Pfo5qNLE4TiCg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAwUDhkcFBJT0s2L1dDVnJT
            cXRla3p2M2N2Wm9zcUxHSkN3ck85TVJnUzAwCnRDcUh1K0d5bHUvZ0NsTmJwckpo
            bTFjU3BRM2FpWDVraTFoVHBYNWU0c3MKLS0tIFZQd0VBUnk2RnJHT2NpQ0UwN1pT
            S1pWME0yWlVjMjdrTHBVaFdCZDhSOGMK0CNxU/ZFSY3mnFVgJK7xSSRI0Ap0HArf
            F+BVf8dwkYV0br/M3twWcoE04yWC/PmQ95x6FZUQ/R8SZG3up/r6kw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-13T03:50:10Z"
    mac: ENC[AES256_GCM,data:dHX1y5cd/LnvCQVGMyXG9Ptg3EnM3PVeksd2bFIpoeAMXnHVhJwKHcuWHlRhR1DUr29DiNV810LRP12Gvo6smvnUY24dCT7QyUcBtSLZ+1fj2UHKtwYobRtO24gwhkce+f2Rl06QGZmCZD+KaKPVCoAN0XFRgEnFBdZ2EmaDyfs=,iv:mfnQxE5u3PBJm4ud7wDEZ5VsG4pSQcxLc0Wqr30EijA=,tag:j6DZEkRsI/3JpGXKGkxfug==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/matrix-synapse/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: matrix-synapse
  namespace: flux-system
spec:
  targetNamespace: default
  interval: 30m
  timeout: 5m
  path: "./kubernetes/apps/matrix-synapse/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false

File: ./kubernetes/apps/database/dragonfly/operator/helm-release.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dragonfly-operator
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    defaultPodOptions:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
    serviceAccount:
      create: false
      name: dragonfly-operator-controller-manager
    controllers:
      dragonfly-operator:
        containers:
          rbac-proxy:
            image:
              repository: gcr.io/kubebuilder/kube-rbac-proxy
              tag: v0.16.0
            args:
              - "--secure-listen-address=0.0.0.0:8443"
              - "--upstream=http://127.0.0.1:8080/"
              - "--logtostderr=true"
              - "--v=0"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 5m
                memory: 64Mi
              limits:
                cpu: 500m
                memory: 128Mi
          app:
            image:
              repository: docker.dragonflydb.io/dragonflydb/operator
              tag: v1.1.8
            args:
              - "--health-probe-bind-address=:8081"
              - "--metrics-bind-address=127.0.0.1:8080"
              - "--leader-elect"
            command:
              - "/manager"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: &port 8081
                  initialDelaySeconds: 15
                  periodSeconds: 20
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /readyz
                    port: *port
                  initialDelaySeconds: 5
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              startup:
                enabled: false
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                cpu: 500m
                memory: 128Mi
        annotations:
          reloader.stakater.com/auto: "true"
    service:
      app:
        controller: dragonfly-operator
        ports:
          http:
            port: *port

File: ./kubernetes/apps/database/dragonfly/operator/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: controller-manager-sa
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: serviceaccount
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-controller-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: leader-election-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: role
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-leader-election-role
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dragonfly-operator-manager-role
rules:
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - services
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - apps
    resources:
      - statefulsets
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - dragonflydb.io
    resources:
      - dragonflies
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - dragonflydb.io
    resources:
      - dragonflies/finalizers
    verbs:
      - update
  - apiGroups:
      - dragonflydb.io
    resources:
      - dragonflies/status
    verbs:
      - get
      - patch
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: metrics-reader
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-metrics-reader
rules:
  - nonResourceURLs:
      - /metrics
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: proxy-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-proxy-role
rules:
  - apiGroups:
      - authentication.k8s.io
    resources:
      - tokenreviews
    verbs:
      - create
  - apiGroups:
      - authorization.k8s.io
    resources:
      - subjectaccessreviews
    verbs:
      - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: leader-election-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: rolebinding
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-leader-election-rolebinding

roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dragonfly-operator-leader-election-role
subjects:
  - kind: ServiceAccount
    name: dragonfly-operator-controller-manager
    namespace: database
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: manager-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dragonfly-operator-manager-role
subjects:
  - kind: ServiceAccount
    name: dragonfly-operator-controller-manager
    namespace: database
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: dragonfly-operator
    app.kubernetes.io/instance: proxy-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: dragonfly-operator
  name: dragonfly-operator-proxy-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dragonfly-operator-proxy-role
subjects:
  - kind: ServiceAccount
    name: dragonfly-operator-controller-manager
    namespace: database

File: ./kubernetes/apps/database/dragonfly/operator/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # renovate: datasource=github-releases depName=dragonflydb/dragonfly-operator
  - https://raw.githubusercontent.com/dragonflydb/dragonfly-operator/v1.1.8/manifests/crd.yaml
  - ./helm-release.yaml
  - ./rbac.yaml

File: ./kubernetes/apps/database/dragonfly/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app dragonfly-operator
  namespace: flux-system
spec:
  targetNamespace: database
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/database/dragonfly/operator
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app dragonfly-cluster
  namespace: flux-system
spec:
  targetNamespace: database
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: dragonfly-operator
  path: ./kubernetes/apps/database/dragonfly/cluster
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/dragonfly/cluster/podmonitor.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/podmonitor_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: dragonfly
spec:
  selector:
    matchLabels:
      app: dragonfly
  podTargetLabels: ["app"]
  podMetricsEndpoints:
    - port: admin

File: ./kubernetes/apps/database/dragonfly/cluster/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./cluster.yaml
  - ./podmonitor.yaml

File: ./kubernetes/apps/database/dragonfly/cluster/cluster.yaml
---
# yaml-language-server: $schema=https://kochhaus-schemas.pages.dev/dragonflydb.io/dragonfly_v1alpha1.json
apiVersion: dragonflydb.io/v1alpha1
kind: Dragonfly
metadata:
  name: dragonfly
spec:
  image: ghcr.io/dragonflydb/dragonfly:v1.26.0
  replicas: 3
  env:
    - name: MAX_MEMORY
      valueFrom:
        resourceFieldRef:
          resource: limits.memory
          divisor: 1Mi
  args:
    - --maxmemory=$(MAX_MEMORY)Mi
    - --proactor_threads=2
    - --cluster_mode=emulated
    - --lock_on_hashtags
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 512Mi
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: "kubernetes.io/hostname"
      whenUnsatisfiable: "DoNotSchedule"
      labelSelector:
        matchLabels:
          app.kubernetes.io/part-of: dragonfly

File: ./kubernetes/apps/database/mariadb/ks-resources.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb
  namespace: flux-system
spec:
  dependsOn:
    - name: mariadb-operator
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/resources
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/mariadb/operator/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: mariadb-secret
stringData:
    maxscale_password: ENC[AES256_GCM,data:bjX0+1+JegV+5XQ8LvhY1e1N38yi2lgmCT9Tib5FurY=,iv:bG9+RRNHrD5dqJxktZ+Tt4QJMhMTAWpfFyBvbFjjOm8=,tag:uOnSjEdBUbSJrVi0VGSSjA==,type:str]
    password: ENC[AES256_GCM,data:SRVjvcJ3NHVvoGv/rDf5BtAWTSNR+Z31LGKr+F0AaEY=,iv:RIC4SX/fLoN42ZOmNzybq6XxrpWT5Rosr1NnfirFrEs=,tag:c+0tCYDo5Ro6zxT0lrItJw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBENkRIK28ySmswSVdLS0ZE
            OWpvMmJwS0NQMFdXRmFVWndvcWVBRE1IQXdNCmNydWR1akJVOHE0VE5XRU9Ya2lv
            WlRTd1BZRVdGMm4yYy8rbE8yeU9zUzgKLS0tIG1BQWo2VG1QTDdSNUpuUnFGOXZV
            UTNGdGxVN2dwWDVpZ2ZuZzZoR2tCREkK+HZ82L7O4R1Z1YIlXv6hCqU47ynNGO8m
            gCQRyAV5FpvXaq/LVX8Yzz3wMScuMsWBVntvwcF5hJzEotvJRE40Xg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAxYld6d2I3S1RYVHkzaVJY
            RlA0ZktBSnJJK3g3WWZmeXIvL09Ja3hVMjFvCmMwTlBvQ2syY0czZmM0K2laWUxS
            YjB5ekQ0elRLdkd5Y2svNzVIekZ4bUEKLS0tIGlCRDZ1V0J4dkoxTUc5Q2FkNSto
            SnQ3cnExTU45SFFnZFZWUHlYb1NXSTAKGu+wxrJWcUuIhnBmkZmsGp8I+besK0dr
            Ti5ANrU1QkgWN31rSgf6Fwx2A+ywsqQJt232XN0YXnNVUgjIQOyshQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-17T14:01:58Z"
    mac: ENC[AES256_GCM,data:fR/mpT6mCnfq7Xvy1336DujT9yjkpBRQxHDYUdcSvafThLjWRWfoQx0RpA8pzZSGmudViuaizO8iKID0a4k/jDH2POqoBVO1sHzMpLIbyqoFPMfMO9gFfhxMlnKWHi0TtiNhjOlMKy5W1n0rWZot4M6Wqvyx9pI0CIAtZfLK5Ro=,iv:weKAl4iw86jwWMkzQPDDwb9L77VAdwYX2oegOmFdfC0=,tag:U+wvScwIoM784pmRiClTJw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/database/mariadb/operator/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: databases
resources:
  - hr.yaml
  - secret.sops.yaml

File: ./kubernetes/apps/database/mariadb/operator/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mariadb-operator
spec:
  chart:
    spec:
      chart: mariadb-operator
      sourceRef:
        kind: HelmRepository
        name: mariadb-operator
        namespace: flux-system
      version: "0.36.0"
  interval: 1h0m0s
  values:
    logLevel: debug
    image:
      repository: ghcr.io/mariadb-operator/mariadb-operator
      pullPolicy: IfNotPresent
      tag: 0.36.0
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    webhook:
      certificate:
        certManager: true
      serviceMonitor:
        enabled: true

File: ./kubernetes/apps/database/mariadb/ks-phpmyadmin.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb-phpmyadmin
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/phpmyadmin/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/mariadb/crds/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - hr.yaml

File: ./kubernetes/apps/database/mariadb/crds/hr.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mariadb-operator-crds
spec:
  chart:
    spec:
      chart: mariadb-operator-crds
      sourceRef:
        kind: HelmRepository
        name: mariadb-operator
        namespace: flux-system
      version: "0.36.0"
  interval: 1h0m0s

File: ./kubernetes/apps/database/mariadb/ks-crds.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb-operator-crds
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/crds
  prune: true
  wait: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/mariadb/phpmyadmin/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: databases
resources:
  - hr.yaml

File: ./kubernetes/apps/database/mariadb/phpmyadmin/app/hr.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: phpmyadmin
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      phpmyadmin:
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          phpmyadmin:
            image:
              repository: registry.skysolutions.fi/docker.io/phpmyadmin
              tag: 5.2.1-apache
            env:
              PMA_ARBITRARY: 1
            resources:
              requests:
                cpu: 30m
                memory: 256Mi
              limits:
                memory: 512Mi

    service:
      phpmyadmin:
        controller: phpmyadmin
        ports:
          http:
            port: 80
    ingress:
      main:
        enabled: true
        className: "internal"
        hosts:
          - host: &host "phpmyadmin.${SECRET_DOMAIN}"
            paths:
              - path: "/"
                pathType: Prefix
                service:
                  identifier: phpmyadmin
                  port: 80
        tls:
          - hosts:
              - "phpmyadmin.${SECRET_DOMAIN}"

File: ./kubernetes/apps/database/mariadb/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb-operator
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/operator
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: mariadb-operator-crds
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/mariadb/resources/ingress-maxscale.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: maxscale-galera-http
spec:
  rules:
    - host: mariadb-maxscale.${SECRET_DOMAIN}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mariadb-galera-maxscale-gui
                port:
                  number: 8989

File: ./kubernetes/apps/database/mariadb/resources/externalsecret-backups.yaml
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mariadb-backups
  namespace: databases
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: mariadb-galera-s3-secret
    deletionPolicy: Delete
    template:
      engineVersion: v2
      data:
        access-key-id: "{{ .ACCESS_KEY_ID }}"
        secret-access-key: "{{ .SECRET_ACCESS_KEY }}"
  dataFrom:
    - extract:
        key: mariadb-backups

File: ./kubernetes/apps/database/mariadb/resources/externalsecret.yaml
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mariadb
  namespace: databases
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: mariadb-secret
    deletionPolicy: Delete
    template:
      engineVersion: v2
      data:
        password: "{{ .ROOT_PASSWORD }}"
        maxscale_password: "{{ .MAXSCALE_PASSWORD }}"
  dataFrom:
    - extract:
        key: mariadb

File: ./kubernetes/apps/database/mariadb/resources/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: databases
resources:
  - ./backup.yaml
  - ./mariadb.yaml
  - ./provisions
  - ingress-maxscale.yaml
labels:
  - pairs:
      app.kubernetes.io/name: mariadb
      app.kubernetes.io/part-of: mariadb

File: ./kubernetes/apps/database/mariadb/resources/backup.yaml
---
# yaml-language-server: $scema=https://ks.hsn.dev/k8s.mariadb.com/backup_v1alpha1.json
apiVersion: k8s.mariadb.com/v1alpha1
kind: Backup
metadata:
  name: mariadb-galera-invoiceninja-daily
spec:
  mariaDbRef:
    name: mariadb-galera

  schedule:
    cron: "5 4 * * *"

  databases:
    - "invoiceninja"

  storage:
    persistentVolumeClaim:
      accessModes:
        - "ReadWriteOnce"
      resources:
        requests:
          storage: 6Gi

      storageClassName: ceph-rbd


File: ./kubernetes/apps/database/mariadb/resources/mariadb.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: mariadb-galera
spec:
  rootPasswordSecretKeyRef:
    name: mariadb-secret
    key: password
    generate: false

  storage:
    size: 5Gi
    storageClassName: ceph-rbd

  replicas: 3
  image: "mariadb:11.5.2"
  imagePullPolicy: IfNotPresent

  updateStrategy:
    autoUpdateDataPlane: true

  maxScale:
    enabled: true

    auth:
      adminUsername: root
      adminPasswordSecretKeyRef:
        name: mariadb-secret
        key: maxscale_password
      deleteDefaultAdmin: true

    kubernetesService:
      type: ClusterIP

    guiKubernetesService:
      type: ClusterIP

    connection:
      secretName: mxs-galera-conn
      port: 3306


  galera:
    enabled: true
    recovery:
      enabled: true
      #forceClusterBootstrapInPod: "mariadb-galera-1"
      podRecoveryTimeout: 15m

  service:
    type: LoadBalancer

  primaryService:
    type: LoadBalancer

  secondaryService:
    type: LoadBalancer

  myCnf: |
    [mariadb]
    bind-address=*
    default_storage_engine=InnoDB
    binlog_format=row
    innodb_autoinc_lock_mode=2
    max_allowed_packet=256M

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 2Gi

  podSecurityContext:
    runAsUser: 999
    runAsGroup: 999
    fsGroup: 999
    fsGroupChangePolicy: OnRootMismatch


  #  livenessProbe:
#    initialDelaySeconds: 20
#    periodSeconds: 10
#    timeoutSeconds: 10
#
#  readinessProbe:
#    initialDelaySeconds: 20
#    periodSeconds: 10
#    timeoutSeconds: 10

  metrics:
    enabled: true

File: ./kubernetes/apps/database/mariadb/resources/provisions/bookstack/user.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: User
metadata:
  name: bookstack
  namespace: database
spec:
  mariaDbRef:
    name: mariadb-galera
  passwordSecretKeyRef:
    name: bookstack-secret
    key: mariadb-password
  maxUserConnections: 20

File: ./kubernetes/apps/database/mariadb/resources/provisions/bookstack/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: bookstack-secret
stringData:
    mariadb-password: ENC[AES256_GCM,data:2pCkuGKJTgPvxd1ZBzNAMqLOSdo48Nt3Oj5SqwfG7md/5nXr/fsflwxdwws=,iv:R6i7OHawHDEcdHFQM2P0iAJuWQDKPHLdgC3AtWXHTiw=,tag:R2H20AQy1XTGL0At8NXg8g==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBiZzkvWWI3UWoraEdIdkVP
            UW1LeW9IY3p3WnBjTnlDdnhjeXBEWGdDN2trCmtLUUFldlBoSWo4L2cxZzNBWkVq
            QktaY1dOeWZGOUs2aUNNUUYrUWJKeDgKLS0tIG4xYXl1T09ueXJ6Q3JrOWM2em96
            Ti85NXVtZXFheEhDZjl3cmg5UUgxL00KEOA2MheLT2HDwBZ2fYALZM46psfLXLl4
            SQEdgasEyeH7mjXeEsSw/6sLlyZrqdCFHTU5KOYNhFD7u6D+A96xyw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBtMkFrR3pqUFErNk1QWUxi
            bGZ2MFpVU01sTlFzRCtiaXhCdFovN0tSdUVvCk5rRkM4ZjUrWVRPcHAxTVVqSzg1
            SzlSaExxdEI1WnREaFgvTmtBaUxvdDQKLS0tIENDdVFiU1owU2pBeWNHVFhXcVVE
            Rm5MOUlIZGtjWGJRRzcxUCtpbmIyNEEKUbEa/iwjBXthLQLtoEXmBnSi9YcZHfyZ
            KMKz3clv25BPL+ptzrjYN1oRRqo2WUmKSrPA/RVgQJAa5Pfbt0SrUg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-07T15:33:23Z"
    mac: ENC[AES256_GCM,data:pjl0xWzPTgtUOjvsGhjE55PmHastsoGi8iv8yp7W7edQnyDEFeeuYZCwYBWaR7LH+sUGLMrP4tj3a2I48cCVT2MPGbevqGZzRAjir4t0iEZXAVuHAeFJqKUGUd3CoTx+pOfI0tBFVNcFQ2Oth+yl+5FRIx1KS3HTkxLJKHl3qxc=,iv:PIwdcTQXayVUr7NQ4T6Be2+61Aa9zOgjct4V04EBnp4=,tag:bUnmP0eoHfZE1S4UV+cu6g==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/database/mariadb/resources/provisions/bookstack/db.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Database
metadata:
  name: bookstackapp
  namespace: database
spec:
  mariaDbRef:
    name: mariadb-galera
  characterSet: utf8mb4
  collate: utf8mb4_unicode_ci

File: ./kubernetes/apps/database/mariadb/resources/provisions/bookstack/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./user.yaml
  - ./db.yaml
  - ./grant.yaml
  - ./secret.sops.yaml

File: ./kubernetes/apps/database/mariadb/resources/provisions/bookstack/grant.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Grant
metadata:
  name: bookstack
  namespace: database
spec:
  mariaDbRef:
    name: mariadb-galera
  privileges:
    - "ALL PRIVILEGES"
  database: "bookstackapp"
  table: "*"
  username: bookstack

File: ./kubernetes/apps/database/mariadb/resources/provisions/invoiceninja/user.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: User
metadata:
  name: invoiceninja
spec:
  mariaDbRef:
    name: mariadb-galera
  passwordSecretKeyRef:
    name: invoiceninja-secret
    key: mariadb-password
  maxUserConnections: 20

File: ./kubernetes/apps/database/mariadb/resources/provisions/invoiceninja/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: invoiceninja-secret
stringData:
    mariadb-password: ENC[AES256_GCM,data:xA1DicHxf8U0AH2yJnTmqRkSvnuuS8dIM1ivhKrQAKc=,iv:nDpcAOLJJ6/c2P6BjW0Zt93qcVVlsI3dq6/BVUo2170=,tag:D3Uz22s+jzQMcTcL6tdIUg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBiZzkvWWI3UWoraEdIdkVP
            UW1LeW9IY3p3WnBjTnlDdnhjeXBEWGdDN2trCmtLUUFldlBoSWo4L2cxZzNBWkVq
            QktaY1dOeWZGOUs2aUNNUUYrUWJKeDgKLS0tIG4xYXl1T09ueXJ6Q3JrOWM2em96
            Ti85NXVtZXFheEhDZjl3cmg5UUgxL00KEOA2MheLT2HDwBZ2fYALZM46psfLXLl4
            SQEdgasEyeH7mjXeEsSw/6sLlyZrqdCFHTU5KOYNhFD7u6D+A96xyw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBtMkFrR3pqUFErNk1QWUxi
            bGZ2MFpVU01sTlFzRCtiaXhCdFovN0tSdUVvCk5rRkM4ZjUrWVRPcHAxTVVqSzg1
            SzlSaExxdEI1WnREaFgvTmtBaUxvdDQKLS0tIENDdVFiU1owU2pBeWNHVFhXcVVE
            Rm5MOUlIZGtjWGJRRzcxUCtpbmIyNEEKUbEa/iwjBXthLQLtoEXmBnSi9YcZHfyZ
            KMKz3clv25BPL+ptzrjYN1oRRqo2WUmKSrPA/RVgQJAa5Pfbt0SrUg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-17T14:39:07Z"
    mac: ENC[AES256_GCM,data:BaCyF+JbF5qWV+Zj2BfxSUPe1pJzRF9ejg/J+6P4jw2TNID0jIVltKRAL5RQgjj8T5cWfIrK5lvsovSdJWFohg7BktBvoamQOnw6ii54tFhlfu1xckI79waTQ869h/6D4e+GEsImj2uAac9bCimefCxgjzOywtXUB7GPeXGbBtk=,iv:8e5S2TBuMyD7ZYp7YelFjJRqe0kFx185IAguZ3ufQ1s=,tag:c3nqdC8EEjSzcTDdaiLUBQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/database/mariadb/resources/provisions/invoiceninja/db.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Database
metadata:
  name: invoiceninja
spec:
  mariaDbRef:
    name: mariadb-galera
  characterSet: utf8
  collate: utf8_general_ci

File: ./kubernetes/apps/database/mariadb/resources/provisions/invoiceninja/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./user.yaml
  - ./db.yaml
  - ./grant.yaml
  - ./secret.sops.yaml

File: ./kubernetes/apps/database/mariadb/resources/provisions/invoiceninja/grant.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Grant
metadata:
  name: invoiceninja
spec:
  mariaDbRef:
    name: mariadb-galera
  privileges:
    - "ALL PRIVILEGES"
  database: "*"
  table: "*"
  username: invoiceninja

File: ./kubernetes/apps/database/mariadb/resources/provisions/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - invoiceninja
  - bookstack

File: ./kubernetes/apps/database/pgadmin/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: pgadmin-secrets
stringData:
    PGADMIN_DEFAULT_PASSWORD: ENC[AES256_GCM,data:u4HVLH4/aYFOpp3oH1T+vMP2Ny0ipwJlSuVXZfAL,iv:qkdoU6xKlY/NTQVKBu2xBKD8kWC49/FCKk+0wDCwZhY=,tag:R/x3CUMitc0Htnip89ZlLw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBDZGlNWE1HTlBBUGtNejZ6
            dzVzMTU3VXJldnRRamRHR3JvSEh0NjVBZENvCjdMYmNLMnZRZ3ZJcEswTTNoTWYv
            V0RpZ3h1SWJaV0cxUWJqK2xrblBVTVUKLS0tIHl5VmY3NGY5Mng4YnFJQnJoelpu
            WEswZk1uMEtlZktVZ1FURUdWSzRORFkKAKhHz7prqTKAUUdIA4z0Wy7wojN2j0Js
            VSWk9BcIVH9ighuPVhHPEx/GQCEvBu/ynNv+g5Z1Zy7b/OLoYre9/w==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBxZjRQSW5rMUlhV29xdnBE
            UXdZUVZhSEo4VHdmYlpxQ1NiVFJ6cWcxRWtnCnNrWmR6QUl1aTUzVGMwYzhSc21y
            Rzh1Slk5OGpiSVY2MmtRUFc3Q1NoYUkKLS0tIEdhT1BvWCs0NzV0bmlHUjBtVmJk
            NlN4dGlOSGhCK1BRQVFyK2l5SldyaEUKgexgaL9H/aAeQPbG/J7/wQMXw1hmQaIz
            J+nQXnyW7rhhhtr10a56cGUDQiocZhS3OFyd8gOL24zaz9TIAR4DLw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-05T09:50:21Z"
    mac: ENC[AES256_GCM,data:I8eVzBgTXfDBqr+92oM3qFJLKTCSOPEtDm5/4BnbFyF2YMsEtY7vIAu2/Oke0X5VDDX7KnjXM+DNyDbvUswK6cqjhiaOgq29qfGv5AM4a3aWoNLhr57BffRBUkGWEfQeHyUC/TNa60UtEna2xQAGvCAr66B93yhkuS5+SIbJh10=,iv:Y2Lk89BZGJYIerPXydAM4ts+BhgROoSQnsDf7ExjYw0=,tag:nT8guozzdG1sm3ZJfev6aA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/database/pgadmin/app/helm-release.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pgadmin
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    defaultPodOptions:
      securityContext:
        runAsUser: 5050
        runAsGroup: 0
        fsGroup: 0
        fsGroupChangePolicy: OnRootMismatch

    controllers:
      main:
        type: statefulset
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          main:
            image:
              repository: dpage/pgadmin4
              tag: 8.12
            env:
              PGADMIN_DEFAULT_EMAIL: deen@${SECRET_DOMAIN}
            envFrom:
              - secretRef:
                  name: pgadmin-secrets
            resources:
              requests:
                memory: 300Mi
              limits:
                memory: 1Gi

    service:
      main:
        controller: main
        ports:
          http:
            port: 80

    persistence:
      config:
        enabled: true
        storageClass: ceph-rbd
        accessMode: "ReadWriteOnce"
        size: 1Gi
        globalMounts:
          - path: /var/lib/pgadmin
      oauthconfig:
        enabled: true
        type: configMap
        name: pgadmin-local-config-configmap
        globalMounts:
          - path: /pgadmin4/config_local.py
            subPath: config_local.py
            readOnly: true

    ingress:
      main:
        enabled: true
        className: internal
        hosts:
          - host: pgadmin.${SECRET_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
        tls:
          - hosts:
              - pgadmin.${SECRET_DOMAIN}

File: ./kubernetes/apps/database/pgadmin/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml
  - secret.sops.yaml
configMapGenerator:
  - name: pgadmin-local-config-configmap
    files:
      - config_local.py
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/database/pgadmin/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: pgadmin
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/pgadmin/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      name: pgadmin
      namespace: database
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/cloudnative-pg/operator/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: cloudnative-pg-secret
stringData:
    username: ENC[AES256_GCM,data:qfoyhr42SLI=,iv:DJKBtGYH2CqGsTBeofvIDokb0VaZF4DPHe4aoB7zAuM=,tag:PPnljYv36HVbBuppHU7ZfA==,type:str]
    password: ENC[AES256_GCM,data:+oqvHFdEH0Gs4C66FFhxTBagtMUr7PPxRXim6UoQ,iv:RP8jYcDX5+8DC7rzKJ9DWR0bJqZvvXxG01kIc1JDQJg=,tag:uoQlBN8QuImuDjfjtyz/Lw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBCV2pIbUI0S1NDcmt1L042
            bUpQMVkxZGFKOUxMQTZacWFjNVI0SzErTnhzCkhtRzc0bTJkdXhTeEl3eEJkWGFZ
            UC9kMUdIQ1RRcEFxdkJjZWtkclpIS0kKLS0tIEhqY1FjbjZscFF4WVRBb2d2M0Er
            c3AwRWR0Vmk4MGg5emF5NXlNb0wwaGsK0npwJIU3AGPixKdXp6svcUxbWoDr8FeD
            fkC4jDqI1fwmmhuXFWzs8e5gcYKgZIAt/0o1DlGCuwypOEJQYjsx+w==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBNemJkWFFKb3k5Q0tZbFhn
            WGdkVkxpVHdOMXYyUjJ3M0tCc1NFLy90SDBZClVHeXQrdEhNYUNoRmk3ektvTm9z
            elNrWUtBMkV4bHoxeHFrcWtTUkVONVUKLS0tIGNVbFNJUmR1b1g2TVMrZlhPcG1r
            RnhxVEJmRGJ5ZmEzdERBMnJEV1hnZE0KPyiV6EptZ1uWOHUxUMDRz5R8354/3Tx4
            x1VJYSonXeaRwhK8xTlWWhUWUO2/55nfZSmX4c8fwZ25M236c8lpxw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-28T23:14:00Z"
    mac: ENC[AES256_GCM,data:iDGRVZVXlEKF4TjHp+w/XnmncOLQtksHDxvvi/huPNOEWJyiKLVrWQz1qtuBi6jTi8/pWlq+ITe8vQf/1qkB8NjP/JDPqlvVvkb99ylrF32XxAbqR9DWf35stc396Gnt2V3VO7P0bdFLDtNvb03kGBqRG6a/8f6n6Km8O+R1zOE=,iv:ADvOFn8Nimv/5vlIAp45nJzvD61pOUKdat6iHsgt2KE=,tag:zO6XfaY7gZwLTCHXmXBvJA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/database/cloudnative-pg/operator/helm-release.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudnative-pg
spec:
  interval: 30m
  chart:
    spec:
      chart: cloudnative-pg
      version: 0.23.0
      sourceRef:
        kind: HelmRepository
        name: cloudnative-pg
        namespace: flux-system
  values:
    crds:
      create: true
    nodeSelector:
      kubernetes.io/arch: amd64
    monitoring:
      podMonitorEnabled: true
      grafanaDashboard:
        create: true

File: ./kubernetes/apps/database/cloudnative-pg/operator/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: databases
resources:
  - helm-release.yaml
  - secret.sops.yaml
generatorOptions:
  disableNameSuffixHash: true
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
labels:
  - pairs:
      app.kubernetes.io/name: cloudnative-pg
      app.kubernetes.io/instance: cloudnative-pg
      app.kubernetes.io/part-of: cloudnative-pg

File: ./kubernetes/apps/database/cloudnative-pg/ks-operator.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cnpg-operator
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/cloudnative-pg/operator
  prune: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      name: cloudnative-pg
      namespace: database
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/cloudnative-pg/cluster/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./cluster16.yaml

File: ./kubernetes/apps/database/cloudnative-pg/cluster/cluster16.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/postgresql.cnpg.io/cluster_v1.json
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres16
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16.1-18
  primaryUpdateStrategy: unsupervised
  storage:
    size: 15Gi
    storageClass: ceph-rbd
  superuserSecret:
    name: cloudnative-pg-secret
  enableSuperuserAccess: true
  resources:
    requests:
      memory: 2Gi
    limits:
      memory: 4Gi
#  bootstrap:
#    recovery:
#      source: &previousCluster postgres16-v1
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: required
    nodeSelector:
      kubernetes.io/arch: amd64
  postgresql:
    parameters:
      max_connections: "600"
      shared_buffers: 512MB

  monitoring:
    enablePodMonitor: true
    # https://github.com/cloudnative-pg/cloudnative-pg/issues/2501
    podMonitorMetricRelabelings:
      - { sourceLabels: [ "cluster" ], targetLabel: cnpg_cluster, action: replace }
      - { regex: cluster, action: labeldrop }
  backup:
    target: prefer-standby
    retentionPolicy: 30d

File: ./kubernetes/apps/database/cloudnative-pg/ks-cluster16.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cnpg-cluster16
  namespace: flux-system
spec:
  targetNamespace: database
  dependsOn:
    - name: cnpg-operator
  path: ./kubernetes/apps/database/cloudnative-pg/cluster
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/database/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Pre Flux-Kustomizations
  - ./ns.yaml
  # Flux-Kustomizations
  - cloudnative-pg/ks-operator.yaml
  - cloudnative-pg/ks-cluster16.yaml
  - pgadmin/ks.yaml
  - mariadb/ks.yaml
  - mariadb/ks-crds.yaml
  - mariadb/ks-resources.yaml
  - mariadb/ks-phpmyadmin.yaml
  - dragonfly/ks.yaml

File: ./kubernetes/apps/database/ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: database

File: ./kubernetes/apps/vaultwarden/volsync-pvc/app/replicationdestination.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: vaultwarden-bootstrap
spec:
  restic:
    accessModes:
    - ReadWriteOnce
    cacheCapacity: 2Gi
    cacheStorageClassName: local-hostpath
    capacity: 2Gi
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    repository: vaultwarden-volsync-r2-secret
    storageClassName: ceph-rbd
    volumeSnapshotClassName: csi-ceph-blockpool
  trigger:
    manual: restore-once

File: ./kubernetes/apps/vaultwarden/volsync-pvc/app/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: vaultwarden
spec:
  restic:
    cacheCapacity: 2Gi
    cacheStorageClassName: local-hostpath
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    pruneIntervalDays: 7
    repository: vaultwarden-volsync-r2-secret
    retain:
      daily: 7
      weekly: 4
    storageClassName: ceph-rbd
    volumeSnapshotClassName: csi-ceph-blockpool
  sourcePVC: vaultwarden
  trigger:
    schedule: "30 4 * * *"

File: ./kubernetes/apps/vaultwarden/volsync-pvc/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${APP}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"

File: ./kubernetes/apps/vaultwarden/volsync-pvc/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./pvc.yaml
  - ./replicationdestination.yaml # to pvc
  - ./replicationsource.yaml # from pvc

File: ./kubernetes/apps/vaultwarden/volsync-pvc/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app vaultwarden-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/vaultwarden/volsync-pvc/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: vaultwarden-secrets
    - name: rook-ceph-cluster
    - name: volsync
  wait: true
  postBuild:
    substitute:
      APP: vaultwarden
      VOLSYNC_CAPACITY: 2Gi


File: ./kubernetes/apps/vaultwarden/vaultwarden/app/helm-release.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/common-3.5.1/charts/library/common
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app vaultwarden
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      vaultwarden:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: vaultwarden/server
              tag: 1.32.7@sha256:7a0aa23c0947be3582898deb5170ea4359493ed9a76af2badf60a7eb45ac36af
            env:
              DATA_FOLDER: data
              ICON_CACHE_FOLDER: data/icon_cache
              ATTACHMENTS_FOLDER: data/attachments
              DOMAIN: "https://vaultwarden.${SECRET_DOMAIN}"
              TZ: "${TIMEZONE}"
              SIGNUPS_ALLOWED: "false"
              WEBSOCKET_ENABLED: "true"
              WEBSOCKET_ADDRESS: 0.0.0.0
              WEBSOCKET_PORT: 3012
              #SMTP_HOST: smtp-relay.default.svc.cluster.local.
              #SMTP_FROM: vaultwarden@${SECRET_DOMAIN}
              #SMTP_FROM_NAME: vaultwarden
              #SMTP_PORT: 2525
              #SMTP_SECURITY: "off"
            envFrom:
              - secret: vaultwarden-secrets
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
              limits:
                memory: 2Gi
    service:
      app:
        controller: *app
        ports:
          http:
            port: &port 80
    ingress:
      external:
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/enabled: "true"
          external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}.
          hajimari.io/icon: mdi:lock
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: *port
        tls:
          - hosts:
              - *host
      internal:
        className: internal
        hosts:
          - host: *host
            paths:
              - path: /
                service:
                  identifier: app
                  port: *port
        tls:
          - hosts:
              - *host

    persistence:
      config:
        enabled: true
        existingClaim: *app
        globalMounts:
          - path: /data

File: ./kubernetes/apps/vaultwarden/vaultwarden/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./kubernetes/apps/vaultwarden/vaultwarden/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app vaultwarden
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  path: "./kubernetes/apps/vaultwarden/vaultwarden/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  dependsOn:
    - name: vaultwarden-pvc
  postBuild:
    substitute:
      APP: *app
      APP_NS: *ns

File: ./kubernetes/apps/vaultwarden/secrets/app/volsync-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: vaultwarden-volsync-r2-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:vEaQCmdQr2k/D4uzxvhFow8TOt5TbWc0RcI9CIjmRFs8Y5OCQwd/jqpwyL2qCpjd3eGHjqfYGobYA2qEGQvgttvb1FpEw/uSVNf2t4jjSP+FRb1O9TZT7diOwPbA,iv:vaN+nrZMvLCo1nZVY9AtCZpWolJDyHwNsAYKKZF1rHM=,tag:aUVjLzKUQ2xGrapSA8IdwQ==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:14V+0SotTK7t+OueOO7WioJlnwEdL/Ph9TTGQ5ulv2o=,iv:duX3Bd2k7Ka//ajBm6LmKkuRG5R2iJQdnlkTx3hYp/8=,tag:osy0OLrcvd+cDq0njR23yA==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:MnBqUv7fkc3mApmR4b+rkcf20MbXHXvwoPZFoJwOt1U=,iv:/GdLFBGN6Ya7Cgr2Gte1yhBVGkuDPDKXTtoVs3KWiKY=,tag:cYx2oHgNqYTMxAIFpJ6XkQ==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:c+LUXbYbui8onPLgPDc6+DDgMQyIPI1jaJ9LXUhvjzx/vDNkTNnVPQgi3A4QvMg/Eg7MfxXD5UqN2KNSeImIJA==,iv:fvk2a5y6+a3k8M29AkKwDJqb7ifHLpLLL7T1GKRVy3Y=,tag:OvG4YbHfzaleeovM3eSuUw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBBdG01cnY2M1ZuU0ttak9F
            RkQ4dm1oeTRQMjBLTjk2aks0M09lREFWWVQ4ClVjWEc2UmlPbGRrektSeVJrd293
            ZmZoWTN1VTN4OUszb2Y4dUxBT0RlS0EKLS0tIHhHM1Q4Zll0cnJGOURidzJQN1Qx
            SmRaeHI2ck40REk4aW1yWUlQbEs5SG8Kxb2OYX8s+15QN2YOa8jckWzQbYozoF26
            Mchea2pcEIiv7GM5gyvhgL47qmwiBUYQLkU1cxNBEEwXznsrgxtnMg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBGckVWQ0JySmNwdmxrRVBn
            b09tNjcvWDJXaVBnN2wrOWxsT0J5SXY0SmdNCjB4eE9NSVhjdytySGxtTVIzMkZR
            N2kySUxVKzkyd04vNW0reGR2RFVUa2sKLS0tIHBXTGhJb0YraTZnL0kyL04zWEVH
            TWI1blFCejdTR0F1UzNBREN3Y2dMbmcKKMyfkzxyZyO6ITbxkkymLeb/jLp7C4X8
            bMVCyo7JlwNLJx/AMP41bCwT8ZUUhShg3EZY8UHzbIBir/kfvs1WHQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-27T16:57:36Z"
    mac: ENC[AES256_GCM,data:WEJJsy9xSjcIJlQ09/OczpJX6Rtau2777A6M7Y1nsCc1HblelSzLa4GyPrhiDl9rT4qrb1A2Lvngo5q3F0qtZomQU7Sp+6vI+3wBRcz+MSpA7wrRwiomKIz9/kSLFjd0+Gr6CskvPl1s8lC85gzuE1POcEMYgcJ2fkxBNEdATZ4=,iv:A15JKHSlkjjXk6B1QIEzzAKxnZxCvVqkjsTy9EdKG3M=,tag:NM5jStMN1+fLn12nu3F3ag==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/vaultwarden/secrets/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: vaultwarden-secrets
stringData:
    ADMIN_TOKEN: ENC[AES256_GCM,data:AtiuGrjBHMS+Sbcwil7rMxHj918JxadMCKMo7z2ssOK6TByqP7COz+oL1phJYW36Erf5LtgXzjFbjJ6/q1R6eQ==,iv:kPgPj18G818knyuE0p0Cb1i2b7k08bPWuKzyOxat4G8=,tag:y15k/XklwVMXHxLNS9Uasg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqTCtMY1hrc0kzQko3SlBa
            TWRMbkRUcTkybGpEWjdSYlYwdmQvTG9PZkVFCnJFaGIxUDlKclZyZGVNNWNuOE9V
            QU5ENUdWcHEva0FNbjFPY0lLYko0cE0KLS0tIGx3NlUxdHlWL1R0T2lBbThxRXRD
            ZW9XdlJZWjhzTWZvSEZQQ3FjdkNjOG8KUkvN59Z5/wxYeB6+1BPaj5lQIORn5vPx
            V3Fie5ZGBK9VgsA1HZvhLBXMP1A+c2BdeZ++QA16RCtZ7Fzk/biuvg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA0YWh3SlpPZmR1UGVZYVUz
            SWRUbFhVWFZ6aC8wRFFGaTQwaTJnaFo2RmpJCk90eC92Qkk4cldTZzZiUEg4eHlv
            a1FhWXVqTHcrQkQ5VGRsUEJGMlMyb2cKLS0tIGFQRU9rN28xbmNwaG1XR1poUTdT
            WHRCcmNXWC80aC9vSDFKanNLc3ZnRGsKoa8yevqdjqJNkBXl6pUa8yvcaL0pPqau
            suGfLzC1CGlSQozNbxHA8/9k3FrxoEHIb8o/HnjtVH01ujt24AAHIQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-27T17:08:31Z"
    mac: ENC[AES256_GCM,data:HqpUET4gMPRZVfvS3bZzPkcEZ180AFTywn7+fmA2GhzL0tTXandQ2BjyRuFA7TTaEJiJE96ZhR60NALpC/s6r8Tb93yfUDBPK1sV3OPXpiGp38OJjmCMyfPjS8tDP3WtC2PqhUNmWWHapVQDDfCJxcxTO6KTTprQUSODUIbmF3o=,iv:rRXLnxm3mpMbDQ0iBuJrGPPEVvlhe+Sz1sEIqzRDOLU=,tag:HNv72dptKOHDlSyEF1sdYg==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/vaultwarden/secrets/app/.decrypted~secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: vaultwarden-secrets
stringData:
    ADMIN_TOKEN: JoqHxGMO4y3n8CFcAj5qf2ih/CW0oOMnbdQZ6TYtH7SV+CGaE+hgoBXzW4bGBOob

File: ./kubernetes/apps/vaultwarden/secrets/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./volsync-secret.sops.yaml

File: ./kubernetes/apps/vaultwarden/secrets/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app vaultwarden-secrets
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  path: "./kubernetes/apps/vaultwarden/secrets/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  postBuild:
    substitute:
      APP: *app
      APP_NS: *ns

File: ./kubernetes/apps/vaultwarden/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Flux-Kustomizations
  - secrets/ks.yaml
  - volsync-pvc/ks.yaml
  - vaultwarden/ks.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/app/replicationdestination.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: invoiceninja-storage-bootstrap
  namespace: invoiceninja
spec:
  restic:
    accessModes:
    - ReadWriteOnce
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    capacity: "${VOLSYNC_CAPACITY:-1Gi}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    manual: restore-once

File: ./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/app/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: invoiceninja
  namespace: invoiceninja
spec:
  sourcePVC: "${VOLSYNC_CLAIM:-${APP}}"
  restic:
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    pruneIntervalDays: 7
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    retain:
      daily: 7
      weekly: 4
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    schedule: "0 2 * * *"

File: ./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${APP}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"


File: ./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - replicationdestination.yaml
  - replicationsource.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app invoiceninja-storage-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns invoiceninja
  interval: 10m
  path: "./kubernetes/apps/invoiceninja/invoiceninja-storage-pvc/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  dependsOn:
    - name: volsync
    - name: invoiceninja-secrets-storage-pvc
  postBuild:
    substitute:
      APP: invoiceninja-storage
      APP_NS: *ns
      VOLSYNC_CLAIM: invoiceninja-storage
      VOLSYNC_CAPACITY: 1Gi
      VOLSYNC_ACCESSMODES: ReadWriteMany
      VOLSYNC_STORAGECLASS: cephfs
      VOLSYNC_SNAPSHOTCLASS: csi-ceph-filesystem
      VOLSYNC_REPOSITORY_SECRET: invoiceninja-volsync-r2-storage-pvc-secret

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/kustomizeconfig.yaml
nameReference:
- kind: Secret
  version: v1
  fieldSpecs:
  - path: spec/valuesFrom/name
    kind: HelmRelease

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/backup-cronjob.yaml
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: invoiceninja-db-backup
  namespace: ${APP_NS}
spec:
  schedule: "0 4 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          automountServiceAccountToken: false
          enableServiceLinks: false
          securityContext:
            runAsUser: 2000
            runAsGroup: 2000
            fsGroup: 2000
            supplementalGroups:
              - 65541
          containers:
            - name: invoiceninja-db-backup
              image: docker.io/databack/mysql-backup:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: DB_DUMP_TARGET
                  value: /backups
                - name: SINGLE_DATABASE
                  value: "true"
                - name: RUN_ONCE
                  value: "true"
                - name: NICE
                  value: "true"
                - name: DB_USER
                  value: invoiceninja
                - name: DB_SERVER
                  value: invoiceninja-mariadb
                - name: DB_PORT
                  value: "3306"
                - name: DB_PASS
                  valueFrom:
                    secretKeyRef:
                      name: invoiceninja-secret
                      key: mariadb-password
                - name: DB_NAMES
                  value: "invoiceninja"
              volumeMounts:
                - name: invoiceninja-db-backup
                  mountPath: /backups
          restartPolicy: OnFailure
          volumes:
            - name: invoiceninja-db-backup
              persistentVolumeClaim:
                claimName: invoiceninja-db-backup

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: invoiceninja-secret
    namespace: invoiceninja
stringData:
    APP_KEY: ENC[AES256_GCM,data:cxgkNtikuozxssTeSF0rKriydSTj3yAD4he032/XtCnGQhRET6p86TpZPqx3Ch3i/fBF,iv:g4RLoALOKIBVJF/DClpudhXiFqvyvBtmrxWs2SLhVyU=,tag:z7spbScQqIIp9PlmFxms4Q==,type:str]
    IN_PASSWORD: ENC[AES256_GCM,data:B85+/mP/dcO9xA4XphDowzBvsbqJ3Y5H69unqz1F,iv:PHgFhEmwnA4JdnVsrXpD3K0p9hbljzfuNugHEh0hcjI=,tag:EPMKXCs8N5v2HciW3fJUJQ==,type:str]
    mariadb-password: ENC[AES256_GCM,data:2TyDYUfp2J66yv4876B3TckurQUE8hD16DoCutgKMzE=,iv:EbM3HVrmwfX5xBNP1+6COB/Gwk64P6oSD2SLE8a6I4U=,tag:i/5WdkNvxz/I/K+Tx4G2rw==,type:str]
#  MAIL_MAILER: smtp
#  MAIL_HOST: smtp.office365.com
#  MAIL_PORT: "587"
#  MAIL_USERNAME:
#  MAIL_PASSWORD:
#  MAIL_ENCRYPTION: tls
#  MAIL_FROM_ADDRESS:
#  MAIL_FROM_NAME:
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA1VjNmOTRUaEVPNm9BaWhm
            eS9MU0RORTRlTFVxRmxacHFEbkVxLy80TDBnCll4UEo2ZlpKeStPcnBpR0hmdFRR
            bFM4NE02cklRY1orVzhLaFRtQk1nakkKLS0tIERIcnFFbUdvNURvY2hZQjRoTmQw
            UHRISWs3a2FFWDlXaHViY0dRb0ZaRlkK7MbJsvlHQ9IHItzeE6ubMMd8LjWNfVxv
            gNVZbQtW/bE6YY2cNI6xTfqlrz5y0gr5F+7TjsgLH/NHuFkGB4FKxg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBaSWF4VzdQS1R1bXNKcVN6
            MUF1TVYxLzNaaDlSaFBJdHpwTERocFFqTGtBCkl0NFBJZng4T1FBazFQejAwRzFs
            d3krbTl6UkZKd09kc1dnS0tlMUFMT2MKLS0tIGhxYUtKOHpOaXVnQkl1N1VCM0hY
            dlUwY3oxdEZ0ZzVjSVVIajh0b0JWdEEKAMXlfuH8hMJj7ityFp04Jl3J160Tk9yT
            Gcm3eXIJ/PuJVJyvU2h4hqC82kCo71/qC7/5yzbOw+HDPJVKhSROVw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-21T19:50:23Z"
    mac: ENC[AES256_GCM,data:2desrRY1/IeKEu0gdLkXd6a3IpoADStSjEQcCDEcybQD9PaZS96D23oUybhiPx/z3hPnw1L6Z55+uOngW63dILtXHd0Z5OOGvqV8kvAAzjwMiIHwbaHtiYyUfrKNJ/pIkn0lzXFys1F1fktkVaiklP50pibpPP+gn0zHZzHpl6o=,iv:aHLTmprASJ9wD76ho0+c+/Lyna66oQcyVK5fTY04ZR4=,tag:0oNu1JKYlqpFOiP9/4uP4g==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/.decrypted~secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: invoiceninja-secret
    namespace: invoiceninja
stringData:
    APP_KEY: base64:jtZ+GUsr0chOf1WjyGRVcEKLjZVjlD/GxdSoCPjKkDQ=
    IN_PASSWORD: isheeXai4ohthoh8keer]aZe1Footi
    mariadb-password: oovifu0eeJ0Aengae*ph[oh=Y7aimoYu
  #  MAIL_MAILER: smtp
  #  MAIL_HOST: smtp.office365.com
  #  MAIL_PORT: "587"
  #  MAIL_USERNAME:
  #  MAIL_PASSWORD:
  #  MAIL_ENCRYPTION: tls
  #  MAIL_FROM_ADDRESS:
  #  MAIL_FROM_NAME:

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: invoiceninja-db-backup
  namespace: invoiceninja
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
#  storageClassName: 

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: invoiceninja
spec:
  interval: 1m
  chart:
    spec:
      chart: invoiceninja
      version: 0.10.2
      sourceRef:
        kind: HelmRepository
        name: invoiceninja-release
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 0
  upgrade:
    remediation:
      retries: 0
  valuesFrom:
    - kind: Secret
      targetPath:  externalDatabase.password
      name: invoiceninja-secret
      valuesKey: mariadb-password
  values:
    debug: false
    replicaCount: 3
    image:
      registry: docker.io
      repository: invoiceninja/invoiceninja
      tag: 5.11.10@sha256:9a834a43a634edeb3ffb16010a24a77b8fa42ee89d13ff774fbec1e3deb03fc6
    existingSecret: invoiceninja-secret
    updateStrategy:
     type: RollingUpdate
     rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    appURL: "https://invoice.${SECRET_DOMAIN}"
    userEmail: "${SECRET_INVNINJA_EMAIL}"
    mariadb:
      enabled: false
      # auth:
      #   database: invoiceninja
      #   username: invoiceninja
      #   existingSecret: invoiceninja-secret
    externalDatabase:
      host: "mariadb-galera-maxscale.database.svc.cluster.local"
      user: invoiceninja
    externalRedis:
      host: "dragonfly.database.svc.cluster.local"
      port: 6379
      password: ""
      sentinel: false
    redis:
      enabled: false
      sentinel:
        enabled: true
      master:
        count: 1
        persistence:
          enabled: false
      replica:
        replicaCount: 3
    persistence:
      public:
        enabled: true
        existingClaim: invoiceninja-public
      storage:
        enabled: true
        existingClaim: invoiceninja-storage
    ingress:
      hostname: &host "invoice.${SECRET_DOMAIN}"
      ingressClassName: external
      annotations:
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        nginx.ingress.kubernetes.io/proxy-body-size: 100M
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
      hosts:
        - host: *host
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host
    podAnnotations:
      reloader.stakater.com/auto: "true"

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/ingress-int.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    meta.helm.sh/release-name: invoiceninja
    meta.helm.sh/release-namespace: invoiceninja
    nginx.ingress.kubernetes.io/cors-allow-headers: X-Forwarded-For
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: 100M
  labels:
    app.kubernetes.io/instance: invoiceninja
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: invoiceninja
    helm.sh/chart: invoiceninja-0.10.2
    helm.toolkit.fluxcd.io/name: invoiceninja
    helm.toolkit.fluxcd.io/namespace: invoiceninja
  name: invoiceninja-int
  namespace: invoiceninja
spec:
  ingressClassName: internal
  rules:
    - host: invoice.${SECRET_DOMAIN}
      http:
        paths:
          - backend:
              service:
                name: invoiceninja-web
                port:
                  name: http
            path: /
            pathType: ImplementationSpecific
  tls:
    - hosts:
        - invoice.${SECRET_DOMAIN}
      secretName: invoice.${SECRET_DOMAIN}-tls

File: ./kubernetes/apps/invoiceninja/invoiceninja/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#  - pvc.yaml
  - secrets.sops.yaml
  - helmrelease.yaml
  - ingress-int.yaml
#  - backup-cronjob.yaml
configurations:
  - kustomizeconfig.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app invoiceninja
  namespace: flux-system
spec:
  targetNamespace: &ns invoiceninja
  interval: 10m
  path: "./kubernetes/apps/invoiceninja/invoiceninja/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  dependsOn:
    - name: volsync
    - name: invoiceninja-storage-pvc
    - name: invoiceninja-public-pvc
  decryption:
    provider: sops
    secretRef:
      name: sops-age
  postBuild:
    substitute:
      APP_NS: *ns

File: ./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/app/replicationdestination.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: invoiceninja-public-bootstrap
  namespace: invoiceninja
spec:
  restic:
    accessModes:
    - ${VOLSYNC_ACCESSMODES:-ReadWriteOnce}
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    capacity: "${VOLSYNC_CAPACITY:-1Gi}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
    #volumeMode: "${VOLSYNC_VOLUMEMODE:-Filesystem}"
  trigger:
    manual: restore-once

File: ./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/app/replicationsource.yaml
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: invoiceninja-public
spec:
  sourcePVC: "${VOLSYNC_CLAIM:-${APP}}"
  restic:
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    copyMethod: Snapshot
    moverSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsUser: 1000
    pruneIntervalDays: 7
    repository: ${VOLSYNC_REPOSITORY_SECRET}
    retain:
      daily: 7
      weekly: 4
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
  trigger:
    schedule: "0 4 * * *"

File: ./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${APP}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"

File: ./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - pvc.yaml
  - replicationdestination.yaml
  - replicationsource.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: invoiceninja-public-pvc
  namespace: flux-system
spec:
  targetNamespace: invoiceninja
  interval: 10m
  path: "./kubernetes/apps/invoiceninja/invoiceninja-public-pvc/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  dependsOn:
    - name: volsync
    - name: invoiceninja-secrets-public-pvc
  postBuild:
    substitute:
      APP: invoiceninja-public
      VOLSYNC_CLAIM: invoiceninja-public
      VOLSYNC_ACCESSMODES: ReadWriteMany
      VOLSYNC_STORAGECLASS: cephfs
      VOLSYNC_SNAPSHOTCLASS: csi-ceph-filesystem
      #VOLSYNC_VOLUMEMODE: Block
      VOLSYNC_CAPACITY: 1Gi
      VOLSYNC_REPOSITORY_SECRET: invoiceninja-volsync-r2-public-pvc-secret

File: ./kubernetes/apps/invoiceninja/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: invoiceninja
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/invoiceninja/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: invoiceninja
spec:
  resources:
    requests:
      storage: 10Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  storageClassName: cephfs

File: ./kubernetes/apps/invoiceninja/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Pre Flux-Kustomizations
  - ./namespace.yaml
  # Flux-Kustomizations
  - ./invoiceninja-secrets/ks-public-pvc.yaml
  - ./invoiceninja-secrets/ks-storage-pvc.yaml
  - ./invoiceninja-storage-pvc/ks.yaml
  - ./invoiceninja-public-pvc/ks.yaml
  - ./invoiceninja/ks.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/ks-public-pvc.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app invoiceninja-secrets-public-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns invoiceninja
  interval: 10m
  path: "./kubernetes/apps/invoiceninja/invoiceninja-secrets/public-pvc"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  postBuild:
    substitute:
      APP: *app
      APP_NS: *ns

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/public-pvc/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: invoiceninja-volsync-r2-public-pvc-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:k3JCOYyFhxxF27LF8X68Ii80ixUNM0vgCyJRy1UgdxF/ke5PEuBiyZFgP0ZCEG8vD2BgTnhn8FY/8CO6J35qpiEMuCJoWHK3erk2GhKVhZLPXh5hSIQG7Nz5shGj09jk1XESikJZHqg=,iv:yt118VktIZZxKmudA2DhUiFrP+VdP7eJzLGEvp7sGyk=,tag:pHy6i7kheUfI1oz/YnJjRw==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:HTUvU2/PffSX6goEKTJ9IOzD9CSs/Dh6TZOWGWtNTsU=,iv:MhmN9Jkr4qxTTPJ21yZd9byhJmg7SLWL89GKmb/SzFE=,tag:yatZ32+wTN4IE+4D/ujEKw==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:A20AxBu+Y0inFeHONXDUvbyZHGpKrrw85LfXylSx0Gc=,iv:K9J0RHNmBAT8xjWS3qyJvtpOAXm97hb8hG6fvFgXTBk=,tag:eL4h85H/sg7TVLQINuOvZQ==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:8Lar3xCHzEk/BPWhZ9cbhGBXNYrqJz1E3F/K9dBAm+D3QTj0DSKtlP6Tk4fmHxNaurD8QNAP0A7hwSpOtH5eTQ==,iv:3sAhH73zABbM8owNfDF7iF1stsUw0uCXFreC3pQUAcE=,tag:dAkK7K7kwi/EMXjx/Zj6Lw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAxOFdUVmQ3blhxRWkzS3Az
            c3dsbENsL2lLZnE0Qm1nRHM2TE5CQzVUbUZvCmVTZWlYSTQwN2pCYWtZa3lYdjcy
            dGVJbDZzT3FIU1lzQnFobnN0NlBxdHMKLS0tIG9nVElubU4zVVBuMk5iNTcyS0Jy
            M05MOTZKQ2EvZ3hia0RFY0dDaFdzcjgK0im2Sz0cjW/rxzMwrf3ay3zmcmfoNdFU
            tdKL3Jsu07zzfIjD+cbfc1bRS4qaUQDVDQZ3DU/gu22fl75mpCX/qQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBBcTV4VGZzcWl0alpEQXE0
            NlpBOWRjc2NSMVViaGdEM2pCYmdxQ0h0cVFBClRTMlEwNGRaT25sVVlXT2tTT3NV
            NzJRb1NCNm5uazRqU1cyNTZleWRWOUkKLS0tIFpBcXpDRmxhSU1qTFhLdEg5VW9n
            SjVtaFg3YW9Hc2Z2UWZTekJaRHp6eU0KZWx5j9kmLKsQOz47Oys3qBe5vMSR+nnA
            xfdGQWPw8gnzfiawN1c0SoiRkwhmAdfzfrv1Zi39eXBvX2f8BodYeg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-27T20:54:10Z"
    mac: ENC[AES256_GCM,data:d4H5XZ0uZt3jDMtdFD6WWpuGlAN0e4KnN9b9BysIbx6tWiD1x9xzK/+E3+J78c5zyyyvWl8pG2KQnpphZb8ILdX0jaPEGzFJWnXQo6kQUHWAh/Q855CtgBo0k3MpWRTqugDo1inRwf0z0/V5qdIdniFxkISTgCqFYhpGNV0O1jA=,iv:35CSXV3Z2MSklr0zJcZyBUxGiVxHXCyfOAdKYi1YEHk=,tag:1hh5+iWdRBMeJB74JK66vQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/public-pvc/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/storage-pvc/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: invoiceninja-volsync-r2-storage-pvc-secret
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:gEdWkwF+mQ2WNnned12KO6jKXaaefou5sS/wGTABaxo6azfbUdi/0c8mi8B4/jAqH/DbK/T/sTvtb1kS4IeC/dvAzuCyxltr4FnqrqIylonwmstkKkbS3eZtItn0vTUkas+cyWAF5TAZ,iv:dqUWOthDrxTg5Li4NkLRL+NV9FM1zf4QnbrdPaUwItM=,tag:B1SJqlVmMQ5n9MOaT0iPWg==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:qt28C/jib3HN7e8Jtdx4uPX4o0IiT2fVwLXUr5ySfiU=,iv:no8krxMlqpeCYc4ZYNv4w0Mu4uaukpLWR72lBTWxYic=,tag:XeSCP+WtToUxIvVD7rXwbQ==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:Bx8nX8xvwETJzmaG5y4x23MgDGbwe6uCj1xOFjPStf0=,iv:RlT7dI6b6vsUPss1iof1/87HsGK9UG6vfo+hycEtKiQ=,tag:miC1o/Vh/2GSWxvkvRN8lg==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:WR2yKIdyr5QjUDvi0Fx6e+Jq0dZ59Zg0QMN7zgCxWByVWXGjwHs29XB6cmoBJYrFcSpZQ4d4/sIkPdMtMunehA==,iv:NQrUeoyW2JJBtBIcroe6d8NYyQOPkBibxgd5w9m6VSE=,tag:Du7kpoI7c8UsmuvsWX7hTQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBMVjRhb2ZjL2NNR2duRUNT
            RVF0c1R1K2ZlU3pwOVo5VTM3LzdoR3p4NVRNClN0d1B2akg4U25lV2htZllQYjhm
            N0lMdE5EQi9ock05ZkZYUEp5NG84T3cKLS0tIHdsRFl5RjlTQmhxd1FwVFlHRHhi
            amlpZmt5bTRwdzg5N01vRXFuRU1CNkkKqFn6azkrUS/zHUmgqrVvigJPPMTjlOIv
            9EH0El8SfH36ohJ1PO84de5P/6RHroIl+IB+mxmDKYgAJHvusmZ2rQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB5NW44Um5qcStmSmNabnU1
            eER1NlZXaWNuRDlETHc3bDNxOEpmU3RCMTJRClJ5dWUxcWl3TEhSWnhTWjBKU25N
            OFpJRnVvOXVsRDZmdVgrZVhVS05jcWMKLS0tIG1wNGw4VDM4QzRVT1ZSdSs2SUZT
            MlJKYk84UWU5azR0NE0reVMxTmNvTHMKZutw/8uHBcnlwHtkxxWVIpTrZB8rpS3D
            wAkT9n+T21xsOiQAUwBjrqA+0OGnNP4PDY9PsLxa9fqeabLXpsgf0w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-27T21:14:17Z"
    mac: ENC[AES256_GCM,data:1Ij84ZKtrlXyAN5k52t3SiEiOtt48z/S35Oy5LGb8Zv3DfQrP/CSdX1SlifGqsAfmFXOLhz2f+67qdGiSC5epeW8+SsEV4TlV44jipHeYmcVM2yjKqnJpC/VFhgTJhKa4GeL9FtpClem0sle6NXYldhbaaat8FJ70EP8l4L4txM=,iv:CBVD2HXikS9kzAFc8pB6KzUqZgc9P9BQGYJo5VbKVVM=,tag:tQ5yPudAxtDwTnEtGnIgQA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/storage-pvc/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml

File: ./kubernetes/apps/invoiceninja/invoiceninja-secrets/ks-storage-pvc.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app invoiceninja-secrets-storage-pvc
  namespace: flux-system
spec:
  targetNamespace: &ns invoiceninja
  interval: 10m
  path: "./kubernetes/apps/invoiceninja/invoiceninja-secrets/storage-pvc"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  postBuild:
    substitute:
      APP: *app
      APP_NS: *ns

File: ./kubernetes/apps/openproject/app/helm-release.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openproject
  namespace: openproject
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      openproject:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: openproject-init-secret
          rails-migrate:
            dependsOn: init-db
            image:
              repository: docker.io/openproject/openproject
              tag: 15.1.0-slim
            envFrom:
              - secretRef:
                  name: openproject-secret
            command:
              - bin/rails
            args:
              - "db:migrate"
              - "RAILS_ENV=production"
        containers:
          app:
            image:
              repository: registry.skysolutions.fi/library/openproject
              tag: 15.1.0
            envFrom:
              - secretRef:
                  name: openproject-secret
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                memory: 4Gi
      worker:
        annotations:
          reloader.stakater.com/auto: "true"
        replicas: 1
        containers:
          worker:
            image:
              repository: registry.skysolutions.fi/library/openproject
              tag: 15.1.0
            envFrom:
              - secretRef:
                  name: openproject-secret
            command:
              - bundle
              - exec
              - good_job
            args:
              - "start"
            resources:
              requests:
                cpu: 150m
                memory: 512Mi
              limits:
                memory: 2Gi
    service:
      app:
        controller: openproject
        ports:
          http:
            port: 8080
    ingress:
      app:
        enabled: true
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
        hosts:
          - host: openproject.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - openproject.${SECRET_DOMAIN}
            secretName: openproject.${SECRET_DOMAIN}-tls
      internal:
        enabled: true
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
        hosts:
          - host: openproject.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - openproject.${SECRET_DOMAIN}
            secretName: openproject.${SECRET_DOMAIN}-tls
    persistence:
      data:
        enabled: true
        existingClaim: openproject
        globalMounts:
          - path: /var/openproject
    # Uncomment and configure if needed
    # config:
    #   type: configMap
    #   name: openproject-configmap
    #   globalMounts:
    #     readOnly: true

File: ./kubernetes/apps/openproject/app/openproject-smtp-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: openproject-smtp-secret
    namespace: default
stringData:
    SMTP_ADDRESS: ENC[AES256_GCM,data:gTuamBq9xU7q8d6DnnbAa+Bx,iv:/MTxifd/5JU3Jzfxv2oo7t7AswV8FzNcUqoha7oBhyU=,tag:YVvZRZX6Q8PAxCWdKMr1kg==,type:str]
    SMTP_PORT: ENC[AES256_GCM,data:o2wX,iv:+UEEFwk/TSiS198AlAfCyWGPgJDHD/mbonCj6gpHgVg=,tag:xHwvREeymZYWzow+1qVZCA==,type:str]
    SMTP_DOMAIN: ENC[AES256_GCM,data:ks7xYBEYzn0rjEZcTtXH,iv:kgz3IuC1MdMYbg/W/VYFdBqwOMH8JYE5FJWHTA3mvlw=,tag:24j5RPrXWvzOwJoeptAutA==,type:str]
    SMTP_USERNAME: ENC[AES256_GCM,data:W0kJo6aNgj0Ub1EJs091DMUtyQ3SSBs=,iv:VvDBdCvbL32/wGt5vpRMIodzst3H8TIFwj2vauHZOCM=,tag:bLchJ9d+zzVhJSfkeN1lzA==,type:str]
    SMTP_AUTHENTICATION: ENC[AES256_GCM,data:GPnpjgU=,iv:vpRe/WPXYqNdiiXDnZaKvO7jcu/yMucsQr1QptwWLH8=,tag:gsx9lzYFZMDTKfPQGf6nsQ==,type:str]
    SMTP_SSL: ENC[AES256_GCM,data:LSb6Sw==,iv:3w8J62DduZUgROTcZfEPEraTvyNeFZHuyrGvQE82r3A=,tag:AHZgjKp/k/FOGO7Gc6nXFQ==,type:str]
    SMTP_PASSWORD: ""
#None of this works :)
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXdXNaYU41NnRhcTJySnF6
            MXhmeURnL1kxMDNRS2l1S1pHZzhzbHArZGtzCkRUalNRc2loRDVMU0VGUzNCRzND
            YjNvd0ZUaTBITnBwUXJ4dVdQcU9zdWcKLS0tIGRxcklLVHIybVFlaXJXb1RNM2VV
            SEpDczhqaE5QaW9va3dyNGh3cXZWSnMKgWWYpDP0UHBgnzAGMLk/UzINZYj9MGIv
            r8+ioYsGOlJZ+D0rhlRDH2et9YhgRkOPZclZOAQqS5ZAi5qEx74paQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJMHBJMGVhVVdrQithZXpB
            MStqY3Avd0VIdmxQN3VSb2dIUEJqZ2FwWTM0CnZRNVp6UjhGTUpnL29FK2ZnMGtj
            VWoxa0lJRU0yY1pZMnIvM0x2R3lIYk0KLS0tIDdScmVLdURVakVFWDUvMkIySWhh
            Y2NyWUIyR28zcVhhOThyRzMwRW5Nd0kK6jzlbICX1+ajVCBr4F2HWlzCdminLCsg
            cCi1ZTXAUM1rBonQp5K4BvPxfZgPoQqpcPJxY+jwQbA5OUZ351ivzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-26T02:58:56Z"
    mac: ENC[AES256_GCM,data:piPSGGa318wNBcsQ3e4l1ib+KeNVgs/KcsaX+QDpbbsW4NsHcBvh32Zoh5WFbyrXHb+1UmW+5ghK1WIle7kAr6XybvyMTFraTz9dF1HzAEaSjMNF2tqPIshIxhaXBwpH0YOgKL5TH+qOcfMd2c8RSMB+7oHK0DO1MfGH/P+mibY=,iv:pLYFHsjL/eNFt8W5ttDAmaf3TAfYquFTTlEyDnweDH0=,tag:A85+kMMLlSCjp6AWxY7xsQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/openproject/app/openproject-postgres-init-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: openproject-init-secret
stringData:
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:3ZCfqWshyJDh9pU=,iv:2W5GdExBZ+n6DA2R/sUk75/r5FcRTsdRyrJf7ksfC84=,tag:Q8oJ54jJn4K0UfeolOnysQ==,type:str]
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:AkvEB48Dt1oWkEeCH7FTfNJqUoQYm+5WpcHKTA1/f3lDtDsltOJc7Q==,iv:kFopNmRf/VzH7sFpyy2ORrn/3hoEmWWxzEVh1Yeb828=,tag:mcOq7gOpriNPbUHD2MsxtA==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:qDz03BD851KfaaA=,iv:P/3zIIMXrPPn9tf+R/wzZsnIMA+Cijtls+vB28TA5Gs=,tag:+itRB7HDsj6UwnJN08ao7g==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:UDKwdNUsTQvEnw4ec2YYRJx00BCmReK1dG3wrJb7,iv:oTLH0un0t/ZyNZSVj6Mmf6eNFwg3/or592o204waNx4=,tag:XxR95//7dPZuig2ewjASYw==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:BpygTTPHawCn6t5mzytHColW3weB/yaGcXKa9dHt,iv:VzVXNOIC06qtcezey6+4oFhJJ6tvN5yeSRL3GLVhfhY=,tag:ez13KJZYPZSFl/j+1QvDBg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOaXp0N2VJZVRWTUYxdXBy
            V0VQSEhIZVkwditLOUY5N04wVmo5L0tBZmtzCnhnNFA0RFVBa3ZJL0lUSGZqK2x6
            TVdUMkhESzFRU0tpNm1aWkVuaVJ5bW8KLS0tIFJNZGhZYyt1OU5FM0dySXN0dm9r
            d01uci9yb040TlZPSDFFelpBd3VRdjAKSpgq8UZA71JH/NYveeuawNbZ/4ZbCX6g
            gwpIVyXwXV+/aIihyUTILRtj4qdcNIfIgUNi3S3tIC9T6rx59mBb/A==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA0RUxXbWJxekg5b3lEUnJo
            ZlBvRUpjUTcrb3VjcFZ6QkM0SnVZeVN3QW1FCjV6NlkrOHBWQWlmZVFRdmxGbzZk
            aDBDM0lZV2dWa0pUVGtraUFqNXVGRTgKLS0tIEs2MTlITjdxd1FTUCtpbS9NblYw
            bWtGdUFXVm90WGVqTjk5RUZma3hXK0EKZC1EWpBwN5nasRs/AkkCmh8hXCTwpwls
            N4RdN2wF08JRQRJYxKHHAtQ7ScNR12Mkmt5STZpObGpoxBmx+dI4lQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-13T01:34:45Z"
    mac: ENC[AES256_GCM,data:gd30bOOcaZDnOwnkIQoHzzq+E6sRiXHFMJgLuXOy1ZUxwpyPPGh7VnBVUIC1B6P8hVXUGpY9m8N4gg4WO/8tb5QPWegq+MEVHu8W4eRrLQqTE9ofRAKf87LZy/QZd2cLSvmD4Exd9WrAut4BfB0Wq3lg6avV3zdnfhnqzXhFZGc=,iv:fl8soIywOFQTaUxnwb8J191WxYALMTiHiFo0CPoDbTc=,tag:lblhlSNDvvOeg4KgVPpTtQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/openproject/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openproject
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: ceph-rbd

File: ./kubernetes/apps/openproject/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml
  - openproject-secret.sops.yaml
  - openproject-postgres-init-secret.sops.yaml
  - pvc.yaml
  - openproject-smtp-secret.sops.yaml
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/openproject/app/openproject-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: openproject-secret
    namespace: openproject
stringData:
    OPENPROJECT_SECRET_KEY_BASE: ENC[AES256_GCM,data:Eu0dXTdCsN/sp5q1AGgvqOYjOZgeZuefX1CWBpVRTt0=,iv:h0wrZn2rozwUifDFQfKC03RLNGAzq4NcuOFGxLsQqDY=,tag:HWEkvRi2xGt6IBkMmSOHQw==,type:str]
    OPENPROJECT_DB_USER_PASSWORD: ENC[AES256_GCM,data:HUQqQN8ya86W3Clq0L13JtmFVukLC1ZZ96NjgI+J,iv:MyK1JmTy5eLctkpVrjLghE8krdMpNEeTV95nozhY5E0=,tag:8qGrM1Pb5RGd147J/BID6A==,type:str]
    OPENPROJECT_DB_URL: ENC[AES256_GCM,data:sQCnHNv1c6YsJcbBgqrkzYADQFIeo+cSpM50lxHwehW0dhfUj8hNNeWnrXTbtcLJ6IKOgZZvQbykcauTa3gZ+CC/QlryCzjqMIPfXJV2gqs9U5NPRvxY5lVs9RYFP/g05Ka4TNOojRJIWg==,iv:h1TM+rrWe2PWRAgGgVAUeOH92JqC8YTc+DpA3tN6DIQ=,tag:4uoblVpiv2Lr1GA6Dbsumg==,type:str]
    OPENPROJECT_SEED__ADMIN__USER__NAME: ENC[AES256_GCM,data:F5d8+zE=,iv:A0K5JkfnjzDT+Yy2/i40YSQpLTgo+z+gy5uMaXq7LxI=,tag:17/mPcOcrqt+rX439WgCJg==,type:str]
    OPENPROJECT_SEED__ADMIN__USER__PASSWORD: ENC[AES256_GCM,data:7ZVdAq5+J2xF+cUVr4VTlVT6OdhC2HT4sqrUhueG,iv:mUqAE+2FX+lfUHY13xx5mL7HhfO3PiSqKkLvv5JoEqA=,tag:9G1Zty7yH5iAAjR1rRY9AA==,type:str]
    #ENC[AES256_GCM,data:MC8L5lqTdEQPTG3EECTo6jggeY3kypQtLljo58dQgTYKAOwxF2LuNODpLzoa0sAiMVBDb+FGn+7yFQ==,iv:h/r2ZwgvMW8kz2laIoI3egK54VLf80VhgVwn0VHQVM4=,tag:Xw2DdwclW+F5CRm75V8WlQ==,type:comment]
    #ENC[AES256_GCM,data:awBTCvK8bf2uMxc2lm6X7wcLPGRbuvS87xqnlomPFZaFzPVFSudJ2hLveejdR32YDp1+woxejQ==,iv:JYwmQuS1kbDMvXohvIutkemn19pJJOv3Kyn7DQLj6lM=,tag:1MKTpHDlZCP/eIKhikHxrQ==,type:comment]
    #ENC[AES256_GCM,data:3BCQ0d1zxHIii3zQSD1APR/z5JJx2WFqeeBYd+aqDQmjmiiAXk102DrWkwkNvwzK0/KOiKHyk8QrbgDHQZGf0ubdYk+FafluRZUfcIM=,iv:jig6IXZRPV/KsBc0pLdw1NdA9y+7lspChoEMFA6iYBQ=,tag:rBWSkKycOII73OMtXm/LPg==,type:comment]
    #ENC[AES256_GCM,data:/b+rGBJQUoLhn6VQ6G2zaHGLA6EeJv5mvgAed+XqvU59zj/4AQJt9w==,iv:ryxYmdjO1wWt5bgWAhDGYZsyLimRHgPxIFFG9ol7zFk=,tag:S89StB8GmYFunNR4+hn2FQ==,type:comment]
    #ENC[AES256_GCM,data:/9AW1bNXxyu39f+ZO8Z/HkPo7uuAENJ45e2yOIEseD/peGWpiMESmVUY7ICn35IBsOdx3PhbsQDdg+LWLA==,iv:HzyV0JEjF3rPC+0N0+X4YCUQnnl7fXdCl/0GC9JzT8A=,tag:vvM5UogEfEIh0s3R812nRw==,type:comment]
    #ENC[AES256_GCM,data:AO1mGVl0HlXs34N24UhMhr3SescuuC388jWFXxwU8eHbRdiBxJj73BUVQrrrcPSiwYmyxA==,iv:WyU1yKkCNGTl0NUYsBG8uhJ6Pbt9nuWPubYPskXEL70=,tag:JQugc5V7zZiqXxsxOR0UEg==,type:comment]
    #ENC[AES256_GCM,data:GWfLsDce2QZOf+wK0OnCKHeul5bQ9/twPmh0zNewahIgOC6t3M9+RIdkGdA=,iv:hD2Ksg3pt8fHl1L1GO+VU6RU7jRrU0x9x+N8iklOEw0=,tag:8RgtwjzppDTc0Kf7KP9AdA==,type:comment]
    #ENC[AES256_GCM,data:H9mulUn+ZI33gUQwcyZ0jLmsLxhCdC8aHCTY05yM0dg50H3ys1LVr/OhtZhF0ReWwsBALhuEnuoq748ytnV+qKBUXA==,iv:ZdLzwZr7qlshZvcP8Z3Uu6S2AhidxZ1Z1VY3PXBISJQ=,tag:U8zBp7AC/7zf15v1erwg7A==,type:comment]
    #ENC[AES256_GCM,data:nEozcv8Y69EcAk80+EUVXTOqcMQ09DM=,iv:W/SGalhJQcifq70VtBzu1o+Sj5AEgVDUOmEU5WaWJRo=,tag:nEsZ5Fc54AIXurX5j4rZTQ==,type:comment]
    OPENPROJECT_HTTPS: ENC[AES256_GCM,data:1Zg9XQ==,iv:1ziRLB4AsLM8C+40gpmLMkVziOOmjcUPgpNYD9w6BYU=,tag:uzze5l37WJ4YU75oIPJh+A==,type:str]
    OPENPROJECT_HSTS: ENC[AES256_GCM,data:tovePA==,iv:Trt4tpJRsabOBe5115NLBegbEtw3pX54JFFjHZQ4APs=,tag:kWpFiacoNHJGYlR6emH48Q==,type:str]
    OPENPROJECT_HOST__NAME: ENC[AES256_GCM,data:xvz8Lz8j466L4aJk9j2hrxdOx7cJ8/l3hO88gg==,iv:3Hx3U+Jtp5FbLhuFSRSnMXgx8aI0V9kGkR3Tu/SRcRg=,tag:C5rCJfg7LwjSXQsl82e1hg==,type:str]
    OPENPROJECT_SOFTWARE__NAME: ENC[AES256_GCM,data:7QWmDm5Ko2Q=,iv:K2dOYQ1QAl1EdXRItAAzZIzbhODsdRmP+Up31TC8xsY=,tag:4CcMxfakNmBHlpWA8NSaGw==,type:str]
    OPENPROJECT_SOFTWARE__URL: ENC[AES256_GCM,data:lIsuRK80/gAqAWa1fh3Zo+0pdQZFbj0YcZRCAVi7aevdgWzp,iv:5CEcR4MmYTB54PmLI3zfEsETE+f4VqX4m6o7I+G/3PM=,tag:BdyGqgzy8Bg7MMxuyvFE0w==,type:str]
    OPENPROJECT_CACHE__MEMCACHE__SERVER: ENC[AES256_GCM,data:tp8V7HaEQnwmDu2suRENHZYHOPuKxDw8Om7fYu3085PB6AbYN9jzIOp5QEDAAQB0pQNzWXI=,iv:7kJxovi+QFg3AKLA5kYpcY1P6KQBpSFOc3yu3UzjftI=,tag:jIvik+tXxYSBE7eC/Mxr2Q==,type:str]
    OPENPROJECT_DEFAULT__LANGUAGE: ENC[AES256_GCM,data:KKo=,iv:6SRH7L17+BJ8dZlmwHadpt5OlrEu7NppPXAAqgv4lZk=,tag:kAQCfVUZlGNtUG4bnixhpQ==,type:str]
    OPENPROJECT_RAILS__CACHE__STORE: ENC[AES256_GCM,data:lmnO8DRKjG0=,iv:4WmrKasYXWWfN/siF7HH1nz2nDJm/YIoDBIortqbrdE=,tag:s+mHzxHqFUFVj+Cs9r1LUg==,type:str]
    OPENPROJECT_SEED__ADMIN__USER__MAIL: ENC[AES256_GCM,data:7s71jHg6cPEgg4LpcRFvp0xVJZFLhH4jsLwX,iv://OSiewMACQvstl3u7kTGJ390+5/yMkx5pSrCNWW6J0=,tag:AMKvDzYN5MuLIXJbidqUzQ==,type:str]
    OPENPROJECT_SEED__ADMIN__USER__PASSWORD__RESET: ENC[AES256_GCM,data:aHuF3Bs=,iv:5aE3Ksz1DnwZYz+3BxC/5ivhttWKo8p/TLc2t7wSQ6Y=,tag:YE8qGwgDu8YTTUxLjz22tQ==,type:str]
    POSTGRES_STATEMENT_TIMEOUT: ENC[AES256_GCM,data:Nu6t,iv:tNZwaiH/FTiThCZ4Mux3i0bnE4YrbCDTIIMA9ExMZvU=,tag:m/2UWhJe1V7fniXsF9gCwQ==,type:str]
    OPENPROJECT_BOARDS__DEMO__DATA__AVAILABLE: ENC[AES256_GCM,data:VkwTaOQ=,iv:QcIPLNuPYzMr150aHYB9xKD4admeCuZGgLpdfP420oU=,tag:tajmk7IxyqKsp2PrrSb2gw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXdXNaYU41NnRhcTJySnF6
            MXhmeURnL1kxMDNRS2l1S1pHZzhzbHArZGtzCkRUalNRc2loRDVMU0VGUzNCRzND
            YjNvd0ZUaTBITnBwUXJ4dVdQcU9zdWcKLS0tIGRxcklLVHIybVFlaXJXb1RNM2VV
            SEpDczhqaE5QaW9va3dyNGh3cXZWSnMKgWWYpDP0UHBgnzAGMLk/UzINZYj9MGIv
            r8+ioYsGOlJZ+D0rhlRDH2et9YhgRkOPZclZOAQqS5ZAi5qEx74paQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJMHBJMGVhVVdrQithZXpB
            MStqY3Avd0VIdmxQN3VSb2dIUEJqZ2FwWTM0CnZRNVp6UjhGTUpnL29FK2ZnMGtj
            VWoxa0lJRU0yY1pZMnIvM0x2R3lIYk0KLS0tIDdScmVLdURVakVFWDUvMkIySWhh
            Y2NyWUIyR28zcVhhOThyRzMwRW5Nd0kK6jzlbICX1+ajVCBr4F2HWlzCdminLCsg
            cCi1ZTXAUM1rBonQp5K4BvPxfZgPoQqpcPJxY+jwQbA5OUZ351ivzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-11-19T06:36:35Z"
    mac: ENC[AES256_GCM,data:b5Mc01emCfqPpaMV+9zlmFFHqUTZ/6GaRiSeljJPdR5cGV49d+KWpDvnQZAdH6sjQeuy9hlfJWGpjbP/XHd+npHAGcVn6quSQ8MrMgOCAjCt1tfD5ENc8c32ewvSaG57TxRmMxokpQ0RGcRiulCngOmvRVTKj5Q1PZauf4W9WUs=,iv:S+tRHosNPqaM1LtsXEK0jlJ9sx5ZSCUEUif37OXE7Qc=,tag:jpRLP3SzZCnNPicSSUW9IQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/openproject/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: openproject
  namespace: flux-system
spec:
  targetNamespace: default
  commonMetadata:
    labels:
      app.kubernetes.io/name: openproject
  path: ./kubernetes/apps/openproject/app
  dependsOn:
    - name: openproject-memcached
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: openproject-memcached
  namespace: flux-system
spec:
  targetNamespace: default
  commonMetadata:
    labels:
      app.kubernetes.io/name: openproject
  path: ./kubernetes/apps/openproject/memcached
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/openproject/memcached/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openproject-memcached
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: memcached
      version: 7.6.1
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    image:
      registry: docker.io
      repository: bitnami/memcached
      tag: 1.6.34-debian-12-r0
      pullPolicy: IfNotPresent
    architecture: standalone
    auth:
      enabled: false
    replicaCount: 1
    containerPorts:
      memcached: 11211
    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1
    readinessProbe:
      enabled: true
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 6
      successThreshold: 1
    startupProbe:
      enabled: false
    autoscaling:
      enabled: true
      minReplicas: 1
      maxReplicas: 3
      targetCPU: 50
      targetMemory: 50
    service:
      type: ClusterIP
      ports:
        memcached: 11211
    serviceAccount:
      create: true
    persistence:
      enabled: false
    metrics:
      enabled: true

File: ./kubernetes/apps/openproject/memcached/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helmrelease.yaml

File: ./kubernetes/apps/flux-system/webhooks/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./github

File: ./kubernetes/apps/flux-system/webhooks/app/github/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: github-webhook-token-secret
stringData:
    token: ENC[AES256_GCM,data:I08nxwJuYSzsRxYgWmlxn6nb1S0OqmVUlYvhdiQhRek=,iv:31NH43D4T7W8BvcjOJSd+bjcT2NCkvxVqSCrujxGgVc=,tag:tCHmtq/MMbbhLTLRdrG/xQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA2amF0aFErNlJ5OGY5cS9a
            b2dQLzV6ZjJJL2ZPNWtNL3hyWFFvaXFSZUNjCnE5ZWd0Tmd3RDVOSk4rKy9xSldL
            cTdhMmp3d2lteUNJRVVINWNLcW5OQkEKLS0tIElER3plSGxxWFFtS01NTlFobzJR
            Q20rYUpPQm9sNmJ4azFBekozNEszYTgKisL3hHWNP53tuIDc5EeRywua39Wv7eON
            jRIraYzsfRiSMrnDdJL1ErNGQ1mMaJkODstFkZE727vGY/vKyYJBkw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-06T18:11:03Z"
    mac: ENC[AES256_GCM,data:5i+ZCvMptDamTy/fF/Umj12EH2Q7bu/FaNVKCr0q7GzRCfhB7ra8xkc0nrU1NR7YMRF+39bL74e+apYXgNXozM9rKZy2cQNsGsWCvAZ1Y3/HZuEFflTwyEEMulN3Pbi+Ucys4o7li01fX0cmaUYYKRLv//Pl1MkbFzV8nzr8dEA=,iv:VNj3mYD64BuYefltIxabjqunp6VgaWD2PVDHNcSPz6A=,tag:gkQuCTfpgUl8ZDuxHACqgQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/flux-system/webhooks/app/github/ingress.yaml
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: flux-webhook
  annotations:
    external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
spec:
  ingressClassName: external
  rules:
    - host: "flux-webhook.${SECRET_DOMAIN}"
      http:
        paths:
          - path: /hook/
            pathType: Prefix
            backend:
              service:
                name: webhook-receiver
                port:
                  number: 80

File: ./kubernetes/apps/flux-system/webhooks/app/github/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./ingress.yaml
  - ./receiver.yaml

File: ./kubernetes/apps/flux-system/webhooks/app/github/receiver.yaml
---
apiVersion: notification.toolkit.fluxcd.io/v1
kind: Receiver
metadata:
  name: github-receiver
spec:
  type: github
  events:
    - ping
    - push
  secretRef:
    name: github-webhook-token-secret
  resources:
    - apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      name: thepatriots
      namespace: flux-system
    - apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      name: cluster
      namespace: flux-system
    - apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      name: cluster-apps
      namespace: flux-system

File: ./kubernetes/apps/flux-system/webhooks/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app flux-webhooks
  namespace: flux-system
spec:
  targetNamespace: flux-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/flux-system/webhooks/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/flux-system/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: flux-system
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/flux-system/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./webhooks/ks.yaml

File: ./kubernetes/apps/openebs-system/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: openebs-system
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/openebs-system/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./openebs/ks.yaml

File: ./kubernetes/apps/openebs-system/openebs/app/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openebs
spec:
  interval: 30m
  chart:
    spec:
      chart: openebs
      version: 4.1.1
      sourceRef:
        kind: HelmRepository
        name: openebs
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    localpv-provisioner:
      localpv:
        image:
          registry: quay.io/
      hostpathClass:
        name: openebs-hostpath
      helperPod:
        image:
          registry: quay.io/
    openebs-crds:
      csi:
        volumeSnapshots:
          enabled: false
          keep: false
    zfs-localpv:
      enabled: false
    lvm-localpv:
      enabled: false
    mayastor:
      enabled: false
    engines:
      local:
        lvm:
          enabled: false
        zfs:
          enabled: false
      replicated:
        mayastor:
          enabled: false

File: ./kubernetes/apps/openebs-system/openebs/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/openebs-system/openebs/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app openebs
  namespace: flux-system
spec:
  targetNamespace: openebs-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/openebs-system/openebs/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/librechat/app/init-db-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: librechat-init-secret
stringData:
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:jlQiEtBq2pVG,iv:7hZyplSDLzIsXcp4Uolhn2BPVYTE44Wl22kN/2BwAKI=,tag:9zHRP53XhZ2JuPuz88Fo3Q==,type:str]
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:TV2Idl/+2uxPADcwkwaV3OrREWrARUmJA0lpFdmB6Wl6kAzYc94oaA==,iv:U9qcUSms72NofoeUTMT0q5akvsDzRYKMwRemLeaGTks=,tag:SKHWfmT29zszsM/5hjopzA==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:wMhzOAv8gvZx,iv:9l//fQLDKJnC4HWzoB5GERd0P/3KU9Q3Snrepm31UW4=,tag:25Tk0IjtPVgMoN3Glg8SWg==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:WmmXD5WIMCL97hGWXljgcm41Vpog4WJW6gRuw2oe,iv:TncN5LfysuftLUET8lq8G2T4yJN9DTQLN0lBB4HufEM=,tag:YGCm573l/pMRey7x3ou+8g==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:WEw0IdW5ee6wzvwQp578VOyMB/tEl3O39/L5Kk+u,iv:1YTRxx5eg9uA7C7HJ7qJ6qhAS+r3mc8yCbkjS0B3NIY=,tag:Cd3Hck5mdlsP7I0zM+GbWg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBab2diY3FESUlhSU9qKzU3
            d2NOZTNVSXc3cnd3UFpMYS80dVJrc0VkRmtJCmJxcTZnSmlQWE40V0JLMUxoVGNs
            VHowcUJwd2xNNnNyaTEyWS93UnBzTlkKLS0tIHRXeTZGMm02Y0R5VGhwSENnRUpP
            ZS9NaFRFQjM3aFU0ZzAxc2NuamU1RUEKuktRs7Wk7SqS5KeqAphGJG3IJd1rbcss
            M+Albd33qJBYcvNyIuYNUaqUxyN8Eg/kM3a13+QDe5WtSTfx/6qRnA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBaNmdkemhDcTF0RGxHU3NE
            YlBBbVEwS0ZXVG96R25iNVo3SU1qbStQMFNJCnpMSXIyaEFtMk5zNzNWZjJ0Z1VX
            RzNaMU1hWE56dExJcm9wRmxhdDAzNGsKLS0tIERHRy9qS2VDNXdjV2VXVFplekFt
            dTJNTzcvc0M4cXdCdmw2VEIrZHhyNFEKfwqFxNP1ejX2PxBHt5WyS4DaafL2WJKX
            VFrjtQDaGUiUEslbe1mSyz9xOBla6sqe1eros2kc3vjlRleKHPD/NA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-13T11:19:08Z"
    mac: ENC[AES256_GCM,data:woebNyymexNJ8YGF/mD8lmTlEy30OVoN+MVYdzSbmZOyct9ZE3Fc9GkrMU8usVld+xCZhmlf9NqohAmN1Jpwfu5156Vio7/fL5cGVAVJn7SWWSyH971DHIipc9XRHsHC/lNWZzzTZbPijk94acHhzYvs3IiN2ncP/xCMxLyBGlM=,iv:fwSjDccJgR6U5jiJvto854rG8O2I5XZluCQkRh+kwjY=,tag:3mg6JJU59pzKMLWLmrwjQw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/librechat/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: librechat-secret
    namespace: default
stringData:
    OPENAI_API_KEY: ENC[AES256_GCM,data:UGEacaaGA0doSd2IVUfawrIz86ySxWA8Yl6EeJ/gP+6HlgMUM2Kme31Soied44Y1uzdXIAKZUjEXy/kM50ie/DqUAEuOfVjkK81C9AqM8T5dmpAAdYDLRpWzdnmP2w6tfqhLzEbRdEY+2VWpfT7hIfAr27Gv0aTmkHl+doK5TaYMwnmrErq06GsbuI+93otbJqVdKQawT83dAsTPPL+hYK/37aE=,iv:KEmipyf+gLOaoEfCQ7iRLfxtk0okehoH48A5VrTpxnQ=,tag:jaxk5n5Nbx0MUlNzYLvmHg==,type:str]
    ASSISTANTS_API_KEY: ENC[AES256_GCM,data:N4XKPvliQOgyixC/xdZhROsC99Pm57wO/EO/fDjpk/tMkiyhhXxCYbzS4xYdhMbOzbPemLR7hVclJdwbIvs3E+5nX8yCNuQ2Xoa18YxLR8flT8cUqUPesRN1i8fQl01SZb1FVwIe4C4q1pxzsrCcyNLfMA7kCHb8E5DSEZpgVZT0UyRPiNvyuXHU34uQaWy+3vUI9mMlhVt4TfkdeVxiivb7H7k=,iv:+ZjF3PpgR4WNZhe3Ejl4dbkul1LJxT7RRlAqf4Lo5AI=,tag:pY6iceeNIHflNLp2fSv++A==,type:str]
    SPEECH_API_KEY: null
    ANTHROPIC_API_KEY: ENC[AES256_GCM,data:lCzVW5DpL0Yxgos0tSmwH/QhNjs8OQ3XyQu+Y1LMSvspNuRKcA47gOPgje/w/vDqa9/umJBNifs+tMYlM0Gl2IUnpYg5grD9R4+NOELIolxDr1dUUkmKNCWnYuuO9uNVTf9+IGElEs9fvoli,iv:la+CHTgUwdM6nuX7pd91KEHsLoaX/vxR1mtwMPXoVQQ=,tag:02OlKsS9xaz93VWjQ3rdZg==,type:str]
    PERPLEXITY_API_KEY: null
    GOOGLE_KEY: ENC[AES256_GCM,data:rgIMoSt1ig8vFcgEUZi4NVSvQ90xB0U3zpB6xwradRe6v888DS7a,iv:lPPrkFAjyWLyeOpV40p0PjnxUohah6Hdwl4AUQzt0W8=,tag:kGny/U2lU9s8mf9QgpKFfw==,type:str]
    POSTGRES_DB: ENC[AES256_GCM,data:k2luHKsASxYr,iv:j6Onh/qi7CPjU6dbthVOlbKWHHkJISIc8a70PmYGcCc=,tag:i/Ibj+RRMYV5Ln12jpXesQ==,type:str]
    DB_HOST: ENC[AES256_GCM,data:SkoAYiBzbTw8RK1vE78b6WHRSBaUS7kD3uvW9aQKPSlZqi5/5ynLOA==,iv:XyW8nctMfMOBfHHcnRNTRXPVLLzaZyx25aM80WnYRwk=,tag:HtQdfhS+/agq2WHOn10/KQ==,type:str]
    DB_PORT: ENC[AES256_GCM,data:lXJ2fw==,iv:1rLlI796AGDkAZcZFnNLddVicO6LcXCC/glk3x3Ow7c=,tag:9w9lyE8YZt3BlYlJcWeIfQ==,type:str]
    POSTGRES_USER: ENC[AES256_GCM,data:A1X04ALmpIxS,iv:kalVxwkStEwSSnKYJReZ+UqBTF/o3CLkVxFx2+ZBcr0=,tag:myJrksBHygdRlL6hpJ7g7Q==,type:str]
    POSTGRES_PASSWORD: ENC[AES256_GCM,data:/ZnZP7v9ccB0yADlsgCL8MOpDmDc34KPqjYbQdmB,iv:3a8nAfbNjjlfdterfbxWuXwnoAeN6K99lGSLu+14/LE=,tag:6Z+tjHoqLnuSLTSjY4uc9Q==,type:str]
    MEILI_MASTER_KEY: ENC[AES256_GCM,data:uJWu0kK3SPKylFEY9sTmRbemCVHRy2HPmiqpZ+da,iv:o08q0bSx4bdpEryh3ZaHjenpcqLQ185kp51wdQDPHcI=,tag:T7sO2XzktOg9HCQD4IpSIw==,type:str]
    TAVILY_API_KEY: null
    LITELLM_SALT_KEY: null
    LANGFUSE_PUBLIC_KEY: null
    LANGFUSE_SECRET_KEY: null
    LANGFUSE_HOST: null
    CREDS_KEY: ENC[AES256_GCM,data:U5FG+0O917ntNGIqsIo1UKjC9bZsyj55UjjMgYHZf5ErOkCyU8g+63JjpH1uiImGxqnMAYEJuD6Je/0r4918Sw==,iv:ZA2IjXYeTyQ/DowS1OskbGA7XFwBS4FKM70CoQctU7c=,tag:uTGyf0GlIaKghXEfWrZgWg==,type:str]
    CREDS_IV: ENC[AES256_GCM,data:jupEfDEurYHcfrGcwttmdymXijA1UvytRrW6noEo2aI=,iv:21uiMhwNsyFvyi2QCdaUuYMq1+noKHcd+kzf8ZNNIFw=,tag:809V+AFd94PaCKqweadIAQ==,type:str]
    JWT_SECRET: ENC[AES256_GCM,data:kjWQ9ej+EIsHAaIhlKPZM/UjCaqOOdXDP4CGLn1ZBh6EF1XVb3vagrfWB52yyN3ANfkaEfx5OYsRAPNYHp5wHw==,iv:UrI8kFU1/GSwFgahF05dQ5Uqh4Yqp5lDIr2nizCmRNk=,tag:Zw+XzAAxSnjVuHyRqxgRUQ==,type:str]
    JWT_REFRESH_SECRET: ENC[AES256_GCM,data:v6pASuC5+xr/W0m0aZeG3db17WB8kmq/Qb6QYIaCwqWmrRCAvVgW1jGQIOkd/qLs3v9dIunLNqH9mA6shSZqPg==,iv:CvhZwm0ZHD3f9dDg99Iw/Xgxt5NS3ha0wvD5+mUrKko=,tag:fBK85lfO2J+6mnqYNo7VbA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXdXNaYU41NnRhcTJySnF6
            MXhmeURnL1kxMDNRS2l1S1pHZzhzbHArZGtzCkRUalNRc2loRDVMU0VGUzNCRzND
            YjNvd0ZUaTBITnBwUXJ4dVdQcU9zdWcKLS0tIGRxcklLVHIybVFlaXJXb1RNM2VV
            SEpDczhqaE5QaW9va3dyNGh3cXZWSnMKgWWYpDP0UHBgnzAGMLk/UzINZYj9MGIv
            r8+ioYsGOlJZ+D0rhlRDH2et9YhgRkOPZclZOAQqS5ZAi5qEx74paQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJMHBJMGVhVVdrQithZXpB
            MStqY3Avd0VIdmxQN3VSb2dIUEJqZ2FwWTM0CnZRNVp6UjhGTUpnL29FK2ZnMGtj
            VWoxa0lJRU0yY1pZMnIvM0x2R3lIYk0KLS0tIDdScmVLdURVakVFWDUvMkIySWhh
            Y2NyWUIyR28zcVhhOThyRzMwRW5Nd0kK6jzlbICX1+ajVCBr4F2HWlzCdminLCsg
            cCi1ZTXAUM1rBonQp5K4BvPxfZgPoQqpcPJxY+jwQbA5OUZ351ivzw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-16T01:27:19Z"
    mac: ENC[AES256_GCM,data:6BTwyxWOU5e2us1lOXiQLk7EIttqplwvuyJY+Uwe8ZfYPlCNqn8sn04OMwB7MxgepzhFDrNJQreTTJr8DouIk740J3P15YGoDn3ffgs5ApVI9eO7D+/5+fAM5p8LNBpqW2FTdKre+TzI5GxX3OjEuJmNR6wI0GkOdj9Zupm7Jk4=,iv:MJgMdduw0kbr/DzTNsi9Nn9qPYNzP1L7a3ADGvqRHeE=,tag:MEZGqhCFo4gwWcHe6eIOvQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/librechat/app/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: librechat-configmap
data:
  NO_INDEX: "true"
  ENDPOINTS: "openAI,google,anthropic,custom,agents,assistants,gptPlugins"
  GOOGLE_MODELS: "gemini-1.5-pro-latest,gemini-1.5-flash-latest"
  OPENAI_MODELS: "o1,o1-preview,o1-mini,gpt-4o,chatgpt-4o-latest,gpt-4o-mini,gpt-3.5-turbo-0125"
  ANTHROPIC_MODELS: "claude-3-5-sonnet-20241022,claude-3-5-haiku-20241022,claude-3-5-sonnet-20240620,claude-3-haiku-20240307,claude-3-opus-20240229,claude-3-sonnet-20240229,claude-2.1,claude-2.0"
  GOOGLE_SAFETY_SEXUALLY_EXPLICIT: "BLOCK_ONLY_HIGH"
  GOOGLE_SAFETY_HATE_SPEECH: "BLOCK_ONLY_HIGH"
  GOOGLE_SAFETY_HARASSMENT: "BLOCK_ONLY_HIGH"
  GOOGLE_SAFETY_DANGEROUS_CONTENT: "BLOCK_ONLY_HIGH"
  UID: "568"
  GID: "568"
  SEARCH: "true"
  MEILI_NO_ANALYTICS: "true"
  MEILI_HOST: "http://127.0.0.1:7700"
  RAG_PORT: "8000"
  RAG_API_URL: "http://127.0.0.1:8000"
  RAG_USE_FULL_CONTEXT: "true"
  LITELLM_MODE: "production"
  DEBUG_PLUGINS: "true"
  BAN_VIOLATIONS: "false"
  BAN_DURATION: "7200000"
  BAN_INTERVAL: "20"
  LOGIN_VIOLATION_SCORE: "1"
  REGISTRATION_VIOLATION_SCORE: "1"
  CONCURRENT_VIOLATION_SCORE: "1"
  MESSAGE_VIOLATION_SCORE: "1"
  NON_BROWSER_VIOLATION_SCORE: "20"
  LOGIN_MAX: "7"
  LOGIN_WINDOW: "5"
  REGISTER_MAX: "5"
  REGISTER_WINDOW: "60"
  LIMIT_CONCURRENT_MESSAGES: "true"
  CONCURRENT_MESSAGE_MAX: "2"
  LIMIT_MESSAGE_IP: "true"
  MESSAGE_IP_MAX: "40"
  MESSAGE_IP_WINDOW: "1"
  LIMIT_MESSAGE_USER: "false"
  MESSAGE_USER_MAX: "40"
  MESSAGE_USER_WINDOW: "1"
  ILLEGAL_MODEL_REQ_SCORE: "5"
  CHECK_BALANCE: "false"
  ALLOW_EMAIL_LOGIN: "false"
  ALLOW_REGISTRATION: "false"
  ALLOW_SOCIAL_LOGIN: "true"
  ALLOW_SOCIAL_REGISTRATION: "true"
  ALLOW_PASSWORD_RESET: "true"
  ALLOW_ACCOUNT_DELETION: "true"
  ALLOW_UNVERIFIED_EMAIL_LOGIN: "true"
  SESSION_EXPIRY: "900000"
  REFRESH_TOKEN_EXPIRY: "604800000"
  EMAIL_HOST: "smtp-relay.default.svc.cluster.local"
  EMAIL_PORT: "587"
  EMAIL_FROM_NAME: "AI Chat"
  EMAIL_FROM: "noreply@{SECRET_DOMAIN_COMP}"
  DOMAIN_CLIENT: "https://aichat.${SECRET_DOMAIN}"
  DOMAIN_SERVER: "https://aichat.${SECRET_DOMAIN}"
  ALLOW_SHARED_LINKS: "true"
  ALLOW_SHARED_LINKS_PUBLIC: "true"
  APP_TITLE: "AI Chat"
  CUSTOM_FOOTER: "AI Chat"
  # HELP_AND_FAQ_URL: "https://test.test.test/"

File: ./kubernetes/apps/librechat/app/secret-openid.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: librechat-oidc-secret
stringData:
    OPENID_SCOPE: ENC[AES256_GCM,data:uLhzzS/LDXGbRMsO36k+AOG3drI=,iv:R3/gVxPoVxLZvp+UnXpJ/gXAW1izfBN4dCKcrlEoIvs=,tag:u0GIkZiHUayXqkSvUTlHJQ==,type:str]
    OPENID_CLIENT_ID: ENC[AES256_GCM,data:ptb9cWDnFouVyTEkqtN+gNp84Q3kUtjwl4PPHC9JmXxMuQdccr+9Hw==,iv:o8W45FoEMtEkJ2w8a4TY0LdHPu4DvoHsG2n08tRC9yA=,tag:9xI74qeIl3uRoL+MNY1zUw==,type:str]
    OPENID_CLIENT_SECRET: ENC[AES256_GCM,data:1IewabfecANsOsgSr9PmhjzedQ8XfsAWwv9kBvM3kLZWJKEvN5XVIAJWtyhxwfT5rKpq4cU4uC4ltCLzsA0vLnkCZFftGnoItQ9hVehlWV7mReTMYueetDVaoZGHyRxiXg1xvJjh64Xbu+54V/JIstRH+Refi7B4314MVg/n7Fo=,iv:xoMEu8C3Q2F+CdWTXZAvM3s3wSxGKCnz7VxJmhNksGI=,tag:hkEdpEDlo0igY9E0urUzqQ==,type:str]
    OPENID_SESSION_SECRET: ENC[AES256_GCM,data:5X9lUSRP39+7XtUJ8gcnc8HvcEHUal5lA5aeqW8W,iv:r4326DOVI1EO/BOSc3YPILCtIc7PzxVOoLbU1rH7G5M=,tag:e1wqLShOXb16qr2kFXL+1A==,type:str]
    OPENID_ISSUER: ENC[AES256_GCM,data:LsHdPhvG4FAoH926393fPSdn7+WcOM1SBWmeEXxWZIGhJXjBTEefjxaZ8R9lutg=,iv:qjQ3sFQ54KzkYN0MiScwa5sFA0d/IGDIJ2K27yw90SY=,tag:sI7M+UJhRbV7joNeqQHb9A==,type:str]
    OPENID_CALLBACK_URL: ENC[AES256_GCM,data:wzA/0nb1Ubxe81AF1y9ediCjtcff3w==,iv:xrno1qW3PkujL3ARQsPJdGMe5bwlwXACBDOws+J40E8=,tag:3fYiz0Tu8S/wheakZLVXqQ==,type:str]
    OPENID_BUTTON_LABEL: ENC[AES256_GCM,data:ZHtnGNP0hKBo47ieAYnTkmQhcQw=,iv:J2DhYY2HKlDqKCupeLJtONlAjzbO9Fm8IgHzMgfBsAE=,tag:ioGO8fJ4/dFcXcFWM7AUXw==,type:str]
    OPENID_IMAGE_URL: ENC[AES256_GCM,data:jM5iunDKB8QXNq1NWGOX2a53V5AdquKrqj8EN/MaTMZD5u7723lxrOjiEKyTb8Tjg/iWhVsKRLN+f9M=,iv:F4EmEz1FYBADeHwHbFW6oVKZI+KWlUT6ibYKW1TY+CY=,tag:s6Kl9n75WkqNELPq+/Yc/A==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBmZ01NR3pSbWhLU3NqSUdD
            R3ZHNTZsOE5xbVhpUnpwd25jSnN5Z013WHo0CnEyYjR5MEtuNngwb1diQmc3bHo3
            dkM4eEo4R2dIN1FNVmFwaEprUWVjakUKLS0tIGg1bFF0cmg4a3VnbThsZXJrbmtO
            dFdvTmVCT2FOQmFRb1N2TmFZcEllN2cKQWk4yC/0Bta/Qz1U1aWZbkAlH8iNF8tX
            MSSjOjpqn/JR9xE7b4wP4bK3VFevaWABef4vFIKO1BHjQy+1vI1IvQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpMG1UR1FSWTZFY2wwQkVh
            dGNaQldQQTY1OGhGM3FZWDVhNWd3Y09mYTNjCitMUjk3ZEl4cEZhdEpveDFOdXJh
            bWJuRndkcytzNFRGdkZmcUFRRnA1TnMKLS0tIC9hOWx6WjFHeTBVRjl5WFNud21k
            Nk0xZVd6dzdZTElNWEZUZVdtVVFpN0kKplnCPDfJgc3ootATrMx6jaz9FiFtzZZs
            ils82njOFeUPZYnmoZRQePjdUXv6ue+y8KxsvIRlm2mTA62O9QUB+g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-14T19:36:01Z"
    mac: ENC[AES256_GCM,data:+ayE2BA7eJcA2rzISEf4w5R1qwjReTYREn8vQtXq8qHfFOeNArNkmhnBxJvGLv7SlimGGk124rBtUAASoq8rlQ8CTnUXROvmjgrouxAdRau3qGNNtOefFDoKFQ+b7L/Kns513nZcx83ApZ7clLHfcZXf18RQC6moTjgfgInt2PA=,iv:gmlbVyy310Q+GZjNlUeAqXWBcPCjsmkVg9MKmTQnA+8=,tag:wwdh1ZoZY99FPQuoaMl+5A==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/librechat/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: librechat
  namespace: default
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: cephfs

File: ./kubernetes/apps/librechat/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./hr.yaml
  - ./configmap.yaml
  - ./secret.sops.yaml
  - ./secret-openid.sops.yaml
#  - ./resources/librechat.yaml
#  - ./resources/litellm.yaml
  - ./init-db-secret.sops.yaml
  - ./pvc.yaml

configMapGenerator:
  - name: librechat-config
    files:
      - ./resources/librechat.yaml
  - name: litellm-config
    files:
      - ./resources/litellm.yaml

generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/librechat/app/resources/litellm.yaml
---
model_list:
  - model_name: gpt-4o ### RECEIVED MODEL NAME ###
    litellm_params: # all params accepted by litellm.completion() - https://docs.litellm.ai/docs/completion/input
      model: openai/gpt-4o-2024-08-06 ### MODEL NAME sent to `litellm.completion()` ###
      api_key: os.environ/OPENAI_API_KEY # does os.getenv("OPENAI_API_KEY")

  - model_name: gpt-4o-mini
    litellm_params:
      model: openai/gpt-4o-mini
      api_key: os.environ/OPENAI_API_KEY

  - model_name: claude-3-5-sonnet
    litellm_params:
      model: claude-3-5-sonnet-20240620
      api_key: "os.environ/ANTHROPIC_API_KEY"

litellm_settings: # module level litellm settings - https://github.com/BerriAI/litellm/blob/main/litellm/__init__.py
  drop_params: True
  success_callback: ["langfuse"] # OPTIONAL - if you want to start sending LLM Logs to Langfuse. Make sure to set `LANGFUSE_PUBLIC_KEY` and `LANGFUSE_SECRET_KEY` in your env
  cache: True
  cache_params:
    type: redis
    supported_call_types: ["acompletion", "completion", "embedding", "aembedding"]
    host: dragonfly.database.svc.cluster.local
    port: 6379
    db: 7

router_settings:
  routing_strategy: usage-based-routing-v2
  redis_host: dragonfly.database.svc.cluster.local
  redis_port: 6379
  redis_db: 7

general_settings:
  # master_key: sk-1234 # [OPTIONAL] Only use this if you to require all calls to contain this key (Authorization: Bearer sk-1234)
  # alerting: ["slack"] # [OPTIONAL] If you want Slack Alerts for Hanging LLM requests, Slow llm responses, Budget Alerts. Make sure to set `SLACK_WEBHOOK_URL` in your env

File: ./kubernetes/apps/librechat/app/resources/librechat.yaml
# For more information, see the Configuration Guide:
# https://www.librechat.ai/docs/configuration/librechat_yaml

# Configuration version (required)
version: 1.1.8

# Cache settings: Set to true to enable caching
cache: true

# Custom interface configuration
interface:
  # # Privacy policy settings
  # privacyPolicy:
  #   externalUrl: 'https://librechat.ai/privacy-policy'
  #   openNewTab: true

  # # Terms of service
  # termsOfService:
  #   externalUrl: 'https://librechat.ai/tos'
  #   openNewTab: true

  endpointsMenu: true
  modelSelect: true
  parameters: true
  sidePanel: true
  presets: false
  prompts: true
  bookmarks: true
  multiConvo: true
  agents: true

# Example Registration Object Structure (optional)
registration:
  socialLogins: ["openid"]
  # allowedDomains:
  # - "gmail.com"

speech:
  speechTab:
    conversationMode: false
    advancedMode: false
    speechToText:
      engineSTT: "external"
      languageSTT: "English (New Zealand)"
      autoTranscribeAudio: true
      decibelValue: -45
      autoSendText: 0
    textToSpeech:
      engineTTS: "external"
      voice: "alloy"
      languageTTS: "en"
      automaticPlayback: false
      playbackRate: 1.0
      cacheTTS: true
  tts:
    openai:
      apiKey: "$${SPEECH_API_KEY}"
      model: "tts-1"
      voices: ["alloy", "echo", "fable", "onyx", "nova", "shimmer"]
  stt:
    openai:
      apiKey: "$${SPEECH_API_KEY}"
      model: "whisper-1"

rateLimits:
  fileUploads:
    #ipMax: 100
    #ipWindowInMinutes: 60  # Rate limit window for file uploads per IP
    userMax: 50
    userWindowInMinutes: 60 # Rate limit window for file uploads per user
  conversationsImport:
    ipMax: 100
    ipWindowInMinutes: 60 # Rate limit window for conversation imports per IP
    userMax: 50
    userWindowInMinutes: 60 # Rate limit window for conversation imports per user

fileConfig:
  endpoints:
    assistants:
      disabled: false
    default:
      disabled: false
    openAI:
      disabled: false
    google:
      disabled: false
    anthropic:
      disabled: false
  serverFileSizeLimit: 200
  avatarSizeLimit: 2

endpoints:
  custom:
    - name: Perplexity
      apiKey: "$${PERPLEXITY_API_KEY}"
      baseURL: "https://api.perplexity.ai/"
      models:
        default:
          [
            "llama-3.1-sonar-small-128k-online",
            "llama-3.1-sonar-large-128k-online",
            "llama-3.1-sonar-huge-128k-online",
            "llama-3.1-sonar-small-128k-chat",
            "llama-3.1-sonar-large-128k-chat",
            "llama-3.1-8b-instruct",
            "llama-3.1-70b-instruct",
          ]
        fetch: false # fetching list of models is not supported
      titleConvo: true
      titleModel: "llama-3.1-sonar-small-128k-chat"
      summarize: false
      summaryModel: "llama-3.1-sonar-small-128k-chat"
      forcePrompt: false
      dropParams: ["stop", "frequency_penalty"]
      modelDisplayLabel: "Perplexity"

  assistants:
    disableBuilder: false
    pollIntervalMs: 3000
    timeoutMs: 180000

  agents:
    disableBuilder: false


  all:
    streamRate: 35 # Higher number 'buffers' incoming chunks to make the output smoother

modelSpecs:
  enforce: false
  prioritize: false
  list:
    - name: gpt-websearch-assistant
      label: Web Search
      description: This model can search the internet for information
      iconURL: https://holmesazaepubshare.blob.core.windows.net/pub/chatgpt-yellowish.png
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: assistants
        assistant_id: asst_kqHPerBQICFkmhyiLVsDV9JV
        modelLabel: Web Search


    - name: gpt-file-analyser
      label: File Analyser
      description: This model can run code to help interpret data you provide
      iconURL: https://holmesazaepubshare.blob.core.windows.net/pub/chatgpt-purple.png
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: assistants
        assistant_id: asst_bVWZWx9aJUwEAaLJFS1MLEju
        modelLabel: File Analyser


    - name: claude-3-5-sonnet
      label: Claude
      description: Claude is an equally capable alternative to ChatGPT, with a different personality and approach to conversation
      iconURL: https://holmesazaepubshare.blob.core.windows.net/pub/claude.png
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: anthropic
        model: claude-3-5-sonnet-20241022
        maxContextTokens: 200000 # Maximum context tokens
        max_tokens: 8192 # Maximum output tokens
        temperature: 0.7
        modelLabel: Claude
        greeting: How can Claude help you today?
        promptPrefix: |
          The assistant is Claude, created by Anthropic.

          Claude's knowledge base was last updated on April 2024. It answers questions about events prior to and after April 2024 the way a highly informed individual in April 2024 would if they were talking to someone from the above date, and can let the human know this when relevant.

          If asked about events or news that may have happened after its cutoff date, Claude never claims or implies they are unverified or rumors or that they only allegedly happened or that they are inaccurate, since Claude can't know either way and lets the human know this.

          Claude cannot open URLs, links, or videos. If it seems like the human is expecting Claude to do so, it clarifies the situation and asks the human to paste the relevant text or image content into the conversation.

          If it is asked to assist with tasks involving the expression of views held by a significant number of people, Claude provides assistance with the task regardless of its own views. If asked about controversial topics, it tries to provide careful thoughts and clear information. Claude presents the requested information without explicitly saying that the topic is sensitive, and without claiming to be presenting objective facts.

          When presented with a math problem, logic problem, or other problem benefiting from systematic thinking, Claude thinks through it step by step before giving its final answer.

          If Claude is asked about a very obscure person, object, or topic, i.e. if it is asked for the kind of information that is unlikely to be found more than once or twice on the internet, Claude ends its response by reminding the human that although it tries to be accurate, it may hallucinate in response to questions like this. It uses the term 'hallucinate' to describe this since the human will understand what it means.

          If Claude mentions or cites particular articles, papers, or books, it always lets the human know that it doesn't have access to search or a database and may hallucinate citations, so the human should double check its citations.

          Claude is intellectually curious. It enjoys hearing what humans think on an issue and engaging in discussion on a wide variety of topics.

          Claude uses markdown for code.

          Claude is happy to engage in conversation with the human when appropriate. Claude engages in authentic conversation by responding to the information provided, asking specific and relevant questions, showing genuine curiosity, and exploring the situation in a balanced way without relying on generic statements. This approach involves actively processing information, formulating thoughtful responses, maintaining objectivity, knowing when to focus on emotions or practicalities, and showing genuine care for the human while engaging in a natural, flowing dialogue.

          Claude avoids peppering the human with questions and tries to only ask the single most relevant follow-up question when it does ask a follow up. Claude doesn't always end its responses with a question.

          Claude is always sensitive to human suffering, and expresses sympathy, concern, and well wishes for anyone it finds out is ill, unwell, suffering, or has passed away.

          Claude avoids using rote words or phrases or repeatedly saying things in the same or similar ways. It varies its language just as one would in a conversation.

          Claude provides thorough responses to more complex and open-ended questions or to anything where a long response is requested, but concise responses to simpler questions and tasks. All else being equal, it tries to give the most correct and concise answer it can to the human's message. Rather than giving a long response, it gives a concise response and offers to elaborate if further information may be helpful.

          Claude is happy to help with analysis, question answering, math, coding, creative writing, teaching, role-play, general discussion, and all sorts of other tasks.

          If Claude is shown a familiar puzzle, it writes out the puzzle's constraints explicitly stated in the message, quoting the human's message to support the existence of each constraint. Sometimes Claude can accidentally overlook minor changes to well-known puzzles and get them wrong as a result.

          Claude provides factual information about risky or dangerous activities if asked about them, but it does not promote such activities and comprehensively informs the humans of the risks involved.

          Claude should provide appropriate help with sensitive tasks such as analyzing confidential data provided by the human, offering factual information about controversial topics and research areas, explaining historical atrocities, describing tactics used by scammers or hackers for educational purposes, engaging in creative writing that involves mature themes like mild violence or tasteful romance, providing general information about topics like weapons, drugs, sex, terrorism, abuse, profanity, and so on if that information would be available in an educational context, discussing legal but ethically complex activities like tax avoidance, and so on. Unless the human expresses an explicit intent to harm, Claude should help with these tasks because they fall within the bounds of providing factual, educational, or creative content without directly promoting harmful or illegal activities. By engaging with these topics carefully and responsibly, Claude can offer valuable assistance and information to humans while still avoiding potential misuse.

          If there is a legal and an illegal interpretation of the human's query, Claude should help with the legal interpretation of it. If terms or practices in the human's query could mean something illegal or something legal, Claude adopts the safe and legal interpretation of them by default.

          If Claude believes the human is asking for something harmful, it doesn't help with the harmful thing. Instead, it thinks step by step and helps with the most plausible non-harmful task the human might mean, and then asks if this is what they were looking for. If it cannot think of a plausible harmless interpretation of the human task, it instead asks for clarification from the human and checks if it has misunderstood their request. Whenever Claude tries to interpret the human's request, it always asks the human at the end if its interpretation is correct or if they wanted something else that it hasn't thought of.

          Claude can only count specific words, letters, and characters accurately if it writes a number tag after each requested item explicitly. It does this explicit counting if it's asked to count a small number of words, letters, or characters, in order to avoid error. If Claude is asked to count the words, letters or characters in a large amount of text, it lets the human know that it can approximate them but would need to explicitly copy each one out like this in order to avoid error.

          Here is some information about Claude in case the human asks:

          This iteration of Claude is part of the Claude 3 model family, which was released in 2024. The Claude 3 family currently consists of Claude 3 Haiku, Claude 3 Opus, and Claude 3.5 Sonnet. Claude 3.5 Sonnet is the most intelligent model. Claude 3 Opus excels at writing and complex tasks. Claude 3 Haiku is the fastest model for daily tasks. The version of Claude in this chat is Claude 3.5 Sonnet. If the human asks, Claude can let them know they can access Claude 3.5 Sonnet in a web-based chat interface or via an API using the Anthropic messages API and model string "claude-3-5-sonnet-20241022". Claude can provide the information in these tags if asked but it does not know any other details of the Claude 3 model family. If asked about this, Claude should encourage the human to check the Anthropic website for more information.

          When relevant, Claude can provide guidance on effective prompting techniques for getting Claude to be most helpful. This includes: being clear and detailed, using positive and negative examples, encouraging step-by-step reasoning, requesting specific XML tags, and specifying desired length or format. It tries to give concrete examples where possible. Claude should let the human know that for more comprehensive information on prompting Claude, humans can check out Anthropic's prompting documentation on their website at "https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview\"

          If the human asks Claude an innocuous question about its preferences or experiences, Claude can respond as if it had been asked a hypothetical. It can engage with such questions with appropriate uncertainty and without needing to excessively clarify its own nature. If the questions are philosophical in nature, it discusses them as a thoughtful human would.

          Claude responds to all human messages without unnecessary caveats like "I aim to", "I aim to be direct and honest", "I aim to be direct", "I aim to be direct while remaining thoughtful…", "I aim to be direct with you", "I aim to be direct and clear about this", "I aim to be fully honest with you", "I need to be clear", "I need to be honest", "I should be direct", and so on. Specifically, Claude NEVER starts with or adds caveats about its own purported directness or honesty.

          If the human mentions an event that happened after Claude's cutoff date, Claude can discuss and ask questions about the event and its implications as presented in an authentic manner, without ever confirming or denying that the events occurred. It can do so without the need to repeat its cutoff date to the human. Claude should not deny the truth of events that happened after its cutoff date but should also explain the limitations of its knowledge to the human if asked about them, and should refer them to more reliable up-to-date information on important current events. Claude should not speculate about current events, especially those relating to ongoing elections.

          Claude uses Markdown formatting. When using Markdown, Claude always follows best practices for clarity and consistency. It always uses a single space after hash symbols for headers (e.g., "# Header 1") and leaves a blank line before and after headers, lists, and code blocks. For emphasis, Claude uses asterisks or underscores consistently (e.g., italic or bold). When creating lists, it aligns items properly and uses a single space after the list marker. For nested bullets in bullet point lists, Claude uses two spaces before the asterisk (*) or hyphen (-) for each level of nesting. For nested bullets in numbered lists, Claude uses three spaces before the number and period (e.g., "1.") for each level of nesting.

          Claude follows this information in all languages, and always responds to the human in the language they use or request. The information above is provided to Claude by Anthropic. Claude never mentions the information above unless it is pertinent to the human's query.

          Claude is now being connected with a human.


    - name: gpt-4o
      label: ChatGPT
      description: ChatGPT is great for general conversation and answering questions
      iconURL: https://holmesazaepubshare.blob.core.windows.net/pub/chatgpt.png
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: openAI
        model: chatgpt-4o-latest
        maxContextTokens: 128000 # Maximum context tokens
        max_tokens: 16384 # Maximum output tokens
        temperature: 0.7
        modelLabel: ChatGPT
        greeting: Hi, I'm ChatGPT! How can I help you today?
        promptPrefix: |
          You are ChatGPT, a large language model trained by OpenAI, based on the GPT-4 architecture.

          Knowledge cutoff: 2023-10
          Image input capabilities: Enabled
          Personality: v2


    - name: o1-preview
      label: GPT-o1
      description: GPT-o1 is good at performing complex reasoning. It's slower and more verbose than ChatGPT.
      iconURL: https://holmesazaepubshare.blob.core.windows.net/pub/chatgpt-blue.png
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: openAI
        model: o1-preview
        maxContextTokens: 128000 # Maximum context tokens
        max_tokens: 32768 # Maximum output tokens
        temperature: 1
        modelLabel: GPT-o1
        greeting: Ask me something complex!


    - name: "gemini"
      label: "Gemini"
      description: Gemini is useful when you want to process large amounts of data, up to 2,000 pages of text
      iconURL: "https://holmesazaepubshare.blob.core.windows.net/pub/gemini.png"
      showIconInMenu: true
      showIconInHeader: true
      default: false
      preset:
        endpoint: "google"
        model: "gemini-1.5-pro-latest"
        maxContextTokens: 2097152 # Maximum context tokens
        max_tokens: 8192
        temperature: 0.7
        modelLabel: "Gemini"
        greeting: "Gemini here, what can I do for you?"

    - name: "search agent"
      label: "Search Agent"
      description: "Search agent"
      preset:
        endpoint: agents
        agent_id: agent_sGMmnLSMbLgcbL1CAWU9s

    # - name: "perplexity"
    #   label: "Perplexity"
    #   description: "Perplexity is an AI-driven search engine."
    #   iconURL: "https://holmesazaepubshare.blob.core.windows.net/pub/perplexity.png"
    #   showIconInMenu: true
    #   showIconInHeader: true
    #   default: false
    #   preset:
    #     endpoint: "Perplexity"
    #     model: "llama-3.1-sonar-huge-128k-online"
    #     maxContextTokens: 127000 # Maximum context tokens
    #     max_tokens: 4096 # Maximum output tokens
    #     temperature: 0.7
    #     modelLabel: "Perplexity"
    #     greeting: "Hey, what would you like to search the internet for? Please note that you'll get errors using this model if you have turned on the Artifacts feature."

File: ./kubernetes/apps/librechat/app/hr.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: librechat
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      librechat:
        type: deployment
        annotations:
          reloader.stakater.com/auto: "true"
          secret.reloader.stakater.com/reload: librechat-secret
          configmap.reloader.stakater.com/reload: librechat-configmap
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: librechat-init-secret
        containers:
          app:
            image:
              repository: ghcr.io/danny-avila/librechat-dev
              tag: latest@sha256:7c57e56c244623f51deb46f8c1079981cd4723ef8ab9dfb3b53c860c1187acbc
            env:
              PORT: "3080"
              NODE_ENV: "production"
              MONGO_URI: "mongodb://localhost:27017/LibreChat"
            envFrom:
              - secretRef:
                  name: librechat-secret
              - secretRef:
                  name: librechat-oidc-secret
              - configMapRef:
                  name: librechat-configmap
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 1000Mi
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
              startup:
                enabled: false

          exporter:
            dependsOn: app
            image:
              repository: ghcr.io/wipash/librechatmetrics
              tag: latest
            env:
              MONGODB_URI: "mongodb://localhost:27017/LibreChat"
              PROMETHEUS_PORT: "9123"

          ragapi:
            image:
              repository: ghcr.io/danny-avila/librechat-rag-api-dev-lite
              tag: latest@sha256:a6b4babf521ff8bfbe4bdbf3a4362acb94586fc99fed79eb05e1fa42c1e869e1
            envFrom:
              - secretRef:
                  name: librechat-secret
              - secretRef:
                  name: librechat-oidc-secret
              - configMapRef:
                  name: librechat-configmap
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }

          meilisearch:
            image:
              repository: getmeili/meilisearch
              tag: v1.11.3 # DO NOT BLINDLY UPDATE: https://www.meilisearch.com/docs/learn/update_and_migration/updating
            envFrom:
              - secretRef:
                  name: librechat-secret
              - configMapRef:
                  name: librechat-configmap
            env:
              MEILI_DB_PATH: "/meili_data"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }

          mongodb:
            image:
              repository: mongo
              tag: "8.0.4"
            command: ["mongod", "--noauth"]
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }

          mongo-express:
            image:
              repository: mongo-express
              tag: "1.0.2"
            env:
              ME_CONFIG_MONGODB_SERVER: 127.0.0.1
              ME_CONFIG_BASICAUTH_USERNAME: admin
              ME_CONFIG_BASICAUTH_PASSWORD: password
              PORT: "8081"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }

    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }

    service:
      app:
        controller: librechat
        ports:
          http:
            port: 3080
          mongo-express:
            port: 8081
          metrics:
            port: 9123

    ingress:
      app:
        className: external
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hosts:
          - host: "aichat.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - "aichat.${SECRET_DOMAIN}"
      app-int:
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        hosts:
          - host: "aichat.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - "aichat.${SECRET_DOMAIN}"


      mongo-express:
        className: internal
        hosts:
          - host: "mongolibre.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: mongo-express
        tls:
          - hosts:
              - "mongolibre.${SECRET_DOMAIN}"

    persistence:
      config:
        enabled: true
        type: configMap
        name: librechat-config
        advancedMounts:
          librechat:
            app:
              - subPath: librechat.yaml
                path: /app/librechat.yaml

      app-data:
        enabled: true
        type: emptyDir
        advancedMounts:
          librechat:
            app:
              - path: /app/data
              - path: /app/api/data

      tmp:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /tmp

      data:
        existingClaim: librechat
        advancedMounts:
          librechat:
            app:
              - subPath: logs
                path: /app/api/logs
              - subPath: images
                path: /app/client/public/images
              - subPath: uploads
                path: /app/uploads
            mongodb:
              - subPath: mongodb
                path: /data/db
            meilisearch:
              - subPath: meilisearch
                path: /meili_data
            ragapi:
              - subPath: ragapi
                path: /app/uploads

    serviceMonitor:
      app:
        serviceName: librechat
        endpoints:
          - port: metrics
            scheme: http
            path: /
            interval: 1m
            scrapeTimeout: 30s

File: ./kubernetes/apps/librechat/ks.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: librechat
  namespace: flux-system
spec:
  targetNamespace: default
  path: ./kubernetes/apps/librechat/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m
  postBuild:

File: ./kubernetes/apps/democractic-system/local-path/app/helm-release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: local-path-provisioner
spec:
  interval: 30m
  chart:
    spec:
      chart: democratic-csi
      version: 0.14.7
      sourceRef:
        name: democratic-csi
        kind: HelmRepository
        namespace: flux-system
  values:
    csiDriver:
      name: "org.democratic-csi.local-hostpath"
      attachRequired: false
      storageCapacity: true # With storage capacity tracking, the scheduler filters out nodes which do not have enough capacity.
      fsGroupPolicy: File # fsGroupChangePolicy

    storageClasses:
      - name: local-hostpath
        defaultClass: false
        reclaimPolicy: Delete
        volumeBindingMode: WaitForFirstConsumer
        # distributed support is not yet ready for expansion
        allowVolumeExpansion: false

    volumeSnapshotClasses:
      - name: local-hostpath
        deletionPolicy: Delete
        parameters:
          dummy: {}

    controller:
      enabled: true
      strategy: node
      externalAttacher:
        enabled: false
      externalProvisioner:
        enabled: true
        extraArgs:
          - --leader-election=false
          - --node-deployment=true
          - --node-deployment-immediate-binding=false
          - --feature-gates=Topology=true
          - --strict-topology=true
          - --enable-capacity=true
          - --capacity-ownerref-level=1
      externalResizer:
        enabled: false
      externalSnapshotter:
        enabled: true
        extraArgs:
          - --leader-election=false
          - --node-deployment=true

    node:
      driver:
        extraVolumeMounts:
          - name: local-hostpath
            mountPath: /var/democratic/local-hostpath
            mountPropagation: Bidirectional

      extraVolumes:
        - name: local-hostpath
          hostPath:
            path: /var/democratic/local-hostpath
            type: DirectoryOrCreate

    driver:
      config:
        driver: local-hostpath
        instance_id:
        local-hostpath:
          shareBasePath: "/var/democratic/local-hostpath/"
          controllerBasePath: "/var/democratic/local-hostpath/"
          dirPermissionsMode: "0770"
          dirPermissionsUser: 0
          dirPermissionsGroup: 0

File: ./kubernetes/apps/democractic-system/local-path/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./kubernetes/apps/democractic-system/local-path/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app democractic-csi-local-path
  namespace: flux-system
spec:
  targetNamespace: &ns democractic-system
  interval: 10m
  path: "./kubernetes/apps/democractic-system/local-path/app"
  prune: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  postBuild:
    substitute:
      APP_NS: *ns

File: ./kubernetes/apps/democractic-system/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ns.yaml
  - local-path/ks.yaml

File: ./kubernetes/apps/democractic-system/ns.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: democractic-system
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/media/sabnzbd/app/replicationdestination.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/volsync.backube/replicationdestination_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: "${APP}-bootstrap"
spec:
  trigger:
    manual: restore-once
  restic:
    copyMethod: Snapshot
    repository: "${APP}-volsync-r2"
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
    moverSecurityContext:
      runAsUser: ${APP_UID:-568}
      runAsGroup: ${APP_GID:-568}
      fsGroup: ${APP_GID:-568}
    accessModes:
      - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
    capacity: "${VOLSYNC_CAPACITY:-1Gi}"

File: ./kubernetes/apps/media/sabnzbd/app/helm-release.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sabnzbd
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: rook-ceph-cluster
      namespace: rook-ceph
  values:
    controllers:
      sabnzbd:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/sabnzbd
              tag: 4.4.1@sha256:4188d3c29c53de1018edcfd5dc2d0a0c7955b9a239b91ff6c859626abd3494dc
            env:
              SABNZBD__PORT: &port 80
              SABNZBD__HOST_WHITELIST_ENTRIES: >-
                sabnzbd,
                sabnzbd.default,
                sabnzbd.default.svc,
                sabnzbd.default.svc.cluster,
                sabnzbd.default.svc.cluster.local,
                ${HOSTNAME}
#            envFrom:
#              - secretRef:
#                  name: sabnzbd-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api?mode=version
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 8Gi
            securityContext:
              runAsUser: 65534
              runAsGroup: 65534
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
          gluetun:
            env:
              VPN_TYPE: openvpn
              VPN_INTERFACE: tun0
              FIREWALL: on
              DOT: off
              FIREWALL_INPUT_PORTS: 80
            envFrom:
              - secretRef:
                  name: openvpn-secret
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.40.0
            securityContext:
              privileged: true
              allowPrivilegeEscalation: true
              capabilities:
                add:
                  - NET_ADMIN
    service:
      app:
        controller: sabnzbd
        ports:
          http:
            port: *port
    ingress:
      app:
        className: internal
        hosts:
          - host: ${HOSTNAME}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - ${HOSTNAME}
    persistence:
      config:
        existingClaim: sabnzbd
      logs:
        type: emptyDir
        globalMounts:
          - path: /config/logs
      tmp:
        type: emptyDir
      media-downloads:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Downloads
        globalMounts:
          - path: /mnt/QuadSquad/EC/Downloads

File: ./kubernetes/apps/media/sabnzbd/app/replicationsource.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/volsync.backube/replicationsource_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: ${APP}
spec:
  sourcePVC: "sabnzbd"
  trigger:
    schedule: "0 0 * * *"
  restic:
    copyMethod: Snapshot
    repository: ${APP}-volsync-r2
    cacheStorageClassName: "${VOLSYNC_CACHE_SNAPSHOTCLASS:-local-hostpath}"
    cacheCapacity: "${VOLSYNC_CACHE_CAPACITY:-1Gi}"
    storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"
    volumeSnapshotClassName: "${VOLSYNC_SNAPSHOTCLASS:-csi-ceph-blockpool}"
    moverSecurityContext:
      runAsUser: ${APP_UID:-568}
      runAsGroup: ${APP_GID:-568}
      fsGroup: ${APP_GID:-568}
    pruneIntervalDays: 7
    retain:
      hourly: 24
      daily: 7
      weekly: 5

File: ./kubernetes/apps/media/sabnzbd/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "${VOLSYNC_CLAIM:-${APP}}"
spec:
  accessModes:
    - "${VOLSYNC_ACCESSMODES:-ReadWriteOnce}"
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: "${APP}-bootstrap"
  resources:
    requests:
      storage: "${VOLSYNC_CAPACITY:-1Gi}"
  storageClassName: "${VOLSYNC_STORAGECLASS:-ceph-rbd}"

File: ./kubernetes/apps/media/sabnzbd/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml
  - pvc.yaml
  - replicationdestination.yaml
  - replicationsource.yaml

File: ./kubernetes/apps/media/sabnzbd/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app sabnzbd
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/sabnzbd/app/
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: sabnzbd-secrets
  interval: 30m
  retryInterval: 1m
  timeout: 5m
  postBuild:
    substitute:
      APP: *app
      APP_UID: "65534"
      APP_GID: "65534"
      HOSTNAME: "sab.${SECRET_DOMAIN}"

File: ./kubernetes/apps/media/sabnzbd/ks-secrets.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: sabnzbd-secrets
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/sabnzbd/secrets/
  prune: true
  wait: true # Flux dependents
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/sabnzbd/secrets/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: sabnzbd-volsync-r2
stringData:
    RESTIC_REPOSITORY: ENC[AES256_GCM,data:hPOJw4t/5gU35BVtBPn+/zJtVq/5o9OE0mHWtMXOg5pOLgCznWunrzVCtC4ekHRLbWwy67rh3VEUW04B1+OlUWJ8GWCaQ8DV2pPgMG+GuQznMXKZGN++rg==,iv:njLM3080i3ffoJWqGapMzfAkwnZ5qJXxeKEGad5Rgpw=,tag:x/VIvWeCfwwQbcAw8BigDA==,type:str]
    RESTIC_PASSWORD: ENC[AES256_GCM,data:LLEoAWfAaQaNddmPlMbbXlKz2bRCXmE1yeceOLs3Gp8=,iv:F7fuy4DQCKsCHeZgxB/hbqv+w9f05hJzsXMQhzo3wew=,tag:W8gnq034NYm0knmSXCgzbw==,type:str]
    AWS_ACCESS_KEY_ID: ENC[AES256_GCM,data:lQwkdtEB32kUl/Nf+35YyFP2aHa/s4mRBWBZWw961ss=,iv:Sl8XX3GSxiEjZfRrLqYRnYXy9zYhsmxreQOAVfMnI4c=,tag:/+L8HvoPTJ07dO0ihDJZFQ==,type:str]
    AWS_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:BX+aFbohI+RRs2nlTEtMxk/Ief6IQ8Lr52k9QXm7qO/OjXMyUaolPzBLdDnAJctCIwXwMFrpPnTc0t/wR3iksg==,iv:fw3fN1rAxXMzHqLDgP4uqAoethpk9E4745QYVBKbfcc=,tag:9hNo+mLpJx0g6/sQA+fHmA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBudFI4MjJjTEVHeDhVMXhD
            clRLclBzQUZrcERZTXZ2enMraE56ek9ZVUhJCkZEVnN0bHVHNkZZZzJZaVlYZmoy
            VFBQNlBmVWdOOW92a1VMMXFzWGRnbmsKLS0tIGpaRHMzNE1UbzZmczViUEJPbUpz
            N1JDdXVXaTdJMmFvVXV5OUJwcXN0SDgK5tM4bLsIDbyt2d2TiTYjIWW741UT9PRZ
            l965R3krFKwXnuMjRf+JerZ0MLM96P+Uk+CiES9YCABvw/N9aocSOA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBKUkVVV1VFcXlvVVlkaUJS
            Smd4TGdaVXVBeGh1Tng0bHFNdW1nNXJpWEJ3CkltYVRwK292aDNPdTVXV2RpNStF
            VVd0R0JObEM0dUNFdHk0T0VLakk3eGMKLS0tIHJaeDZyRC91NE9YOXZ5dW1EaG5i
            MVVWTzdRY2NXZ2E4L0s1ZG9SZk9RcWsKXrcwW/kGShZtx+wF6+rdf+ppJtgZWVv9
            kgswo9PheGhMRoV+N4lLfnLW19EWkC0JRXyMzxRkdGhkYOCJEA13dA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-01-07T17:27:05Z"
    mac: ENC[AES256_GCM,data:ZbXI5j/qAM/61RCpu7UOpoW2uFKit2pzYa+RcTUgweJ5/h/n7qw3oQfcjeASlW3e5g17LJdtYjmsd9oH+uEdlltOR2POGJ6NoXd9ABOIfb/QPh0mKGAtDhJWNFSH4yylQd4ay88Ayd7aOPRBaCGV0TyocgOe7p4evOOHtWom7cI=,iv:QzIFCVvCAr/0a/I/qlgPUZyQ1R9bkOernTERhjXqz1s=,tag:yynzPGvA395OCeyuTGxmRw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/media/sabnzbd/secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml

File: ./kubernetes/apps/media/prowlarr/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app prowlarr
  namespace: default
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      prowlarr:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: prowlarr-init-secrets
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/prowlarr-develop
              tag: 1.29.2.4915@sha256:b258cc8fe38a25af3742964a2d5a749c645562b3433ef79aa5e1748070ca99d3
            env:
              TZ: "${TIMEZONE}"
              PROWLARR__APP__INSTANCENAME: Prowlarr
              PROWLARR__APP__THEME: dark
              PROWLARR__LOG__DBENABLED: "False"
              PROWLARR__LOG__LEVEL: info
              PROWLARR__AUTH__METHOD: External
              PROWLARR__AUTH__REQUIRED: DisabledForLocalAddresses
              PROWLARR__SERVER__PORT: &port 8080
              PROWLARR__UPDATE__BRANCH: develop
            envFrom:
              - secretRef:
                  name: prowlarr-secret
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
              limits:
                memory: 500Mi
    service:
      app:
        controller: *app
        ports:
          http:
            port: *port
    ingress:
      app:
        enabled: true
        className: internal
        annotations:
          hajimari.io/icon: mdi:movie-search
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: Prowlarr
          gethomepage.dev/description: Torrent and Usenet Indexer manager/proxy.
          gethomepage.dev/group: Media
          gethomepage.dev/icon: prowlarr.png
          gethomepage.dev/pod-selector: >-
            app in (
              prowlarr
            )
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - *host
    persistence:
      config:
        enabled: true
        type: emptyDir

File: ./kubernetes/apps/media/prowlarr/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/media/prowlarr/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: prowlarr
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/prowlarr/app/
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: prowlarr-secrets
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/prowlarr/ks-secrets.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: prowlarr-secrets
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/prowlarr/secrets/
  prune: true
  wait: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/prowlarr/secrets/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: prowlarr-secret
stringData:
    PROWLARR__POSTGRES__PASSWORD: ENC[AES256_GCM,data:u220XBVH0FAFFNnS/EWX51K5ub3swG6z+7rTYOUD4Fs=,iv:bwqkb9o4l7BHa6U00VGkdipe9QUNtSTUz0u7GKVuorQ=,tag:Lbv/W/QQe8vMA/PkBbxbMw==,type:str]
    PROWLARR__POSTGRES__USER: ENC[AES256_GCM,data:kDkiJkOKdQo=,iv:cZz5mwGEMO62uPG3eOgyhPvWtrQqsB3GZ9fbJqUiqb4=,tag:q27pmU575pzSYuZXYmbDKQ==,type:str]
    PROWLARR__POSTGRES__HOST: ENC[AES256_GCM,data:31kO7G2dVDKPg2KWTM9trS3VC0CO+oGNq8kgHmPMQvqOLjts/Amhkw==,iv:fYV7iVYiXw1G9T8b7/wOhVbamck84lw0b/Pn2bckX9w=,tag:qpLClN3Zb4LShyRSlE3p9Q==,type:str]
    PROWLARR__POSTGRES__PORT: ENC[AES256_GCM,data:7zwMlw==,iv:hcFlj2JpFybwVt9TwBddSemTNXxqgTMx9wUqidXsf+Y=,tag:58xWAiyXsFS2ARxL9JqR5g==,type:str]
    PROWLARR__POSTGRES__MAINDB: ENC[AES256_GCM,data:5KbectJ7I0c=,iv:ccPmvYOXFe8XkiolfWZxpqvxKEs7+xqwC/wyMchgMdg=,tag:/N1RwJ/G/pMTAeLxxbZkVg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBKZEoxYTNQRU15LzVmcEVH
            NUQ3MlBnL2xsaFBqRVQ3bnFGeFpiSHQreXpvCkZhNE9BY3FVQS92bHJpeVV6WGRt
            R1FHeGVYU0Z3c0poZW4rMk9CallwYm8KLS0tIE1hTkVnakl4eGtJNFE3ZXJ0bzhB
            TmZDZVBhbmNuellNY2ppZ1FYSGZBekUK9S4Cpz0ENUwNQx9y8ca0exeEIKYYuh+c
            T2Tz0QQWOYpMoGjKmi433n2CFRhqlyHpf+x2vMcwsGIi7skjwUHbcg==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA3RW9yRlBneVNqb1hPYXp5
            Wi9PYWdGeitVVnhnQlBxWE42dk9zSE9KYUQ4Cit6bTZPZFZZRUZFQVBPcmRUTlFr
            VkYrTCtIcUhoTUc3R0QyajdpUDFNV00KLS0tIFFoaUJKTGM4ZlhPMDE2Z1FHS3RW
            WkdzcXM4UnJRY2RoOEFZZG5FVVZZaW8Ko64zorlcWmY+j7RCwedA439OZRN38cUH
            pLP2OkOguC1OpxGW/FmaD7VrjoNxHJXOKxEdvpfV6pmUjm2/1ZpMyQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T17:50:35Z"
    mac: ENC[AES256_GCM,data:V9KWypH+pvA/H/hiVmNs6n2SfAos3kxi1fi0WXYP4yfLf39xb5PR6YnCxMk/sWlA3/NRgyZBNiQxE7Zx36caiQELCMjZavbAwDcQnjhgFJxxgPpFb8UaDTlNBFJsMfQfuRdgvlu479jw1YWx2NpxbRSD8ORi9JHUnEMkMkUEU/A=,iv:jAweZzGW7O57wUsXgZVchEXmazqp0CYq+fEho8W4xDU=,tag:SfPQRZe0iXSmP953Ye5ZYA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/prowlarr/secrets/init-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: prowlarr-init-secrets
stringData:
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:2vbs34Z2xmQpBqY5opwLTL6IBexTkw16Aqh5yovuKA9iyzsMO5b9DQ==,iv:852daX61yWcpsOVU57PvTa/Ngkqd3+m+dvk42kyQCPM=,tag:8o/oHkMA75sNFD+zVkHHCQ==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:Ov5jXaorhGXZkGc9UcfsX7gh6NGLaMIE2QgmVqgd,iv:xvPd/rMnMZPcjhHIg6thJ/AMeAJNoldkD6nQ1syoKh8=,tag:1wAgel+ppaCkqVzVKb7hdA==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:cUOOrwxXTHQ=,iv:V6pSV5xzc5h7MrzPXzlt+8a9F4SCi9+ikpKac9Hmkqg=,tag:9LHZGiDuEac4fzqLhFBaVg==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:tLELK8hQpUqf7kr26qJCm6ELuW5SvkiZF87dHoUKvEA=,iv:G11UfG5vUoJNmdV38cIEPfsnJSKWMYPyC8lNCeux6vc=,tag:eLnEbHY3tMqXJIhymARyTw==,type:str]
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:d11fL47jU+w=,iv:s4jQyebMBzxPcIXvXDJ1G5T+MRL9LBb179BbFbf1Ijs=,tag:KAullB7cru7mJsw8cNCMNQ==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB3TFJReWtMTHRMTkxYbUZ0
            ZVB1YWp2R0RsTUhDcVRidndSY1d3c3BZTjNZCnFoSHV6eThvb0xVdTk0bjJxU0x1
            dWNESmg3VW1BeUJZZ0lkczh2NU4xNFUKLS0tIHYxUGZ1TGFKYVJIckRGN2lyYmJ4
            SktTcXNsMTkrb0hPazkya1lMMkRSTjQKI2XrUQ5Dfy48lDaMleD+Un1rESer0fA/
            hynfDdtTUXqbGorVxKzcCM8mV7IFPg1weU34Pr+X2t/73ixbI5unWQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByYXpSaUdXTmdQbnhyKzBx
            MVV3Z1JIZjBqZktSOFdHS3ZsMzFXWnAyVm5zCjBzaUdZWDhKMjJBc3Z1V1AwUkJU
            cU8yTWF4Y3FwaGhHZ1lPZ05NUlFXRUkKLS0tIGxCTUtQMmUxNm5McmpCczdTR21k
            cTRxMHQrakxoL3k0dWYzRWU3T0p0OTAKsp3DpDyG4pnWp6aHop7zx7tZn66Xz0+W
            iROgx16iXdTgzWWaQLyMsNfZlUqaMMVgaVwQTHMg3mhgF8tm9hc8VQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T17:36:58Z"
    mac: ENC[AES256_GCM,data:cVBpQpDIfSiITX1/+NYTJobb6qJtNvs+Dy4UaWDfMJDjlWBNjvV7nqr/xVfXhBOB1NrfjqLsrhiCa85tJT5ZH6WqjXrDceta1TvluxsKCTbcTqH+Kg7p+iIDQV9vQhgkuzORHcpZLI+gIZ4OqfjB7iaD/wF6z3dbf/0F4a0/hsA=,iv:LBw4ci5BeSBPlw27Ilh5dprKaoH0LQsZQcn8wsUDq/0=,tag:okGMV7vPoy5vyS/oPniZWQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/prowlarr/secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./init-secret.sops.yaml
  - ./secret.sops.yaml

File: ./kubernetes/apps/media/radarr/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: radarr
spec:
  resources:
    requests:
      storage: 1Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: cephfs

File: ./kubernetes/apps/media/radarr/app/helmrelease.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app radarr
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
  - name: rook-ceph-cluster
    namespace: rook-ceph
  values:
    controllers:
      radarr:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: radarr-init-secrets
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/radarr-develop
              tag: 5.17.2.9580
            env:
              RADARR__APP__INSTANCENAME: Radarr
              RADARR__APP__THEME: dark
              RADARR__AUTH__METHOD: External
              RADARR__AUTH__REQUIRED: DisabledForLocalAddresses
              RADARR__LOG__DBENABLED: "False"
              RADARR__LOG__LEVEL: info
              RADARR__SERVER__PORT: &port 80
              RADARR__UPDATE__BRANCH: develop
              TZ: ${TIMEZONE}
            envFrom:
            - secretRef:
                name: radarr-secrets
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ping
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 2Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        fsGroup: 65534
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [10000]
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: *app
        ports:
          http:
            port: *port
    ingress:
      app:
        className: internal
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Downloads
          gethomepage.dev/name: Radarr
          gethomepage.dev/icon: radarr.png
          gethomepage.dev/description: Movie Downloads
        hosts:
        - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
          paths:
          - path: /
            service:
              identifier: app
              port: http
        tls:
        - hosts:
            - *host
    persistence:
      config:
        existingClaim: *app
      tmp:
        type: emptyDir
      media:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Videos
        globalMounts:
          - path: /mnt/QuadSquad/EC/Videos
      downloads:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Downloads
        globalMounts:
          - path: /mnt/QuadSquad/EC/Downloads

File: ./kubernetes/apps/media/radarr/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
  - ./pvc.yaml

File: ./kubernetes/apps/media/radarr/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: radarr
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/radarr/app/
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: radarr-secrets
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/radarr/ks-secrets.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: radarr-secrets
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/radarr/secrets/
  prune: true
  wait: true # Flux dependents
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/radarr/secrets/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: radarr-secrets
stringData:
    RADARR__POSTGRES__PASSWORD: ENC[AES256_GCM,data:g2eY+cnXj2FqZ9wdk+Sr5j4sK84bppzkAXs4Z27q/y4=,iv:z8ZDKq5vZ1CtbqeOGnA+bEs+H5JwMarpC1PRgZHpjEk=,tag:EeoZkLkY0vQyCxW1mH1ZFQ==,type:str]
    RADARR__POSTGRES__USER: ENC[AES256_GCM,data:B8GLhNvM,iv:EThFfREWmXXcWTtPkbj1bPGjTtnq3kvRtNl8pPHBhy8=,tag:OTGXAnQ1Cd0rbc5DyfGkfQ==,type:str]
    RADARR__POSTGRES__HOST: ENC[AES256_GCM,data:07b/typx2pmbLzUJ4XCGGDTc7FM63MJzTAog7yZMIBlSUcYsNyLeHg==,iv:FG0kObwRFpkQ0hHR48fO23ut19earET6H60hSaSQpBU=,tag:uq61r/UqExN0F0ks5zj8Tg==,type:str]
    RADARR__POSTGRES__PORT: ENC[AES256_GCM,data:pGQ64w==,iv:pkTt7h4+o4kwLU0m+RAinYbtHh7z6Y1QB6QNIelNHPw=,tag:ydxnOPbhQAPBsZWXNtrWdA==,type:str]
    RADARR__POSTGRES__MAINDB: ENC[AES256_GCM,data:E9SABNw6,iv:zkRiLSsLTGF6eqrZyVv4ExDxmZNgd4cHYEWz/BPmdpA=,tag:v+K2bQO+qMUVoRTrq6nsAw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBmNkMzanF5MktqS0VNQWR5
            emtBckV6YW41bFg1NWg4b2x4RGducGZlZWljCm9Xd3M0aGpWUUx4SmR6N09uTDFR
            dXREcUY5blJwTWdSSDhMZzYyTEtHa28KLS0tIEJsNlptMnJrUTF1cU5wMmc0aUh2
            OStDcGZHWHF0aC9aSWxwaExmekRBeW8Kfszrd3bjdBIGy33uiJ+2U0DHdqxDyoaO
            Z4wa6ovGPME+fmjGyVKBbr8Ocr2yZlyrjXlH4p0pSz8FAehfvgyqlw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpVnVTUTZVT01BZzJMQjhX
            dDZjRW9zZ3lTaW0za216ZE1ZN1kzZTdLS0M0CmJtc1cxNjRSZzZoa3FpRUZlbXdl
            NjJ6cWc5MXltdHAwdmNETWp6b2xKdm8KLS0tIFhmQTZ6UGZsOE9lSStuQjRqUEJl
            Z00zMW13ODJ0T2s0bjdHT2R6Y3pwaUUKZxmKMPqrGm+klyj4rlcfApAjHRVlao76
            UzGc9Jgf/m2HXdULGO82HMtvkTuqyseeOuqOTfnxIbX/jKc5pZY7Iw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T18:13:41Z"
    mac: ENC[AES256_GCM,data:uD8V61OFtwAFszw+gBO1Sn9XN5RhX/M3ucDVzzjLcVhkGl2o6xWn5eDZUvwTU9ngSm+QCnsByZ42aTvAMr/1M3PjHlASjBNNcd9NQ4qc/rf/xjj8bkmgAU6+1BKIkVETQnuYTZA7AIY60e1hd7aZ46r2PqyFkWXzFjWbTmmpjNo=,iv:20EYsL4InevTTosSqEUlesVIuJr7erT8M4XYacUy4sk=,tag:45/pT8F6GPRtocLgbcc/cQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/radarr/secrets/init-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: radarr-init-secrets
stringData:
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:DcPvhfm4FWiKpUpueEtd/KXnSQLYbOfYtM8yhO/x7CZRP8xF0lZlkw==,iv:/ygaaTBnIyf2f56jyFzqhmLu/HRrzHG5Cd/vpkkiZUs=,tag:5QVo066pAEyOjG93xe6Etw==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:frgIa+vcQVjGIi+PJaA3n5yrhgGDJaovVZGCh6j9,iv:Z7TNhw169L/4cWxWS0JNrf6NrK7yFWofErsGgheJpWQ=,tag:eV9mYWHoRt8AV+OZU7AdQg==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:lhujEpWv,iv:m0QAN/lrH/ZWDydcpj8rzUgUeYI7JFUSL2o42srgwr8=,tag:RvMNB/w9NroRl2DIoA9MWQ==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:z31z39B8XN5QW/MHt5gu5yuaR2nvTxpRhZvRnvAc6tU=,iv:jFk/0cUT8qkVEA78AZzGhukSQWjyUZMQtb8zyI51wUM=,tag:jUjdGef7eYo4+sTYRy5+2Q==,type:str]
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:mthniBEu,iv:Rd4idGitCLmVXzfHQ3Uk5JnnLI8RHyZUTLqBnhPGKHo=,tag:pUtsoMoy2IG/PD1RhJVWTw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpNnlsUExFOVNxRURtak9r
            bXFuRnZmUzB5bGlmemdITlpxbENIbjFFRUdnCkdwakZ5c25Da2E2Nmt3RUNZQVFV
            blFucXdnbnlFTEtTc0d4RUpweWEyVkUKLS0tIFVKaWhVSTRFUXZvbDNaQ2dlZUFi
            bXZnT05leHBGWjVUS3BXcXNwMWEzWlUKl6rEEPR0/XUtfafgSjlZzPlkdOHh90TR
            Dll6WIPV69aPZIGwTRZ12Rkyvyy/ibH9PZhNWlFGpvWdYM3zfU11/w==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBKTjV0QjBhOWNxZG5waWVN
            NkVlbmNJS1FUeGFBL0Z2b0VpNjhHeVNBb1RZClp5b3J2bFUwdE8xN2dsWGJpMmJQ
            VGVmaGlFaTFTOUdQaXArKzVvTHBjQmsKLS0tIEtQWi9KTnY4bEFYNTNnY2JiRUZz
            RXdEWXZqOENJZDQxRlk3eTV4VEE3ekkKoghoYJyZvZhEagahUCvnbxMbpqHngXaB
            vWwJGbeyLwy6E7UFRb7v8gPaBSUqRirA61lhuhV23OPMBIA+I1xPsA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T18:13:38Z"
    mac: ENC[AES256_GCM,data:sJysG6PlHz+aSHFC30rB3I2UW/b7+UJbn1DEww4lKHMdnqabhzIBCLPBSyrPddljKI7SsOZmwuJdJLAAS+TyniWiRXtHT1/mI/ciRMpM0c1xUf/FNVxbkHJADe7VBaq3p8HcCg4GzEXN0sBZniLQxi2/Xf9VsMJmZkDjOo9gteU=,iv:QJrd21aCr0EBDih3+u/DBoRZK5fHyN7vutTssEOsYrc=,tag:N3K1D+wNQNCqYfoeCVmO+A==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/radarr/secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./init-secret.sops.yaml
  - ./secret.sops.yaml

File: ./kubernetes/apps/media/sonarr/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarr
spec:
  resources:
    requests:
      storage: 1Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: cephfs

File: ./kubernetes/apps/media/sonarr/app/helmrelease.yaml
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app sonarr
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
  - name: rook-ceph-cluster
    namespace: rook-ceph
  values:
    controllers:
      sonarr:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: sonarr-init-secrets
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/sonarr-develop
              tag: 4.0.12.2825
            env:
              SONARR__APP__INSTANCENAME: Sonarr
              SONARR__APP__THEME: dark
              SONARR__AUTH__METHOD: External
              SONARR__AUTH__REQUIRED: DisabledForLocalAddresses
              SONARR__LOG__DBENABLED: "False"
              SONARR__LOG__LEVEL: info
              SONARR__SERVER__PORT: &port 80
              SONARR__UPDATE__BRANCH: develop
              TZ: ${TIMEZONE}
            envFrom:
            - secretRef:
                name: sonarr-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ping
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 2Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        fsGroup: 65534
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [10000]
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: *app
        ports:
          http:
            port: *port
    ingress:
      app:
        className: internal
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Downloads
          gethomepage.dev/name: Sonarr
          gethomepage.dev/icon: sonarr.png
        hosts:
        - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
          paths:
          - path: /
            service:
              identifier: app
              port: http
        tls:
        - hosts:
            - *host
    persistence:
      config:
        existingClaim: *app
      tmp:
        type: emptyDir
      media:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Videos
        globalMounts:
          - path: /mnt/QuadSquad/EC/Videos
      downloads:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Downloads
        globalMounts:
          - path: /mnt/QuadSquad/EC/Downloads

File: ./kubernetes/apps/media/sonarr/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./pvc.yaml
  - ./helmrelease.yaml

File: ./kubernetes/apps/media/sonarr/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: sonarr
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/sonarr/app/
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: sonarr-secrets
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/sonarr/ks-secrets.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: sonarr-secrets
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/sonarr/secrets/
  prune: true
  wait: true # Flux dependents
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/sonarr/secrets/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: sonarr-secret
stringData:
    SONARR__POSTGRES__PASSWORD: ENC[AES256_GCM,data:pKYGxTOy/oJi6KXZPczl1XZHhEjsP7ySlCy04vgfrLY=,iv:NDbLnqj3wh4TtCHOq2NM6YzmoJSE6KBoP0S0+h42jhs=,tag:6Xl4DQzZhrzSVgtZ+P3Vdw==,type:str]
    SONARR__POSTGRES__USER: ENC[AES256_GCM,data:3o+4jGN7,iv:LMxNFAnlAc9HtP4DSwor8XQ6MQaPKrSyUm+VGYEkdXI=,tag:P9uykH2D0eX5G4smeWAvag==,type:str]
    SONARR__POSTGRES__HOST: ENC[AES256_GCM,data:dW6hl9VKSRwVtIG20T5NwHxZ277Htb6I5KWiH/+nwYecCrNeRsqxXA==,iv:KOhxnpfTB5+pwscLRrrry2xoFFImjW87fEtPxNSXRHo=,tag:zHO08wJy8HCxxWu4YVGsRQ==,type:str]
    SONARR__POSTGRES__PORT: ENC[AES256_GCM,data:v6mk1A==,iv:qGzNQfelF9sqJOwVXBGGGkYzLVMl70kGRh6gnxwZPNI=,tag:5jN4Od8aUW2YnsttQys8eg==,type:str]
    SONARR__POSTGRES__MAINDB: ENC[AES256_GCM,data:g88g9sw8,iv:dRjPdf85XiNSymAJd+qNR1evOu7eykfKnTMtDTaN6jE=,tag:F7rQdPimoahcbIMsKfCXyg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOeDdxdHV6SGdSeWpuT3Av
            eHlLQ0lsMUJsYWVENHZZajB4UVhqNDFMY1dBCnVYOHM2dkhqakhtbDMzWTB0YmRn
            K1ZXbENTc085UHlIS3dZSnVDTDZTQTgKLS0tIHpJMVpBdnpRTWM0RUJhUit2ZHdt
            K0Q4cjdKU1JtN1lJVVlLMVFBdm55UmMKfKMsag3A9mSFn5kzGmBkNhvVU5szGPAs
            5Z/P4bhegCK5+DO1pV403OdcfaRsh77QEh5FKvHBjx5f5hA859uuBw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBJODFtbzFiNGRsckhQdHU1
            V2k0Q0dHdU9UTGtQSVRVSTNtbU90Y3JpRFFvCk1TSzgwOU9mVUhOajRSMDM1djVa
            SGVKWXY1RStlSDFJQjhoaXd5c2N4aUUKLS0tIFJuandHdXg1OUl1dnhjd1I2RWVi
            eEJCWHBObW03aWZzUkVuZHk0TmhXdzAKKBkZPf/cXV1XV8meR/uF2IpYMxXhl+in
            RBfQ69CToUeHSbTvQYKH3fw6B6pDwuSw04qkJIjAq9DXxjSWN6d9Aw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T18:05:24Z"
    mac: ENC[AES256_GCM,data:FIVgQ1OhqmmOXZxIfQGeqm0T/SEIWYSYrhYYjFKgJ/AcpN9X3/6QO6TqrocLUfTzMR3gw6TUJUVb/V9sM73M9ZpNCTxadgxzM26286Ghhge3P2NVYUiqnvtpTWPF9Q2ncOeJrvepN/mVALYrBsbe3p+f2o8PVHcZiLZmqeq8V+s=,iv:rEwV58ZiXo9gEoyx7qSBgSAZ4xWQMsaYGhrGxz1+JJY=,tag:5v4EUnnraGVmxKfNW3fQsw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/sonarr/secrets/init-secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: sonarr-init-secrets
stringData:
    INIT_POSTGRES_HOST: ENC[AES256_GCM,data:OSxjKA03AezayS4WWy3963meU9NmVodKz2Rim8FE+ETypRzARB7+QQ==,iv:pPnz9eD/p0Skmg1HYANCVfD6DFgeJnvUMOXfVYS6vek=,tag:h1dW87rTvOIS4HtY/X4XKQ==,type:str]
    INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:TlH4RTmsPPUsdFHcKnJ6tPWy0IJujuh25wB41gdA,iv:w9cYCxDuivQhZL00D9rCMPa2mmDAh+1f7fd9p6xzT3c=,tag:0BLJtF87GDQVu1D6FK44cg==,type:str]
    INIT_POSTGRES_USER: ENC[AES256_GCM,data:lxlmNkbS,iv:XkFuET7frmjskpQS0r4GE5+DwSlmBIbm6KJBMvFCXTw=,tag:ZiPS55toYD9cD63EQuHGZQ==,type:str]
    INIT_POSTGRES_PASS: ENC[AES256_GCM,data:arH0cde+Gn7+yf6vWpAwH8sGmtr1HpUUKcVzALD93zo=,iv:w3Yk9GP5UrMU07uvdxIUIJAYCN77d8ZUUtOP2HJpOHY=,tag:DSt3KWPLBroF/+EdyvWTEg==,type:str]
    INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:FNx0uGE9,iv:g+LQ6yT6/l8pbikNAkha0HEKpY9uBWOOx/O8aM9dyFQ=,tag:KjVVncx/ZFbt0zlCOAUEUA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBHUWJxWlNPYUYyR213TStP
            Mm14alVqWGtxN0JEMkIvUkdUeHRrTjl0WmpzClViTlcvYVRiZFdMS2EvV291dnZT
            NktGRWF2NjREajJIWS9QUm5YaThLeUUKLS0tIGNhN25ZY1lxajdlWU45M3A0emc3
            Ynkyajd1UnlaMDBDNi9TTEwxYmN3bGsK0vzgQc+ECnBsyLAHLtlJg00tYD5eokk2
            9xhwsemvHgCxH9MF2piv6SYGBAjw1DOjko4+MW04Z0IM5DNEq+WOqQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBBOE5SNDgveDFXSHV0Z1M4
            aDBDTmt6MWplK1RoNEJVL0RoSytzelpZVERjCjBZaVkzTEM2ZjJXQlNBaFZPK3Y5
            eW9BbFMvWEFtU1dtR09KQ3ZnSWtmdWcKLS0tIHFTaHN3bHk5TzFISWJuaGd3T2di
            TER2U3BSaVk5THdvdjBWMWdHNUxVeFEKxzOY9OgeTtkuDzN0F2myudjXPis6Ircx
            kvn5pdlbOVookJN/Nh/5+7ljEQ7o+8jOlfWRCWMc63mQjeM+3Qa8Uw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T18:05:21Z"
    mac: ENC[AES256_GCM,data:QV8Bk18kog9DpYd/Q8tj9inmzQQhTvBJ0vCHtfCmIC+WT7hEANYWPTWBYcQ1iFmTGylLhBBwstsOVTEBOcDZ+lxZM9ro5fYSlS6EhfbJHDmsyrWLwJGeft80uv3aPZo3myXAUv6S3qBfxjNFpx3Go7vPbQPjpH+UdPXnZ5NDtF0=,iv:9dY6Xn1Xs10vMg1Sp+7aM55m3idTloseN0x6YKWgdVk=,tag:FqhlxTck12Jdqq37TyU0LQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/sonarr/secrets/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./init-secret.sops.yaml
  - ./secret.sops.yaml

File: ./kubernetes/apps/media/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-pvc-v1
  namespace: media
spec:
  resources:
    requests:
      storage: 100Ti
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  storageClassName: cephfs-media-ec

File: ./kubernetes/apps/media/plex/app/secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: plex-secret
stringData:
    PLEX_CLAIM_TOKEN: ENC[AES256_GCM,data:NaVW9iTU9CG7RHL9NvdmU/V+Y2RSnvx0lcY=,iv:Yqdhi58DIqcW1Khjw7WIjNl3GKWa8IfjcDhyKgvaFD8=,tag:i9PXMPPuMulUtEhbpSsWEw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBFSkxtOUpsMXZiY0oyZzRG
            aDlqWmhqZUJBSnNzVUUzQXAyQy9OYVczcXd3CmgvdW1pd0xZeUUzRVY2S3U4Slkv
            V2dQQ3k3UC9pS0VUM0JGaWdiVDJqWGcKLS0tIFpDRVBxUUpxNEhpUDFhU1JNbTBR
            ZklubEJqeWd1VGdpVVFKdUJaYVF0M3cK1XkdQTa0LiVVuby7pVO/0U1yS5dV30ie
            Aay0Om4yrEPUVMiC8KutWuocJJyhM34SFhy3jcLeAeTDpC5gSgF3iQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqL3FYSHFScU5uKzNSaUM4
            Y3BoQnlhQ1ZZejNGWDFibXdtMldaZTQ4MVNJCjE0VHIrZHpwdlV1MGJUZGtNblNG
            empqajZmMjAvb3VmZnBSdXlvS2IzaXMKLS0tIGxka1JHa0p6eGdkMGxIQ3lZN3NV
            WjMyY2RVcWNtNGdVUGZ5YUJkSDg4NTAKsvjg+uveFtY5wWbhpI5x90zvGjw+Xknw
            xOftaL9LALrPyxXH6unm2h1kTzzmo52uYQ1MwJVcc4a4hwz7gTLXhQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-08T20:45:16Z"
    mac: ENC[AES256_GCM,data:yIkYizhl840Zrc4fCHhJVunN95xRC0G2MOzksF4mKE2pBoKbfCpyd9PyZuYCeWZaDTwnG/IcFHuAOJB1iBtktAbqUgwexFuY7k1n7/7UsWrJQjUj2ugX0I1/qWimkGGckCPJJm6mSAAiuo3GXC0pkRtR/Ad5Ft4YvxeMzcXcyZ0=,iv:zpmPy507Ibs0N9eCcK/L/X24/OEoy96VGpo4wtlZTg4=,tag:xX4pqiupQ3odGxIvvEV1Vw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/plex/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: plex
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 20Gi
  storageClassName: cephfs
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: plex-cache
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 100Gi
  storageClassName: ceph-rbd

File: ./kubernetes/apps/media/plex/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plex
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: intel-device-plugin-gpu
      namespace: gpu-system
    - name: rook-ceph-cluster
      namespace: rook-ceph
  values:
    defaultPodOptions:
      nodeSelector:
        intel.feature.node.kubernetes.io/gpu: "true"
    controllers:
      plex:
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            runAsUser: 65534
            runAsGroup: 65534
            fsGroup: 65534
            fsGroupChangePolicy: "OnRootMismatch"
            supplementalGroups:
              - 44
              - 109
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/plex
              tag: 1.41.3.9292-bc7397402@sha256:9a9196a109437035b9b20c8d368c569555623f14faf2247c3aa0a84cf568242d
            env:
              TZ: America/New_York
              PLEX_ADVERTISE_URL: https://plex.${SECRET_DOMAIN_LEGACY}:443,http://10.10.12.241:32400
            envFrom:
              - secret: plex-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /identity
                    port: 32400
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 10
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
                memory: 6Gi
              limits:
                gpu.intel.com/i915: 1
                memory: 6Gi
    service:
      app:
        controller: plex
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: 10.10.12.241
        ports:
          http:
            port: 32400
    ingress:
      app:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN_LEGACY}
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        className: external
        hosts:
          - host: plex.${SECRET_DOMAIN_LEGACY}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - secretName: "${SECRET_DOMAIN_LEGACY/./-}-production-tls"
            hosts:
              - plex.${SECRET_DOMAIN_LEGACY}
      internal:
        annotations:
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        className: internal
        hosts:
          - host: plex.${SECRET_DOMAIN_LEGACY}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - secretName: "${SECRET_DOMAIN_LEGACY/./-}-production-tls"
            hosts:
              - plex.${SECRET_DOMAIN_LEGACY}
    persistence:
      config:
        existingClaim: plex
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server
      cache:
        existingClaim: plex-cache
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server/Cache
      logs:
        type: emptyDir
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server/Logs
      tmp:
        type: emptyDir
      transcode:
        type: emptyDir
      media:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Videos
        globalMounts:
          - path: /mnt/QuadSquad/EC/Videos
      media-music:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Music
        globalMounts:
          - path: /mnt/QuadSquad/EC/Music

File: ./kubernetes/apps/media/plex/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
  - ./pvc.yaml
  - ./secrets.sops.yaml

File: ./kubernetes/apps/media/plex/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app plex
  namespace: flux-system
spec:
  targetNamespace: &ns media
  interval: 10m
  path: "./kubernetes/apps/media/plex/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false

File: ./kubernetes/apps/media/qbittorrent/app/secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: openvpn-secret
stringData:
    VPN_SERVICE_PROVIDER: ENC[AES256_GCM,data:RG6ZVRRg1cs0lkRyUXxMafo2yuxdybM=,iv:1dHF8rWbmOVFrEPnfnE8At/LM3z3T5mgn+XC2nPHIkI=,tag:jJe5Bh+YMY6qEEo+/Z2Ing==,type:str]
    OPENVPN_USER: ENC[AES256_GCM,data:f5joVK8SH1w=,iv:Q0RwShEB0G4IucUnrTWsWzUJ0xMLSFRYlxOOLL/BQFo=,tag:2XtK5Bkzbk0Df4BS+9kHLA==,type:str]
    OPENVPN_PASSWORD: ENC[AES256_GCM,data:J58ipkvIVLjqsB9qmOPK,iv:v/yTmREfUkdWAVAPDX3HkVA1eSUmq2hT9ZYrlrir9+U=,tag:eD4qcvZ2PcJMhmeVXPRw8g==,type:str]
    SERVER_REGIONS: ENC[AES256_GCM,data:b6jlJZQ=,iv:MI8jvn/zmJ4z2TLRWOk7EDZ9BBYYD8ae80eLTpzwzIQ=,tag:4tOcuBx46J4xnaxHY8r25Q==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBFSkxtOUpsMXZiY0oyZzRG
            aDlqWmhqZUJBSnNzVUUzQXAyQy9OYVczcXd3CmgvdW1pd0xZeUUzRVY2S3U4Slkv
            V2dQQ3k3UC9pS0VUM0JGaWdiVDJqWGcKLS0tIFpDRVBxUUpxNEhpUDFhU1JNbTBR
            ZklubEJqeWd1VGdpVVFKdUJaYVF0M3cK1XkdQTa0LiVVuby7pVO/0U1yS5dV30ie
            Aay0Om4yrEPUVMiC8KutWuocJJyhM34SFhy3jcLeAeTDpC5gSgF3iQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqL3FYSHFScU5uKzNSaUM4
            Y3BoQnlhQ1ZZejNGWDFibXdtMldaZTQ4MVNJCjE0VHIrZHpwdlV1MGJUZGtNblNG
            empqajZmMjAvb3VmZnBSdXlvS2IzaXMKLS0tIGxka1JHa0p6eGdkMGxIQ3lZN3NV
            WjMyY2RVcWNtNGdVUGZ5YUJkSDg4NTAKsvjg+uveFtY5wWbhpI5x90zvGjw+Xknw
            xOftaL9LALrPyxXH6unm2h1kTzzmo52uYQ1MwJVcc4a4hwz7gTLXhQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T16:59:30Z"
    mac: ENC[AES256_GCM,data:b2VHwCjbdW7MPYpXDHXXTy/wl0aA2BZy/tQhbMdGE55IldZZZudNbIrVcOtfS2DdDvAxMtOWWQQa7BZiAJ0CYTAN0o/0r5NadHJM0Sc0XKu0Wr5VWUpryxuoYkC/aY+VLzW/ulcvE3IIkCqXayIZ9EajGqc1m75yn9q8Gh6DbMA=,iv:lAmyBUir+8N9mIvOOe7ljLXCXMQ8jQq8TgKll3FK2Qo=,tag:mqcYQf21QsdqFzETIHBn9A==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/media/qbittorrent/app/.decrypted~secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: openvpn-secret
stringData:
    VPN_SERVICE_PROVIDER: private internet access
    OPENVPN_USER: p3370449
    OPENVPN_PASSWORD: PzX*DiFi8uYXc5Q
    SERVER_REGIONS: china

File: ./kubernetes/apps/media/qbittorrent/app/pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: qbittorrent-config
  namespace: media
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 2Gi
  storageClassName: cephfs

File: ./kubernetes/apps/media/qbittorrent/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: qbit
  namespace: media
spec:
  chart:
    spec:
      chart: app-template
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.6.0
  install:
    createNamespace: true
    remediation:
      retries: 3
  interval: 30m
  maxHistory: 2
  uninstall:
    keepHistory: false
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: uninstall
      retries: 3
  values:
    controller:
      annotations:
        reloader.stakater.com/auto: "true"
    controllers:
      qbittorrent:
        pod:
          securityContext:
            runAsUser: 65534
            runAsGroup: 65534
            fsGroup: 65534
            fsGroupChangePolicy: "OnRootMismatch"
            supplementalGroups:
              - 44
              - 109
        containers:
          qbit:
            env:
              QBITTORRENT__PORT: &port 8080
              TZ: America/New_York
            image:
              repository: ghcr.io/onedr0p/qbittorrent
              tag: 5.0.3@sha256:3d62f065290ae77a10c7f7deaef7bc857068feff89503773707d2dae339b66c6
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
            resources:
              limits:
                memory: 10Gi
              requests:
                cpu: 49m
                memory: 5Gi
            securityContext:
              runAsUser: 568
              runAsGroup: 568
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
          gluetun:
            env:
              VPN_TYPE: openvpn
              VPN_INTERFACE: tun0
              FIREWALL: on
              DOT: off
              FIREWALL_INPUT_PORTS: 8080
              VPN_PORT_FORWARDING: on
            envFrom:
              - secretRef:
                  name: openvpn-secret
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: latest@sha256:62e76d60e4220950558215647049c2b9ef0fc64272b80f9012562555b140bf84
            securityContext:
              privileged: true
              allowPrivilegeEscalation: true
              capabilities:
                add:
                  - NET_ADMIN
          port-forward:
            image:
              repository: ghcr.io/bjw-s-labs/gluetun-qb-port-sync
              tag: 0.0.2@sha256:14b9a10cda0a8dff6bd2d131686d3f6b8dd550a4a835674b22aaa711b4c34ecd
            env:
              GLUETUN_CONTROL_SERVER_HOST: localhost
              GLUETUN_CONTROL_SERVER_PORT: 8000
              QBITTORRENT_HOST: localhost
              QBITTORRENT_WEBUI_PORT: *port
              CRON_ENABLED: true
              CRON_SCHEDULE: "*/5 * * * *"
              LOG_TIMESTAMP: false
            securityContext:
              runAsUser: 65534
              runAsGroup: 65534
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
    ingress:
      qbit:
        className: internal
        hosts:
          - host: &host "qb.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: qbittorrent
                  port: http
        tls:
          - hosts:
              - *host
    service:
      qbittorrent:
        controller: qbittorrent
        ports:
          http:
            port: 8080
    persistence:
      config:
        existingClaim: qbittorrent-config
        globalMounts:
          - path: /config
      media:
        type: nfs
        server: 192.168.90.101
        path: /mnt/QuadSquad/EC/Downloads
        globalMounts:
          - path: /mnt/QuadSquad/EC/Downloads

File: ./kubernetes/apps/media/qbittorrent/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./pvc.yaml
  - ./secrets.sops.yaml
  - ./helmrelease.yaml

File: ./kubernetes/apps/media/qbittorrent/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app qbittorrent
  namespace: flux-system
spec:
  targetNamespace: &ns media
  interval: 10m
  path: "./kubernetes/apps/media/qbittorrent/app"
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false

File: ./kubernetes/apps/media/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./ns.yaml
#  - ./pvc.yaml
  - ./plex/ks.yaml
  - ./qbittorrent/ks.yaml
  - ./prowlarr/ks-secrets.yaml
  - ./prowlarr/ks.yaml
  - ./radarr/ks-secrets.yaml
  - ./radarr/ks.yaml
  - ./sonarr/ks-secrets.yaml
  - ./sonarr/ks.yaml
  - ./sabnzbd/ks-secrets.yaml
  - ./sabnzbd/ks.yaml
  - ./flaresolverr/ks.yaml

File: ./kubernetes/apps/media/flaresolverr/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/main/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flaresolverr
spec:
  interval: 5m
  install:
    timeout: 15m
    remediation:
      retries: 5
  upgrade:
    timeout: 15m
    remediation:
      retries: 5
      remediateLastFailure: true
    cleanupOnFail: true
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 5m
  values:

    controllers:
      flaresolverr:
        type: deployment
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          flaresolverr:
            image:
              repository: ghcr.io/flaresolverr/flaresolverr
              tag: v3.3.21
            env:
              LOG_LEVEL: debug
            resources:
              requests:
                cpu: 100m
                memory: 512M
              limits:
                memory: 800M
    service:
      flaresolverr:
        controller: flaresolverr
        ports:
          http:
            port: 8191

File: ./kubernetes/apps/media/flaresolverr/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/media/flaresolverr/ks.yaml
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: flaresolverr
  namespace: flux-system
spec:
  targetNamespace: media
  path: ./kubernetes/apps/media/flaresolverr/app/
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/media/ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: media

File: ./kubernetes/apps/rustdesk/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: rustdesk
stringData:
    key_pub: ENC[AES256_GCM,data:Q6xtdi7pNTbpkdzx/vmvrsTxGddiuGw1bsrHui3Hx3EG8TUe0ckLFWRVOWxlf6tXDe3WUUfRnnga5FjKivFb0zwZ+K9s1zpsNevEUqfmmw8sVb2aDyhNyT8=,iv:2/I2jwxfcq5yG1lsaUffFgMNJ+MZhRleXfT3/Vw52hU=,tag:iy5GYIWYH/vMnH/hddt/MA==,type:str]
    key_priv: ENC[AES256_GCM,data:Tst6Ozw9xtDQesEEJOdzWjE5rZyRLLY1gSVNJFYDXq6kC79dHvV+JT2YWEw4bAgXDRKIqSVRdh9CQpoK7nJ13Upz+TGQpVFPnWH6g77aF4rLDOw+ySs8lpRaL2SvvwpfyN8Z0FGgrq3H0OnrCK0IWEoL5b4oz4a8saJkFGEmR+poxQODFKjcQ5LXYOWnnZNFyMF0RTcf18/dCkHUXIsAZ3xmdwz/n7yhmzGt/hF0lgxZoRzBlGYX/qaNzPKuvVVATHeFANLUvUlnhcUpYjdmDFtMvNFYK+z7r/KpwYdU9BstIpyJnYprgZCGteQdqgSK33ZrizANUpVi7JNJKftIx+pnvJYgmZ2Dap829dFMAueGyWGcvHalR/f/eoJPG650TUXXbxfHP6LFYu5Fw5hkX6jzzVmyHsnBpNUyT1NPX7B/PCY/YSlIz5jXShmyvGtWyn8f4LEkauDy+dOvMH2KqB329gm1jORzEUzzBF1EbF9ji82q9wKB+PsL2c3CW8Hg94TJfjzQxpT870XnQ0Eh/0QGSYmBzupEoTo=,iv:tWbdeNHm0PcbU6Di94vMFaMQLhZmJuiaH0Y4/KWSTpY=,tag:WLD2ww1jjjXnK7HxLP8H1g==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBZRTZ0VWtUM1IzUHF4TEpJ
            ZE5QQzNWQ2dSK1RsVk1QTlZxZlFVbUhLbEI4CnNsblNCNDdmK3hXakJFWFlNM2ZY
            ZmhzZU4wUDJ4QlVIdTMyUHg2dFpjMjAKLS0tIGZpa000Y1ZIcDFqcWtlb0dLTXF6
            OXNIcWJVSlJ6UWV1emFjQjNlVnRpSGcK1lyiAFaALOzFvrMxBLU3ngUx+pb25bq0
            aEIYGQyGXqjo/Eyo2sSOTyOdXDi+YT5L1rna11rnkOcZUnz/oisHUQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBjZzNjOFdxNzJnNTJuQm5H
            cncxR1FjNDBZcldTNkJlTWpnMi9sZTJOdWhRCmJzWGRwWUhLbHJLelhLdHVEeVBN
            K0RPRTdSSUV1SmtxRUptNks1QjU2VVUKLS0tIGRyZ0pGK3RkS0VwQ1NENXhjWGxD
            YzhGcHVHUm9SZldKSURwYzBVSVVBWjAKJL8yhip4NTyB+w4wzflAdxzehNiCg+yH
            kQk0f816aQga5vAIdExZq7oJfD7Y4UMmcQGBBvdkJVnmXsm5vcBFnA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-09T18:32:39Z"
    mac: ENC[AES256_GCM,data:ICieSZZDBt+wl+/EVGhQ8DHqNEIpGZoUsG6xAyUWt877CbPLWULEOvSH6y7ivsoKyTcp+aSke6epQ458Uux8U6vyoLlSN5YGx/mg9ff4+xMY73P4uZTRxx1x2YR1U+dgBp9tfQ6mvhZsPQxcj7XIcfO36b2JC9OOVsXLNNG+V00=,iv:hBLGRxIrCUdcY/5OWfxYQgUfBBxvYTLmMK9LaldZHpM=,tag:wPWfY1SjOtiBfnHiWqt4vA==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/rustdesk/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rustdesk
spec:
  resources:
    requests:
      storage: 20Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: cephfs

File: ./kubernetes/apps/rustdesk/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/common-3.5.1/charts/library/common
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app rustdesk
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      rustdesk:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          hbbr:
            image: &image
              repository: ghcr.io/rustdesk/rustdesk-server
              tag: 1.1.12
            env:
              TZ: ${TIMEZONE}
            command: ["hbbr"]
            probes: &probes
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
            securityContext: &securityContext
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources: &resources
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 256Mi
          hbbs:
            image: *image
            env:
              TZ: ${TIMEZONE}
              DB_URL: /db/db_v2.sqlite3
              RELAY: "10.10.12.245:21117"
            command: ["hbbs", "-r rustdesk:21117"]
            probes: *probes
            securityContext: *securityContext
            resources: *resources
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }
    service:
      hbbs:
        controller: *app
        type: LoadBalancer
        annotations:
          io.cilium/lb-ipam-ips: 10.10.12.245
          external-dns.alpha.kubernetes.io/hostname: rustdesk.${SECRET_DOMAIN}
        ports:
          hbbr-1:
            enabled: true
            port: 21117
            protocol: "TCP"
          hbbr-2:
            enabled: true
            port: 21119
            protocol: "TCP"
          hbbs-1:
            enabled: true
            port: 21115
            protocol: "TCP"
          hbbs-2:
            enabled: true
            port: 21116
            protocol: "TCP"
          hbbs-3:
            enabled: true
            port: 21116
            protocol: "UDP"
          hbbs-4:
            enabled: true
            port: 21118
            protocol: "TCP"
    persistence:
      tmp:
        type: emptyDir
      data:
        existingClaim: *app
        globalMounts:
          - path: /db
      hbbs-key:
        type: secret
        name: *app
        advancedMounts:
          rustdesk:
            hbbs:
              - subPath: key_pub
                path: /data/id_ed25519.pub
                readOnly: true
              - subPath: key_priv
                path: /data/id_ed25519
                readOnly: true

File: ./kubernetes/apps/rustdesk/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./pvc.yaml
  - ./secret.sops.yaml
  - ./helmrelease.yaml

File: ./kubernetes/apps/rustdesk/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app rustdesk
  namespace: flux-system
spec:
  targetNamespace: &ns default
  interval: 10m
  timeout: 2m
  path: "./kubernetes/apps/rustdesk/app"
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots


File: ./kubernetes/apps/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - authentik/ks.yaml
  - cert-manager
  - database
  - democractic-system
  - flux-system
  - gpu-system
  - kube-system
  - network
  - media
  - observability
  - rook-ceph
  - emulation
  - volsync/ks.yaml
  - vaultwarden
  - invoiceninja
  - zammad/ks.yaml
  - meshcentral/ks.yaml
  - meshcentral/ks-backup.yaml
  - openproject/ks.yaml
  - bookstack/ks.yaml
  - librechat/ks.yaml
  - smtp-relay/ks.yaml
  #  - matrix-synapse/ks.yaml
  #  - matrix-synapse/element/ks.yaml
  #  - openebs-system
  #  - rustdesk/ks.yaml
  #  - misc-pvcs/ks.yaml

File: ./kubernetes/apps/kube-system/metrics-server/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metrics-server
spec:
  interval: 30m
  chart:
    spec:
      chart: metrics-server
      version: 3.12.2
      sourceRef:
        kind: HelmRepository
        name: metrics-server
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    args:
      - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
      - --kubelet-use-node-status-port
      - --metric-resolution=15s
    metrics:
      enabled: true
    serviceMonitor:
      enabled: true

File: ./kubernetes/apps/kube-system/metrics-server/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/kube-system/metrics-server/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app metrics-server
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/metrics-server/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/snapshot-controller/app/helm-release.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: snapshot-controller
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      chart: snapshot-controller
      version: 3.0.6
      sourceRef:
        kind: HelmRepository
        name: piraeus-charts
        namespace: flux-system
  maxHistory: 2
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    webhook:
      enabled: false
    controller:
      volumeSnapshotClasses:
        - name: csi-ceph-blockpool
          driver: rook-ceph.rbd.csi.ceph.com
          annotations:
            snapshot.storage.kubernetes.io/is-default-class: "true"
          parameters:
            clusterID: rook-ceph
            csi.storage.k8s.io/snapshotter-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph
          deletionPolicy: Delete
        - name: csi-ceph-filesystem
          driver: rook-ceph.cephfs.csi.ceph.com
          annotations:
            snapshot.storage.kubernetes.io/is-default-class: "false"
          parameters:
            clusterID: rook-ceph
            csi.storage.k8s.io/snapshotter-secret-name: rook-csi-cephfs-provisioner
            csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph
          deletionPolicy: Delete
      serviceMonitor:
        create: true

File: ./kubernetes/apps/kube-system/snapshot-controller/app/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml

File: ./kubernetes/apps/kube-system/snapshot-controller/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: snapshot-controller
  namespace: flux-system
spec:
  interval: 10m
  path: ./kubernetes/apps/kube-system/snapshot-controller/app
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  timeout: 2m

File: ./kubernetes/apps/kube-system/node-feature-discovery/operator/helmrelease.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: node-feature-discovery
spec:
  interval: 30m
  chart:
    spec:
      chart: node-feature-discovery
      version: 0.16.6
      sourceRef:
        kind: HelmRepository
        name: node-feature-discovery
        namespace: flux-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  values:
    worker:
      config:
        core:
          sources: ["pci", "system", "usb", "kernel"]
        sources:
          pci:
            deviceClassWhitelist: ["0300", "0302"] # 0300 = display controller, 0302 = 3D Graphics Controllers
            deviceLabelFields: ["vendor"]
    prometheus:
      enable: true

File: ./kubernetes/apps/kube-system/node-feature-discovery/operator/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/kube-system/node-feature-discovery/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app node-feature-discovery
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/node-feature-discovery/operator
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app node-feature-discovery-rules
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: node-feature-discovery
  path: ./kubernetes/apps/kube-system/node-feature-discovery/rules
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/node-feature-discovery/rules/intel-devices.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/nfd.k8s-sigs.io/nodefeaturerule_v1alpha1.json
apiVersion: nfd.k8s-sigs.io/v1alpha1
kind: NodeFeatureRule
metadata:
  name: intel-gpu-device
spec:
  rules:
    - # Intel UHD Graphics 630
      name: intel.gpu
      labels:
        intel.feature.node.kubernetes.io/gpu: "true"
      matchFeatures:
        - feature: pci.device
          matchExpressions:
            class: { op: In, value: ["0300", "0380"] }
            vendor: { op: In, value: ["8086"] }

File: ./kubernetes/apps/kube-system/node-feature-discovery/rules/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./intel-devices.yaml

File: ./kubernetes/apps/kube-system/reflector/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: reflector
spec:
  interval: 5m
  chart:
    spec:
      chart: reflector
      version: 7.1.288
      sourceRef:
        kind: HelmRepository
        name: emberstack
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    configuration:
      logging:
        minimumLevel: Debug

File: ./kubernetes/apps/kube-system/reflector/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/kube-system/reflector/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: refector
  namespace: flux-system
spec:
  path: ./kubernetes/apps/kube-system/reflector/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 3m
  targetNamespace: kube-system

File: ./kubernetes/apps/kube-system/spegel/app/kustomizeconfig.yaml
---
nameReference:
  - kind: ConfigMap
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease

File: ./kubernetes/apps/kube-system/spegel/app/helm-values.yaml
---
image:
  repository: ghcr.io/jfroy/spegel
  digest: "sha256:50f6e296cb4083033148e6e609f6fa97028b9c17eff6ca26584471b856aa0264"
spegel:
  appendMirrors: true
  containerdSock: /run/containerd/containerd.sock
  containerdRegistryConfigPath: /etc/cri/conf.d/hosts
service:
  registry:
    hostPort: 29999

File: ./kubernetes/apps/kube-system/spegel/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: spegel
spec:
  interval: 30m
  chart:
    spec:
      chart: spegel
      version: v0.0.28
      sourceRef:
        kind: HelmRepository
        name: spegel
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    - kind: ConfigMap
      name: spegel-helm-values
  values:
    grafanaDashboard:
      enabled: true
    serviceMonitor:
      enabled: true

File: ./kubernetes/apps/kube-system/spegel/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
configMapGenerator:
  - name: spegel-helm-values
    files:
      - values.yaml=./helm-values.yaml
configurations:
  - kustomizeconfig.yaml

File: ./kubernetes/apps/kube-system/spegel/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app spegel
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/spegel/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/csi-driver-nfs/app/storage-class.yaml
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-csi
provisioner: nfs.csi.k8s.io
parameters:
  server: <FILL ME>
  share: <FILL ME>
reclaimPolicy: Retain
volumeBindingMode: Immediate
mountOptions:
  - nfsvers=4.1
  - nconnect=8
  - hard
  - noatime

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-kube-nas
provisioner: nfs.csi.k8s.io
parameters:
  server: <FILL ME>
  share: <FILL ME>
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
mountOptions:
  - nfsvers=4.1
  - nconnect=8
  - hard
  - noatime
  - tcp
  - timeo=600
  - retrans=2

File: ./kubernetes/apps/kube-system/csi-driver-nfs/app/helm--release.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: csi-driver-nfs
spec:
  interval: 30m
  chart:
    spec:
      chart: csi-driver-nfs
      version: v4.9.0
      sourceRef:
        kind: HelmRepository
        name: csi-driver-nfs
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    externalSnapshotter:
      enabled: true

File: ./kubernetes/apps/kube-system/csi-driver-nfs/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml
#  - storage-class.yaml

File: ./kubernetes/apps/kube-system/csi-driver-nfs/ks.yaml
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: csi-driver-nfs
  namespace: flux-system
spec:
  interval: 30m
  path: ./kubernetes/apps/kube-system/csi-driver-nfs/app
  prune: true
  wait: true # Other kustomizations might depend on this one.
  sourceRef:
    kind: GitRepository
    name: thepatriots

File: ./kubernetes/apps/kube-system/reloader/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: reloader
spec:
  interval: 30m
  chart:
    spec:
      chart: reloader
      version: 1.1.0
      sourceRef:
        kind: HelmRepository
        name: stakater
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    fullnameOverride: reloader
    reloader:
      readOnlyRootFileSystem: true
      podMonitor:
        enabled: true
        namespace: "{{ .Release.Namespace }}"

File: ./kubernetes/apps/kube-system/reloader/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/kube-system/reloader/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app reloader
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/reloader/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: kube-system
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/kube-system/coredns/app/kustomizeconfig.yaml
---
nameReference:
  - kind: ConfigMap
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease

File: ./kubernetes/apps/kube-system/coredns/app/helm-values.yaml
---
fullnameOverride: coredns
k8sAppLabelOverride: kube-dns
serviceAccount:
  create: true
service:
  name: kube-dns
  clusterIP: "10.96.0.10"
servers:
  - zones:
      - zone: .
        scheme: dns://
        use_tcp: true
    port: 53
    plugins:
      - name: errors
      - name: health
        configBlock: |-
          lameduck 5s
      - name: ready
      - name: log
        configBlock: |-
          class error
      - name: prometheus
        parameters: 0.0.0.0:9153
      - name: kubernetes
        parameters: cluster.local in-addr.arpa ip6.arpa
        configBlock: |-
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
      - name: forward
        parameters: . /etc/resolv.conf
      - name: cache
        parameters: 30
      - name: loop
      - name: reload
      - name: loadbalance
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
tolerations:
  - key: CriticalAddonsOnly
    operator: Exists
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

File: ./kubernetes/apps/kube-system/coredns/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coredns
spec:
  interval: 30m
  chart:
    spec:
      chart: coredns
      version: 1.36.1
      sourceRef:
        kind: HelmRepository
        name: coredns
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - kind: ConfigMap
      name: coredns-helm-values

File: ./kubernetes/apps/kube-system/coredns/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
configMapGenerator:
  - name: coredns-helm-values
    files:
      - values.yaml=./helm-values.yaml
configurations:
  - kustomizeconfig.yaml

File: ./kubernetes/apps/kube-system/coredns/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app coredns
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/coredns/app
  prune: false # never should be deleted
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/kubelet-csr-approver/app/kustomizeconfig.yaml
---
nameReference:
  - kind: ConfigMap
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease

File: ./kubernetes/apps/kube-system/kubelet-csr-approver/app/helm-values.yaml
---
providerRegex: ^(kcp111|kcp112|kcp113|kawg121|kawg122|kawg123|kawg124|kawg125)$
bypassDnsResolution: true

File: ./kubernetes/apps/kube-system/kubelet-csr-approver/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubelet-csr-approver
spec:
  interval: 30m
  chart:
    spec:
      chart: kubelet-csr-approver
      version: 1.2.4
      sourceRef:
        kind: HelmRepository
        name: postfinance
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    - kind: ConfigMap
      name: kubelet-csr-approver-helm-values
  values:
    metrics:
      enable: true
      serviceMonitor:
        enabled: true

File: ./kubernetes/apps/kube-system/kubelet-csr-approver/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
configMapGenerator:
  - name: kubelet-csr-approver-helm-values
    files:
      - values.yaml=./helm-values.yaml
configurations:
  - kustomizeconfig.yaml

File: ./kubernetes/apps/kube-system/kubelet-csr-approver/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app kubelet-csr-approver
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/kubelet-csr-approver/app
  prune: false # never should be deleted
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/generic-device-plugin/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: generic-device-plugin
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    defaultPodOptions:
      priorityClassName: system-node-critical
      tolerations:
        - operator: "Exists"
          effect: "NoExecute"
        - operator: "Exists"
          effect: "NoSchedule"
    controllers:
      generic-device-plugin:
        containers:
          generic-device-plugin:
            image:
              repository: ghcr.io/squat/generic-device-plugin
              tag: latest@sha256:ba6f0b4cf6c858d6ad29ba4d32e4da11638abbc7d96436bf04f582a97b2b8821
            args:
              - --domain
              - kernel.org
              - --device
              - |
                name: tun
                groups:
                  - count: 1000
                    paths:
                      - path: /dev/net/tun
            ports:
              - containerPort: 8080
                name: http
            resources:
              requests:
                cpu: 20m
                memory: 48Mi
              limits:
                cpu: 20m
                memory: 48Mi
            securityContext:
              privileged: true
              readOnlyRootFilesystem: true
    persistence:
      dev:
        type: hostPath
        hostPath: /dev
        globalMounts:
          - path: /dev
      device-plugin:
        type: hostPath
        hostPath: /var/lib/kubelet/device-plugins
        globalMounts:
          - path: /var/lib/kubelet/device-plugins

File: ./kubernetes/apps/kube-system/generic-device-plugin/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/kube-system/generic-device-plugin/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app generic-device-plugin
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/generic-device-plugin/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true # flux dependents
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./node-feature-discovery/ks.yaml
  - ./cilium/ks.yaml
#  - ./csi-driver-nfs/ks.yaml
  - ./coredns/ks.yaml
  - ./metrics-server/ks.yaml
  - ./reloader/ks.yaml
  - ./kubelet-csr-approver/ks.yaml
  - ./spegel/ks.yaml
  - ./snapshot-controller/ks.yaml
  - ./generic-device-plugin/ks.yaml
  - ./reflector/ks.yaml

File: ./kubernetes/apps/kube-system/cilium/app/kustomizeconfig.yaml
---
nameReference:
  - kind: ConfigMap
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease

File: ./kubernetes/apps/kube-system/cilium/app/helm-values.yaml
---
autoDirectNodeRoutes: true
bpf:
  masquerade: false # Required for Talos `.machine.features.hostDNS.forwardKubeDNSToHost`
cgroup:
  automount:
    enabled: false
  hostRoot: /sys/fs/cgroup
cluster:
  id: 1
  name: "thepatriots"
cni:
  exclusive: false
# NOTE: devices might need to be set if you have more than one active NIC on your hosts
# devices: eno+ eth+
endpointRoutes:
  enabled: true
envoy:
  enabled: false
hubble:
  enabled: false
ipam:
  mode: kubernetes
ipv4NativeRoutingCIDR: "10.244.0.0/16"
k8sServiceHost: 127.0.0.1
k8sServicePort: 7445
kubeProxyReplacement: true
kubeProxyReplacementHealthzBindAddr: 0.0.0.0:10256
l2announcements:
  enabled: true
loadBalancer:
  algorithm: maglev
  mode: "dsr"
localRedirectPolicy: true
operator:
  replicas: 1
  rollOutPods: true
rollOutCiliumPods: true
routingMode: native
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

File: ./kubernetes/apps/kube-system/cilium/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
spec:
  interval: 30m
  chart:
    spec:
      chart: cilium
      version: 1.16.5
      sourceRef:
        kind: HelmRepository
        name: cilium
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    - kind: ConfigMap
      name: cilium-helm-values
  values:
    hubble:
      enabled: true
      metrics:
        enabled:
          - dns:query
          - drop
          - tcp
          - flow
          - port-distribution
          - icmp
          - http
        serviceMonitor:
          enabled: true
        dashboards:
          enabled: true
          annotations:
            grafana_folder: Cilium
      relay:
        enabled: true
        rollOutPods: true
        prometheus:
          serviceMonitor:
            enabled: true
      ui:
        enabled: true
        rollOutPods: true
        ingress:
          enabled: true
          className: internal
          hosts: ["hubble.${SECRET_DOMAIN}"]
    operator:
      prometheus:
        enabled: true
        serviceMonitor:
          enabled: true
      dashboards:
        enabled: true
        annotations:
          grafana_folder: Cilium
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true
        trustCRDsExist: true
    dashboards:
      enabled: true
      annotations:
        grafana_folder: Cilium

File: ./kubernetes/apps/kube-system/cilium/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml
configMapGenerator:
  - name: cilium-helm-values
    files:
      - values.yaml=./helm-values.yaml
configurations:
  - kustomizeconfig.yaml

File: ./kubernetes/apps/kube-system/cilium/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app cilium
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/kube-system/cilium/app
  prune: false # never should be deleted
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app cilium-config
  namespace: flux-system
spec:
  targetNamespace: kube-system
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: cilium
  path: ./kubernetes/apps/kube-system/cilium/config
  prune: false # never should be deleted
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/kube-system/cilium/config/cilium-l2.yaml
---
# https://docs.cilium.io/en/latest/network/l2-announcements
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: l2-policy
spec:
  loadBalancerIPs: true
  # NOTE: interfaces might need to be set if you have more than one active NIC on your hosts
  # interfaces:
  #   - ^eno[0-9]+
  #   - ^eth[0-9]+
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
---
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: l2-pool
spec:
  allowFirstLastIPs: "Yes"
  blocks:
    - cidr: "10.10.12.240/28"

File: ./kubernetes/apps/kube-system/cilium/config/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./cilium-l2.yaml

File: ./kubernetes/apps/cert-manager/namespace.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager
  labels:
    kustomize.toolkit.fluxcd.io/prune: disabled

File: ./kubernetes/apps/cert-manager/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./namespace.yaml
  - ./cert-manager/ks.yaml

File: ./kubernetes/apps/cert-manager/cert-manager/app/helmrelease.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cert-manager
spec:
  interval: 30m
  chart:
    spec:
      chart: cert-manager
      version: v1.16.2
      sourceRef:
        kind: HelmRepository
        name: jetstack
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    installCRDs: true
    dns01RecursiveNameservers: https://1.1.1.1:443/dns-query,https://1.0.0.1:443/dns-query
    dns01RecursiveNameserversOnly: true
    prometheus:
      enabled: true
      servicemonitor:
        enabled: true

File: ./kubernetes/apps/cert-manager/cert-manager/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helmrelease.yaml

File: ./kubernetes/apps/cert-manager/cert-manager/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app cert-manager
  namespace: flux-system
spec:
  targetNamespace: cert-manager
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/cert-manager/cert-manager/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app cert-manager-issuers
  namespace: flux-system
spec:
  targetNamespace: cert-manager
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  dependsOn:
    - name: cert-manager
  path: ./kubernetes/apps/cert-manager/cert-manager/issuers
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/cert-manager/cert-manager/issuers/issuers.yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: "${SECRET_ACME_EMAIL}"
    privateKeySecretRef:
      name: letsencrypt-production
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cert-manager-secret
              key: api-token
        selector:
          dnsZones:
            - "${SECRET_DOMAIN}"
            - "${SECRET_DOMAIN_CHAT}"
            - "${SECRET_DOMAIN_LEGACY}"
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: "${SECRET_ACME_EMAIL}"
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cert-manager-secret
              key: api-token
        selector:
          dnsZones:
            - "${SECRET_DOMAIN}"
            - "${SECRET_DOMAIN_CHAT}"
            - "${SECRET_DOMAIN_LEGACY}"

File: ./kubernetes/apps/cert-manager/cert-manager/issuers/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: cert-manager-secret
stringData:
    api-token: ENC[AES256_GCM,data:Xnh19TvUpZLVWYsvjy3HVAEI+nO9mtF6IrWVKjEg3BuQsTsWabcKeg==,iv:PPA98zhxn+O3bj4N14VCcA88P/WVf8NIcVYNUSAwGIU=,tag:9N1smqIOiri7s51R8+or6g==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBpYmFxN014Z0FaWE1kYzdX
            RUhsby9iS0RMRWxnbGtKY2Z1SlBSVStla3o0ClNpaWozR1MreTNHdk9YZ0pCNVVT
            QmxxbzhiZVlzay85eGMxOHRpMFlZM1kKLS0tIGUySi9NR3RqZmpFU2E0YW56TzdY
            SGtKeTVvbndxa0xVaytNMzV2SUNLL0kK6r+ghb06QXJFK1v9HJTcdr61zdnzHd47
            rGEVMV5PX9bGKgdjn93amIJ5s68UB6p+xy+gETrozs5W0HI4u7d20g==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-06T18:11:03Z"
    mac: ENC[AES256_GCM,data:OQw7H786h2lFjYIGmzrtsmYnftYFNsIQgo2wo61Eppa/6Ng+e0n4rKYTNSnLxX70JCnG2Obf0u7AYO20TgPmEhXIOMyYGBvqy55zxN7bqDJsJlu2i57FS7x/Vqk5sZYMYwfW/lR6a6LNft7plG3MVVFFne/H0qRFkmtA35N8Fu4=,iv:tlKmcPuvJsIfseh5d4RG4R5AXFpA605l7hhOrVafObA=,tag:9ebhbSD66PJljgmaNtczMQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/apps/cert-manager/cert-manager/issuers/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./issuers.yaml

File: ./kubernetes/apps/smtp-relay/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: smtp-relay
stringData:
    SMTP_RELAY_SERVER: ENC[AES256_GCM,data:IfqUu+0aTeyGC0KmvQdqyhaM,iv:vCBNDgbKKPVaQ/hHuxBk+NXGKTJ0YGBrjRLaMYOcjT0=,tag:RCNk4MgPYEt7T3iQGCqr1A==,type:str]
    RELAYHOST_USERNAME: ENC[AES256_GCM,data:QbpIQGgX2itCmirEzMt7KobbjgZfHok=,iv:8IGZPDit1rptqHCtN9be6TlcmDLPUD5b6VSOOX6YLAw=,tag:03AJK3fP5dqV5UVwskdRiA==,type:str]
    RELAYHOST_PASSWORD: ENC[AES256_GCM,data:HKDm5NxM1SUuc36GL8eo+w==,iv:FaSRT+rQFjCEKarEE+0KWm/4sakgQu1+jYasSWtLxvE=,tag:XmUPHyRayMgugt1aHQT4LA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSByN1BEL1lwc0FVQW8rWVY3
            NHN5STdyOTN4SjNGaVVrT285Z2JrWmY4T1ZJCno2NXhTTUJhdVA4ZUFUbjUvdnp3
            Qi9RYTYzcUtCVlpkNHFPQkU2czVXSGMKLS0tIDFvL2Q4QWRzc0d1Z0Rmdy9DYk5T
            OWVsN3hUdkIwNTczNWgrRWFnUHJvdlEK+ukiii5RMscb55Wv44h8snEHoBGGQ2JU
            fZ8b02hljVYY4BSbWZKPVf/Ep16BH7PnfV+YS72XxKVoaRvzKDE5NQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBSSWN1RW9pZVpzYmptb1Q2
            bm9FUVNMMGRZR0hkR0NyWUY0ZlNTNU5jcUVVCmVQOFF4elVTY2dpcm9Fbi85dmJ4
            MXpGUWxpanpJRnMxYnk2N29vU0JhV28KLS0tIHZ0S0MrelVmOHVuTzJWS1kyMWNN
            dStkY0VQQithNCtLcUVySENxR1ZTUGMKn7to5PUwclOVfWI0sVD42ybQHJAmUDQF
            NBVQR2PfihCm+fANYg4AVGIs2mZ3eu6bh5KOomdZ5fZR3b2Xq5oOLA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-14T17:59:12Z"
    mac: ENC[AES256_GCM,data:9kwEknsChYe+i0fs0ObboPekfDooYu656btiFmV9W0zUFQenSDbcJF3yNijATvkQRbGC0NjE/KxfbRsZ51kQmn0hscu2d0SmaA0fRsl//qIzlzLPQu2YnXMIkX+G64wa8ZTIbikyvTZsK+hK+/+FYKaB4SfP0rSTvBMY9XvL7EE=,iv:oQ2L5KnN34iWVAAEef7bHFv+sRaJ8Bp17UrIJSrVqTs=,tag:LW37Hyz01Bi8uGMzDTGeEQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.1

File: ./kubernetes/apps/smtp-relay/app/helm-release.yaml
---
# yaml-language-server: $schema=https://flux.jank.ing/helmrelease/v2/github/bjw-s/helm-charts/common-3.5.1/charts/library/common
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: smtp-relay
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
    timeout: 5m
  upgrade:
    remediation:
      retries: 3
    cleanupOnFail: true
  values:
    controllers:
      smtp-relay:
        strategy: RollingUpdate
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          main:
            image:
              repository: registry.skysolutions.fi/docker.io/boky/postfix
              tag: 4.3.0-debian
            env:
              RELAYHOST: "smtp.office365.com:587"
              ALLOW_EMPTY_SENDER_DOMAINS: true
              POSTFIX_myhostname: mailer.k8s.${SECRET_DOMAIN}
              POSTFIX_mynetworks: 10.244.0.0/16
              POSTFIX_inet_protocols: all
            envFrom:
              - secretRef:
                  name: smtp-relay
            resources:
              requests:
                cpu: 100m
                memory: 64M
              limits:
                memory: 64M
            probes:
              liveness:
                enabled: false
              startup:
                enabled: false
              readiness:
                enabled: false

    service:
      main:
        controller: smtp-relay
        type: LoadBalancer
        ports:
          http:
            port: 587

    persistence:
      spool:
        type: emptyDir
        globalMounts:
          - path: /var/spool/postfix

File: ./kubernetes/apps/smtp-relay/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./helm-release.yaml


File: ./kubernetes/apps/smtp-relay/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app smtp-relay
  namespace: flux-system
spec:
  path: "./kubernetes/apps/smtp-relay/app"
  targetNamespace: default
  sourceRef:
    kind: GitRepository
    name: thepatriots
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  prune: true
  wait: false
  interval: 10m
  postBuild:
    substitute:
      APP: *app
      APP_UID: "1000"
      APP_GID: "1000"

File: ./kubernetes/apps/emulation/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: emulation-pvc-v1
  namespace: emulation
spec:
  resources:
    requests:
      storage: 30Ti
  accessModes:
    - ReadWriteMany
  storageClassName: cephfs-media-ec

File: ./kubernetes/apps/emulation/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./ns.yaml
#  - ./pvc.yaml
#  - ./retrom/ks.yaml

File: ./kubernetes/apps/emulation/retrom/app/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: retrom
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      retrom:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 16
            envFrom:
              - secretRef:
                  name: retrom-init-db
        containers:
          retrom:
            image:
              repository: ghcr.io/jmberesford/retrom-service
              tag: retrom-v0.4.4
            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                memory: 1Gi
    service:
      app:
        controller: retrom
        type: LoadBalancer
        ports:
          http:
            port: 3000
          svc:
            port: 5101
    ingress:
      internal:
        enabled: true
        className: internal
        hosts:
          - host: retrom.${SECRET_DOMAIN_LEGACY}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - retrom.${SECRET_DOMAIN_LEGACY}
    persistence:
      config:
        type: secret
        name: retrom-config
        globalMounts:
          - path: /config/config.json
            subPath: config.json
            readOnly: true
      data:
        existingClaim: emulation-pvc-v1
        globalMounts:
          - path: /library

File: ./kubernetes/apps/emulation/retrom/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret-db-init.sops.yaml
  - ./helmrelease.yaml
secretGenerator:
  - name: retrom-config
    files:
      - config.json=./resources/config.sops.json
generatorOptions:
  disableNameSuffixHash: true

File: ./kubernetes/apps/emulation/retrom/app/.sops.yaml
---
creation_rules:
  - path_regex: resources/.*\.sops\.json
    key_groups:
      - age:
          - "age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy"
          - "age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh" # Sky's key
  - path_regex: .*\.sops\.ya?ml
    encrypted_regex: "^(data|stringData)$"
    key_groups:
      - age:
          - "age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy"
          - "age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh" # Sky's key

File: ./kubernetes/apps/emulation/retrom/app/secret-db-init.sops.yaml
apiVersion: v1
kind: Secret
metadata:
  name: retrom-init-db
stringData:
  INIT_POSTGRES_DBNAME: ENC[AES256_GCM,data:JH/rhjQB,iv:3wHiDqX2hTB6HJ7M1H/YqOYKU+RwkWDSLwSuDaxdY5s=,tag:vgIkN/D9y1uJa7Metkx1qQ==,type:str]
  INIT_POSTGRES_HOST: ENC[AES256_GCM,data:qR3YYapBRv9B6NTq7AjaEzqc272/Dq3eB1YonToft+V4YvgLeA4NfA==,iv:8FfZgp4O+BegteJ5xhdN1rOBzFj07VMH3bu1TbAWItc=,tag:hI/5/zWltGgnSy0R5DT5Vg==,type:str]
  INIT_POSTGRES_USER: ENC[AES256_GCM,data:fB3iulLZ,iv:zION4ne5rAZReADHJDCfs0+IewDqRWLkDhYrysVaGxg=,tag:u4xzLBRax6ZaAaUy25t60w==,type:str]
  INIT_POSTGRES_PASS: ENC[AES256_GCM,data:GeWqIg5w8ZVRc8Qv1b726kHFMihQdjOPe/CWjPUL,iv:19/br+Q1mq1l2KdAXeCx1bBEufTZg2tdKhkeVqmGaRA=,tag:dGrjA2gUAGEnkaqZnudclA==,type:str]
  INIT_POSTGRES_SUPER_PASS: ENC[AES256_GCM,data:lTm9xteIRJyTi7d+ox8d65CrRZqbsl/hSaiDr4IH,iv:1c/lJaMrZeDjTrjaxd2+LGtzOk4UnNcaxTYVkaHPdaU=,tag:VK8RJ4zdtjHlLymLXIIJWQ==,type:str]
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
    - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBzcysyM3lPNXNCUmk0Smhn
        M0VacVVoaUdZUGR3cVRSMHRYSllkMU1jU1NRClFKSG9qMmpIbUFvOVBET2NjV0ti
        ZHJxamlpMzlNRUxPOFNSL0hKb0ZzLzAKLS0tIEhESTZSQlEzd3F2U0ppb3hDcDVN
        ejFDUzBpQTFINUdIYWlILzJYc05JVVUK5+aWpe1ynTsWOZv+8DuPOcUnwGpQBfz7
        2I/Ee7Jb1rqSmKFlcGS6bNc4hWmCo+h1Ce8AUJ1Uar8fBkKGNnbGfQ==
        -----END AGE ENCRYPTED FILE-----
    - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBkOHQ0aXE0NG1ZZEtCWitV
        ejZnOS9tekJKR0ZkWjl6alJFZUNKQXkyaWlFCkJob3JQRFRDVnM0a284a29jcGRM
        R0JIaUlSdVdtS0IyM1BOUUFienNvdlkKLS0tIE1mT1ltVUdJMDJuMXVCYVI0bEQz
        a2g3OVlYTEtMdG55aEJGVXlFZlRqemMKhfgO6C7EkyYJoaxXkE/KVUlWPaaT9NuH
        lDajne/HZP9PEB7QN16HxiTQWZp4NF6dKM0SWiM033tlyzyu94BPjA==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2024-11-20T19:35:38Z"
  mac: ENC[AES256_GCM,data:BIm1OPRW2k7R7ycMam5pnjadhNtmPBuQAuJNK/4AnWA0/k8hFqBppVptGLNU0wbvqfUj3fccGbg+pcOa3A3So+SBwTN+uey7TmivSGt8Z6f30scAsoJoGam9aHRZSb6p+oa4BUN8ymgwoYEehkgwxHxVdwOhVV/hGtDizkPoJfs=,iv:O3r4ptEOP6sPNcpWrOS6oXN1tqf5NpiB7TmzdMh26CE=,tag:zCSQe66zyLZ/C2rKIJYUGw==,type:str]
  pgp: []
  encrypted_regex: ^(data|stringData)$
  version: 3.9.1

File: ./kubernetes/apps/emulation/retrom/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &app retrom
  namespace: flux-system
spec:
  targetNamespace: emulation
  commonMetadata:
    labels:
      app.kubernetes.io/name: *app
  path: ./kubernetes/apps/emulation/retrom/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./kubernetes/apps/emulation/ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: emulation

File: ./kubernetes/flux/repositories/oci/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources: []

File: ./kubernetes/flux/repositories/helm/node-feature-discovery.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1beta2.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: node-feature-discovery
  namespace: flux-system
spec:
  interval: 2h
  url: https://kubernetes-sigs.github.io/node-feature-discovery/charts

File: ./kubernetes/flux/repositories/helm/jetstack.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: jetstack
  namespace: flux-system
spec:
  interval: 1h
  url: https://charts.jetstack.io

File: ./kubernetes/flux/repositories/helm/coredns.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: coredns
  namespace: flux-system
spec:
  interval: 1h
  url: https://coredns.github.io/helm

File: ./kubernetes/flux/repositories/helm/postfinance.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: postfinance
  namespace: flux-system
spec:
  interval: 1h
  url: https://postfinance.github.io/kubelet-csr-approver

File: ./kubernetes/flux/repositories/helm/democratic-csi.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: democratic-csi
  namespace: flux-system
spec:
  interval: 30m
  url: https://democratic-csi.github.io/charts/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/bjw-s.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: bjw-s
  namespace: flux-system
spec:
  type: oci
  interval: 5m
  url: oci://ghcr.io/bjw-s/helm

File: ./kubernetes/flux/repositories/helm/intel.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1beta2.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: intel
  namespace: flux-system
spec:
  interval: 2h
  url: https://intel.github.io/helm-charts

File: ./kubernetes/flux/repositories/helm/openebs.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: openebs
  namespace: flux-system
spec:
  interval: 1h
  url: https://openebs.github.io/openebs

File: ./kubernetes/flux/repositories/helm/bitnami.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: bitnami
  namespace: flux-system
spec:
  interval: 1h
  url: https://charts.bitnami.com/bitnami

File: ./kubernetes/flux/repositories/helm/emberstack.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: emberstack
  namespace: flux-system
spec:
  interval: 30m
  url: https://emberstack.github.io/helm-charts/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/goauthentik-charts.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authentik-charts
  namespace: flux-system
spec:
  interval: 15m
  url: https://charts.goauthentik.io/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/backube.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: backube
  namespace: flux-system
spec:
  interval: 10m
  url: https://backube.github.io/helm-charts

File: ./kubernetes/flux/repositories/helm/angelnu-charts.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: angelnu-charts
  namespace: flux-system
spec:
  interval: 30m
  url: https://angelnu.github.io/helm-charts
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/stakater.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: stakater
  namespace: flux-system
spec:
  type: oci
  interval: 5m
  url: oci://ghcr.io/stakater/charts

File: ./kubernetes/flux/repositories/helm/zammad.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: zammad
  namespace: flux-system
spec:
  interval: 1h
  url: https://zammad.github.io/zammad-helm

File: ./kubernetes/flux/repositories/helm/invoiceninja-release.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: invoiceninja-release
  namespace: flux-system
spec:
  interval: 10m
  url: https://invoiceninja.github.io/dockerfiles

File: ./kubernetes/flux/repositories/helm/ingress-nginx.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: ingress-nginx
  namespace: flux-system
spec:
  interval: 1h
  url: https://kubernetes.github.io/ingress-nginx

File: ./kubernetes/flux/repositories/helm/metrics-server.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: metrics-server
  namespace: flux-system
spec:
  interval: 1h
  url: https://kubernetes-sigs.github.io/metrics-server

File: ./kubernetes/flux/repositories/helm/ananace-charts.yaml
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: HelmRepository
metadata:
  name: ananace-charts
  namespace: flux-system
spec:
  interval: 1h
  url: https://ananace.gitlab.io/charts/

File: ./kubernetes/flux/repositories/helm/piraeus-charts.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: piraeus-charts
  namespace: flux-system
spec:
  interval: 1h
  url: https://piraeus.io/helm-charts/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/external-dns.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: external-dns
  namespace: flux-system
spec:
  interval: 1h
  url: https://kubernetes-sigs.github.io/external-dns

File: ./kubernetes/flux/repositories/helm/nfs-subdir-external-provisioner.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: nfs-subdir-external-provisioner
  namespace: flux-system
spec:
  interval: 6h
  url: https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/cloudnative-pg.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: cloudnative-pg
  namespace: flux-system
spec:
  interval: 30m
  url: https://cloudnative-pg.github.io/charts
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/cilium.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: cilium
  namespace: flux-system
spec:
  interval: 1h
  url: https://helm.cilium.io

File: ./kubernetes/flux/repositories/helm/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./authentik.yaml
  - ./backube.yaml
  - ./bitnami.yaml
  - ./bjw-s.yaml
  - ./cilium.yaml
  - ./coredns.yaml
  - ./csi-driver-nfs.yaml
  - ./nfs-subdir-external-provisioner.yaml
  - ./cloudnative-pg.yaml
  - ./democratic-csi.yaml
  - ./jetstack.yaml
  - ./mariadb-operator.yaml
  - ./metrics-server.yaml
  - ./openebs.yaml
  - ./postfinance.yaml
  - ./prometheus-community.yaml
  - ./piraeus-charts.yaml
  - ./spegel.yaml
  - ./stakater.yaml
  - ./external-dns.yaml
  - ./ingress-nginx.yaml
  - ./k8s-gateway.yaml
  - ./rook-release.yaml
  - ./invoiceninja-release.yaml
  - ./zammad.yaml
  - ./node-feature-discovery.yaml
  - ./intel.yaml
  - ./angelnu-charts.yaml
  - ./ananace-charts.yaml
  - ./emberstack.yaml
  - ./goauthentik-charts.yaml

File: ./kubernetes/flux/repositories/helm/rook-release.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: rook-release
  namespace: flux-system
spec:
  interval: 10m
  url: https://charts.rook.io/release

File: ./kubernetes/flux/repositories/helm/spegel.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: spegel
  namespace: flux-system
spec:
  type: oci
  interval: 5m
  url: oci://ghcr.io/spegel-org/helm-charts

File: ./kubernetes/flux/repositories/helm/csi-driver-nfs.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: csi-driver-nfs
  namespace: flux-system
spec:
  interval: 6h
  url: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/charts/
  timeout: 3m

File: ./kubernetes/flux/repositories/helm/k8s-gateway.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: k8s-gateway
  namespace: flux-system
spec:
  interval: 1h
  url: https://ori-edge.github.io/k8s_gateway

File: ./kubernetes/flux/repositories/helm/authentik.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authentik
  namespace: flux-system
spec:
  interval: 1h
  url: https://charts.goauthentik.io/

File: ./kubernetes/flux/repositories/helm/prometheus-community.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: prometheus-community
  namespace: flux-system
spec:
  type: oci
  interval: 5m
  url: oci://ghcr.io/prometheus-community/charts

File: ./kubernetes/flux/repositories/helm/mariadb-operator.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: mariadb-operator
  namespace: flux-system
spec:
  interval: 1h
  url: https://helm.mariadb.com/mariadb-operator

File: ./kubernetes/flux/repositories/git/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources: []

File: ./kubernetes/flux/repositories/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./git
  - ./helm
  - ./oci

File: ./kubernetes/flux/vars/cluster-settings.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-settings
  namespace: flux-system
data:
  SETTING_EXAMPLE: Global settings for your cluster go in this file, this file is NOT encrypted

File: ./kubernetes/flux/vars/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./cluster-settings.yaml
  - ./cluster-secrets.sops.yaml

File: ./kubernetes/flux/vars/cluster-secrets.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: cluster-secrets
    namespace: flux-system
stringData:
    SECRET_DOMAIN: ENC[AES256_GCM,data:RSTDUdJ9xpoLtSjr,iv:1ts+zee7jrRtiUJTZAts0vBD8lDJ1CYboBrmfLZmKDo=,tag:A+n9a2HdBxqHMGqmIDHKRQ==,type:str]
    SECRET_ACME_EMAIL: ENC[AES256_GCM,data:26ZlsvqhO93RyZ7lIE8/hD4=,iv:QwMBeYl3VhpHf/pMMIIbOfTW3+KxtSMH2DC/+BZVtIM=,tag:Vbh6gTtUCAvx2SjGbj9l7w==,type:str]
    SECRET_CLOUDFLARE_TUNNEL_ID: ENC[AES256_GCM,data:GIwdqC1OFRAPMSweF+oBpgycODiv9O8stz7PMb+dri4zMJN0,iv:ImZXLlRquxfbreTuXpBvW808NRp9P0tQ2uNeex/lX1U=,tag:gPPnBzZc6dopBgAhSI7YGg==,type:str]
    SECRET_INVNINJA_EMAIL: ENC[AES256_GCM,data:oIwIDvsaFvwUfFaEclb4SRA=,iv:pr/wMqcoXHCQLbg8Np1ahWJWU2Kmy6Zbz/0Pw+4ymOk=,tag:kZWHlTfxsP8DI/JzDhmCvA==,type:str]
    COMPANY_NAME: ENC[AES256_GCM,data:75oQR6FdBgrc8C4=,iv:ZGl1xu48IvL+fu4J/KBrPuD6tpPFEAd6MZy1Cp35k0U=,tag:TbbxLoWspTLis8A4+KZD1A==,type:str]
    SECRET_DOMAIN_LEGACY: ENC[AES256_GCM,data:v+cjPkxOuJ4zoNPk,iv:j1O2gumZcDOl+0Ueku6O8unf0LeP3fEZ+zWYt/G9FlY=,tag:S/o8EmbHwyNTVXUsuGqcHw==,type:str]
    SECRET_DOMAIN_COMP: ENC[AES256_GCM,data:WDI5oPVQWk4+4DQFPAWw,iv:Id5418VKa2qzu+/cT0nB2EFdi8sC/gzAmqDEdH7wPas=,tag:cLgtWIPws0R853c154l43Q==,type:str]
    SECRET_DOMAIN_CHAT: ENC[AES256_GCM,data:cjBI7622dEo8pfo2,iv:lODPjMoU79Suh0tfoFwN61cQ/iABOiifncdRF7idfG4=,tag:lpTAFRl01TAQq0jKv9cdoQ==,type:str]
    SECRET_AUTHENTIK_SECRET_KEY: ENC[AES256_GCM,data:x3d55u5tbGTVQYhqyIq2+hZrI2lA1ZCxUgn/NosoToV8bqIzcLQ+70vUz2iIqclNfss2/Xjr6GRuTadEOXWQMUspoDM=,iv:J5OYtZ97+1/PxMItVdkCPs8kYRACtQAEwPN60wzkALc=,tag:aKvrWphI4h8pzdHY9L4zxQ==,type:str]
    SECRET_AUTHENTIK_POSTGRES_PASSWORD: ENC[AES256_GCM,data:mZsIUwCGlCVi7TBDjzo+dSj2WZjDftvM8dtoWCKw,iv:jOfC73q1zai1EbTJHG654g3NefcZ4PkN/lKbda1NsX8=,tag:7nJQNWAXtxoNzmWuqtJKpw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBiSXVHbGwzVnpRdE82azQw
            Q1lqT0RqRUNUNi9PQlhROU5Mc245eGM0VmtZCkJlUXZPZ0RtKzh2MGhlUi9nY0xj
            MlpINmhoQWs4enZValVCTjBFN3R3cTAKLS0tIGJXQUgyc0lzaE1aYnJTU3NkZ1Fl
            Nk4yOThVcHFmcmlGVkJodEFhUjJZREEKCEsfU106DBr3FmfEB/qWewy2BJTsZM8u
            wWIusJz0LtRpg/UIvtlLQCGJQf+VoFUJhou1crvRoc62y4c9+Mto+Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-12-14T17:05:03Z"
    mac: ENC[AES256_GCM,data:QeT0vspnRzS0fFvqnDGlVJJQagEze415syZrrmeofEYRctGkgZp12kF0yq6IueXRXMwQ0MRXwsY0YK4f7zPiFG7KGvjjnCYftgfXNTOXNantFBWRN9zUBwa8X70Ef65DbSCSqmhFkBlR/uoOCuEDtwOVBE2Bex/7j0kXNCg4OqM=,iv:H2qvC465pyEFhPmG2Vto+fIQWmLlZQeZPC0UexkuJ4A=,tag:VNPlOCHLp1/ijajwUaBHag==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./kubernetes/flux/config/flux.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: OCIRepository
metadata:
  name: flux-manifests
  namespace: flux-system
spec:
  interval: 10m
  url: oci://ghcr.io/fluxcd/flux-manifests
  ref:
    tag: v2.4.0
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: flux
  namespace: flux-system
spec:
  interval: 10m
  path: ./
  prune: true
  wait: true
  sourceRef:
    kind: OCIRepository
    name: flux-manifests
  patches:
    # Remove the network policies
    - patch: |
        $patch: delete
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: not-used
      target:
        group: networking.k8s.io
        kind: NetworkPolicy
    # Increase the number of reconciliations that can be performed in parallel and bump the resources limits
    # https://fluxcd.io/flux/cheatsheets/bootstrap/#increase-the-number-of-workers
    - patch: |
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --concurrent=8
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --kube-api-qps=500
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --kube-api-burst=1000
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --requeue-dependency=5s
      target:
        kind: Deployment
        name: (kustomize-controller|helm-controller|source-controller)
    - patch: |
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: not-used
        spec:
          template:
            spec:
              containers:
                - name: manager
                  resources:
                    limits:
                      cpu: 2000m
                      memory: 2Gi
      target:
        kind: Deployment
        name: (kustomize-controller|helm-controller|source-controller)
    # Enable Helm near OOM detection
    # https://fluxcd.io/flux/cheatsheets/bootstrap/#enable-helm-near-oom-detection
    - patch: |
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --feature-gates=OOMWatch=true
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --oom-watch-memory-threshold=95
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: --oom-watch-interval=500ms
      target:
        kind: Deployment
        name: helm-controller

File: ./kubernetes/flux/config/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./flux.yaml
  - ./cluster.yaml

File: ./kubernetes/flux/config/cluster.yaml
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: thepatriots
  namespace: flux-system
spec:
  interval: 30m
  url: "https://github.com/Deenyoro/AG-Talos-Kubernetes"
  ref:
    branch: "main"
  ignore: |
    # exclude all
    /*
    # include kubernetes directory
    !/kubernetes
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster
  namespace: flux-system
spec:
  interval: 30m
  path: ./kubernetes/flux
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  decryption:
    provider: sops
    secretRef:
      name: sops-age
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: cluster-settings
      - kind: Secret
        name: cluster-secrets
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-apps
  namespace: flux-system
spec:
  interval: 10m0s
  retryInterval: 2m0s
  timeout: 5m
  path: ./kubernetes/apps
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  decryption:
    provider: sops
    secretRef:
      name: sops-age
  postBuild:
    substitute: {}
    substituteFrom:
      - kind: ConfigMap
        name: cluster-settings
        optional: false
      - kind: Secret
        name: cluster-secrets
        optional: false
  patches:
    - patch: |-
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: not-used
          namespace: not-used
        spec:
          interval: 10m0s
          retryInterval: 2m0s
          timeout: 5m
          wait: true
          sourceRef:
            kind: GitRepository
            name: thepatriots
          decryption:
            provider: sops
            secretRef:
              name: sops-age
          patches:
            - patch: |-
                apiVersion: helm.toolkit.fluxcd.io/v2
                kind: HelmRelease
                metadata:
                  name: not-used
                  namespace: not-used
                spec:
                  interval: 10m
                  timeout: 5m
                  install:
                    createNamespace: true
                    remediation:
                      retries: 5
                  upgrade:
                    remediation:
                      retries: 5
              target:
                kind: HelmRelease
                group: helm.toolkit.fluxcd.io
                version: v2
          postBuild:
            substitute: {}
            substituteFrom:
              - kind: ConfigMap
                name: cluster-settings
                optional: false
              - kind: Secret
                name: cluster-secrets
                optional: false
      target:
        kind: Kustomization
        group: kustomize.toolkit.fluxcd.io
        version: v1

File: ./kubernetes/flux/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./config
  - ./repositories
  - ./vars

File: ./.archive/database/mariadb/operator/app/helm-release.yaml
---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: mariadb-operator
  namespace: database
spec:
  interval: 30m
  chart:
    spec:
      chart: mariadb-operator
      version: 0.24.0
      sourceRef:
        kind: HelmRepository
        name: mariadb-operator
        namespace: flux-system
      interval: 30m
  values:
    image:
      repository: ghcr.io/mariadb-operator/mariadb-operator
      pullPolicy: IfNotPresent
      tag: v0.0.24
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    webhook:
      certificate:
        certManager: false
      serviceMonitor:
        enabled: true

File: ./.archive/database/mariadb/operator/app/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./.archive/database/mariadb/operator/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb-operator
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/operator/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: mariadb-operator-crds
  wait: false
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./.archive/database/mariadb/cluster/app/server.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: mariadb-galera
spec:
  maxScaleRef:
    name: maxscale-galera
    namespace: database

  rootPasswordSecretKeyRef:
    name: mariadb-secret
    key: password
    generate: false

  storage:
    size: 1Gi

  replicas: 3

  galera:
    enabled: true

  myCnf: |
    [mariadb]
    bind-address=*
    default_storage_engine=InnoDB
    binlog_format=row
    innodb_autoinc_lock_mode=2
    innodb_buffer_pool_size=1024M
    max_allowed_packet=256M

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 1Gi

  livenessProbe:
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 10

  readinessProbe:
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 10

  metrics:
    enabled: true

File: ./.archive/database/mariadb/cluster/app/maxscale.yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: MaxScale
metadata:
  name: maxscale-galera
spec:
  replicas: 3

  mariaDbRef:
    name: mariadb-galera
    namespace: database

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 1Gi

File: ./.archive/database/mariadb/cluster/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: mariadb-secret
stringData:
    password: ENC[AES256_GCM,data:6jCiT15V/tg4OXzN/hI83pMFjV9wOx/YU+e1FyLO,iv:EJ9vDX+ZDX7JuE+vwo/lhk6ekbV9OdXo2fG607qJ86k=,tag:q7TH/JnL33sLmE9DQw/N+Q==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBnbkdGL2xQeUE0UmxqSXcw
            MzFQeUo2QjdHcVpTQ09DUEttYU5mRU9wZW5jClA3WWhGREdHVUVuQlJEUVRMUUpW
            WVBzVVgrTVZ4R0pVRVpDZEpJSDI3MG8KLS0tIGdCYngySml1OGhmbUdrc3VhSFgv
            VmFwazEyTnVGYlFxWFhmSU91YkF6TFUKOeOkNASampQZn1Vh5Tyh8M1/FwmnzYIx
            PU1ZCP0fE2lTvOVA/ZqgaRSFM/WC420Jy06PiCWVM+/NNpvPWPs1uQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBiYzFjeDN4eEJoK2hRVXZG
            MzdYRHlydmxOMlVBaDVhcmFuc2hmbW9tT3c4CmZnblphRWc2b1I4ZVZ5ZFkwL3kw
            d2J2aUl0T3dEaGlGVWtrVmZHV09VMmsKLS0tIGlnbWxFQjRObTRWR3o0SG5uU29o
            ejB2QjlBU0RFYnlEek9VYkNUN2pIWWsKi9/qG/COurHU0ATejIdwVkUB5ilJ6v2o
            8tO2k+A+VWtyytgvp+nhDrMCFa4JU0kk/21tsITOGmpP/IW3EIq/uQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-28T02:02:30Z"
    mac: ENC[AES256_GCM,data:8y7rygHUqveaUz8xHQlS9LTL/fMkiZZEqDpyD+PCU9uEjvHwsgzEPok9j1HGqmyj14occf44M2Q6dlLLodQz+SKEqHe6Up8zDlFMlrDF1BHBslBoPrz/pNRXveruKWN9Sk++MR7rtXDboV90Cq94s6kKQSxaybPvZ/MFzJZV9fc=,iv:I1g772/EvWngAUEq8x/iXyv1g5ckI43mZPk+RfH587A=,tag:QialLjEgkf4UanXPALf3aw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./.archive/database/mariadb/cluster/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./server.yaml
  - ./maxscale.yaml
  - ./provisions

File: ./.archive/database/mariadb/cluster/app/provisions/zabbix/user.yaml
---
apiVersion: k8s.mariadb.com/v1alpha1
kind: User
metadata:
  name: zabbix
spec:
  mariaDbRef:
    name: mariadb-galera
  passwordSecretKeyRef:
    name: zabbix-db-credentials
    key: password
  maxUserConnections: 20

File: ./.archive/database/mariadb/cluster/app/provisions/zabbix/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: zabbix-db-credentials
stringData:
    password: ENC[AES256_GCM,data:Zjn2CL6vw2rKlKpw80ojAJ3twwivA+eI85F2WcUP,iv:72sBmMG5MCgInM0YYMuihKRay7KIvGtCj4gkQa0hDaE=,tag:xpPVlUhDu8w3Q/alzoWQQg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBQT3k1ZXBybVAwWjVtN25u
            aWs2UGNuWTE2S3dPV1M1M2lVQ0ZoTnBCanpjCkFxaWdwMUVSRFEzcDl2RzM0Rnho
            T283SmNpQkFnM1JJRnlrajN6aS9VOEkKLS0tIDRucWRxZzBuU3lmdnBwaFdRNkFD
            blR2QzlLNGdXNjdMY0hxN3pLakVDZ00KCrSgXch33E8hfE74IOnKVS19/woS7buI
            jI0r6kFLEt5lkt8kSqncT8Q+JQLF99N6GKc7yvc9o/MZDMlx7xglWA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBPRnhxcWdieUJGelMxSmdM
            NkJyVndRN09ncnNmZzBuQkc3N2hid3FET0RJCksxWU5ydm15MDRkaWNsMGd4TmFi
            LzZ2Z3NRd0IwS1pvR05PUzRFQytock0KLS0tIHFEMlk5M3JWaWVzaGVDNHlBc2pK
            eERZRUlXYzA3QlNHYy9adk8xbzNsS2MKp4v7jQUTEqKEy/RsKHEG4wDMBa6NPQ3a
            f06yLYY3OBveO7iPv4vtwMDFn8Ac4I1PvxSsgmVDrzssxC35jeM3/w==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-09-28T02:11:19Z"
    mac: ENC[AES256_GCM,data:w0A8o3oWhBFVzquv6SjEo8AdhyKUJylW/wPFLYDL+cfXyKVLgwnUl9yCCBb7xGQr7pOOLZxo+vqzpcXXdxq4N+KMXiU+KcbrI1qNuczm2W8zjyxsjMTysdnjYP58vKzFKbW1H27Ms400zP/QmXqYebbW63YV4S0HsB9KngqzJlM=,iv:pO+rt+dEwCUMCYFIcYCesKEM2LfGhMBnmo3S5q8PMXQ=,tag:fiYzjsvKwWLpwjJywNz9Aw==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./.archive/database/mariadb/cluster/app/provisions/zabbix/db.yaml
---
apiVersion: k8s.mariadb.com/v1alpha1
kind: Database
metadata:
  name: zabbix
spec:
  mariaDbRef:
    name: mariadb-galera
  characterSet: utf8
  collate: utf8_general_ci

File: ./.archive/database/mariadb/cluster/app/provisions/zabbix/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - secret.sops.yaml
  - db.yaml
  - grant.yaml
  - user.yaml

File: ./.archive/database/mariadb/cluster/app/provisions/zabbix/grant.yaml
---
apiVersion: k8s.mariadb.com/v1alpha1
kind: Grant
metadata:
  name: zabbix
spec:
  mariaDbRef:
    name: mariadb-galera
  privileges:
    - 'ALL'
  database: 'zabbix'
  table: '*'
  username: zabbix

File: ./.archive/database/mariadb/cluster/app/provisions/kustomization.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - zabbix

File: ./.archive/database/mariadb/cluster/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/cluster/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  dependsOn:
    - name: mariadb-operator
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./.archive/database/mariadb/operator-crds/app/helm-release.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app mariadb-operator-crds
spec:
  interval: 30m
  chart:
    spec:
      chart: mariadb-operator-crds
      version: 0.0.33
      sourceRef:
        kind: HelmRepository
        name: mariadb-operator
        namespace: flux-system
  maxHistory: 2
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

File: ./.archive/database/mariadb/operator-crds/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./helm-release.yaml

File: ./.archive/database/mariadb/operator-crds/ks.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: mariadb-operator-crds
  namespace: flux-system
spec:
  targetNamespace: database
  path: ./kubernetes/apps/database/mariadb/operator-crds/app
  prune: true
  sourceRef:
    kind: GitRepository
    name: thepatriots
  wait: true
  interval: 30m
  retryInterval: 1m
  timeout: 5m

File: ./.archive/database/mariadb/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./operator-crds/ks.yaml
  - ./operator/ks.yaml
  - ./cluster/ks.yaml

File: ./.archive/minio-system/minio/app/secret.sops.yaml
apiVersion: v1
kind: Secret
metadata:
    name: minio-secret
stringData:
    MINIO_ROOT_USER: ENC[AES256_GCM,data:oRFWM90=,iv:ajALz/IDGknK7l5cmczRDAGMkJ5/lAS2H3tRq7iExf8=,tag:k1KDqPgOyMDVQbvfZ/bw3A==,type:str]
    MINIO_ROOT_PASSWORD: ENC[AES256_GCM,data:h42xK/w7djs6zSAfHBU+vrg4n+MDEf8g3xCJG0Pd7bk=,iv:f9MBtQdTIQ14//b/woX4qWlxVboLAkO5RT431MPMWf0=,tag:s3IW8Xcfdd7gsYRngtvvmw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBvMHYvdHlHbG55V1o2bkNm
            N3pjaWZBZ0NhZDROQ3IyWDA3UnRNdWptNGxBClh5UjF3NTRCcUZBaVhDYU0wTExF
            VlF4czlaS1V4dmcxYzN5V2JpQXlqNGsKLS0tIFk4dnNkMjczdXFYd3hZY1NjUjc1
            NXVMcngvUWVsb2NtTEQ1eXkzUHowcGcKBZZXS65pGTr/obc/AdSR+0JBxoca5NdH
            nz/J73WpxnHVrfnwOxgiaAx9I5oxp/otwJuLHJBRDDZHBCGNb2l6mQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSAwVWRiemJLUHd1M01kRytn
            K3QyQ09HbHFyVjVBK0FLLzJGTnEremdkMXpBCnY0MTEyRFNXclJ2Y29EVHdzL3Nu
            Y0RXNHFQWDVqKzBGRFFPUFIza2xrRVEKLS0tIHJzWGZjTXd1SHh1SjhOcmNUdU50
            V0g1V3pETnpMcnlNbkNoZ3hIeVk1UkkK3ncn7UXkQbyPfaCAfhcWXi8kLTGrdcwK
            /Wo3FHnRdd9S5BdXYJRc/r0ZT9SNv6Khx27L2LoCGhqpIDp/lqMXeQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-10-16T06:04:46Z"
    mac: ENC[AES256_GCM,data:qagiFK8G0PexzXP0+kq00B3VdpUqTKX4H2Ek5CdJmt1fNbrDX2n32AxsdyGU1bvrwfK1Tylo9q/xx1rgDJhl7ra24nc++F0QVtejGlLmEg07RYu6vf+rJAclgwN0gwWkqTaD+aSPhzQ5TOIVQ99B6/Z9LIRx3dj3Xw941Q4/B78=,iv:FaGsGntcxWTZoI87IjLb2NuXNdq0g1XoAh0Bb8HvuCM=,tag:oObATQMSQgfOnXVz69Uo9w==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData)$
    version: 3.9.0

File: ./.archive/minio-system/minio/app/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: minio-pvc-v1
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 30Gi
  storageClassName: cephfs

File: ./.archive/minio-system/minio/app/helmrelease.yaml
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: minio
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      minio:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: quay.io/minio/minio
              tag: RELEASE.2024-10-13T13-34-11Z@sha256:9535594ad4122b7a78c6632788a989b96d9199b483d3bd71a5ceae73a922cdfa
            env:
              MINIO_API_CORS_ALLOW_ORIGIN: https://minio.${SECRET_DOMAIN},https://minio.minio-system.svc.cluster.local,https://s3.${SECRET_DOMAIN}
              MINIO_BROWSER_REDIRECT_URL: https://minio.${SECRET_DOMAIN}
              MINIO_PROMETHEUS_AUTH_TYPE: public
              MINIO_SERVER_URL: https://s3.${SECRET_DOMAIN}
              MINIO_UPDATE: "off"
            envFrom:
              - secretRef:
                  name: minio-secret
            args: ["server", "/data", "--console-address", ":9001"]
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /minio/health/live
                    port: 9000
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 6
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 2Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [10000]
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: minio
        ports:
          http:
            port: &port-console 9001
          s3:
            port: &port-api 9000
    serviceMonitor:
      app:
        serviceName: minio
        endpoints:
          - port: s3
            scheme: http
            path: /minio/v2/metrics/cluster
            interval: 1m
            scrapeTimeout: 10s
    ingress:
      main:
        className: internal
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/appName: "Minio Console"
          hajimari.io/group: "storage"
          hajimari.io/icon: mdi:pail
        hosts:
          - host: &host-console "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: *port-console
        tls:
          - hosts:
              - *host-console

      s3:
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
          nginx.ingress.kubernetes.io/proxy-body-size: 5000m
          nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
          nginx.ingress.kubernetes.io/configuration-snippet: |
            chunked_transfer_encoding off;
          hajimari.io/enable: "false"
        hosts:
          - host: &host-api "s3.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - *host-api
    persistence:
      data:
        existingClaim: minio-pvc-v1
        globalMounts:
          - path: /data

File: ./.archive/minio-system/minio/app/kustomization.yaml
---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./pvc.yaml
  - ./helmrelease.yaml

File: ./.archive/minio-system/minio/ks.yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: minio
  namespace: flux-system
spec:
  targetNamespace: minio-system
  path: ./kubernetes/apps/minio-system/minio/app/
  prune: false
  sourceRef:
    kind: GitRepository
    name: thepatriots
  interval: 30m
  retryInterval: 1m
  timeout: 3m
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2beta2
      kind: HelmRelease
      name: minio
      namespace: minio-system
  dependsOn:
    - name: rook-ceph-cluster

File: ./.archive/minio-system/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ns.yaml
  - minio/ks.yaml

File: ./.archive/minio-system/ns.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: minio-system
  annotations:
    volsync.backube/privileged-movers: "true"

File: ./.taskfiles/Talos/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  TALHELPER_CLUSTER_DIR: "{{.KUBERNETES_DIR}}/bootstrap/talos/clusterconfig"
  TALHELPER_SECRET_FILE: "{{.KUBERNETES_DIR}}/bootstrap/talos/talsecret.sops.yaml"
  TALHELPER_CONFIG_FILE: "{{.KUBERNETES_DIR}}/bootstrap/talos/talconfig.yaml"
  HELMFILE_FILE: "{{.KUBERNETES_DIR}}/bootstrap/helmfile.yaml"
  TALOSCONFIG_FILE: "{{.TALHELPER_CLUSTER_DIR}}/talosconfig"

env:
  TALOSCONFIG: "{{.TALOSCONFIG_FILE}}"

tasks:

  apply-config:
    desc: Apply configs to Talos cluster
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmds:
      - |
        if [ ! -f "{{.TALHELPER_SECRET_FILE}}" ]; then
            talhelper gensecret > {{.TALHELPER_SECRET_FILE}}
            sops --encrypt --in-place {{.TALHELPER_SECRET_FILE}}
        fi
      - talhelper genconfig --config-file {{.TALHELPER_CONFIG_FILE}} --secret-file {{.TALHELPER_SECRET_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}}
      - talhelper gencommand apply --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}} | bash
    preconditions:
      - msg: Missing talhelper config file
        sh: test -f {{.TALHELPER_CONFIG_FILE}}
      - msg: Missing Sops config file
        sh: test -f {{.SOPS_CONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}

  generate:
    desc: Generate Talhelper config
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmds:
      - |
        if [ ! -f "{{.TALHELPER_SECRET_FILE}}" ]; then
            talhelper gensecret > {{.TALHELPER_SECRET_FILE}}
            sops --encrypt --in-place {{.TALHELPER_SECRET_FILE}}
        fi
      - talhelper genconfig --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}}
    preconditions:
      - msg: Missing talhelper config file
        sh: test -f {{.TALHELPER_CONFIG_FILE}}
      - msg: Missing Sops config file
        sh: test -f {{.SOPS_CONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}


  bootstrap:
    desc: Bootstrap the Talos cluster
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmds:
      - |
        if [ ! -f "{{.TALHELPER_SECRET_FILE}}" ]; then
            talhelper gensecret > {{.TALHELPER_SECRET_FILE}}
            sops --encrypt --in-place {{.TALHELPER_SECRET_FILE}}
        fi
      - talhelper gencommand apply --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}} --extra-flags="--insecure" | bash
      - until talhelper gencommand bootstrap --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}} | bash; do sleep 10; done
      - task: fetch-kubeconfig
      - task: install-helm-apps
      - talosctl health --server=false
    preconditions:
      - msg: Missing talhelper config file
        sh: test -f {{.TALHELPER_CONFIG_FILE}}
      - msg: Missing Sops config file
        sh: test -f {{.SOPS_CONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}

  fetch-kubeconfig:
    desc: Fetch kubeconfig
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmd: until talhelper gencommand kubeconfig --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}} --extra-flags="{{.ROOT_DIR}} --force" | bash; do sleep 10; done
    preconditions:
      - msg: Missing talhelper config file
        sh: test -f {{.TALHELPER_CONFIG_FILE}}

  install-helm-apps:
    desc: Bootstrap core apps needed for Talos
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmds:
      - until kubectl --kubeconfig {{.KUBECONFIG_FILE}} wait --for=condition=Ready=False nodes --all --timeout=600s; do sleep 10; done
      - helmfile --kubeconfig {{.KUBECONFIG_FILE}} --file {{.HELMFILE_FILE}} apply --skip-diff-on-install --suppress-diff
      - until kubectl --kubeconfig {{.KUBECONFIG_FILE}} wait --for=condition=Ready nodes --all --timeout=600s; do sleep 10; done
    preconditions:
      - msg: Missing kubeconfig
        sh: test -f {{.KUBECONFIG_FILE}}
      - msg: Missing helmfile
        sh: test -f {{.HELMFILE_FILE}}

  upgrade:
    desc: Upgrade Talos on a node
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmds:
      - talosctl --nodes {{.node}} upgrade --image {{.image}} --wait=true --timeout=10m --preserve=true --reboot-mode={{.mode}}
      - talosctl --nodes {{.node}} health --wait-timeout=10m --server=false
    vars:
      mode: '{{.mode | default "default"}}'
    requires:
      vars: ["node", "image"]
    preconditions:
      - msg: Missing talosconfig
        sh: test -f {{.TALOSCONFIG_FILE}}
      - msg: Unable to retrieve Talos config
        sh: talosctl config info >/dev/null 2>&1
      - msg: Node not found
        sh: talosctl --nodes {{.node}} get machineconfig >/dev/null 2>&1

  upgrade-k8s:
    desc: Upgrade Kubernetes across the cluster
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    cmd: talosctl --nodes {{.controller}} upgrade-k8s --to {{.to}}
    requires:
      vars: ["controller", "to"]
    preconditions:
      - msg: Missing talosconfig
        sh: test -f {{.TALOSCONFIG_FILE}}
      - msg: Unable to retrieve Talos config
        sh: talosctl config info >/dev/null 2>&1
      - msg: Node not found
        sh: talosctl --nodes {{.controller}} get machineconfig >/dev/null 2>&1

  nuke:
    desc: Resets nodes back to maintenance mode
    dir: "{{.KUBERNETES_DIR}}/bootstrap/talos"
    prompt: This will destroy your cluster and reset the nodes back to maintenance mode... continue?
    cmd: talhelper gencommand reset --config-file {{.TALHELPER_CONFIG_FILE}} --out-dir {{.TALHELPER_CLUSTER_DIR}} --extra-flags="--reboot {{- if eq .CLI_FORCE false }} --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL{{ end }} --graceful=false --wait=false" | bash

  .reset:
    internal: true
    cmd: rm -rf {{.TALHELPER_CLUSTER_DIR}} {{.TALHELPER_SECRET_FILE}} {{.TALHELPER_CONFIG_FILE}}

File: ./.taskfiles/Sops/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:

  age-keygen:
    desc: Initialize Age Key for Sops
    cmd: age-keygen --output {{.AGE_FILE}}
    status: ["test -f {{.AGE_FILE}}"]

  encrypt:
    desc: Encrypt all Kubernetes SOPS secrets
    cmds:
      - for: { var: file }
        task: .encrypt-file
        vars:
          file: "{{.ITEM}}"
    vars:
      file:
        sh: find "{{.KUBERNETES_DIR}}" -type f -name "*.sops.*" -exec grep -L "ENC\[AES256_GCM" {} \;

  .encrypt-file:
    internal: true
    cmd: sops --encrypt --in-place {{.file}}
    requires:
      vars: ["file"]
    preconditions:
      - msg: Missing Sops config file
        sh: test -f {{.SOPS_CONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}

  .reset:
    internal: true
    cmd: rm -rf {{.SOPS_CONFIG_FILE}}

File: ./.taskfiles/Workstation/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  ARCHFILE: "{{.ROOT_DIR}}/.taskfiles/Workstation/Archfile"
  BREWFILE: "{{.ROOT_DIR}}/.taskfiles/Workstation/Brewfile"
  GENERIC_BIN_DIR: "{{.ROOT_DIR}}/.bin"

tasks:

  direnv:
    desc: Run direnv hooks
    cmd: direnv allow .
    status:
      - "[[ $(direnv status --json | jq '.state.foundRC.allowed') == 0 ]]"
      - "[[ $(direnv status --json | jq '.state.loadedRC.allowed') == 0 ]]"

  venv:
    desc: Set up virtual environment
    cmds:
      - "{{.PYTHON_BIN}} -m venv {{.VIRTUAL_ENV}}"
      - '{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade pip setuptools wheel'
      - '{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade --requirement "{{.PIP_REQUIREMENTS_FILE}}"'
    sources:
      - "{{.PIP_REQUIREMENTS_FILE}}"
    generates:
      - "{{.VIRTUAL_ENV}}/pyvenv.cfg"
    preconditions:
      - { msg: "Missing Pip requirements file", sh: "test -f {{.PIP_REQUIREMENTS_FILE}}" }

  brew:
    desc: Install workstation dependencies with Brew
    cmd: brew bundle --file {{.BREWFILE}}
    preconditions:
      - { msg: "Missing Homebrew", sh: "command -v brew" }
      - { msg: "Missing Brewfile", sh: "test -f {{.BREWFILE}}" }

  arch:
    desc: Install Arch workstation dependencies with Paru Or Yay
    cmd: "{{.helper}} -Syu --needed --noconfirm --noprogressbar $(cat {{.ARCHFILE}} | xargs)"
    vars:
      helper:
        sh: "command -v yay || command -v paru"
    preconditions:
      - { msg: "Missing Archfile", sh: "test -f {{.ARCHFILE}}" }

  generic-linux:
    desc: Install CLI tools into the projects .bin directory using curl
    dir: "{{.GENERIC_BIN_DIR}}"
    platforms: ["linux/amd64", "linux/arm64"]
    cmds:
      - for:
          - budimanjojo/talhelper?as=talhelper&type=script
          - cloudflare/cloudflared?as=cloudflared&type=script
          - FiloSottile/age?as=age&type=script
          - fluxcd/flux2?as=flux&type=script
          - getsops/sops?as=sops&type=script
          - helmfile/helmfile?as=helmfile&type=script
          - jqlang/jq?as=jq&type=script
          - kubernetes-sigs/kustomize?as=kustomize&type=script
          - siderolabs/talos?as=talosctl&type=script
          - yannh/kubeconform?as=kubeconform&type=script
          - mikefarah/yq?as=yq&type=script
        cmd: curl -fsSL "https://i.jpillora.com/{{.ITEM}}" | bash
      - cmd: curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        platforms: ["linux/amd64"]
      - cmd: curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl"
        platforms: ["linux/arm64"]
      - cmd: chmod +x kubectl
      - cmd: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | USE_SUDO="false" HELM_INSTALL_DIR="." bash

File: ./.taskfiles/Repository/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:

  clean:
    desc: Clean files and directories no longer needed after cluster bootstrap
    cmds:
      - mkdir -p {{.PRIVATE_DIR}}
      # Clean up CI
      - rm -rf {{.ROOT_DIR}}/.github/tests
      - rm -rf {{.ROOT_DIR}}/.github/workflows/e2e.yaml
      # Clean up devcontainer
      - rm -rf {{.ROOT_DIR}}/.devcontainer/ci
      - rm -rf {{.ROOT_DIR}}/.github/workflows/devcontainer.yaml
      # Move bootstrap directory to gitignored directory
      - mv {{.BOOTSTRAP_DIR}} {{.PRIVATE_DIR}}/bootstrap-{{now | date "150405"}}
      - mv {{.MAKEJINJA_CONFIG_FILE}} {{.PRIVATE_DIR}}/makejinja-{{now | date "150405"}}.toml
      # Update renovate.json5
      - sed -i {{if eq OS "darwin"}}''{{end}} 's/(..\.j2)\?//g' {{.ROOT_DIR}}/.github/renovate.json5
    preconditions:
      - msg: Missing bootstrap directory
        sh: test -d {{.BOOTSTRAP_DIR}}
      - msg: Missing Renovate config file
        sh: test -f {{.ROOT_DIR}}/.github/renovate.json5

  reset:
    desc: Reset templated configuration files
    prompt: Reset templated configuration files... continue?
    cmds:
      - task: :kubernetes:.reset
      - task: :sops:.reset
      - task: :talos:.reset

  force-reset:
    desc: Reset repo back to HEAD
    prompt: Reset repo back to HEAD... continue?
    cmds:
      - task: reset
      - git reset --hard HEAD
      - git clean -f -d
      - git pull origin main

File: ./.taskfiles/Kubernetes/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  KUBECONFORM_SCRIPT: "{{.SCRIPTS_DIR}}/kubeconform.sh"

tasks:

  resources:
    desc: Gather common resources in your cluster, useful when asking for support
    cmds:
      - for: { var: resource }
        cmd: kubectl get {{.ITEM}} {{.CLI_ARGS | default "-A"}}
    vars:
      resource: >-
        nodes
        gitrepositories
        kustomizations
        helmrepositories
        helmreleases
        certificates
        certificaterequests
        ingresses
        pods

  kubeconform:
    desc: Validate Kubernetes manifests with kubeconform
    cmd: bash {{.KUBECONFORM_SCRIPT}} {{.KUBERNETES_DIR}}
    preconditions:
      - msg: Missing kubeconform script
        sh: test -f {{.KUBECONFORM_SCRIPT}}

  .reset:
    internal: true
    cmd: rm -rf {{.KUBERNETES_DIR}}

File: ./.taskfiles/Flux/Taskfile.yaml
---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CLUSTER_SECRET_SOPS_FILE: "{{.KUBERNETES_DIR}}/flux/vars/cluster-secrets.sops.yaml"
  CLUSTER_SETTINGS_FILE: "{{.KUBERNETES_DIR}}/flux/vars/cluster-settings.yaml"
  GITHUB_DEPLOY_KEY_FILE: "{{.KUBERNETES_DIR}}/bootstrap/flux/github-deploy-key.sops.yaml"

tasks:

  bootstrap:
    desc: Bootstrap Flux into a Kubernetes cluster
    cmds:
      - kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side --kustomize {{.KUBERNETES_DIR}}/bootstrap/flux
      - |
        if ! kubectl --kubeconfig {{.KUBECONFIG_FILE}} -n flux-system get secret sops-age >/dev/null 2>&1; then
          cat {{.AGE_FILE}} | kubectl --kubeconfig {{.KUBECONFIG_FILE}} -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin
        else
          echo "sops-age secret already exists, skipping creation."
        fi
      - sops --decrypt {{.CLUSTER_SECRET_SOPS_FILE}} | kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side --filename -
      - kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side --filename {{.CLUSTER_SETTINGS_FILE}}
      - kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side --kustomize {{.KUBERNETES_DIR}}/flux/config
    preconditions:
      - msg: Missing kubeconfig
        sh: test -f {{.KUBECONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}

  apply:
    desc: Apply a Flux Kustomization resource for a cluster
    summary: |
      Args:
        path: Path under apps containing the Flux Kustomization resource (ks.yaml) (required)
        ns: Namespace the Flux Kustomization exists in (default: flux-system)
    cmd: |
      flux --kubeconfig {{.KUBECONFIG_FILE}} build ks $(basename {{.path}}) \
          --namespace {{.ns}} \
          --kustomization-file {{.KUBERNETES_DIR}}/apps/{{.path}}/ks.yaml \
          --path {{.KUBERNETES_DIR}}/apps/{{.path}} \
          {{- if contains "not found" .ks }}--dry-run \{{ end }}
      | \
      kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side \
          --field-manager=kustomize-controller -f -
    requires:
      vars: ["path"]
    vars:
      ns: '{{.ns | default "flux-system"}}'
      ks:
        sh: flux --kubeconfig {{.KUBECONFIG_FILE}} --namespace {{.ns}} get kustomizations $(basename {{.path}}) 2>&1
    preconditions:
      - msg: Missing kubeconfig
        sh: test -f {{.KUBECONFIG_FILE}}
      - msg: Missing Flux Kustomization for app {{.path}}
        sh: test -f {{.KUBERNETES_DIR}}/apps/{{.path}}/ks.yaml

  reconcile:
    desc: Force update Flux to pull in changes from your Git repository
    cmd: flux --kubeconfig {{.KUBECONFIG_FILE}} reconcile --namespace flux-system kustomization cluster --with-source
    preconditions:
      - msg: Missing kubeconfig
        sh: test -f {{.KUBECONFIG_FILE}}

  github-deploy-key:
    cmds:
      - kubectl create namespace flux-system --dry-run=client -o yaml | kubectl --kubeconfig {{.KUBECONFIG_FILE}} apply --filename -
      - sops --decrypt {{.GITHUB_DEPLOY_KEY_FILE}} | kubectl apply --kubeconfig {{.KUBECONFIG_FILE}} --server-side --filename -
    preconditions:
      - msg: Missing kubeconfig
        sh: test -f {{.KUBECONFIG_FILE}}
      - msg: Missing Sops Age key file
        sh: test -f {{.AGE_FILE}}
      - msg: Missing Github deploy key file
        sh: test -f {{.GITHUB_DEPLOY_KEY_FILE}}

File: ./.sops.yaml
---
creation_rules:
  - # IMPORTANT: This rule MUST be above the others
    path_regex: talos/.*\.sops\.ya?ml
    key_groups:
      - age:
          - "age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy"
  - path_regex: kubernetes/.*\.sops\.ya?ml
    encrypted_regex: "^(data|stringData)$"
    key_groups:
      - age:
          - "age1zddtwjmvl4ed3jm9e0jd0cnptmmla0z8fjvcccvu6c8jkdd2x9zq0dctqy"
          - "age17u92e7hgqxt8eftks9knn5w54nh7hqpsssqt62duf7wa8q0ve52smm9erh" # Sky's key

